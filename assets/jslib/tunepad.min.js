var tunepad=function(e){"use strict";const t=new CSSStyleSheet;t.replaceSync("/*\n@keyframes fade-out {\n    0% {\n        opacity: 1.0;\n    }\n\n    100% {\n        opacity: 0.0;\n    }\n}\n*/\n.instrument {\n    position: relative;\n    box-sizing: border-box;\n    display: flex;\n}\n\n.backdrop {\n    fill: #30303f;\n}\n\n.container {\n    width: 100%;\n}\n\n.piano-key.black {\n    fill: #1d1e1f;\n    stroke: #222;\n    stroke-width: 1.5;\n    rx: 1.5;\n}\n\n.piano-key.black .black-top {\n    fill: #444;\n}\n\n.piano-key.black:hover .black-top {\n    fill: #777;\n}\n\n.piano-key.black.pressed .black-top {\n    fill: #222;\n}\n\n.piano-key.white {\n    fill: #ecedee;\n    stroke: #f7f7f8;\n    stroke-width: 1.5;\n    rx: 1.4;\n}\n\n.piano-key.white:hover {\n    fill: #ccc;\n}\n\n.piano-key.white.pressed {\n    fill: #aaa;\n    stroke: #777;\n}\n/*\n.piano-key.white.pressed.step-0 { fill: rgb(229, 76, 78); }\n.piano-key.white.pressed.step-2 { fill: rgb(228, 171, 81); }\n.piano-key.white.pressed.step-4 { fill: rgb(223, 228, 78); }\n.piano-key.white.pressed.step-5 { fill: rgb(174, 215, 71); }\n.piano-key.white.pressed.step-7 { fill: rgb(63, 169, 180); }\n.piano-key.white.pressed.step-9 { fill: rgb(78, 69, 179); }\n.piano-key.white.pressed.step-11 { fill: rgb(202, 69, 147); }\n*/\n.note-hint,\n.midi-hint,\n.key-hint {\n    stroke: none;\n    font: 9pt sans-serif;\n    fill: #0006;\n    text-anchor: middle;\n    opacity: 0.0;\n    pointer-events: none;\n    user-select: none;\n}\n\n.midi-hint.black, .note-hint.black, .key-hint.black {\n    fill: #ccc;\n}\n.show {\n    opacity: 1.0;\n}\n\n.note-hint.always-show {\n    opacity: 1.0;\n}\n\n.felt {\n    fill: #a00;\n}\n\n.animated-slide {\n    transition: transform 0.5s ease-in-out;\n}\n\n.mini-piano {\n    opacity: 0.0;\n    transition: opacity 0.25s;\n}\n\n.mini-piano.show {\n    opacity: 1.0;\n}\n");const s={note:0,velocity:90,message:"note-on",source:"pointer"};class i{get customEvent(){return new CustomEvent(this.props.message,{bubbles:!0,composed:!0,detail:this.props})}constructor(e){this.props={...s,...e,time:Date.now()}}}class n extends HTMLElement{get minKey(){return 12*this.props.minOctave+12}get maxKey(){return 12*this.props.maxOctave+23}constructor(){super(),this.props={noteHints:!0,midiHints:!0,armed:!1,minOctave:0,maxOctave:7,keyRange:24,focusOctave:2},this.container=null,this.parent=document.createElementNS("http://www.w3.org/2000/svg","g"),this.allKeys=document.createElementNS("http://www.w3.org/2000/svg","g"),this.keys=[],this.width=700,this.height=190,this.key_map="awsedftgyhujkolp;']",this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(t)}connectedCallback(){const e=document.createElement("template");e.innerHTML='<div class="instrument"><svg class="container" version="1.1"></svg></div>',this.root.appendChild(e.content.cloneNode(!0)),this.container=this.root.querySelector("svg.container"),this.container?.append(this.parent),this.container?.setAttribute("viewBox",`0 0 ${this.props.keyRange*a.width} 190`),this.render(),document.addEventListener("keydown",(e=>this.onKeyDown(e))),document.addEventListener("keyup",(e=>this.onKeyUp(e)))}disconnectedCallback(){}attributeChangedCallback(e,t,s){switch(e){case"note-hints":this.setNoteHints("false"!=s);break;case"midi-hints":this.setMidiHints("false"!=s);break;case"armed":"false"==s?this.disarmKeyboard():this.armKeyboard();break;case"key-range":this.setKeyRange(parseInt(s));break;case"min-octave":this.setMinOctave(parseInt(s));break;case"max-octave":this.setMaxOctave(parseInt(s));break;case"focus-octave":this.setFocusOctave(parseInt(s))}}emitNoteOn(e,t,s=90){const n=new i({note:e,source:t,velocity:s,message:"note-on"});this.root.host.dispatchEvent(n.customEvent)}emitNoteOff(e,t){const s=new i({note:e,source:t,velocity:0,message:"note-off"});this.root.host.dispatchEvent(s.customEvent)}emitPitchBend(e,t){const s=new i({value:e,source:t,message:"pitch-bend"});this.root.host.dispatchEvent(s.customEvent)}noteOn(e,t=90){let s=this._noteToKey(e);s?.press()}noteOff(e){let t=this._noteToKey(e);t?.release()}allNotesOff(){this.keys.forEach((e=>e.release()))}isNoteOn(e){let t=this._noteToKey(e);return null!=t&&t.isPressed()}setKeyRange(e){isNaN(e)||(this.props.keyRange=Math.max(7,Math.min(e,56)),this.container?.setAttribute("viewBox",`0 0 ${this.props.keyRange*a.width} 190`))}setMinOctave(e){isNaN(e)||(e=Math.max(0,Math.min(6,e)))!=this.props.minOctave&&(this.props.minOctave=e,this.render())}setMaxOctave(e){isNaN(e)||(e=Math.max(1,Math.min(7,e)))!=this.props.maxOctave&&(this.props.maxOctave=e,this.render())}armKeyboard(){this.props.armed=!0,this.root.querySelectorAll(".key-hint").forEach((e=>{e.classList.add("show")}))}disarmKeyboard(){this.props.armed=!1,this.root.querySelectorAll(".key-hint").forEach((e=>{e.classList.remove("show")}))}get isKeyboardArmed(){return this.props.armed}getArmedKey(e){const t=12*(this.props.focusOctave-this.props.minOctave),s=this.key_map.indexOf(e.toLowerCase());return s>=0&&s+t<this.keys.length?this.keys[s+t]:null}onKeyDown(e){if(!(e.ctrlKey||e.metaKey||e.shiftKey||1==e.repeat)&&this.isKeyboardArmed){const t=this.getArmedKey(e.key.toLowerCase());t?(this.emitNoteOn(t.note,"keyboard"),t.press()):"ArrowLeft"==e.key?this.setFocusOctave(this.props.focusOctave-1):"ArrowRight"==e.key?this.setFocusOctave(this.props.focusOctave+1):"ArrowDown"==e.key?this.emitPitchBend(-200,"keyboard"):"ArrowUp"==e.key&&this.emitPitchBend(200,"keyboard")}}onKeyUp(e){if("ArrowUp"==e.key||"ArrowDown"==e.key)this.emitPitchBend(0,"keyboard");else{const t=this.getArmedKey(e.key.toLowerCase());t&&(this.emitNoteOff(t.note,"keyboard"),t.release())}}_noteToKey(e){const t=Math.round(e-12);return t>=0&&t>=this.keys.length?this.keys[t]:null}render(){if(null==this.container)return;this.parent.innerHTML="",this.keys=[];const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.classList.add("backdrop"),e.setAttribute("width","100%"),e.setAttribute("height","100%"),this.parent.append(e),this.allKeys.classList.add("animated-slide");const t=document.createElementNS("http://www.w3.org/2000/svg","g"),s=document.createElementNS("http://www.w3.org/2000/svg","g");for(let e=this.minKey;e<=this.maxKey;e++){const i=new a(e,this);this.keys.push(i),i.black?s.append(i.el):t.append(i.el)}this.allKeys.append(t),this.allKeys.append(s),this.parent.append(this.allKeys);const i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.classList.add("felt"),i.setAttribute("width","100%"),i.setAttribute("height","1.5"),i.setAttribute("x","0"),i.setAttribute("y","0"),this.parent.append(i),this.setFocusOctave(this.props.focusOctave)}setFocusOctave(e){this.props.focusOctave=Math.max(this.props.minOctave,Math.min(this.props.maxOctave,e));const t=12*(this.props.focusOctave-this.props.minOctave);if(!isNaN(e)&&null!=this.container&&(this.keys.forEach((e=>e.autoRelease())),t>=0&&t<this.keys.length)){const e=this.keys[t].x;this.allKeys.style.transform=`translateX(${-e}px)`,this.keys.forEach((e=>e.clearKeymap()));for(let e=0;e<this.key_map.length;e++){const s=t+e;s>=0&&s<this.keys.length&&this.keys[s].setKeymap(this.key_map[e])}}}setNoteHints(e){this.props.noteHints=e,this.root.querySelectorAll(".note-hint").forEach((t=>{t.classList.toggle("show",e)}))}get showNoteHints(){return this.props.noteHints}setMidiHints(e){this.props.midiHints=e,this.root.querySelectorAll(".midi-hint").forEach((t=>{t.classList.toggle("show",e)}))}get showMidiHints(){return this.props.midiHints}}n.observedAttributes=["note-hints","midi-hints","armed","min-octave","max-octave","key-range","focus-octave"],n.ELEMENT="piano-keyboard";class a{get step(){return this.note%12}get octave(){return Math.floor(this.note/12)-1}get name(){return`${a.NOTES[this.step]}`}get offset(){return 7*(this.octave-this.piano.props.minOctave)+this._key_offsets[this.step]}get x(){return this.offset*a.width}get black(){return[1,3,6,8,10].includes(this.step)}get white(){return!this.black}get height(){return this.black?130:195}constructor(e,t){this.keyHint=document.createElementNS("http://www.w3.org/2000/svg","text"),this._key_offsets=[0,.45,1,1.55,2,3,3.4,4,4.5,5,5.6,6],this._hint_offsets=[-8,0,0,0,8,-8,0,0,0,0,0,8],this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.rect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._down=!1,this.note=e,this.piano=t,this.el.setAttribute("transform",`translate(${this.x}, 0)`),this.el.classList.add("piano-key",`step-${this.step}`),this.el.classList.add(this.black?"black":"white");const s=this.black?10:1.5;let i=s,n=a.width-2*s;if(this.rect.setAttribute("x",`${i}`),this.rect.setAttribute("y","-8"),this.rect.setAttribute("width",`${n}`),this.rect.setAttribute("height",`${this.height}`),this.rect.setAttribute("rx","3"),this.el.append(this.rect),this.black){i+=3,n-=6;const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.classList.add("black-top"),e.setAttribute("x",`${i}`),e.setAttribute("y","-5"),e.setAttribute("width",`${n}`),e.setAttribute("height",""+(this.height-20)),e.setAttribute("pointer-events","none"),this.el.append(e)}else{const e=document.createElementNS("http://www.w3.org/2000/svg","text");e.classList.add("note-hint"),e.setAttribute("x",`${i+n/2}`),e.setAttribute("y",""+(this.height-17)),e.innerHTML=`${this.name}${this.octave}`,this.piano.showNoteHints&&e.classList.add("show"),0==this.step&&e.classList.add("always-show"),this.el.append(e)}const o=document.createElementNS("http://www.w3.org/2000/svg","text");o.classList.add("midi-hint"),this.black&&o.classList.add("black"),o.setAttribute("x",`${i+n/2}`),o.setAttribute("y",""+(this.height-35)),o.innerHTML=`${this.note}`,this.piano.showMidiHints&&o.classList.add("show"),this.el.append(o);let r=i+n/2+this._hint_offsets[this.step];this.keyHint.classList.add("key-hint"),this.black&&this.keyHint.classList.add("black"),this.keyHint.setAttribute("x",`${r}`),this.keyHint.setAttribute("y",this.black?"45":"60"),this.piano.isKeyboardArmed&&this.keyHint.classList.add("show"),this.el.append(this.keyHint),this.el.addEventListener("pointerdown",(e=>{this.piano.emitNoteOn(this.note,"pointer"),this.press(),e.stopPropagation()})),this.el.addEventListener("pointerup",(e=>{this.piano.emitNoteOff(this.note,"pointer"),this.release()})),this.el.addEventListener("pointerleave",(e=>{this._down&&(this.piano.emitNoteOff(this.note,"pointer"),this.release())})),this.el.addEventListener("pointerenter",(e=>{e.buttons>0&&(this.piano.emitNoteOn(this.note,"pointer"),this.press())}))}press(){this._down=!0,this.el.classList.add("pressed")}release(){this._down&&(this._down=!1,this.el.classList.remove("pressed"))}isPressed(){return this.el.classList.contains("pressed")}autoRelease(){this._down&&(this.piano.emitNoteOff(this.note,"system"),this._down=!1,this.el.classList.remove("pressed"))}setKeymap(e){this.keyHint.innerHTML=e}clearKeymap(){this.keyHint.innerHTML=""}}a.NOTES=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],a.width=45;const o=new CSSStyleSheet;o.replaceSync("\n.piano-wrapper {\n    width: 100%;\n    margin: 0 auto;\n    padding: 1rem 0;\n    background-color: black;\n    border-radius: 10px;\n    display: flex;\n}\n\npiano-keyboard { flex: 1; }\n.octave-button {\n    background-color: transparent;\n    border: none;\n    outline: none;\n    color: #fffc;\n    font-size: 200%;\n    user-select: none;\n}\n.octave-button:hover { color: #fff; }\n.octave-button:active { color: rgb(121, 216, 245); }\n");function r(e,t=0){const s=parseInt(e);return isNaN(s)?t:s}function h(e,t=0){const s=parseFloat(e);return isNaN(s)?t:s}function c(e,t=""){return e?e.toString():t}function l(e){return Math.max(0,Math.pow(10,e/20))}function u(e){return 20*Math.log(e)/Math.LN10}function d(e){return Math.pow(10,e/20)/1.78}function p(e){return 20*Math.log(1.78*e)/Math.LN10}function m(e){return l(p(e))}function f(e,t,s){return Math.max(t,Math.min(s,e))}class g{get bpm(){return this._bpm}set bpm(e){this.setTempo(e)}get meter(){return this._meter}set meter(e){this.setTimeSignature(e)}get beatsPerMeasure(){return this._beatsPerMeasure}get beatValue(){return this._beatValue}get key(){return this._key}set key(e){this._key=e}get contextTime(){return this.context.currentTime}get time(){return this.isPaused?this._start:this.contextTime-this._start}get timeString(){let e=""+Math.floor(this.time/60)%60,t=""+Math.round(this.time)%60,s=""+Math.floor(100*this.time)%100;return 1==e.length&&(e=`0${e}`),1==t.length&&(t=`0${t}`),1==s.length&&(s=`0${s}`),`${e}:${t}.${s}`}get beats(){return this.time*this.bpm/60+this._elapsedBeats}get isPaused(){return 0==this._subscribers.size}static init(){return null==g._instance&&(g._instance=new g),g._instance}constructor(){this._start=0,this._elapsedBeats=0,this._bpm=120,this._meter="4/4",this._beatsPerMeasure=4,this._beatValue=4,this._key="C major",this._subscribers=new Set,this._listeners=new Set,this.context=new AudioContext,this._metronomes=new Set,this._timer=-1}addSubscriber(e){this._listeners.add(e)}removeSubscriber(e){this._listeners.delete(e)}isPlaying(e){return this._subscribers.has(e)}play(e){this.isPaused&&(this._start=this.contextTime-this._start),this._subscribers.add(e),this._listeners.add(e)}pause(e){this._listeners.add(e),this.isPlaying(e)&&(this._subscribers.delete(e),this.isPaused&&(this._start=this.contextTime-this._start))}stopAll(){this._elapsedBeats=0,this._start=0,this._subscribers.clear(),this._listeners.forEach((e=>e.onClockReset()))}setTime(e){this._elapsedBeats=e,this._start=0,this._listeners.forEach((e=>e.onClockTimeChange())),this._subscribers.clear()}setTempo(e){const t=this.beats;e!=this._bpm&&(this._bpm=Math.max(5,e),this._start=this.contextTime-60*t/this._bpm,this._listeners.forEach((e=>e.onTempoChange())))}setTimeSignature(e){2!=e.split("/").length&&(e="4/4"),this._beatsPerMeasure=r(e.split("/")[0],-1),this._beatValue=r(e.split("/")[1],-1),(this._beatsPerMeasure<0||this._beatValue<0)&&(this._beatsPerMeasure=4,this._beatValue=4);const t=`${this._beatsPerMeasure}/${this._beatValue}`;this._meter!=t&&(this._meter=t,this._listeners.forEach((e=>e.onTimeSignatureChange())))}startMetronome(e){if(this._metronomes.add(e),-1==this._timer){const e=this.contextTime;let t=0;this._metronomes.forEach((e=>e.pulse(0))),this._timer=window.setInterval((()=>{if(0==this._metronomes.size)window.clearInterval(this._timer),this._timer=-1;else{const s=60/this.bpm,i=this.contextTime-e,n=Math.floor(i/s)%this.beatsPerMeasure;n!=t&&(t=n,this._metronomes.forEach((e=>e.pulse(t))))}}),30)}}stopMetronome(e){this._metronomes.delete(e)}isMetronomePlaying(e){return this._metronomes.has(e)}}const y=16.3516,b=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],v=["rgb(229, 76, 78)","rgb(223, 132, 74)","rgb(228, 171, 81)","rgb(227, 199, 73)","rgb(223, 228, 78)","rgb(174, 215, 71)","rgb(63, 188, 70)","rgb(63, 169, 180)","rgb(64, 124, 180)","rgb(78, 69, 179)","rgb(141, 69, 183)","rgb(202, 69, 147)"];class _{get note(){return this._note}set note(e){this._note=e}get end(){return this.start+this.duration}get octave(){return Math.floor(this.note/12)}set octave(e){this.note=12*e+this.step}get step(){return this.note%12}set step(e){this.note=12*this.octave+e}get cents(){return Math.round(100*(this.note-Math.floor(this.note)))}get velocity(){return this._velocity}set velocity(e){this._velocity=w(e,0,127)}get gain(){return this.velocity*this.velocity/16129}get name(){return`${b[Math.floor(this.step)]}`}get accidental(){return this.name.substring(1)}get nameWithOctave(){return`${b[Math.round(this.step)]}${this.octave-1}`}get stepColor(){return v[Math.round(this.step)%v.length]}get rate(){return Math.pow(2,this.note/12)}get frequency(){return y*this.rate}set frequency(e){e>0&&(this.note=12*Math.log(e/y)/Math.LN2)}constructor(e){this._note=60,this.start=0,this.duration=1,this._velocity=90,this.note=e}isEqual(e){return this.note===e.note&&this.start===e.start&&this.duration===e.duration&&this.velocity===e.velocity}clone(){let e=new _(this.note);return e.start=this.start,e.duration=this.duration,e.velocity=this.velocity,e}static fromName(e){const t=new _(60);return t.octave=_.nameToOctave(e),t.step=_.nameToStep(e),t}static fromFrequency(e){const t=new _(60);return t.frequency=e,t}static nameToOctave(e){if(2==e.length){let t=e.codePointAt(1);if(t)return w(t-48,0,8)}else if(e.length>2){let t=e.codePointAt(2);if(t)return w(t-48,0,8)}return 0}static nameToStep(e){return null==e||""==e?0:(e=e.length<=2?e[0].toUpperCase():e.substring(0,2).toUpperCase(),Math.max(0,b.indexOf(e)))}static nameToNote(e){if(e.length<2||e.length>3)return-1;e=e.replaceAll("#","♯");for(let t=0;t<12;t++)if(e.startsWith(b[t])){const s=e.substring(b[t].length);if(["0","1","2","3","4","5","6","7","8"].includes(s)){let e=s.codePointAt(0);return 12*((e||48)-48)+t}}return-1}}function w(e,t,s){return Math.max(t,Math.min(s,e))}class k{constructor(e,t){this.released=!1,this.canceled=!1,this.note=e,this.chain=t}}class A{constructor(e,t,s){this.value=1,this.gain=new GainNode(e),this.name=t,this.value=s,this.gain.gain.value=s}connect(e,t){return t==this.name&&(e.level.connect(this.gain),!0)}destroy(){this.gain.disconnect()}updateParameter(e,t){return e==`${this.name}-mod}`&&(this.value=h(t,this.value),this.gain.gain.value=this.value,!0)}}class x{constructor(e,t){this.id=0,this.modulators=new Array,this.connectors=new Array,this.context=e,this.id=parseInt(t.id),this.level=e.createGain();const s=h(t.level,0);this.level.gain?.setValueAtTime(l(s),0),this.level.gain.value=l(s),this.addModulator("gain",h(t["gain-mod"],1),this.level.gain)}connect(e,t){for(let s of this.modulators)if(s.connect(e,t))return;"level"==t?e.level.connect(this.level.gain):e.level.connect(this.level)}addConnector(e){this.connectors.push(e),this.level?.connect(e.level)}addModulator(e,t,s){const i=new A(this.context,e,t);i.gain.connect(s),this.modulators.push(i)}playNote(e){}releaseNote(){}scheduleNote(e,t,s,i){}cancelNotes(){}destroy(){this.level.disconnect(),this.modulators.forEach((e=>e.destroy())),this.connectors.forEach((e=>e.destroy()))}pitchBend(e){}schedulePitchBend(e,t){}updateParameter(e,t){for(let s of this.modulators)if(s.updateParameter(e,t))return;if("level"==e){const e=h(t,0);this.level.gain?.setValueAtTime(l(e),0),this.level.gain.value=l(e)}}updateConnectorLevel(e,t){this.connectors.forEach((s=>{s.id==e&&s.updateLevel(t)}))}attachAnalyzer(e,t,s){for(let i of this.connectors)i.id==e&&i.attachAnalyzer(t,s)}detachAnalyzer(e){this.connectors.forEach((t=>{t.id==e&&t.detachAnalyzer()}))}getFloatTimeDomainData(e,t,s){this.connectors.forEach((i=>{i.id==e&&i.getFloatTimeDomainData(t,s)}))}}class N extends x{constructor(e,t){super(e,t),this.A=.1,this.D=.1,this.S=1,this.R=.2,this.aShape=5,this.dShape=2,this.rShape=2,this.attackCurve=[],this.decayCurve=[],this.releaseCurve=[],this.A=h(t.A,this.A),this.D=h(t.D,this.D),this.S=h(t.S,this.S),this.R=h(t.R,this.R),this.R=Math.max(this.R,.01),this.aShape=h(t["a shape"],this.aShape),this.dShape=h(t["d shape"],this.dShape),this.rShape=h(t["r shape"],this.rShape),this._attack=e.createGain(),this._decay=e.createGain(),this._release=e.createGain(),this._attack.gain.value=0,this._decay.gain.value=1,this._release.gain.value=1,this._attack.connect(this._decay),this._decay.connect(this._release),this._release.connect(this.level),this._buildCurves()}connect(e,t){e.level.connect(this._attack)}playNote(e){let t=this.context.currentTime;try{this._attack.gain?.cancelScheduledValues(0),this._decay.gain?.cancelScheduledValues(0),this._release.gain?.cancelScheduledValues(0),this.A>0?this._attack.gain?.setValueAtTime(0,t):this._attack.gain?.setValueAtTime(1,t),this._decay.gain?.setValueAtTime(1,t),this._release.gain?.setValueAtTime(1,t),t=this.context.currentTime+.01,this.A>0?this._attack.gain?.setValueCurveAtTime(this.attackCurve,t,this.A):this._attack.gain?.setValueAtTime(1,t),this.D>0?this._decay.gain?.setValueCurveAtTime(this.decayCurve,t+this.A,this.D):this._decay.gain?.setValueAtTime(this.S,t+this.A)}catch(e){console.log("Exception in ADSR playNote $x.")}}releaseNote(){const e=this.context.currentTime;this.R>0?(this._attack.gain?.cancelScheduledValues(e),this._decay.gain?.cancelScheduledValues(e),this._release.gain?.setValueCurveAtTime(this.releaseCurve,e,this.R)):this._release.gain?.setValueAtTime(0,e)}scheduleNote(e,t,s,i){const n=t<0?-t:0;let a=(t=t<0?0:t)+this.context.currentTime;if(this.A>0?this._attack.gain?.setValueAtTime(0,a):this._attack.gain?.setValueAtTime(1,a),this._decay.gain?.setValueAtTime(1,a),this._release.gain?.setValueAtTime(1,a),a+=.01,this.A>0&&this.A>n){const e=this.A-n;this._attack.gain?.setValueCurveAtTime(this.attackCurve,a,e)}else this._attack.gain?.setValueAtTime(1,a);if(this.D>0&&this.A+this.D>n&&s>this.A){const e=n>=this.A?this.D-(n-this.A):this.D,t=n>=this.A?a:a+this.A-n;this._decay.gain?.setValueCurveAtTime(this.decayCurve,t,e),this.A+this.D>s&&this._decay.gain?.cancelScheduledValues(a+s-n)}else this._decay.gain?.setValueAtTime(this.S,Math.max(0,a+this.A+this.D-n));if(s+this.R>n){const e=n>=s?this.R-(n-s):this.R;this._release.gain?.setValueCurveAtTime(this.releaseCurve,a+s-n,e)}else this._release.gain?.setValueAtTime(0,a)}cancelNotes(){super.cancelNotes();const e=this.context.currentTime;this._release.gain?.cancelScheduledValues(e),this._release.gain.value=0,this._attack.gain?.cancelScheduledValues(e),this._attack.gain.value=0,this._decay.gain?.cancelScheduledValues(e),this._decay.gain.value=0}destroy(){super.destroy(),this._attack.disconnect(),this._decay.disconnect(),this._release.disconnect()}updateParameter(e,t){switch(super.updateParameter(e,t),e){case"A":this.A=h(t,this.A);break;case"D":this.D=h(t,this.D);break;case"S":this.S=h(t,this.S);break;case"R":this.R=h(t,this.R);break;case"a shape":this.aShape=h(t,this.aShape);break;case"d shape":this.dShape=h(t,this.dShape);break;case"r shape":this.rShape=h(t,this.rShape)}this.R=Math.max(this.R,.01),this._buildCurves()}_buildCurves(){this._buildAttackCurve(this.aShape),this._buildDecayCurve(this.dShape),this._buildReleaseCurve(this.rShape)}_buildAttackCurve(e){e=f(e,.001,8),this.attackCurve=[];const t=Math.ceil(N.samplesPerSecond*this.A);if(t>0)for(let s=0;s<=t;s++){let i=s/t;i=Math.pow(i,e),this.attackCurve.push(i)}}_buildDecayCurve(e){e=f(e,.001,4),this.decayCurve=[];const t=Math.ceil(N.samplesPerSecond*this.D);if(t>0)for(let s=0;s<=t;s++){let i=s/t;i=1-Math.pow(i,e),this.decayCurve.push((1-this.S)*i+this.S)}}_buildReleaseCurve(e){e=f(e,.001,4),this.releaseCurve=[];const t=Math.ceil(N.samplesPerSecond*this.R);if(t>0)for(let s=0;s<=t;s++){let i=s/t;i=1-Math.pow(i,e),this.releaseCurve.push(i)}}}N.samplesPerSecond=300;class E{get context(){return this.source.context}constructor(e,t){this.id=0,this.dB=0,this._pre=null,this._analyzers=new Array,this._splitter=null,this._merger=null,this._buffer=null,this.type="",this.source=e,this.id=r(t.id,-1),this.level=new GainNode(this.context),this.dB=h(t.level,0),this.level.gain?.setValueAtTime(l(this.dB),0),this.type=c(t.type,"")}updateLevel(e){this.dB=e,(this._pre??this.level).gain?.setValueAtTime(l(e),0)}destroy(){this.level.disconnect()}attachAnalyzer(e,t,s=-60,i=5){t=f(t,1,6),this._pre=new GainNode(this.context),this._splitter=this.context.createChannelSplitter(t),this._merger=this.context.createChannelMerger(t),this._pre.gain?.setValueAtTime(l(this.dB),0),this.level.gain?.setValueAtTime(1,0),this.source.level.disconnect(this.level),this.source.level.connect(this._pre),this._pre?.connect(this._splitter),this._merger?.connect(this.level);for(let n=0;n<t;n++){let t=new AnalyserNode(this.level.context);this._analyzers.push(t),t.fftSize=e,t.minDecibels=s,t.maxDecibels=i,this._splitter?.connect(t,n,0),t.connect(this._merger,0,n),0==n&&(this._buffer=new Float32Array(t.frequencyBinCount))}}detachAnalyzer(){if(null!=this._pre){this.level.gain?.setValueAtTime(l(this.dB),0),this.source.level.disconnect(this._pre),this._pre?.disconnect(),this._splitter?.disconnect(),this._merger?.disconnect();for(let e of this._analyzers)e.disconnect();this.source.level.connect(this.level),this._pre=null,this._buffer=null,this._splitter=null,this._merger=null,this._analyzers=[]}}getFloatTimeDomainData(e,t){if(e<this._analyzers.length){const s=this._analyzers[e];if(null!=this._buffer&&t.length==this._buffer.length){s.getFloatTimeDomainData(this._buffer);for(let e=0;e<t.length;e++)t[e]+=this._buffer[e]}}}}class S extends N{constructor(e,t){super(e,t)}}class T{constructor(){}static hasSound(e){return T.sounds.has(e)}static getAudioBuffer(e){return T.sounds.get(e)}static async loadAudioBuffer(e,t){if(T.hasSound(e))return!0;const s=T.supportsAudioType("audio/ogg")?`${e}.ogg`:`${e}.wav`;try{let i=await fetch(s),n=await i.arrayBuffer(),a=await t.decodeAudioData(n);return T.sounds.set(e,a),console.log("Loaded "+s),!0}catch(e){return console.log(e),!1}}static async loadCustomSound(e,t){if(T.hasSound(e))return!0;try{let s=await fetch(e),i=await s.arrayBuffer(),n=await t.decodeAudioData(i);return T.sounds.set(e,n),console.log("Loaded "+e),!0}catch(e){return console.log(e),!1}}static supportsAudioType(e){if(T._supports.has(e))return T._supports.get(e);let t=!1;const s=document.createElement("audio");return s.id="test-audio-node",document.body.append(s),"probably"!=s.canPlayType(e)&&"maybe"!=s.canPlayType(e)||(t=!0,document.querySelector("#test-audio-node")?.remove()),T._supports.set(e,t),t}}T.sounds=new Map,T._supports=new Map;class M extends x{constructor(e,t){super(e,t),this.sources=new Array,this.playback=1,this.detune=0,this.sample_pack="piano",this.samples=new Array,this._rate=1,this.drumkit=!1,this.playback=h(t.playback,this.playback),this.detune=h(t.detune,this.detune),this.sample_pack=c(t["sample-pack"],this.sample_pack),this.dIn=new GainNode(e),this.pIn=new GainNode(e),this.dIn.gain.value=h(t["detune-mod"],1),this.pIn.gain.value=h(t["playback-mod"],1),"samples"in t&&Array.isArray(t.samples)&&this.loadSamplePack(t.samples)}loadSamplePack(e){this.samples=e.filter((e=>{return"object"==typeof(t=e)&&"sample"in t&&"string"==typeof t.sample&&"step"in t&&"number"==typeof t.step;var t})).sort(((e,t)=>e.step-t.step)),this.samples.forEach((e=>T.loadAudioBuffer(e.sample,this.context)))}playNote(e){this.scheduleNote(e,0,0,0)}findBestSample(e){let t;if(this.drumkit)t=this.samples.find((t=>t.step===Math.round(e.note)));else{let s=1e5;for(const i of this.samples){if(i.step==e.note)return i;if(i.step>e.note){return i.step-e.note+3<s?i:t}{const n=e.note-i.step;n<s&&(t=i,s=n)}}}}scheduleNote(e,t,s,i){const n=t<0?-t:0;t=Math.max(0,t);const a=this.findBestSample(e);if(a){const o=T.getAudioBuffer(a.sample);if(o){const r=e.note-a.step,h=this.context.currentTime,c=Math.pow(2,r/12),l=new AudioBufferSourceNode(this.context);l.connect(this.level),this.sources.push(l),this.dIn.connect(l.detune),this.pIn.connect(l.playbackRate),l.buffer=o,l.playbackRate.value=c*this.playback,l.start(t+h,n),s>0&&l.stop(t+h+s+i),l.addEventListener("ended",(e=>{this.sources=this.sources.filter((e=>e!==l)),l.disconnect()})),o.duration,this.playback,this._rate=c}}}cancelNotes(){super.cancelNotes(),this.sources.forEach((e=>{e.stop(),e.disconnect()})),this.sources=new Array,this._rate=1}destroy(){super.destroy(),this.sources.forEach((e=>{e.stop(),e.disconnect()})),this.sources=new Array,this._rate=1}pitchBend(e){const t=this.context.currentTime;this.sources.forEach((s=>{s.detune?.setTargetAtTime(this.detune+e,t,.1)}))}schedulePitchBend(e,t){if(this.sources.length>0){const s=this.sources[this.sources.length-1];t.apply(s.detune,e,this.context,this.detune)}}connect(e,t){"detune"==t?e.level.connect(this.dIn):"playback"==t&&e.level.connect(this.pIn)}updateParameter(e,t){"playback"==e?(this.playback=h(t,this.playback),this.sources.forEach((e=>{e.playbackRate?.setValueAtTime(this._rate*this.playback,this.context.currentTime)}))):"detune"==e?(this.detune=h(t,this.detune),this.sources.forEach((e=>{e.detune?.setValueAtTime(this.detune,this.context.currentTime)}))):"sample-pack"==e||("playback-mod"==e?this.pIn.gain.value=h(t,1):"detune-mod"==e?this.dIn.gain.value=h(t,1):super.updateParameter(e,t))}}class C{constructor(e){this.id=0,this.free=0,this.nodes=new Map,this.out=null,this.release=0,this.gates=new Array,this.context=e,this.id=C._CHAIN_ID++,this.loadPatch(C._sine_patch)}playNote(e,t){const s=t.context.currentTime;this.free=31536e3,this.disconnect();const i=new GainNode(t.context);i.connect(t),i.gain.value=e.gain,i.gain.setValueAtTime(e.gain,s),this.out?.level.connect(i),this.gates.push({free:this.free,node:i}),this.nodes.forEach(((t,s,i)=>t.playNote(e)))}releaseNote(){this.nodes.forEach(((e,t,s)=>e.releaseNote()))}scheduleNote(e,t,s,i){const n=i.context.currentTime;this.free=n+t+s+this.release+.05;const a=new GainNode(i.context);a.connect(i),a.gain.value=0,a.gain?.setValueAtTime(0,0),a.gain?.setValueAtTime(e.gain,Math.max(n,n+t)),a.gain?.setValueAtTime(0,Math.max(n,n+t+s+this.release)),this.out?.level.connect(a),this.gates.push({free:this.free,node:a});try{this.nodes.forEach(((i,n,a)=>{i.scheduleNote(e,t,s,this.release)}))}catch(e){console.log("Note scheduling exception: $x")}for(let e=0;e<this.gates.length;e++)this.gates[e].free<n&&(this.gates[e].node?.disconnect(),this.out?.level.disconnect(this.gates[e].node),delete this.gates[e]);return this.gates=this.gates.filter((e=>void 0!==e)),this.release}disconnect(){this.out?.level.disconnect(),this.gates.forEach((e=>{e.node?.disconnect()})),this.gates=[]}cancelNotes(){this.disconnect(),this.nodes.forEach((e=>e.cancelNotes())),this.free=0}destroy(){this.disconnect(),this.nodes.forEach((e=>e.destroy())),this.nodes.clear()}pitchBend(e){this.nodes.forEach((t=>t.pitchBend(e)))}schedulePitchBend(e,t){this.nodes.forEach((s=>s.schedulePitchBend(e,t)))}loadPatch(e){if(this.nodes.clear(),this.out=null,this.release=0,Array.isArray(e.nodes))for(let t of e.nodes){let e=this.createSynthNode(this.context,t);e instanceof S&&(this.out=e),this.nodes.set(e.id,e)}this._updateReleaseValue();for(let t of e.routing){let e=this.nodes.get(t.source),s=this.nodes.get(t.dest);if(e&&s){let i=new E(e,t);e.addConnector(i),s.connect(i,c(t.type,""))}}}createSynthNode(e,t){switch(t.type){case"gain":return new x(e,t);case"adsr":return new N(e,t);case"out":return new S(e,t);case"sample":return new M(e,t);default:return console.log(`Node not found: ${t.type}`),new x(e,t)}}getNodeById(e){return this.nodes.get(e)}updateParameter(e,t,s){let i=this.nodes.get(e);i?.updateParameter(t,s),this._updateReleaseValue()}updateConnectorLevel(e,t,s){let i=this.nodes.get(e);i?.updateConnectorLevel(t,s)}attachAnalyzer(e,t,s,i){let n=this.nodes.get(e);n?.attachAnalyzer(t,s,i)}detachAnalyzer(e,t){let s=this.nodes.get(e);s?.detachAnalyzer(t)}getFloatTimeDomainData(e,t,s,i){let n=this.nodes.get(e);n?.getFloatTimeDomainData(t,s,i)}_updateReleaseValue(){this.release=0,this.nodes.forEach((e=>{e instanceof N&&(this.release=Math.max(Math.max(e.A+e.D,e.R),this.release))}))}}C._CHAIN_ID=0,C._sine_patch={nodes:[{type:"out",A:.1,D:.1,S:.8,R:.15,id:0},{type:"osc",waveform:"sine",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"out"}]},C._custom_patch={nodes:[{type:"out",id:0,A:0,D:.1,S:1,R:.3,level:0},{type:"sample","sample-pack":"custom",samples:[{sample:"<SOUNDURL>",step:60}],id:1,level:0}],routing:[{id:2,source:1,dest:0,type:"audio",level:0}]};const L={start:0,beats:0,values:[]};class O{constructor(e,t){this.params=new Array,this.start=0,this.beats=-1,this.free=-1,this.id=O._EFFECT_ID++,this.name=e,this.oparams=t,this.start=Math.max(0,t.start),this.beats=t.beats,this.free=-1;for(const e of t.values){const t=Array();if(Array.isArray(e))for(const s of e)t.push(s);else"number"==typeof e&&t.push(e);this.params.push(t)}}static createEffect(e,t){return new P(t)}connect(e,t,s){return this.free=(s+this.start+this.beats+.1)*(60/t)+e.context.currentTime,this.node.connect(e),this.node}disconnect(){this.node.disconnect()}afterEffect(e,t,s,i,n){}clampParam(e,t,s){for(let i=0;i<e.length;i++)e[i]=f(e[i],t,s)}}O._EFFECT_ID=0;class P extends O{get node(){return this._node}constructor(e){super("empty",L),this._node=new GainNode(e)}}class D{constructor(){this.trace=new Array,this._beats=0,this._playhead=0,this._minNote=-1,this._maxNote=-1,this._noteCount=0}get length(){return this.trace.length}get isEmpty(){return 0===this.length}get beats(){return this._beats}get minNote(){return this._minNote}get minOctave(){return Math.max(0,Math.floor(this._minNote/12))}get maxNote(){return this._maxNote}get maxOctave(){return Math.max(0,Math.floor(this._minNote/12))}get noteRange(){return this.maxNote-this.minNote}get octaveRange(){return this.maxOctave-this.minOctave}get noteCount(){return this._noteCount}clear(){this.trace=[],this._beats=0,this._minNote=-1,this._maxNote=-1,this._noteCount=0,this._playhead=0}fromPython(e){for(let t of e)this.addTraceEvent(t)}getMessages(){return this.trace.filter((e=>"message"===e.command)).map((e=>Object.fromEntries(e.params)))}isEquivalent(e){if(this.length!==e.length)return!1;for(let t=0;t<this.length;t++)if(!this.trace[t].isEquivalent(e.trace[t]))return!1;return!0}addTraceEvent(e){this._addTraceEvent(V.fromMap(e))}_addTraceEvent(e){switch(this.trace.push(e),e.command){case V.PLAY:this._beats=Math.max(e.end,this._beats),this._playhead=e.end,(this._minNote<0||e.note.note<this._minNote)&&(this._minNote=e.note.note),this._maxNote=Math.max(this._maxNote,e.note.note),this._noteCount++;break;case V.SOUND:this._beats=Math.max(e.end,this._beats),this._playhead=e.end,this._noteCount++;break;case V.REST:this._beats=Math.max(e.end,this._beats),this._playhead=e.end}}getTraceGroup(e){return this.trace.filter((t=>t.trace_group===e))}}class V{get end(){return this.time+this.duration}constructor(e,t){this.time=0,this.duration=1,this.line=-1,this.note=new _(60),this.trace_group=-1,this.params=new Map,this.id=V._TRACE_ID++,this.command=e,this.time=t}clone(){let e=new V(this.command,this.time);e.line=this.line,e.duration=this.duration,e.note=this.note.clone();for(let[t,s]of this.params)e.params.set(t,s);return e}static fromMap(e){let t=new V(String(e.get("command")),Math.max(0,Number(e.get("time"))));t.duration=Number(e.get("duration")),t.note.duration=t.duration;for(let[s,i]of e)if("note"===s&&"number"==typeof i)t.note.note=i;else if("pitch"===s&&"number"==typeof i)t.note.note=i+60;else if("velocity"===s&&"number"==typeof i)t.note.velocity=i;else if("sustain"===s&&"number"==typeof i)t.note.duration=Math.max(t.note.duration,i),t.duration=t.note.duration;else if("line"===s&&"number"==typeof i)t.line=i;else if("trace"===s)t.trace_group=i;else{if(["command","time","duration"].includes(s))continue;t.params.set(s,i)}return t}isEquivalent(e){if(this.command===e.command&&this.time===e.time&&this.duration===e.duration&&this.note.isEqual(e.note)){for(let[t,s]of this.params)if("line"!==t&&e.params.get(t)!==s)return!1;return!0}return!1}}V.PLAY="play",V.SOUND="sound",V.REST="rest",V.PUSH_FX="push_fx",V.POP_FX="pop_fx",V.MESSAGE="message",V._TRACE_ID=0;class R{get bpm(){return this._bpm}set bpm(e){this._bpm=f(e,5,300)}get isPlaying(){for(const e of this.bank)if(e.free>0)return!0;return!1}constructor(){this._bpm=90,this.notes=new Array,this.patch={name:"piano",nodes:new Array,routing:new Array},this.voice="simple sine",this.bank=new Array,this.sound_gens=new Array,this.parameters=new Array,this._analyzer=null,this._analyzers=new Map,this._effects=new Array}playNote(e,t){let s=this._allocateGenerator(t.context,t.context.currentTime);if(null==s)return null;s.cancelNotes(),s.playNote(e,t);const i=new k(e,s);return this.notes.push(i),i}scheduleNote(e,t,s,i=0){const n=t.context.currentTime,a=e.duration*(60/this.bpm);s=(s+i)*(60/this.bpm);const o=this._allocateGenerator(t.context,n+s);return o?.scheduleNote(e,s,a,t),o}release(e){if(e.released)return;e.released=!0,e.chain.releaseNote();const t=Math.ceil(1e3*e.chain.release)+100;setTimeout((()=>{this.notes=this.notes.filter((t=>t!==e)),e.chain.disconnect(),this._releaseGenerator(e.chain)}),t)}releaseNote(e){this.notes.forEach((t=>{t.note.note==e.note&&this.release(t)}))}releaseAll(){this.notes.forEach((e=>{this.release(e)}))}cancelAllNotes(){for(const e of this.bank)this._releaseGenerator(e);for(const e of this.sound_gens)e.cancelNotes();this.sound_gens=[]}scheduleNotes(e,t,s){const i=t.context.currentTime,n=Math.max(0,-s);for(let e=0;e<this._effects.length;e++){const t=this._effects[e];t.free>0&&t.free<i&&(t.disconnect(),delete this._effects[e])}this._effects=this._effects.filter((e=>void 0!==e));for(let e=0;e<this.sound_gens.length;e++){this.sound_gens[e].free<i&&delete this.sound_gens[e]}this.sound_gens=this.sound_gens.filter((e=>void 0!==e));const a=new Array,o=new P(t.context);o.beats=e.beats,a.push(o),this._effects.push(o),o.connect(t,this.bpm,s);for(const i of e.trace)if(i.command==V.PUSH_FX){const e=a[a.length-1],n=O.createEffect(i,t.context);n.connect(e.node,this.bpm,s),a.push(n),this._effects.push(n)}else if(i.command==V.POP_FX);else if(i.command==V.PLAY&&i.end>=n){const e=a[a.length-1],t=this.scheduleNote(i.note,e.node,i.time,s);a.forEach((e=>{e.afterEffect(t,i.time,i.note.duration,this.bpm,s)}))}}pitchBend(e){this.notes.forEach((t=>t.chain.pitchBend(e)))}async loadPatch(e,t){try{let i=await fetch(e),n=await i.json();if("string"==typeof(s=n).name&&"2.0"===s.version&&"tunepad-patch"===s.format&&Array.isArray(s.nodes)&&Array.isArray(s.routing)){const s=e.split("/").slice(0,-1).join("/")+"/";this.voice=n.name,this.patch=n,this.parameters=[],this._destroyAllGenerators(),this.sound_gens=[];for(const e of this.patch.nodes)if("sample"===e.type&&Array.isArray(e.samples)){for(const i of e.samples)if(null!=i.sample){const e=s+i.sample;i.sample=e,await T.loadAudioBuffer(e,t)}}else"reverb"===e.type?await T.loadCustomSound(e.impulse,t):"buffer source"===e.type&&await T.loadCustomSound(e.buffer,t);return!0}}catch(e){console.log("Failed to load audio patch.",e)}finally{return!1}var s}getNodeById(e){return this.bank.length>0?this.bank[0]?.getNodeById(e):void 0}updateParameter(e,t,s){this.bank.forEach((i=>{i.updateParameter(e,t,s)}));for(const i of this.patch.nodes)i.id==e&&(i[t]=s)}_allocateGenerator(e,t){this.bank.length>0&&this.bank[0].context!=e&&this._destroyAllGenerators();for(const s of this.bank)if(s.free<t&&s.context==e)return this._analyzers.forEach((e=>{0==s.free&&s.attachAnalyzer(e.nodeId,e.connectorId,e.fftSize,e.channels)})),s;if(this.bank.length<R.MAX_GENERATORS){const t=new C(e);return t.loadPatch(this.patch),this.bank.push(t),this._analyzers.forEach((e=>{t.attachAnalyzer(e.nodeId,e.connectorId,e.fftSize,e.channels)})),t}}_releaseGenerator(e){e.cancelNotes(),this._analyzers.forEach((t=>{e.detachAnalyzer(t.nodeId,t.connectorId)}))}_destroyAllGenerators(){this.bank.forEach((e=>{e.destroy()})),this.bank=[]}}R.MAX_GENERATORS=24;class B extends HTMLElement{constructor(){super(),this.synth=new R,this.octave=3,this.minOctave=0,this.maxOctave=7,this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(o);const e=document.createElement("template");e.innerHTML='<div class="piano-wrapper">\n    <button id="down-octave" class="octave-button" title="Lower Octave">❮</button>\n    <piano-keyboard note-hints="true" midi-hints="true" armed="true" max-octave="8" min-octave="1" focus-octave="3" key-range="14"></piano-keyboard>\n    <button id="up-octave" class="octave-button" title="Higher Octave">❯</button>\n</div>',this.root.appendChild(e.content.cloneNode(!0)),this.keyboard=this.root.querySelector("piano-keyboard"),this.audio=g.init()}connectedCallback(){this.audio=g.init(),this.keyboard.addEventListener("note-on",(e=>{const t=new _(e.detail.note);this.synth.playNote(t,this.audio.context.destination)})),this.keyboard.addEventListener("note-off",(e=>{const t=new _(e.detail.note);this.synth.releaseNote(t)})),this.root.querySelector("#down-octave")?.addEventListener("click",(e=>{this.octave=Math.max(this.minOctave,this.octave-1),this.root.querySelector("piano-keyboard")?.setAttribute("focus-octave",`${this.octave}`)})),this.root.querySelector("#up-octave")?.addEventListener("click",(e=>{this.octave=Math.min(this.maxOctave,this.octave+1),this.root.querySelector("piano-keyboard")?.setAttribute("focus-octave",`${this.octave}`)}))}disconnectedCallback(){}attributeChangedCallback(e,t,s){"patch"===e&&s!==t?this.synth.loadPatch(s,this.audio.context):s!==t&&this.keyboard.setAttribute(e,s),"focus-octave"===e?this.octave=parseInt(s):"min-octave"===e?this.minOctave=parseInt(s):"max-octave"===e&&(this.maxOctave=parseInt(s)),this.octave=isNaN(this.octave)?3:this.octave,this.minOctave=isNaN(this.minOctave)?0:this.minOctave,this.maxOctave=isNaN(this.maxOctave)?7:this.maxOctave}}B.ELEMENT="piano-instrument",B.observedAttributes=[...n.observedAttributes,"patch"];const H=new CSSStyleSheet;H.replaceSync(".explore-wrapper {\n    width: 95%;\n    margin: 2rem auto;\n    padding: 1rem 0;\n    border-radius: 20px;\n    display: flex;\n    flex-direction: column;\n}\n#code-hint {\n    margin: 0rem 0.25rem 0 0;\n    padding: 0 1rem;\n    background: #0002;\n    height: 35px;\n    line-height: 35px;\n    border: 1px solid #887;\n    border-radius: 5px;\n    user-select: none;\n    box-sizing: border-box;\n    flex: 1;\n}\n.shelf {\n    display: flex;\n    margin: 1rem 4.5rem;\n}\n.keyboard-wrapper {\n    display: flex;\n}\n#copy-button {\n    color: #000a;\n    outline: none;\n    border: 1px solid #555;\n    height: 35px;\n    background-color: transparent;\n    border-radius: 5px;\n    font-weight: 500;\n    user-select: none;\n}\n#copy-button:hover { color: black; }\n#copy-button:active { color: rgb(45, 113, 134); }\npiano-instrument { flex: 1; }\n");class I extends HTMLElement{constructor(){super(),this.notes=new Set,this.chord=new Array,this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(H);const e=document.createElement("template");e.innerHTML='<div class="explore-wrapper">\n    <div class="keyboard-wrapper">\n        <piano-instrument></piano-instrument> \n    </div>\n    <div class="shelf">\n        <pre id="code-hint"></pre>\n        <button id="copy-button" title="Copy Code">Copy to Clipboard</button>\n    </div>\n</div>',this.root.appendChild(e.content.cloneNode(!0))}connectedCallback(){const e=this.root.querySelector("piano-instrument");e?.addEventListener("note-on",(e=>{const t=new _(e.detail.note);this.addCodeHint(t)})),e?.addEventListener("note-off",(e=>{const t=new _(e.detail.note);this.removeCodeHint(t)})),e?.addEventListener("click",(e=>{const t=document.querySelector("#code-hint");t&&navigator.clipboard.writeText(t.innerHTML)}))}disconnectedCallback(){}attributeChangedCallback(e,t,s){s!==t&&this.root.querySelector("piano-instrument")?.setAttribute(e,s)}getCodeHint(){if(1===this.chord.length){const e=new _(this.chord[0]);return`playNote(${e.note})    # ${e.nameWithOctave}`}return this.chord.length>0?`playNote([ ${this.chord.join(", ")} ])`:""}addCodeHint(e){this.notes.add(e.note),this.chord=[...this.notes].sort();const t=this.root.getElementById("code-hint");t&&(t.innerHTML=this.getCodeHint())}removeCodeHint(e){this.notes.delete(e.note),0==this.notes.size&&(this.chord=[])}}I.ELEMENT="note-explorer",I.observedAttributes=B.observedAttributes;class ${static init(){return null===$.instance&&($.instance=new $),$.instance}constructor(){this.queue=new Array,this.cache=new Map,this.modules=new Map,this.active=null,this.warnings=new Array,this.worker=new Worker("/jslib/PythonWorker.js"),setTimeout((()=>{$.instance?.processQueue()}),50),this.worker.onmessage=e=>{const t=e.data,s=this.active;if(s&&s.uuid===t.uuid){for(let e of this.queue)if(e.uuid===s.uuid&&e.action===s.action&&e.code!==s.code)return void(this.active=null);let e=new q(s);e.output=t.output,e.globals=t.globals,e.errors=t.errors,e.dependencies=t.dependencies,this.warnings=this.warnings.filter((t=>t.target!==e.uuid&&t.source!==e.uuid));for(const[t,s]of this.cache)t!==e.uuid&&s.dependencies.includes(e.name)&&this.warnings.push({name:"Dependency Warning",message:`Cell '${e.name}' has been updated.`,details:"",line:-1,target:s.uuid,source:e.uuid});for(let[t,s]of this.cache)if(t!==e.uuid)for(let i of s.dependencies){let n=i===e.name;for(let[e,s]of this.cache)t!==e&&s.name===i&&(n=!0);n||this.warnings.push({name:"Dependency Warning",message:`Cell '${i}' does not exist.`,details:"",line:-1,target:s.uuid,source:e.uuid})}e.globals.has("__tunepad_trace")&&e.trace.fromPython(e.globals.get("__tunepad_trace").value),e.hasNoErrors()&&this.cache.set(e.uuid,e),s.callback(e)}this.active=null}}static destroy(){if($.instance){const e=$.instance;e.worker.terminate(),e.active=null,e.cache.clear(),e.modules.clear()}}static compile(e,t=!1){return new Promise((s=>{$.instance?.queue.push(new K(e,"compile",s,t))}))}static run(e){return new Promise((t=>{$.instance?.queue.push(new K(e,"run",t))}))}static preload(e){const t=$.instance;return new Promise((async s=>{for(const s of e)t?.queue.push(new K(s,"preload",(e=>{console.log("preload response for "+e.name)})));s(!0)}))}static _timeout(e){return new Promise((t=>setTimeout(t,e)))}static playCell(e){$.instance?.worker.postMessage({...e,action:"play"})}static pauseCell(e){$.instance?.worker.postMessage({...e,action:"pause"})}static deleteCell(e){const t=$.instance;if(t){t.modules.delete(e.uuid),t.cache.delete(e.uuid),t.worker.postMessage({...e,action:"delete"});for(const[s,i]of t.cache)s!==e.uuid&&i.dependencies.includes(e.name)&&t.warnings.push({name:"Dependency Warning",message:`Cell '${e.name}' was deleted.`,details:"",line:-1,target:s,source:e.uuid})}}static getWarnings(){return $.instance?.warnings}equivalentCode(e,t){function s(e){return e.split("\n").filter((e=>""!==e&&!e.startsWith("#"))).join("\n")}return s(e)===s(t)}equivalent(e,t){return!e.force&&e.name===t.name&&e.action===t.action&&this.equivalentCode(e.code,t.code)}async processQueue(){if(this.queue.length>0&&null===this.active){let e=this.queue.shift();this.modules.set(e.uuid,e.cell);let t=this.cache.get(e.uuid);t&&t.code&&this.equivalent(e,t)?e.callback(t):(this.active=e,this.removeFromCache(e.uuid),this.worker.postMessage({uuid:e.uuid,name:e.name,action:e.action,code:e.code}))}setTimeout((()=>{$.instance?.processQueue()}),50)}removeFromCache(e){this.cache.get(e)?.close(),this.cache.delete(e)}static makePythonSafe(e,t){let s="";for(const t of e){let e=t.charCodeAt(0);e>=48&&e<=57||e>=97&&e<=199||e>=65&&e<=90||95===e?s+=t:32===e&&(s+="_")}""===s&&(s="new_cell"),s.charCodeAt(0)>=48&&s.charCodeAt(0)<=57&&(s="_"+s),z.includes(s)&&(s="_"+s);let i=s,n=2;for(;$.instance?.duplicateName(s,t);)s=i+"_"+n,n++;return s}duplicateName(e,t){for(const[s,i]of this.modules)if(t!==s&&i.name===e)return!0;return!1}}$.instance=null;class K{constructor(e,t,s,i=!1){this.force=!1,this.cell=e,this.action=t,this.callback=s,this.force=i}get uuid(){return this.cell.uuid}get name(){return this.cell.name}get code(){return this.cell.code}}class q{constructor(e){this.output=[],this.trace=new D,this.errors=[],this.dependencies=[],this.uuid=e.uuid,this.code=e.code,this.name=e.name,this.action=e.action}hasErrors(){return this.errors.length>0}hasNoErrors(){return 0===this.errors.length}close(){}}const z=["and","as","assert","break","class","continue","def","del","elif","else","except","exec","False","finally","for","from","global","if","import","in","is","lambda","None","nonlocal","not","or","pass","raise","return","True","try","while","with","yield"];return customElements.define(n.ELEMENT,n),customElements.define(I.ELEMENT,I),customElements.define(B.ELEMENT,B),e.CompileResponse=q,e.MIDIEvent=i,e.Note=_,e.PythonRuntime=$,e.Synthesizer=R,e.TunePadAudio=g,e.clamp=f,e.dBToGain=l,e.dBToValue=d,e.gainToValue=function(e){return d(u(e))},e.gainTodB=u,e.mix=function(e,t,s){return e+s*(t-e)},e.toBool=function(e,t=!1){if(null==e)return t;if("boolean"==typeof e)return e;{const t=e.toString().toLowerCase();if("true"===t||"t"===t)return!0;if("false"===t||"f"===t)return!1}return t},e.toDateTime=function(e){return Date.parse(e)},e.toInt=r,e.toNum=h,e.toStr=c,e.valueToGain=m,e.valueTodB=p,e.veloctyToGain=function(e){return m(e/127)},e}({});
//# sourceMappingURL=tunepad.min.js.map
