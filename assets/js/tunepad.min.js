var tunepad=function(e,t){"use strict";const s=new CSSStyleSheet;s.replaceSync("/*\n@keyframes fade-out {\n    0% {\n        opacity: 1.0;\n    }\n\n    100% {\n        opacity: 0.0;\n    }\n}\n*/\n.instrument {\n    position: relative;\n    box-sizing: border-box;\n    display: flex;\n}\n\n.backdrop {\n    fill: #30303f;\n}\n\n.container {\n    width: 100%;\n}\n\n.piano-key.black {\n    fill: #1d1e1f;\n    stroke: #222;\n    stroke-width: 1.5;\n    rx: 1.5;\n}\n\n.piano-key.black .black-top {\n    fill: #444;\n}\n\n.piano-key.black:hover .black-top {\n    fill: #777;\n}\n\n.piano-key.black.pressed .black-top {\n    fill: #222;\n}\n\n.piano-key.white {\n    fill: #ecedee;\n    stroke: #f7f7f8;\n    stroke-width: 1.5;\n    rx: 1.4;\n}\n\n.piano-key.white:hover {\n    fill: #ccc;\n}\n\n.piano-key.white.pressed {\n    fill: #aaa;\n    stroke: #777;\n}\n/*\n.piano-key.white.pressed.step-0 { fill: rgb(229, 76, 78); }\n.piano-key.white.pressed.step-2 { fill: rgb(228, 171, 81); }\n.piano-key.white.pressed.step-4 { fill: rgb(223, 228, 78); }\n.piano-key.white.pressed.step-5 { fill: rgb(174, 215, 71); }\n.piano-key.white.pressed.step-7 { fill: rgb(63, 169, 180); }\n.piano-key.white.pressed.step-9 { fill: rgb(78, 69, 179); }\n.piano-key.white.pressed.step-11 { fill: rgb(202, 69, 147); }\n*/\n.note-hint,\n.midi-hint,\n.key-hint {\n    stroke: none;\n    font: 9pt sans-serif;\n    fill: #0006;\n    text-anchor: middle;\n    opacity: 0.0;\n    pointer-events: none;\n    user-select: none;\n}\n\n.midi-hint.black, .note-hint.black, .key-hint.black {\n    fill: #ccc;\n}\n.show {\n    opacity: 1.0;\n}\n\n.note-hint.always-show {\n    opacity: 1.0;\n}\n\n.felt {\n    fill: #a00;\n}\n\n.animated-slide {\n    transition: transform 0.5s ease-in-out;\n}\n\n.mini-piano {\n    opacity: 0.0;\n    transition: opacity 0.25s;\n}\n\n.mini-piano.show {\n    opacity: 1.0;\n}\n");const i={note:0,velocity:90,message:"note-on",source:"pointer"};class n{get customEvent(){return new CustomEvent(this.props.message,{bubbles:!0,composed:!0,detail:this.props})}constructor(e){this.props={...i,...e,time:Date.now()}}}class a{static init(){a.instance||(a.instance=new a)}static get ready(){return a.init(),void 0!==a.instance?.access}static get outputs(){return a.init(),a.instance?a.instance._outputs:void 0}get _outputs(){return this.access?this.access.outputs:void 0}static get inputs(){return a.init(),a.instance?a.instance._inputs:void 0}get _inputs(){return this.access?this.access.inputs:void 0}constructor(){navigator.requestMIDIAccess().then((e=>{this.access=e,console.log("Connected to MIDI."),e.addEventListener("statechange",(e=>this._midiConnection(e))),e.outputs.forEach((e=>e.open()))}),(()=>{console.log("Failed to initialize web MIDI.")}))}_midiConnection(e){const t=e.port;t&&("input"==t.type&&"connected"==t.state?t.onmidimessage=this._midiEvent:"output"==t.type&&"connected"==t.state&&t.open())}_midiEvent(e){if(e.data&&e.data.length>=2){let t=e.data[0]>>4,s=15&e.data[0],i=e.data[1],n=0;e.data.length>=3&&(n=e.data[2]),console.log(t,s,i,n)}}}class o extends HTMLElement{get minKey(){return 12*this.props.minOctave+12}get maxKey(){return 12*this.props.maxOctave+23}constructor(){super(),this.props={noteHints:!0,midiHints:!0,armed:!1,minOctave:0,maxOctave:7,keyRange:24,focusOctave:2},this.container=null,this.parent=document.createElementNS("http://www.w3.org/2000/svg","g"),this.allKeys=document.createElementNS("http://www.w3.org/2000/svg","g"),this.keys=[],this.width=700,this.height=190,this.key_map="awsedftgyhujkolp;']",this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(s)}connectedCallback(){const e=document.createElement("template");e.innerHTML='<div class="instrument"><svg class="container" version="1.1"></svg></div>',this.root.appendChild(e.content.cloneNode(!0)),this.container=this.root.querySelector("svg.container"),this.container?.append(this.parent),this.container?.setAttribute("viewBox",`0 0 ${this.props.keyRange*r.width} 190`),this.render(),document.addEventListener("keydown",(e=>this.onKeyDown(e))),document.addEventListener("keyup",(e=>this.onKeyUp(e)))}disconnectedCallback(){}attributeChangedCallback(e,t,s){switch(e){case"note-hints":this.setNoteHints("false"!=s);break;case"midi-hints":this.setMidiHints("false"!=s);break;case"armed":"false"==s?this.disarmKeyboard():this.armKeyboard();break;case"key-range":this.setKeyRange(parseInt(s));break;case"min-octave":this.setMinOctave(parseInt(s));break;case"max-octave":this.setMaxOctave(parseInt(s));break;case"focus-octave":this.setFocusOctave(parseInt(s))}}emitNoteOn(e,t,s=90){const i=new n({note:e,source:t,velocity:s,message:"note-on"});this.root.host.dispatchEvent(i.customEvent)}emitNoteOff(e,t){const s=new n({note:e,source:t,velocity:0,message:"note-off"});this.root.host.dispatchEvent(s.customEvent)}emitPitchBend(e,t){const s=new n({value:e,source:t,message:"pitch-bend"});this.root.host.dispatchEvent(s.customEvent)}noteOn(e,t=90){let s=this._noteToKey(e);s?.press()}noteOff(e){let t=this._noteToKey(e);t?.release()}allNotesOff(){this.keys.forEach((e=>e.release()))}isNoteOn(e){let t=this._noteToKey(e);return null!=t&&t.isPressed()}setKeyRange(e){isNaN(e)||(this.props.keyRange=Math.max(7,Math.min(e,56)),this.container?.setAttribute("viewBox",`0 0 ${this.props.keyRange*r.width} 190`))}setMinOctave(e){isNaN(e)||(e=Math.max(0,Math.min(6,e)))!=this.props.minOctave&&(this.props.minOctave=e,this.render())}setMaxOctave(e){isNaN(e)||(e=Math.max(1,Math.min(7,e)))!=this.props.maxOctave&&(this.props.maxOctave=e,this.render())}armKeyboard(){this.props.armed=!0,this.root.querySelectorAll(".key-hint").forEach((e=>{e.classList.add("show")}))}disarmKeyboard(){this.props.armed=!1,this.root.querySelectorAll(".key-hint").forEach((e=>{e.classList.remove("show")}))}get isKeyboardArmed(){return this.props.armed}getArmedKey(e){const t=12*(this.props.focusOctave-this.props.minOctave),s=this.key_map.indexOf(e.toLowerCase());return s>=0&&s+t<this.keys.length?this.keys[s+t]:null}onKeyDown(e){if(!(e.ctrlKey||e.metaKey||e.shiftKey||1==e.repeat)&&this.isKeyboardArmed){const t=this.getArmedKey(e.key.toLowerCase());t?(this.emitNoteOn(t.note,"keyboard"),t.press()):"ArrowLeft"==e.key?this.setFocusOctave(this.props.focusOctave-1):"ArrowRight"==e.key?this.setFocusOctave(this.props.focusOctave+1):"ArrowDown"==e.key?this.emitPitchBend(-200,"keyboard"):"ArrowUp"==e.key&&this.emitPitchBend(200,"keyboard")}}onKeyUp(e){if("ArrowUp"==e.key||"ArrowDown"==e.key)this.emitPitchBend(0,"keyboard");else{const t=this.getArmedKey(e.key.toLowerCase());t&&(this.emitNoteOff(t.note,"keyboard"),t.release())}}_noteToKey(e){const t=Math.round(e-12);return t>=0&&t>=this.keys.length?this.keys[t]:null}render(){if(null==this.container)return;this.parent.innerHTML="",this.keys=[];const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.classList.add("backdrop"),e.setAttribute("width","100%"),e.setAttribute("height","100%"),this.parent.append(e),this.allKeys.classList.add("animated-slide");const t=document.createElementNS("http://www.w3.org/2000/svg","g"),s=document.createElementNS("http://www.w3.org/2000/svg","g");for(let e=this.minKey;e<=this.maxKey;e++){const i=new r(e,this);this.keys.push(i),i.black?s.append(i.el):t.append(i.el)}this.allKeys.append(t),this.allKeys.append(s),this.parent.append(this.allKeys);const i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.classList.add("felt"),i.setAttribute("width","100%"),i.setAttribute("height","1.5"),i.setAttribute("x","0"),i.setAttribute("y","0"),this.parent.append(i),this.setFocusOctave(this.props.focusOctave)}setFocusOctave(e){this.props.focusOctave=Math.max(this.props.minOctave,Math.min(this.props.maxOctave,e));const t=12*(this.props.focusOctave-this.props.minOctave);if(!isNaN(e)&&null!=this.container&&(this.keys.forEach((e=>e.autoRelease())),t>=0&&t<this.keys.length)){const e=this.keys[t].x;this.allKeys.style.transform=`translateX(${-e}px)`,this.keys.forEach((e=>e.clearKeymap()));for(let e=0;e<this.key_map.length;e++){const s=t+e;s>=0&&s<this.keys.length&&this.keys[s].setKeymap(this.key_map[e])}}}setNoteHints(e){this.props.noteHints=e,this.root.querySelectorAll(".note-hint").forEach((t=>{t.classList.toggle("show",e)}))}get showNoteHints(){return this.props.noteHints}setMidiHints(e){this.props.midiHints=e,this.root.querySelectorAll(".midi-hint").forEach((t=>{t.classList.toggle("show",e)}))}get showMidiHints(){return this.props.midiHints}}o.observedAttributes=["note-hints","midi-hints","armed","min-octave","max-octave","key-range","focus-octave"],o.ELEMENT="piano-keyboard";class r{get step(){return this.note%12}get octave(){return Math.floor(this.note/12)-1}get name(){return`${r.NOTES[this.step]}`}get offset(){return 7*(this.octave-this.piano.props.minOctave)+this._key_offsets[this.step]}get x(){return this.offset*r.width}get black(){return[1,3,6,8,10].includes(this.step)}get white(){return!this.black}get height(){return this.black?130:195}constructor(e,t){this.keyHint=document.createElementNS("http://www.w3.org/2000/svg","text"),this._key_offsets=[0,.45,1,1.55,2,3,3.4,4,4.5,5,5.6,6],this._hint_offsets=[-8,0,0,0,8,-8,0,0,0,0,0,8],this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.rect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._down=!1,this.note=e,this.piano=t,this.el.setAttribute("transform",`translate(${this.x}, 0)`),this.el.classList.add("piano-key",`step-${this.step}`),this.el.classList.add(this.black?"black":"white");const s=this.black?10:1.5;let i=s,n=r.width-2*s;if(this.rect.setAttribute("x",`${i}`),this.rect.setAttribute("y","-8"),this.rect.setAttribute("width",`${n}`),this.rect.setAttribute("height",`${this.height}`),this.rect.setAttribute("rx","3"),this.el.append(this.rect),this.black){i+=3,n-=6;const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.classList.add("black-top"),e.setAttribute("x",`${i}`),e.setAttribute("y","-5"),e.setAttribute("width",`${n}`),e.setAttribute("height",""+(this.height-20)),e.setAttribute("pointer-events","none"),this.el.append(e)}else{const e=document.createElementNS("http://www.w3.org/2000/svg","text");e.classList.add("note-hint"),e.setAttribute("x",`${i+n/2}`),e.setAttribute("y",""+(this.height-17)),e.innerHTML=`${this.name}${this.octave}`,this.piano.showNoteHints&&e.classList.add("show"),0==this.step&&e.classList.add("always-show"),this.el.append(e)}const a=document.createElementNS("http://www.w3.org/2000/svg","text");a.classList.add("midi-hint"),this.black&&a.classList.add("black"),a.setAttribute("x",`${i+n/2}`),a.setAttribute("y",""+(this.height-35)),a.innerHTML=`${this.note}`,this.piano.showMidiHints&&a.classList.add("show"),this.el.append(a);let o=i+n/2+this._hint_offsets[this.step];this.keyHint.classList.add("key-hint"),this.black&&this.keyHint.classList.add("black"),this.keyHint.setAttribute("x",`${o}`),this.keyHint.setAttribute("y",this.black?"45":"60"),this.piano.isKeyboardArmed&&this.keyHint.classList.add("show"),this.el.append(this.keyHint),this.el.addEventListener("pointerdown",(e=>{this.piano.emitNoteOn(this.note,"pointer"),this.press(),e.stopPropagation()})),this.el.addEventListener("pointerup",(e=>{this.piano.emitNoteOff(this.note,"pointer"),this.release()})),this.el.addEventListener("pointerleave",(e=>{this._down&&(this.piano.emitNoteOff(this.note,"pointer"),this.release())})),this.el.addEventListener("pointerenter",(e=>{e.buttons>0&&(this.piano.emitNoteOn(this.note,"pointer"),this.press())}))}press(){this._down=!0,this.el.classList.add("pressed")}release(){this._down&&(this._down=!1,this.el.classList.remove("pressed"))}isPressed(){return this.el.classList.contains("pressed")}autoRelease(){this._down&&(this.piano.emitNoteOff(this.note,"system"),this._down=!1,this.el.classList.remove("pressed"))}setKeymap(e){this.keyHint.innerHTML=e}clearKeymap(){this.keyHint.innerHTML=""}}r.NOTES=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],r.width=45;const h=new CSSStyleSheet;h.replaceSync("\n.piano-wrapper {\n    width: 100%;\n    margin: 0 auto;\n    padding: 1rem 0;\n    background-color: black;\n    border-radius: 10px;\n    display: flex;\n}\n\npiano-keyboard { flex: 1; }\n.octave-button {\n    background-color: transparent;\n    border: none;\n    outline: none;\n    color: #fffc;\n    font-size: 200%;\n    user-select: none;\n}\n.octave-button:hover { color: #fff; }\n.octave-button:active { color: rgb(121, 216, 245); }\n");function c(e,t=0){const s=parseInt(e);return isNaN(s)?t:s}function l(e,t=0){const s=parseFloat(e);return isNaN(s)?t:s}function u(e,t=!1){if(null==e)return t;if("boolean"==typeof e)return e;{const t=e.toString().toLowerCase();if("true"===t||"t"===t)return!0;if("false"===t||"f"===t)return!1}return t}function d(e,t=""){return e?e.toString():t}function p(e){return Math.max(0,Math.pow(10,e/20))}function m(e){return 20*Math.log(e)/Math.LN10}function f(e){return Math.pow(10,e/20)/1.78}function g(e){return 20*Math.log(1.78*e)/Math.LN10}function b(e){return p(g(e))}function y(e,t,s){return Math.max(t,Math.min(s,e))}class v{get bpm(){return this._bpm}set bpm(e){this.setTempo(e)}get meter(){return this._meter}set meter(e){this.setTimeSignature(e)}get beatsPerMeasure(){return this._beatsPerMeasure}get beatValue(){return this._beatValue}get key(){return this._key}set key(e){this._key=e}get contextTime(){return this.context.currentTime}get time(){return this.isPaused?this._start:this.contextTime-this._start}get timeString(){let e=""+Math.floor(this.time/60)%60,t=""+Math.round(this.time)%60,s=""+Math.floor(100*this.time)%100;return 1==e.length&&(e=`0${e}`),1==t.length&&(t=`0${t}`),1==s.length&&(s=`0${s}`),`${e}:${t}.${s}`}get beats(){return this.time*this.bpm/60+this._elapsedBeats}get isPaused(){return 0==this._subscribers.size}static init(){return null==v._instance&&(v._instance=new v),v._instance}constructor(){this._start=0,this._elapsedBeats=0,this._bpm=90,this._meter="4/4",this._beatsPerMeasure=4,this._beatValue=4,this._key="C major",this._subscribers=new Set,this._listeners=new Set,this.context=new AudioContext,this._metronomes=new Set,this._timer=-1}addSubscriber(e){this._listeners.add(e)}removeSubscriber(e){this._listeners.delete(e)}isPlaying(e){return this._subscribers.has(e)}play(e){this.isPaused&&(this._start=this.contextTime-this._start),this._subscribers.add(e),this._listeners.add(e)}pause(e){this._listeners.add(e),this.isPlaying(e)&&(this._subscribers.delete(e),this.isPaused&&(this._start=this.contextTime-this._start))}stopAll(){this._elapsedBeats=0,this._start=0,this._subscribers.clear(),this._listeners.forEach((e=>e.onClockReset()))}setTime(e){this._elapsedBeats=e,this._start=0,this._listeners.forEach((e=>e.onClockTimeChange())),this._subscribers.clear()}setTempo(e){if(isNaN(e))return;const t=this.beats;e!=this._bpm&&(this._bpm=Math.max(5,e),this._start=this.contextTime-60*t/this._bpm,this._listeners.forEach((e=>e.onTempoChange())))}setTimeSignature(e){2!=e.split("/").length&&(e="4/4"),this._beatsPerMeasure=c(e.split("/")[0],-1),this._beatValue=c(e.split("/")[1],-1),(this._beatsPerMeasure<0||this._beatValue<0)&&(this._beatsPerMeasure=4,this._beatValue=4);const t=`${this._beatsPerMeasure}/${this._beatValue}`;this._meter!=t&&(this._meter=t,this._listeners.forEach((e=>e.onTimeSignatureChange())))}startMetronome(e){if(this._metronomes.add(e),-1==this._timer){const e=this.contextTime;let t=0;this._metronomes.forEach((e=>e.pulse(0))),this._timer=window.setInterval((()=>{if(0==this._metronomes.size)window.clearInterval(this._timer),this._timer=-1;else{const s=60/this.bpm,i=this.contextTime-e,n=Math.floor(i/s)%this.beatsPerMeasure;n!=t&&(t=n,this._metronomes.forEach((e=>e.pulse(t))))}}),30)}}stopMetronome(e){this._metronomes.delete(e)}isMetronomePlaying(e){return this._metronomes.has(e)}}const k=16.3516,w=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],_=["rgb(229, 76, 78)","rgb(223, 132, 74)","rgb(228, 171, 81)","rgb(227, 199, 73)","rgb(223, 228, 78)","rgb(174, 215, 71)","rgb(63, 188, 70)","rgb(63, 169, 180)","rgb(64, 124, 180)","rgb(78, 69, 179)","rgb(141, 69, 183)","rgb(202, 69, 147)"];class A{get note(){return this._note}set note(e){this._note=e}get end(){return this.start+this.duration}get octave(){return Math.floor(this.note/12)}set octave(e){this.note=12*e+this.step}get step(){return this.note%12}set step(e){this.note=12*this.octave+e}get cents(){return Math.round(100*(this.note-Math.floor(this.note)))}get velocity(){return this._velocity}set velocity(e){this._velocity=x(e,0,127)}get gain(){return this.velocity*this.velocity/16129}get name(){return`${w[Math.floor(this.step)]}`}get accidental(){return this.name.substring(1)}get nameWithOctave(){return`${w[Math.round(this.step)]}${this.octave-1}`}get stepColor(){return _[Math.round(this.step)%_.length]}get rate(){return Math.pow(2,this.note/12)}get frequency(){return k*this.rate}set frequency(e){e>0&&(this.note=12*Math.log(e/k)/Math.LN2)}constructor(e){this._note=60,this.start=0,this.duration=1,this._velocity=90,this.note=e}isEqual(e){return this.note===e.note&&this.start===e.start&&this.duration===e.duration&&this.velocity===e.velocity}clone(){let e=new A(this.note);return e.start=this.start,e.duration=this.duration,e.velocity=this.velocity,e}static fromName(e){const t=new A(60);return t.octave=A.nameToOctave(e),t.step=A.nameToStep(e),t}static fromFrequency(e){const t=new A(60);return t.frequency=e,t}static nameToOctave(e){if(2==e.length){let t=e.codePointAt(1);if(t)return x(t-48,0,8)}else if(e.length>2){let t=e.codePointAt(2);if(t)return x(t-48,0,8)}return 0}static nameToStep(e){return null==e||""==e?0:(e=e.length<=2?e[0].toUpperCase():e.substring(0,2).toUpperCase(),Math.max(0,w.indexOf(e)))}static nameToNote(e){if(e.length<2||e.length>3)return-1;e=e.replaceAll("#","♯");for(let t=0;t<12;t++)if(e.startsWith(w[t])){const s=e.substring(w[t].length);if(["0","1","2","3","4","5","6","7","8"].includes(s)){let e=s.codePointAt(0);return 12*((e||48)-48)+t}}return-1}}function x(e,t,s){return Math.max(t,Math.min(s,e))}class S{get length(){return this.trace.length}get isEmpty(){return 0===this.length}get beats(){return this._beats}get minNote(){return this._minNote}get minOctave(){return Math.max(0,Math.floor(this._minNote/12))}get maxNote(){return this._maxNote}get maxOctave(){return Math.max(0,Math.floor(this._minNote/12))}get noteRange(){return this.maxNote-this.minNote}get octaveRange(){return this.maxOctave-this.minOctave}get noteCount(){return this._noteCount}constructor(){this.trace=new Array,this._beats=0,this._playhead=0,this._minNote=-1,this._maxNote=-1,this._noteCount=0}clear(){this.trace=[],this._beats=0,this._minNote=-1,this._maxNote=-1,this._noteCount=0,this._playhead=0}fromPython(e){for(let t of e)this.addTraceEvent(t)}getMessages(){return this.trace.filter((e=>"message"===e.command)).map((e=>Object.fromEntries(e.params)))}isEquivalent(e){if(this.length!==e.length)return!1;for(let t=0;t<this.length;t++)if(!this.trace[t].isEquivalent(e.trace[t]))return!1;return!0}addTraceEvent(e){this._addTraceEvent(T.fromMap(e))}_addTraceEvent(e){switch(this.trace.push(e),e.command){case T.PLAY:this._beats=Math.max(e.end,this._beats),this._playhead=e.end,(this._minNote<0||e.note.note<this._minNote)&&(this._minNote=e.note.note),this._maxNote=Math.max(this._maxNote,e.note.note),this._noteCount++;break;case T.SOUND:this._beats=Math.max(e.end,this._beats),this._playhead=e.end,this._noteCount++;break;case T.REST:this._beats=Math.max(e.end,this._beats),this._playhead=e.end}}getTraceGroup(e){return this.trace.filter((t=>t.trace_group===e))}}class T{get end(){return this.time+this.duration}constructor(e,t){this.time=0,this.duration=1,this.line=-1,this.note=new A(60),this.trace_group=-1,this.params=new Map,this.id=T._TRACE_ID++,this.command=e,this.time=t}clone(){let e=new T(this.command,this.time);e.line=this.line,e.duration=this.duration,e.note=this.note.clone();for(let[t,s]of this.params)e.params.set(t,s);return e}static fromMap(e){let t=new T(String(e.get("command")),Math.max(0,Number(e.get("time"))));t.duration=Number(e.get("duration")),t.note.duration=t.duration;for(let[s,i]of e)if("note"===s&&"number"==typeof i)t.note.note=i;else if("pitch"===s&&"number"==typeof i)t.note.note=i+60;else if("velocity"===s&&"number"==typeof i)t.note.velocity=i;else if("sustain"===s&&"number"==typeof i)t.note.duration=Math.max(t.note.duration,i),t.duration=t.note.duration;else if("line"===s&&"number"==typeof i)t.line=i;else if("trace"===s)t.trace_group=i;else{if(["command","time","duration"].includes(s))continue;t.params.set(s,i)}return t}isEquivalent(e){if(this.command===e.command&&this.time===e.time&&this.duration===e.duration&&this.note.isEqual(e.note)){for(let[t,s]of this.params)if("line"!==t&&e.params.get(t)!==s)return!1;return!0}return!1}}T.PLAY="play",T.SOUND="sound",T.REST="rest",T.PUSH_FX="push_fx",T.POP_FX="pop_fx",T.MESSAGE="message",T._TRACE_ID=0;class M{constructor(e,t){this.released=!1,this.canceled=!1,this.note=e,this.chain=t}}class N{constructor(e,t,s){this.value=1,this.gain=new GainNode(e),this.name=t,this.value=s,this.gain.gain.value=s}connect(e,t){return t==this.name&&(e.level.connect(this.gain),!0)}destroy(){this.gain.disconnect()}updateParameter(e,t){return e==`${this.name}-mod}`&&(this.value=l(t,this.value),this.gain.gain.value=this.value,!0)}}class E{constructor(e,t){this.id=0,this.modulators=new Array,this.connectors=new Array,this.context=e,this.id=parseInt(t.id),this.level=e.createGain();const s=l(t.level,0);this.level.gain?.setValueAtTime(p(s),0),this.level.gain.value=p(s),this.addModulator("gain",l(t["gain-mod"],1),this.level.gain)}connect(e,t){for(let s of this.modulators)if(s.connect(e,t))return;"level"==t?e.level.connect(this.level.gain):e.level.connect(this.level)}addConnector(e){this.connectors.push(e),this.level?.connect(e.level)}addModulator(e,t,s){const i=new N(this.context,e,t);i.gain.connect(s),this.modulators.push(i)}playNote(e){}releaseNote(){}scheduleNote(e,t,s,i){}cancelNotes(){}destroy(){this.level.disconnect(),this.modulators.forEach((e=>e.destroy())),this.connectors.forEach((e=>e.destroy()))}pitchBend(e){}schedulePitchBend(e,t){}updateParameter(e,t){for(let s of this.modulators)if(s.updateParameter(e,t))return;if("level"==e){const e=l(t,0);this.level.gain?.setValueAtTime(p(e),0),this.level.gain.value=p(e)}}updateConnectorLevel(e,t){this.connectors.forEach((s=>{s.id==e&&s.updateLevel(t)}))}attachAnalyzer(e,t,s){for(let i of this.connectors)i.id==e&&i.attachAnalyzer(t,s)}detachAnalyzer(e){this.connectors.forEach((t=>{t.id==e&&t.detachAnalyzer()}))}getFloatTimeDomainData(e,t,s){this.connectors.forEach((i=>{i.id==e&&i.getFloatTimeDomainData(t,s)}))}}class C extends E{constructor(e,t){super(e,t),this.A=.1,this.D=.1,this.S=1,this.R=.2,this.aShape=5,this.dShape=2,this.rShape=2,this.attackCurve=[],this.decayCurve=[],this.releaseCurve=[],this.A=l(t.A,this.A),this.D=l(t.D,this.D),this.S=l(t.S,this.S),this.R=l(t.R,this.R),this.R=Math.max(this.R,.01),this.aShape=l(t["a shape"],this.aShape),this.dShape=l(t["d shape"],this.dShape),this.rShape=l(t["r shape"],this.rShape),this._attack=e.createGain(),this._decay=e.createGain(),this._release=e.createGain(),this._attack.gain.value=0,this._decay.gain.value=1,this._release.gain.value=1,this._attack.connect(this._decay),this._decay.connect(this._release),this._release.connect(this.level),this._buildCurves()}connect(e,t){e.level.connect(this._attack)}playNote(e){let t=this.context.currentTime;try{this._attack.gain?.cancelScheduledValues(0),this._decay.gain?.cancelScheduledValues(0),this._release.gain?.cancelScheduledValues(0),this.A>0?this._attack.gain?.setValueAtTime(0,t):this._attack.gain?.setValueAtTime(1,t),this._decay.gain?.setValueAtTime(1,t),this._release.gain?.setValueAtTime(1,t),t=this.context.currentTime+.01,this.A>0?this._attack.gain?.setValueCurveAtTime(this.attackCurve,t,this.A):this._attack.gain?.setValueAtTime(1,t),this.D>0?this._decay.gain?.setValueCurveAtTime(this.decayCurve,t+this.A,this.D):this._decay.gain?.setValueAtTime(this.S,t+this.A)}catch(e){console.log("Exception in ADSR playNote $x.")}}releaseNote(){const e=this.context.currentTime;this.R>0?(this._attack.gain?.cancelScheduledValues(e),this._decay.gain?.cancelScheduledValues(e),this._release.gain?.setValueCurveAtTime(this.releaseCurve,e,this.R)):this._release.gain?.setValueAtTime(0,e)}scheduleNote(e,t,s,i){const n=t<0?-t:0;let a=(t=t<0?0:t)+this.context.currentTime;if(this.A>0?this._attack.gain?.setValueAtTime(0,a):this._attack.gain?.setValueAtTime(1,a),this._decay.gain?.setValueAtTime(1,a),this._release.gain?.setValueAtTime(1,a),a+=.01,this.A>0&&this.A>n){const e=this.A-n;this._attack.gain?.setValueCurveAtTime(this.attackCurve,a,e)}else this._attack.gain?.setValueAtTime(1,a);if(this.D>0&&this.A+this.D>n&&s>this.A){const e=n>=this.A?this.D-(n-this.A):this.D,t=n>=this.A?a:a+this.A-n;this._decay.gain?.setValueCurveAtTime(this.decayCurve,t,e),this.A+this.D>s&&this._decay.gain?.cancelScheduledValues(a+s-n)}else this._decay.gain?.setValueAtTime(this.S,Math.max(0,a+this.A+this.D-n));if(s+this.R>n){const e=n>=s?this.R-(n-s):this.R;this._release.gain?.setValueCurveAtTime(this.releaseCurve,a+s-n,e)}else this._release.gain?.setValueAtTime(0,a)}cancelNotes(){super.cancelNotes();const e=this.context.currentTime;this._release.gain?.cancelScheduledValues(e),this._release.gain.value=0,this._attack.gain?.cancelScheduledValues(e),this._attack.gain.value=0,this._decay.gain?.cancelScheduledValues(e),this._decay.gain.value=0}destroy(){super.destroy(),this._attack.disconnect(),this._decay.disconnect(),this._release.disconnect()}updateParameter(e,t){switch(super.updateParameter(e,t),e){case"A":this.A=l(t,this.A);break;case"D":this.D=l(t,this.D);break;case"S":this.S=l(t,this.S);break;case"R":this.R=l(t,this.R);break;case"a shape":this.aShape=l(t,this.aShape);break;case"d shape":this.dShape=l(t,this.dShape);break;case"r shape":this.rShape=l(t,this.rShape)}this.R=Math.max(this.R,.01),this._buildCurves()}_buildCurves(){this._buildAttackCurve(this.aShape),this._buildDecayCurve(this.dShape),this._buildReleaseCurve(this.rShape)}_buildAttackCurve(e){e=y(e,.001,8),this.attackCurve=[];const t=Math.ceil(C.samplesPerSecond*this.A);if(t>0)for(let s=0;s<=t;s++){let i=s/t;i=Math.pow(i,e),this.attackCurve.push(i)}}_buildDecayCurve(e){e=y(e,.001,4),this.decayCurve=[];const t=Math.ceil(C.samplesPerSecond*this.D);if(t>0)for(let s=0;s<=t;s++){let i=s/t;i=1-Math.pow(i,e),this.decayCurve.push((1-this.S)*i+this.S)}}_buildReleaseCurve(e){e=y(e,.001,4),this.releaseCurve=[];const t=Math.ceil(C.samplesPerSecond*this.R);if(t>0)for(let s=0;s<=t;s++){let i=s/t;i=1-Math.pow(i,e),this.releaseCurve.push(i)}}}C.samplesPerSecond=300;class L{get context(){return this.source.context}constructor(e,t){this.id=0,this.dB=0,this._pre=null,this._analyzers=new Array,this._splitter=null,this._merger=null,this._buffer=null,this.type="",this.source=e,this.id=c(t.id,-1),this.level=new GainNode(this.context),this.dB=l(t.level,0),this.level.gain?.setValueAtTime(p(this.dB),0),this.type=d(t.type,"")}updateLevel(e){this.dB=e,(this._pre??this.level).gain?.setValueAtTime(p(e),0)}destroy(){this.level.disconnect()}attachAnalyzer(e,t,s=-60,i=5){t=y(t,1,6),this._pre=new GainNode(this.context),this._splitter=this.context.createChannelSplitter(t),this._merger=this.context.createChannelMerger(t),this._pre.gain?.setValueAtTime(p(this.dB),0),this.level.gain?.setValueAtTime(1,0),this.source.level.disconnect(this.level),this.source.level.connect(this._pre),this._pre?.connect(this._splitter),this._merger?.connect(this.level);for(let n=0;n<t;n++){let t=new AnalyserNode(this.level.context);this._analyzers.push(t),t.fftSize=e,t.minDecibels=s,t.maxDecibels=i,this._splitter?.connect(t,n,0),t.connect(this._merger,0,n),0==n&&(this._buffer=new Float32Array(t.frequencyBinCount))}}detachAnalyzer(){if(null!=this._pre){this.level.gain?.setValueAtTime(p(this.dB),0),this.source.level.disconnect(this._pre),this._pre?.disconnect(),this._splitter?.disconnect(),this._merger?.disconnect();for(let e of this._analyzers)e.disconnect();this.source.level.connect(this.level),this._pre=null,this._buffer=null,this._splitter=null,this._merger=null,this._analyzers=[]}}getFloatTimeDomainData(e,t){if(e<this._analyzers.length){const s=this._analyzers[e];if(null!=this._buffer&&t.length==this._buffer.length){s.getFloatTimeDomainData(this._buffer);for(let e=0;e<t.length;e++)t[e]+=this._buffer[e]}}}}class q extends E{constructor(e,t){super(e,t),this.tracking=!0,this.ratio=1,this.frequency=350,this.Q=1,this.gain=0,this.detune=0,this.type="lowpass",this.filter=e.createBiquadFilter(),this.filter.connect(this.level),this.Q=y(l(t.Q,1),1e-4,1e3),this.gain=y(l(t.gain,0),-40,40),this.type=d(t["filter type"],"lowpass"),this.detune=l(t.detune,0),this.frequency=y(l(t.frequency,350),0,16700),this.tracking=u(t.tracking,!0),this.ratio=l(t["tracking ratio"],1),this.addModulator("Q",l(t["Q-mod"],1),this.filter.Q),this.addModulator("gain",l(t["gain-mod"],5),this.filter.gain),this.addModulator("frequency",l(t["frequency-mod"],1e3),this.filter.frequency),this.filter.Q.value=this.Q,this.filter.gain.value=this.gain,this.filter.type=this.type,this.filter.detune.value=this.detune,this.filter.frequency.value=this.frequency}playNote(e){const t=this.tracking?e.frequency*this.ratio+this.frequency:this.frequency,s=this.context.currentTime;this.filter.Q?.setValueAtTime(this.Q,s),this.filter.gain?.setValueAtTime(this.gain,s),this.filter.detune?.setValueAtTime(this.detune,s),this.filter.frequency?.setValueAtTime(t,s)}scheduleNote(e,t,s,i){t=t<0?0:t;const n=this.context.currentTime,a=this.tracking?e.frequency*this.ratio+this.frequency:this.frequency;this.filter.Q?.setValueAtTime(this.Q,t+n),this.filter.gain?.setValueAtTime(this.gain,t+n),this.filter.detune?.setValueAtTime(this.detune,t+n),this.filter.frequency?.setValueAtTime(a,t+n)}cancelNotes(){super.cancelNotes(),this.filter.Q?.cancelScheduledValues(0),this.filter.gain?.cancelScheduledValues(0),this.filter.detune?.cancelScheduledValues(0),this.filter.frequency?.cancelScheduledValues(0)}destroy(){super.destroy(),this.filter.disconnect()}connect(e,t){"audio"===t?e.level.connect(this.filter):super.connect(e,t)}updateParameter(e,t){const s=this.context.currentTime;"filter type"===e&&q.FILTERS.includes(t)?(this.type=d(t,"lowpass"),this.filter.type=this.type):"Q"===e?(this.Q=y(l(t,this.Q),1e-4,1e3),this.filter.Q.cancelScheduledValues(0),this.filter.Q.setValueAtTime(this.Q,s),this.filter.Q.value=this.Q):"gain"===e?(this.gain=y(l(t,this.gain),-40,40),this.filter.gain.cancelScheduledValues(0),this.filter.gain.setValueAtTime(this.gain,s),this.filter.gain.value=this.gain):"detune"===e?(this.detune=l(t,this.detune),this.filter.detune?.cancelScheduledValues(0),this.filter.detune?.setValueAtTime(this.detune,s)):"frequency"===e?(this.frequency=y(l(t,this.frequency),0,16700),this.filter.frequency?.cancelScheduledValues(0),this.filter.frequency?.setValueAtTime(this.frequency,s),this.filter.frequency.value=this.frequency):"tracking"===e?this.tracking=u(t,this.tracking):"ratio"===e?this.ratio=l(t,this.ratio):super.updateParameter(e,t)}}q.FILTERS=["lowpass","highpass","bandpass","allpass","lowshelf","highshelf","peaking","notch","allpass"];class V extends E{constructor(e,t){super(e,t),this.frequency=440,this.multiplier=1,this.detune=0,this.relative=!0,this.waveform="sine",this.waveform=d(t.waveform,"sine"),this.frequency=l(t.frequency,this.frequency),this.detune=l(t.detune,0),this.relative=u(t.relative,!0),this.multiplier=l(t.multiplier,this.multiplier),this.osc=e.createOscillator(),this.gain=new GainNode(e),this.shaper=e.createWaveShaper(),this.addModulator("detune",l(t["detune-mod"],500),this.osc.detune),this.addModulator("frequency",l(t["frequency-mod"],1e3),this.osc.frequency),this.addModulator("amplitude",l(t["amplitude-mod"],1),this.level.gain),this.gain.gain.value=.3,V.Waveforms.includes(this.waveform)||(this.waveform="sine"),this.osc.frequency.setValueAtTime(90,0),this.osc.type="sine",this.osc.start(),this.osc.connect(this.gain),this.shaper.connect(this.gain),this.gain.connect(this.level),this._updateWaveform(this.waveform)}_updateWaveform(e){V.Waveforms.includes(e)&&(this.waveform=e),this.osc.type="sine",V.BasicWaveforms.includes(e)?(this.osc.type=e,this.osc.disconnect(),this.osc.connect(this.gain)):V.PeriodicWaveforms.includes(e)?(this.osc.setPeriodicWave(this._createPeriodicWave(e)),this.osc.disconnect(),this.osc.connect(this.gain)):V.ShaperWaveforms.includes(e)&&(this.shaper.curve=this._createWaveShaper(e),this.osc.disconnect(),this.osc.connect(this.shaper),this.osc.type="pitched noise"===e?"sawtooth":"sine")}_createWaveShaper(e){var t,s=new Float32Array(256);switch(e){case"exp sin":t=e=>Math.pow(e,5);break;case"hump":t=e=>(e<0?0:e)-.5;break;default:t=e=>2*Math.random()-1}for(let e=0;e<s.length;e++)s[e]=t(2*e/s.length-1);return s}_createPeriodicWave(e){let t=new Array;switch(e){case"cello":t=[0,1,.5,.3,.5,.35,.2,.2,.1,.15,.15,.15];break;case"flute":t=[0,.5,.05,.3,.1];break;case"reed":t=[-.15,.5,1,.4,.6,.3,.25,.2];break;case"brass":t=[0,.8,.8,.85,.9,.8,.85,.7,.6,.4,.3,.25,.2,.1];break;case"glass":t=[0,1,0,.25,0,.5,0,.75,0,.8];break;case"vibraphone":t=[0,6,19,.8,13,3];break;case"camel":t.push(0);for(let e=1;e<20;e++)t.push(1/Math.pow(e,2));break;case"soft saw":t.push(-.1);for(let e=1;e<20;e++)t.push(1/e);break;case"soft square":t.push(0);for(let e=1;e<50;e++)t.push(1/e*(e%2));break;case"organ 1":t=[-.1,1,1,1];break;case"organ 2":t=[-.1,1,1,1,0,0,0,0,0,.8];break;case"organ 3":t=[0,1,0,0,0,0,.8,.8,.8,.8];break;case"buzz 1":t.push(0);let e=1;for(let s=1;s<100;s++)s%3==0||s%4==0?(t.push(1/e),e++):t.push(0);break;default:t.push(0),e=1;for(let s=1;s<100;s++)s%5==0||s%2==0?(t.push(.5/e),e++):t.push(0)}return this.osc.context.createPeriodicWave(t,new Float32Array(t.length))}playNote(e){let t=this.relative?e.frequency*this.multiplier:this.frequency;t=y(t,0,23999),this.osc.frequency?.setValueAtTime(t,this.context.currentTime),this.osc.detune?.setValueAtTime(this.detune,this.context.currentTime)}scheduleNote(e,t,s,i){t=t<0?0:t;let n=this.relative?e.frequency*this.multiplier:this.frequency;n=y(n,0,23999),this.osc.frequency?.setValueAtTime(n,t+this.context.currentTime),this.osc.detune?.setValueAtTime(this.detune,t+this.context.currentTime)}cancelNotes(){super.cancelNotes(),this.osc.frequency?.cancelScheduledValues(0),this.osc.detune?.cancelScheduledValues(0)}destroy(){super.destroy(),this.osc.stop(),this.osc.disconnect(),this.gain.disconnect(),this.shaper.disconnect()}pitchBend(e){const t=this.context.currentTime;this.osc.detune?.setTargetAtTime(this.detune+e,t,.1)}schedulePitchBend(e,t){t.apply(this.osc.detune,e,this.context,this.detune)}updateParameter(e,t){if("waveform"===e)this._updateWaveform(t);else if("relative"==e)this.relative=u(t,!0);else if("frequency"==e)this.frequency=l(t,this.frequency),this.osc.frequency?.setValueAtTime(this.frequency,this.context.currentTime);else if("multiplier"==e)if(this.relative){let e=this.osc.frequency.value/this.multiplier;this.multiplier=l(t,this.multiplier),this.multiplier>0&&(e*=this.multiplier),e=y(e,0,23999),this.osc.frequency?.setValueAtTime(e,this.context.currentTime)}else this.multiplier=l(t,this.multiplier);else"detune"==e?(this.detune=l(t,this.detune),this.osc.detune?.setValueAtTime(this.detune,this.context.currentTime)):super.updateParameter(e,t)}}V.BasicWaveforms=["sine","square","triangle","sawtooth"],V.PeriodicWaveforms=["cello","flute","reed","brass","glass","vibraphone","camel","organ 1","organ 2","organ 3","soft saw","soft square","buzz 1","buzz 2"],V.ShaperWaveforms=["pitched noise","exp sin","hump"],V.Waveforms=[...V.BasicWaveforms,...V.PeriodicWaveforms,...V.ShaperWaveforms];class P extends C{constructor(e,t){super(e,t)}}class O{constructor(){}static hasSound(e){return O.sounds.has(e)}static getAudioBuffer(e){return O.sounds.get(e)}static async loadAudioBuffer(e,t){if(O.hasSound(e))return!0;const s=O.supportsAudioType("audio/ogg")?`${e}.ogg`:`${e}.wav`;try{let i=await fetch(s),n=await i.arrayBuffer(),a=await t.decodeAudioData(n);return O.sounds.set(e,a),!0}catch(e){return console.log(e),!1}}static async loadCustomSound(e,t){if(O.hasSound(e))return!0;try{let s=await fetch(e),i=await s.arrayBuffer(),n=await t.decodeAudioData(i);return O.sounds.set(e,n),console.log("Loaded "+e),!0}catch(e){return console.log(e),!1}}static supportsAudioType(e){if(O._supports.has(e))return O._supports.get(e);let t=!1;const s=document.createElement("audio");return s.id="test-audio-node",document.body.append(s),"probably"!=s.canPlayType(e)&&"maybe"!=s.canPlayType(e)||(t=!0,document.querySelector("#test-audio-node")?.remove()),O._supports.set(e,t),t}}function B(e){return"object"==typeof e&&"sample"in e&&"string"==typeof e.sample&&"step"in e&&"number"==typeof e.step}O.sounds=new Map,O._supports=new Map;class H extends E{constructor(e,t){super(e,t),this.sources=new Array,this.playback=1,this.detune=0,this.sample_pack="piano",this.samples=new Array,this._rate=1,this.drumkit=!1,this.playback=l(t.playback,this.playback),this.detune=l(t.detune,this.detune),this.sample_pack=d(t["sample-pack"],this.sample_pack),this.dIn=new GainNode(e),this.pIn=new GainNode(e),this.dIn.gain.value=l(t["detune-mod"],1),this.pIn.gain.value=l(t["playback-mod"],1),"samples"in t&&Array.isArray(t.samples)&&this.loadSamplePack(t.samples)}loadSamplePack(e){this.samples=e.filter((e=>B(e))).sort(((e,t)=>e.step-t.step)),this.samples.forEach((e=>O.loadAudioBuffer(e.sample,this.context)))}static loadAudioBuffers(e,t){e.forEach((e=>O.loadAudioBuffer(e.sample,t)))}playNote(e){this.scheduleNote(e,0,0,0)}findBestSample(e){let t;if(this.drumkit)t=this.samples.find((t=>t.step===Math.round(e.note)));else{let s=1e5;for(const i of this.samples){if(i.step==e.note)return i;if(i.step>e.note){return i.step-e.note+3<s?i:t}{const n=e.note-i.step;n<s&&(t=i,s=n)}}}return t}scheduleNote(e,t,s,i){const n=t<0?-t:0;t=Math.max(0,t);const a=this.findBestSample(e);if(a){const o=O.getAudioBuffer(a.sample);if(o){const r=e.note-a.step,h=this.context.currentTime,c=Math.pow(2,r/12),l=new AudioBufferSourceNode(this.context);l.connect(this.level),this.sources.push(l),this.dIn.connect(l.detune),this.pIn.connect(l.playbackRate),l.buffer=o,l.playbackRate.value=c*this.playback,l.start(t+h,n),s>0&&l.stop(t+h+s+i),l.addEventListener("ended",(e=>{this.sources=this.sources.filter((e=>e!==l)),l.disconnect()})),o.duration,this.playback,this._rate=c}}}cancelNotes(){super.cancelNotes(),this.sources.forEach((e=>{e.stop(),e.disconnect()})),this.sources=new Array,this._rate=1}destroy(){super.destroy(),this.sources.forEach((e=>{e.stop(),e.disconnect()})),this.sources=new Array,this._rate=1}pitchBend(e){const t=this.context.currentTime;this.sources.forEach((s=>{s.detune?.setTargetAtTime(this.detune+e,t,.1)}))}schedulePitchBend(e,t){if(this.sources.length>0){const s=this.sources[this.sources.length-1];t.apply(s.detune,e,this.context,this.detune)}}connect(e,t){"detune"==t?e.level.connect(this.dIn):"playback"==t&&e.level.connect(this.pIn)}updateParameter(e,t){"playback"==e?(this.playback=l(t,this.playback),this.sources.forEach((e=>{e.playbackRate?.setValueAtTime(this._rate*this.playback,this.context.currentTime)}))):"detune"==e?(this.detune=l(t,this.detune),this.sources.forEach((e=>{e.detune?.setValueAtTime(this.detune,this.context.currentTime)}))):"sample-pack"==e||("playback-mod"==e?this.pIn.gain.value=l(t,1):"detune-mod"==e?this.dIn.gain.value=l(t,1):super.updateParameter(e,t))}}class z{constructor(e){this.id=0,this.free=0,this.nodes=new Map,this.out=null,this.release=0,this.gates=new Array,this.context=e,this.id=z._CHAIN_ID++,this.loadPatch(z._sine_patch)}playNote(e,t){const s=t.context.currentTime;this.free=31536e3,this.disconnect();const i=new GainNode(t.context);i.connect(t),i.gain.value=e.gain,i.gain.setValueAtTime(e.gain,s),this.out?.level.connect(i),this.gates.push({free:this.free,node:i}),this.nodes.forEach(((t,s,i)=>t.playNote(e)))}releaseNote(){this.nodes.forEach(((e,t,s)=>e.releaseNote()))}scheduleNote(e,t,s,i){const n=i.context.currentTime;this.free=n+t+s+this.release+.05;const a=new GainNode(i.context);a.connect(i),a.gain.value=0,a.gain?.setValueAtTime(0,0),a.gain?.setValueAtTime(e.gain,Math.max(n,n+t)),a.gain?.setValueAtTime(0,Math.max(n,n+t+s+this.release)),this.out?.level.connect(a),this.gates.push({free:this.free,node:a});try{this.nodes.forEach(((i,n,a)=>{i.scheduleNote(e,t,s,this.release)}))}catch(e){console.log("Note scheduling exception: $x")}for(let e=0;e<this.gates.length;e++)this.gates[e].free<n&&(this.gates[e].node?.disconnect(),this.out?.level.disconnect(this.gates[e].node),delete this.gates[e]);return this.gates=this.gates.filter((e=>void 0!==e)),this.release}disconnect(){this.out?.level.disconnect(),this.gates.forEach((e=>{e.node?.disconnect()})),this.gates=[]}cancelNotes(){this.disconnect(),this.nodes.forEach((e=>e.cancelNotes())),this.free=0}destroy(){this.disconnect(),this.nodes.forEach((e=>e.destroy())),this.nodes.clear()}pitchBend(e){this.nodes.forEach((t=>t.pitchBend(e)))}schedulePitchBend(e,t){this.nodes.forEach((s=>s.schedulePitchBend(e,t)))}loadPatch(e){if(this.nodes.clear(),this.out=null,this.release=0,Array.isArray(e.nodes))for(let t of e.nodes){let e=this.createSynthNode(this.context,t);e instanceof P&&(this.out=e),this.nodes.set(e.id,e)}this._updateReleaseValue();for(let t of e.routing){let e=this.nodes.get(t.source),s=this.nodes.get(t.dest);if(e&&s){let i=new L(e,t);e.addConnector(i),s.connect(i,d(t.type,""))}}}createSynthNode(e,t){switch(t.type){case"gain":return new E(e,t);case"osc":return new V(e,t);case"adsr":return new C(e,t);case"filter":return new q(e,t);case"out":return new P(e,t);case"sample":case"drums":return new H(e,t);default:return console.log(`Node not found: ${t.type}`),new E(e,t)}}getNodeById(e){return this.nodes.get(e)}updateParameter(e,t,s){let i=this.nodes.get(e);i?.updateParameter(t,s),this._updateReleaseValue()}updateConnectorLevel(e,t,s){let i=this.nodes.get(e);i?.updateConnectorLevel(t,s)}attachAnalyzer(e,t,s,i){let n=this.nodes.get(e);n?.attachAnalyzer(t,s,i)}detachAnalyzer(e,t){let s=this.nodes.get(e);s?.detachAnalyzer(t)}getFloatTimeDomainData(e,t,s,i){let n=this.nodes.get(e);n?.getFloatTimeDomainData(t,s,i)}_updateReleaseValue(){this.release=0,this.nodes.forEach((e=>{e instanceof C&&(this.release=Math.max(Math.max(e.A+e.D,e.R),this.release))}))}}z._CHAIN_ID=0,z._sine_patch={nodes:[{type:"out",A:.1,D:.1,S:.8,R:.15,id:0},{type:"osc",waveform:"sine",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"out"}]},z._custom_patch={nodes:[{type:"out",id:0,A:0,D:.1,S:1,R:.3,level:0},{type:"sample","sample-pack":"custom",samples:[{sample:"<SOUNDURL>",step:60}],id:1,level:0}],routing:[{id:2,source:1,dest:0,type:"audio",level:0}]};const D={start:0,beats:0,values:[]};class I{constructor(e,t){this.params=new Array,this.start=0,this.beats=-1,this.free=-1,this.id=I._EFFECT_ID++,this.name=e,this.oparams=t,this.start=Math.max(0,t.start),this.beats=t.beats,this.free=-1;for(const e of t.values){const t=Array();if(Array.isArray(e))for(const s of e)t.push(s);else"number"==typeof e&&t.push(e);this.params.push(t)}}static createEffect(e,t){return new R(t)}connect(e,t,s){return this.free=(s+this.start+this.beats+.1)*(60/t)+e.context.currentTime,this.node.connect(e),this.node}disconnect(){this.node.disconnect()}afterEffect(e,t,s,i,n){}clampParam(e,t,s){for(let i=0;i<e.length;i++)e[i]=y(e[i],t,s)}}I._EFFECT_ID=0;class R extends I{get node(){return this._node}constructor(e){super("empty",D),this._node=new GainNode(e)}}class ${get bpm(){return this._bpm}set bpm(e){isNaN(e)||(this._bpm=y(e,5,300))}constructor(){this._bpm=90,this.notes=new Array,this.patch={name:"piano",nodes:new Array,routing:new Array},this.voice="simple sine",this.bank=new Array,this.sound_gens=new Array,this.parameters=new Array,this._analyzer=null,this._analyzers=new Map,this._effects=new Array}get isPlaying(){if(0===this.bank.length)return!1;{const e=this.bank[0].context.currentTime;for(const t of this.bank)if(t.free>e)return!0;return!1}}playNote(e,t){let s=this._allocateGenerator(t.context,t.context.currentTime);if(null==s)return null;s.cancelNotes(),s.playNote(e,t);const i=new M(e,s);return this.notes.push(i),i}scheduleNote(e,t,s,i=0){const n=t.context.currentTime,a=e.duration*(60/this.bpm);s=(s+i)*(60/this.bpm);const o=this._allocateGenerator(t.context,n+s);return o?.scheduleNote(e,s,a,t),o}release(e){if(e.released)return;e.released=!0,e.chain.releaseNote();const t=Math.ceil(1e3*e.chain.release)+100;setTimeout((()=>{this.notes=this.notes.filter((t=>t!==e)),e.chain.disconnect(),this._releaseGenerator(e.chain)}),t)}releaseNote(e){this.notes.forEach((t=>{t.note.note==e.note&&this.release(t)}))}releaseAll(){this.notes.forEach((e=>{this.release(e)}))}cancelAllNotes(){for(const e of this.bank)this._releaseGenerator(e);for(const e of this.sound_gens)e.cancelNotes();this.sound_gens=[]}scheduleNotes(e,t,s){const i=t.context.currentTime,n=Math.max(0,-s);for(let e=0;e<this._effects.length;e++){const t=this._effects[e];t.free>0&&t.free<i&&(t.disconnect(),delete this._effects[e])}this._effects=this._effects.filter((e=>void 0!==e));for(let e=0;e<this.sound_gens.length;e++){this.sound_gens[e].free<i&&delete this.sound_gens[e]}this.sound_gens=this.sound_gens.filter((e=>void 0!==e));const a=new Array,o=new R(t.context);o.beats=e.beats,a.push(o),this._effects.push(o),o.connect(t,this.bpm,s);for(const i of e.trace)if(i.command==T.PUSH_FX){const e=a[a.length-1],n=I.createEffect(i,t.context);n.connect(e.node,this.bpm,s),a.push(n),this._effects.push(n)}else if(i.command==T.POP_FX)a.pop();else if(i.command==T.PLAY&&i.end>=n){const e=a[a.length-1],t=this.scheduleNote(i.note,e.node,i.time,s);a.forEach((e=>{e.afterEffect(t,i.time,i.note.duration,this.bpm,s)}))}}scheduleMidiNotes(e,t,s){const i=window.performance.now(),n=Math.max(0,-t);for(const a of e.trace)if(a.command===T.PLAY&&a.end>=n){const e=a.note.duration*(60/this.bpm)*1e3,n=i+(a.time+t)*(60/this.bpm)*1e3,o=[144,Math.round(a.note.note),a.note.velocity],r=[128,Math.round(a.note.note),0];s.send(o,n),s.send(r,n+e)}}setMidiProgram(e,t){t>=0&&t<=127&&e.send([192,t])}cancelAllMidiNotes(e){const t=window.performance.now();for(let s=0;s<=127;s++)e.send([128,s,0],t);"clear"in e&&"function"==typeof e.clear&&e.clear()}pitchBend(e){this.notes.forEach((t=>t.chain.pitchBend(e)))}async loadPatch(e,t){try{e.endsWith("/")&&(e+="patch.json");let i=await fetch(e),n=await i.json();if("string"==typeof(s=n).name&&"2.0"===s.version&&"tunepad-patch"===s.format&&Array.isArray(s.nodes)&&Array.isArray(s.routing)){const s=e.split("/").slice(0,-1).join("/")+"/";this.voice=n.name,this.patch=n,this.parameters=[],this._destroyAllGenerators(),this.sound_gens=[];for(const e of this.patch.nodes)if(Array.isArray(e.samples)){const i=e.samples.filter((e=>B(e))).sort(((e,t)=>e.step-t.step));i.forEach((e=>{e.sample=s+e.sample,O.loadAudioBuffer(e.sample,t)})),e.samples=i}else"reverb"===e.type?await O.loadCustomSound(e.impulse,t):"buffer source"===e.type&&await O.loadCustomSound(e.buffer,t);return!0}}catch(e){console.log("Failed to load audio patch.",e)}finally{return!1}var s}getNodeById(e){return this.bank.length>0?this.bank[0]?.getNodeById(e):void 0}updateParameter(e,t,s){this.bank.forEach((i=>{i.updateParameter(e,t,s)}));for(const i of this.patch.nodes)i.id==e&&(i[t]=s)}_allocateGenerator(e,t){this.bank.length>0&&this.bank[0].context!=e&&this._destroyAllGenerators();for(const s of this.bank)if(s.free<t&&s.context==e)return this._analyzers.forEach((e=>{0==s.free&&s.attachAnalyzer(e.nodeId,e.connectorId,e.fftSize,e.channels)})),s;if(this.bank.length<$.MAX_GENERATORS){const t=new z(e);return t.loadPatch(this.patch),this.bank.push(t),this._analyzers.forEach((e=>{t.attachAnalyzer(e.nodeId,e.connectorId,e.fftSize,e.channels)})),t}}_releaseGenerator(e){e.cancelNotes(),this._analyzers.forEach((t=>{e.detachAnalyzer(t.nodeId,t.connectorId)}))}_destroyAllGenerators(){this.bank.forEach((e=>{e.destroy()})),this.bank=[]}}$.MAX_GENERATORS=24;class F extends HTMLElement{constructor(){super(),this.synth=new $,this.octave=3,this.minOctave=0,this.maxOctave=7,this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(h);const e=document.createElement("template");e.innerHTML='<div class="piano-wrapper">\n    <button id="down-octave" class="octave-button" title="Lower Octave">❮</button>\n    <piano-keyboard note-hints="true" midi-hints="true" armed="true" max-octave="8" min-octave="1" focus-octave="3" key-range="14"></piano-keyboard>\n    <button id="up-octave" class="octave-button" title="Higher Octave">❯</button>\n</div>',this.root.appendChild(e.content.cloneNode(!0)),this.keyboard=this.root.querySelector("piano-keyboard"),this.audio=v.init()}connectedCallback(){this.audio=v.init(),this.keyboard.addEventListener("note-on",(e=>{const t=new A(e.detail.note);this.synth.playNote(t,this.audio.context.destination)})),this.keyboard.addEventListener("note-off",(e=>{const t=new A(e.detail.note);this.synth.releaseNote(t)})),this.root.querySelector("#down-octave")?.addEventListener("click",(e=>{this.octave=Math.max(this.minOctave,this.octave-1),this.root.querySelector("piano-keyboard")?.setAttribute("focus-octave",`${this.octave}`)})),this.root.querySelector("#up-octave")?.addEventListener("click",(e=>{this.octave=Math.min(this.maxOctave,this.octave+1),this.root.querySelector("piano-keyboard")?.setAttribute("focus-octave",`${this.octave}`)}))}disconnectedCallback(){}attributeChangedCallback(e,t,s){"patch"===e&&s!==t?this.synth.loadPatch(s,this.audio.context):s!==t&&this.keyboard.setAttribute(e,s),"focus-octave"===e?this.octave=parseInt(s):"min-octave"===e?this.minOctave=parseInt(s):"max-octave"===e&&(this.maxOctave=parseInt(s)),this.octave=isNaN(this.octave)?3:this.octave,this.minOctave=isNaN(this.minOctave)?0:this.minOctave,this.maxOctave=isNaN(this.maxOctave)?7:this.maxOctave}}F.ELEMENT="piano-instrument",F.observedAttributes=[...o.observedAttributes,"patch"];const K=new CSSStyleSheet;K.replaceSync('.code-view-wrapper {\n    margin: 2rem 0;\n    border-radius: 0.75em;\n    overflow: hidden;\n    max-width: 650px;\n    position: relative;\n}\n\n.buttons {\n    position: absolute;\n    right: 0;\n    top: 0;\n    z-index: 5;\n    margin: 0.75rem;\n}\n\n.buttons button {\n    width: 30px;\n    height: 30px;\n    line-height: 20px;\n    outline: none;\n    border: none;\n    background: transparent;\n    color: #666;\n    padding: 4px;\n}\n.buttons button svg { width: 15px; height: 15px; fill: #666; vertical-align: middle; }\n.buttons button:hover { color: black; }\n.buttons button:hover svg { fill: black; }\n.buttons button:active { color: var(--highlight-color); }\n.buttons button:active svg { fill: var(--highlight-color); }\n.buttons button.hidden { display: none; }\n\n#loader svg {\n    animation: spin-animation 2s infinite;\n    animation-timing-function: linear;\n}\n\npre[class*="language-python"] {\n    padding-left: 0.5em;\n    font-size: 12px;\n}\n\ncode[class*="language-python"] {\n    line-height: 1.75;\n}\n\npre[class*="language-"].line-numbers {\n\tposition: relative;\n\tpadding-left: 3.8em;\n    margin: 0;\n\tcounter-reset: linenumber;\n}\n\npre[class*="language-"].line-numbers > code {\n\tposition: relative;\n\twhite-space: inherit;\n}\n\n.line-numbers .line-numbers-rows {\n\tposition: absolute;\n\tpointer-events: none;\n\ttop: -2px;\n\tfont-size: 100%;\n\tleft: -3.8em;\n\twidth: 3em; /* works for line-numbers below 1000 lines */\n\tletter-spacing: -1px;\n\tborder-right: 1px solid #999;\n\tuser-select: none;\n\tbackground-color: transparent;\n}\n\n.line-numbers-rows > span {\n    display: block;\n    counter-increment: linenumber;\n}\n\n.line-numbers-rows > span:before {\n    content: counter(linenumber);\n    color: #999;\n    display: block;\n    padding-right: 0.8em;\n    text-align: right;\n}\n\nfooter {\n    background-color: #777;\n    color: white;\n    font-size: 11px;\n    padding: 0.25em 2em;\n    display: flex;\n}\n\nfooter.error {\n    background-color: #aa3e3e;\n}\n\nfooter div {\n    margin-left: 1.5rem;\n}\n\nfooter div:first-child {\n    margin-left: 0;\n}\n\n#status, #error { flex: 1; }\n\nfooter #error { display: none; }\nfooter.error div { display: none; }\nfooter.error div#error { display: block; }\n\n.progress-bar {\n    display: block;\n    height: 5px;\n    width: 100%;\n    background-color: #0002;\n}\n.progress-bar.hidden { display: none; }\n\n.progress-bar .fill {\n    background-color: cornflowerblue;\n    height: 100%;\n    margin: 0;\n    padding: 0;\n}\n\n@media print {\n    footer { display: none; }\n}\n\n@keyframes spin-animation {\n    0% {\n      transform: rotate(0deg);\n    }\n    100% {\n      transform: rotate(359deg);\n    }\n  }');const G=new CSSStyleSheet;G.replaceSync('code[class*=language-],pre[class*=language-]{color:#111b27;background:0 0;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{background:#ccd6e4}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#ccd6e4}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#e3e9f2}:not(pre)>code[class*=language-]{padding:.1em .3em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#304259;font-style:italic}.token.punctuation{color:#111b27}.token.selector,.token.tag{color:#007474}.token.attr-name,.token.boolean,.token.constant,.token.number,.token.pseudo-class,.token.pseudo-element,.token.selector .token.attribute{color:#7d6600}.token.class-name,.token.key,.token.parameter,.token.property,.token.property-access,.token.variable{color:#005c99}.token.attr-value,.token.color,.token.inserted,.token.selector .token.value,.token.string,.token.string .token.url-link{color:#237800}.token.builtin,.token.keyword-array,.token.package,.token.regex{color:#b800b8}.token.function,.token.selector .token.class,.token.selector .token.id{color:#8600c6}.token.atrule .token.rule,.token.combinator,.token.keyword,.token.operator,.token.unit{color:#aa4d00}.token.deleted,.token.important{color:#bf0100}.token.keyword-this,.token.this{color:#005c99}.token.bold,.token.important,.token.keyword-this,.token.this{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.language-markdown .token.title,.language-markdown .token.title .token.punctuation{color:#005c99;font-weight:700}.language-markdown .token.code{color:#007474}.language-markdown .token.url>.token.content{color:#237800}.language-markdown .token.url-link{color:#7d6600}.language-markdown .token.list.punctuation{color:#b800b8}.language-markdown .token.table-header{color:#111b27}.language-json .token.operator{color:#111b27}.token.cr:before,.token.lf:before,.token.space:before,.token.tab:not(:empty):before{color:#304259}div.code-toolbar>.toolbar a,div.code-toolbar>.toolbar button{color:#e3e9f2;background:#005c99}div.code-toolbar>.toolbar a:focus,div.code-toolbar>.toolbar a:hover,div.code-toolbar>.toolbar button:focus,div.code-toolbar>.toolbar button:hover{color:#e3e9f2;background:#005c99da;text-decoration:none}div.code-toolbar>.toolbar span,div.code-toolbar>.toolbar span:focus,div.code-toolbar>.toolbar span:hover{color:#e3e9f2;background:#304259}.line-highlight{background:#3042591f;background:linear-gradient(to right,#3042591f 70%,#30425915)}.line-highlight:before,.line-highlight[data-end]:after{background-color:#304259;color:#e3e9f2;box-shadow:0 1px #ccd6e4}pre[id].linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:#3042591f}.line-numbers .line-numbers-rows{border-right:1px solid #111b271f;background:#d8e0ebda}.line-numbers-rows>span:before{color:#111b2796}.rainbow-braces .token.punctuation.brace-level-1,.rainbow-braces .token.punctuation.brace-level-5,.rainbow-braces .token.punctuation.brace-level-9{color:#7d6600}.rainbow-braces .token.punctuation.brace-level-10,.rainbow-braces .token.punctuation.brace-level-2,.rainbow-braces .token.punctuation.brace-level-6{color:#b800b8}.rainbow-braces .token.punctuation.brace-level-11,.rainbow-braces .token.punctuation.brace-level-3,.rainbow-braces .token.punctuation.brace-level-7{color:#005c99}.rainbow-braces .token.punctuation.brace-level-12,.rainbow-braces .token.punctuation.brace-level-4,.rainbow-braces .token.punctuation.brace-level-8{color:#8600c6}pre.diff-highlight>code .token.deleted:not(.prefix),pre>code.diff-highlight .token.deleted:not(.prefix){background-color:#bf01001f}pre.diff-highlight>code .token.inserted:not(.prefix),pre>code.diff-highlight .token.inserted:not(.prefix){background-color:#2378001f}.command-line-prompt{border-right:1px solid #111b271f}.command-line-prompt>span:before{color:#111b2796}');class W{static init(){return null===W.instance&&(W.instance=new W),W.instance}constructor(){this.queue=new Array,this.cache=new Map,this.modules=new Map,this.active=null,this.warnings=new Array,this.worker=new Worker("/js/PythonWorker.js"),setTimeout((()=>{W.instance?.processQueue()}),50),this.worker.onmessage=e=>{const t=e.data,s=this.active;if(s&&s.uuid===t.uuid){for(let e of this.queue)if(e.uuid===s.uuid&&e.action===s.action&&e.code!==s.code)return void(this.active=null);let e=new U(s);e.output=t.output,e.globals=t.globals,e.errors=t.errors,e.dependencies=t.dependencies,this.warnings=this.warnings.filter((t=>t.target!==e.uuid&&t.source!==e.uuid));for(const[t,s]of this.cache)t!==e.uuid&&s.dependencies.includes(e.name)&&this.warnings.push({name:"Dependency Warning",message:`Cell '${e.name}' has been updated.`,details:"",line:-1,target:s.uuid,source:e.uuid});for(let[t,s]of this.cache)if(t!==e.uuid)for(let i of s.dependencies){let n=i===e.name;for(let[e,s]of this.cache)t!==e&&s.name===i&&(n=!0);n||this.warnings.push({name:"Dependency Warning",message:`Cell '${i}' does not exist.`,details:"",line:-1,target:s.uuid,source:e.uuid})}e.globals.has("__tunepad_trace")&&e.trace.fromPython(e.globals.get("__tunepad_trace").value),e.hasNoErrors&&this.cache.set(e.uuid,e),s.callback(e)}this.active=null}}static destroy(){if(W.instance){const e=W.instance;e.worker.terminate(),e.active=null,e.cache.clear(),e.modules.clear()}}static compile(e,t=!1){return new Promise((s=>{W.instance?.queue.push(new Q(e,"compile",s,t))}))}static run(e){return new Promise((t=>{W.instance?.queue.push(new Q(e,"run",t))}))}static preload(e){const t=W.instance;return new Promise((async s=>{for(const s of e)t?.queue.push(new Q(s,"preload",(e=>{console.log("preload response for "+e.name)})));s(!0)}))}static _timeout(e){return new Promise((t=>setTimeout(t,e)))}static playCell(e){W.instance?.worker.postMessage({...e,action:"play"})}static pauseCell(e){W.instance?.worker.postMessage({...e,action:"pause"})}static deleteCell(e){const t=W.instance;if(t){t.modules.delete(e.uuid),t.cache.delete(e.uuid),t.worker.postMessage({...e,action:"delete"});for(const[s,i]of t.cache)s!==e.uuid&&i.dependencies.includes(e.name)&&t.warnings.push({name:"Dependency Warning",message:`Cell '${e.name}' was deleted.`,details:"",line:-1,target:s,source:e.uuid})}}static getWarnings(){return W.instance?.warnings}equivalentCode(e,t){function s(e){return e.split("\n").filter((e=>""!==e&&!e.startsWith("#"))).join("\n")}return s(e)===s(t)}equivalent(e,t){return!e.force&&e.name===t.name&&e.action===t.action&&this.equivalentCode(e.code,t.code)}async processQueue(){if(this.queue.length>0&&null===this.active){let e=this.queue.shift();this.modules.set(e.uuid,e.cell);let t=this.cache.get(e.uuid);t&&t.code&&this.equivalent(e,t)?e.callback(t):(this.active=e,this.removeFromCache(e.uuid),this.worker.postMessage({uuid:e.uuid,name:e.name,action:e.action,code:e.code}))}setTimeout((()=>{W.instance?.processQueue()}),50)}removeFromCache(e){this.cache.get(e)?.close(),this.cache.delete(e)}static makePythonSafe(e,t){let s="";for(const t of e){let e=t.charCodeAt(0);e>=48&&e<=57||e>=97&&e<=199||e>=65&&e<=90||95===e?s+=t:32===e&&(s+="_")}""===s&&(s="new_cell"),s.charCodeAt(0)>=48&&s.charCodeAt(0)<=57&&(s="_"+s),j.includes(s)&&(s="_"+s);let i=s,n=2;for(;W.instance?.duplicateName(s,t);)s=i+"_"+n,n++;return s}duplicateName(e,t){for(const[s,i]of this.modules)if(t!==s&&i.name===e)return!0;return!1}}W.instance=null;class Q{constructor(e,t,s,i=!1){this.force=!1,this.cell=e,this.action=t,this.callback=s,this.force=i}get uuid(){return this.cell.uuid}get name(){return this.cell.name}get code(){return this.cell.code}}class U{constructor(e){this.output=[],this.trace=new S,this.errors=[],this.dependencies=[],this.uuid=e.uuid,this.code=e.code,this.name=e.name,this.action=e.action}get hasErrors(){return this.errors.length>0}get hasNoErrors(){return 0===this.errors.length}close(){}}const j=["and","as","assert","break","class","continue","def","del","elif","else","except","exec","False","finally","for","from","global","if","import","in","is","lambda","None","nonlocal","not","or","pass","raise","return","True","try","while","with","yield"];class X extends HTMLElement{get currentBeat(){return this.audio.beats%this.duration}get remainingBeats(){return this.duration-this.currentBeat}get percentBeats(){return this.currentBeat/this.duration}constructor(){super(),this.uuid=self.crypto.randomUUID(),this.code="",this.synth=new $,this.midiOut=!1,this.midiVoice=-1,this.audio_ready=!1,this.audible=!1,this.duration=4,this._last_beat=0,this._looped=-1,this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(G),this.root.adoptedStyleSheets.push(K);const e=document.createElement("template");e.innerHTML='<div class="code-view-wrapper">\n    <div class="buttons">\n        <button id="loader" class="hidden" title="Loading audio">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\n                <path d="M304 48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zm0 416a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM48 304a48 48 0 1 0 0-96 48 48 0 1 0 0 96zm464-48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM142.9 437A48 48 0 1 0 75 369.1 48 48 0 1 0 142.9 437zm0-294.2A48 48 0 1 0 75 75a48 48 0 1 0 67.9 67.9zM369.1 437A48 48 0 1 0 437 369.1 48 48 0 1 0 369.1 437z"/>\n            </svg>\n        </button>\n        <button id="play-button" class="hidden" title="Play Audio">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">\n                <path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/>\n            </svg>\n        </button>\n        <button id="pause-button" class="hidden">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">\n                <path d="M48 64C21.5 64 0 85.5 0 112V400c0 26.5 21.5 48 48 48H80c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H48zm192 0c-26.5 0-48 21.5-48 48V400c0 26.5 21.5 48 48 48h32c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H240z"/>\n            </svg>\n        </button>\n        <button id="stop-button" class="hidden">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">\n                <path d="M0 128C0 92.7 28.7 64 64 64H320c35.3 0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128z"/>\n            </svg>\n        </button>\n        <button id="copy-button" title="Copy to Clipboard">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">\n                <path d="M384 336H192c-8.8 0-16-7.2-16-16V64c0-8.8 7.2-16 16-16l140.1 0L400 115.9V320c0 8.8-7.2 16-16 16zM192 384H384c35.3 0 64-28.7 64-64V115.9c0-12.7-5.1-24.9-14.1-33.9L366.1 14.1c-9-9-21.2-14.1-33.9-14.1H192c-35.3 0-64 28.7-64 64V320c0 35.3 28.7 64 64 64zM64 128c-35.3 0-64 28.7-64 64V448c0 35.3 28.7 64 64 64H256c35.3 0 64-28.7 64-64V416H272v32c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192c0-8.8 7.2-16 16-16H96V128H64z"/>\n            </svg>\n        </button>\n    </div>\n    <pre class="line-numbers"><code id="code-view" class="language-python"></code></pre>\n    <div class="progress-bar hidden">\n        <div class="fill" style="width: 0"></div>\n    </div>\n    <footer>\n        <div id="status"></div>\n        <div id="error"></div>\n        <div id="beats"></div>\n        <div id="tempo"></div>\n        <div id="time"></div>\n        <div id="patch"></div>\n    </footer>\n</div>\n',this.root.appendChild(e.content.cloneNode(!0)),this.audio=v.init()}connectedCallback(){const e=this.root.querySelector(".code-view-wrapper"),s=this.root.querySelector("#code-view");this.code=this.root.host.innerHTML.trim(),this.code=this.code.split("\n").map((e=>"/"===e?"":e)).join("\n"),s&&e&&(s.innerHTML=this.code,t.highlightAllUnder(e)),this.audible&&this.compileCode(this.code),this.root.querySelector("#play-button")?.addEventListener("click",(e=>this.playAudio())),this.root.querySelector("#pause-button")?.addEventListener("click",(e=>this.pauseAudio())),this.root.querySelector("#stop-button")?.addEventListener("click",(e=>this.audio.stopAll())),this.root.querySelector("#copy-button")?.addEventListener("click",(e=>{navigator.clipboard.writeText(this.code)}))}cueAudio(e){this.trace&&this.synth.scheduleNotes(this.trace,this.audio.context.destination,e),this.trace&&this.midiOut&&a.outputs?.forEach((t=>{this.synth.setMidiProgram(t,this.midiVoice),this.synth.scheduleMidiNotes(this.trace,e,t)}))}playAudio(){this.trace&&(this.audio.play(this),this.cueAudio(-1*this.currentBeat),this.remainingBeats<=.5&&(this.cueAudio(this.remainingBeats),this._looped=this.currentBeat,this._last_beat=this.currentBeat),this.root.querySelector("#play-button")?.classList.add("hidden"),this.root.querySelector("#pause-button")?.classList.remove("hidden"),this.animation())}pauseAudio(){this.synth.cancelAllNotes(),this.audio.pause(this),this.midiOut&&a.outputs?.forEach((e=>{this.synth.cancelAllMidiNotes(e)})),this.root.querySelector("#play-button")?.classList.remove("hidden"),this.root.querySelector("#pause-button")?.classList.add("hidden")}stopAudio(){this.pauseAudio(),this.setFill(0),this._looped=-1,this._last_beat=0}async compileCode(e){W.init();const t={uuid:this.uuid,name:this.uuid,code:e};this.status();const s=await W.compile(t);this.trace=s.trace,this.duration=Math.ceil(s.trace.beats/this.audio.beatsPerMeasure)*this.audio.beatsPerMeasure,this.setHTML("#beats",`${this.duration} beats`),s.hasErrors&&(this.error=s.errors[0]),this.status()}disconnectedCallback(){}attributeChangedCallback(e,t,s){s!==t&&("patch"===e&&null!==s?(this.audible=!0,this.loadPatch(s)):"id"===e?(this.uuid=s,this.setHTML("#status",`${this.uuid} (python)`)):"tempo"===e&&null!==s?(this.audio.bpm=parseInt(s),this.synth.bpm=parseInt(s),this.setHTML("#tempo",`${this.synth.bpm} bpm`)):"time"===e&&null!==s?(this.audio.meter=s,this.setHTML("#time",`${this.audio.meter} time`)):"midi-out"===e?(this.midiOut="true"===s,this.midiOut&&a.init()):"midi-voice"===e&&(this.midiVoice=parseInt(s)))}async loadPatch(e){this.root.querySelector("#loader")?.classList.remove("hidden"),this.status(),await this.synth.loadPatch(e,this.audio.context),this.setHTML("#patch",this.synth.patch.name),this.audio_ready=!0,this.status()}animation(){this.audio.isPlaying(this)&&(this.setFill(this.percentBeats),this.remainingBeats<.5&&this._looped<0?(this._looped=this.currentBeat,this.cueAudio(this.remainingBeats)):this._looped>this.currentBeat?this._looped=-1:this._looped<0&&this._last_beat>this.currentBeat&&this.cueAudio(-1*this.currentBeat),this._last_beat=this.currentBeat,requestAnimationFrame((e=>{this.animation()})))}setFill(e){this.root.querySelector(".progress-bar .fill").style.width=100*e+"%"}status(){const e=this.root.querySelector("#status");e&&(this.error?(this.addClass("footer","error"),this.setHTML("#error",`${this.error.name} (line ${this.error.line})`),this.addClass("#loader","hidden")):this.audible&&(this.audio_ready&&this.trace?(e.innerHTML=`${this.uuid} (python)`,this.root.querySelector("#play-button")?.classList.remove("hidden"),this.root.querySelector("#stop-button")?.classList.remove("hidden"),this.root.querySelector(".progress-bar")?.classList.remove("hidden"),this.root.querySelector("#loader")?.classList.add("hidden")):this.audio_ready?e.innerHTML="Loading python...":this.trace?e.innerHTML="Loading audio...":e.innerHTML="Loading..."))}setHTML(e,t){const s=this.root.querySelector(e);s&&(s.innerHTML=t)}addClass(e,t){const s=this.root.querySelector(e);s&&s.classList.add(t)}removeClass(e,t){const s=this.root.querySelector(e);s&&s.classList.remove(t)}onClockReset(){this.stopAudio()}onClockTimeChange(){}onTempoChange(){}onTimeSignatureChange(){}}X.ELEMENT="tunepad-code",X.observedAttributes=["id","patch","tempo","time","midi-out","midi-voice"];const Y=new CSSStyleSheet;Y.replaceSync(".explore-wrapper {\n    width: 95%;\n    margin: 2rem auto;\n    padding: 1rem 0;\n    border-radius: 20px;\n    display: flex;\n    flex-direction: column;\n}\n#code-hint {\n    margin: 0rem 0.25rem 0 0;\n    padding: 0 1rem;\n    background: #0002;\n    height: 35px;\n    line-height: 35px;\n    border: 1px solid #887;\n    border-radius: 5px;\n    user-select: none;\n    box-sizing: border-box;\n    flex: 1;\n}\n.shelf {\n    display: flex;\n    margin: 1rem 4.5rem;\n}\n.keyboard-wrapper {\n    display: flex;\n}\n#copy-button {\n    color: #000a;\n    outline: none;\n    border: 1px solid #555;\n    height: 35px;\n    background-color: transparent;\n    border-radius: 5px;\n    font-weight: 500;\n    user-select: none;\n}\n#copy-button:hover { color: black; }\n#copy-button:active { color: rgb(45, 113, 134); }\npiano-instrument { flex: 1; }\n");class J extends HTMLElement{constructor(){super(),this.notes=new Set,this.chord=new Array,this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(Y);const e=document.createElement("template");e.innerHTML='<div class="explore-wrapper">\n    <div class="keyboard-wrapper">\n        <piano-instrument></piano-instrument> \n    </div>\n    <div class="shelf">\n        <pre id="code-hint"></pre>\n        <button id="copy-button" title="Copy Code">Copy to Clipboard</button>\n    </div>\n</div>',this.root.appendChild(e.content.cloneNode(!0))}connectedCallback(){const e=this.root.querySelector("piano-instrument");e?.addEventListener("note-on",(e=>{const t=new A(e.detail.note);this.addCodeHint(t)})),e?.addEventListener("note-off",(e=>{const t=new A(e.detail.note);this.removeCodeHint(t)})),e?.addEventListener("click",(e=>{const t=document.querySelector("#code-hint");t&&navigator.clipboard.writeText(t.innerHTML)}))}disconnectedCallback(){}attributeChangedCallback(e,t,s){s!==t&&this.root.querySelector("piano-instrument")?.setAttribute(e,s)}getCodeHint(){if(1===this.chord.length){const e=new A(this.chord[0]);return`playNote(${e.note})    # ${e.nameWithOctave}`}return this.chord.length>0?`playNote([ ${this.chord.join(", ")} ])`:""}addCodeHint(e){this.notes.add(e.note),this.chord=[...this.notes].sort();const t=this.root.getElementById("code-hint");t&&(t.innerHTML=this.getCodeHint())}removeCodeHint(e){this.notes.delete(e.note),0==this.notes.size&&(this.chord=[])}}return J.ELEMENT="note-explorer",J.observedAttributes=F.observedAttributes,customElements.define(F.ELEMENT,F),customElements.define(o.ELEMENT,o),customElements.define(J.ELEMENT,J),customElements.define(X.ELEMENT,X),e.CompileResponse=U,e.MIDIEvent=n,e.MIDIManager=a,e.MusicTrace=S,e.Note=A,e.PythonRuntime=W,e.Synthesizer=$,e.TraceEvent=T,e.TunePadAudio=v,e.clamp=y,e.dBToGain=p,e.dBToValue=f,e.gainToValue=function(e){return f(m(e))},e.gainTodB=m,e.mix=function(e,t,s){return e+s*(t-e)},e.toBool=u,e.toDateTime=function(e){return Date.parse(e)},e.toInt=c,e.toNum=l,e.toStr=d,e.valueToGain=b,e.valueTodB=g,e.veloctyToGain=function(e){return b(e/127)},e}({},Prism);
//# sourceMappingURL=tunepad.min.js.map
