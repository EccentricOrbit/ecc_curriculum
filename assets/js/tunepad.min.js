var tunepad=function(e){"use strict";const t=new CSSStyleSheet;t.replaceSync("/*\n@keyframes fade-out {\n    0% {\n        opacity: 1.0;\n    }\n\n    100% {\n        opacity: 0.0;\n    }\n}\n*/\n.instrument {\n    position: relative;\n    box-sizing: border-box;\n    display: flex;\n}\n\n.backdrop {\n    fill: #30303f;\n}\n\n.container {\n    width: 100%;\n}\n\n.piano-key.black {\n    fill: #1d1e1f;\n    stroke: #222;\n    stroke-width: 1.5;\n    rx: 1.5;\n}\n\n.piano-key.black .black-top {\n    fill: #444;\n}\n\n.piano-key.black:hover .black-top {\n    fill: #777;\n}\n\n.piano-key.black.pressed .black-top {\n    fill: #222;\n}\n\n.piano-key.white {\n    fill: #ecedee;\n    stroke: #f7f7f8;\n    stroke-width: 1.5;\n    rx: 1.4;\n}\n\n.piano-key.white:hover {\n    fill: #ccc;\n}\n\n.piano-key.white.pressed {\n    fill: #aaa;\n    stroke: #777;\n}\n/*\n.piano-key.white.pressed.step-0 { fill: rgb(229, 76, 78); }\n.piano-key.white.pressed.step-2 { fill: rgb(228, 171, 81); }\n.piano-key.white.pressed.step-4 { fill: rgb(223, 228, 78); }\n.piano-key.white.pressed.step-5 { fill: rgb(174, 215, 71); }\n.piano-key.white.pressed.step-7 { fill: rgb(63, 169, 180); }\n.piano-key.white.pressed.step-9 { fill: rgb(78, 69, 179); }\n.piano-key.white.pressed.step-11 { fill: rgb(202, 69, 147); }\n*/\n.note-hint,\n.midi-hint,\n.key-hint {\n    stroke: none;\n    font: 9pt sans-serif;\n    fill: #0006;\n    text-anchor: middle;\n    opacity: 0.0;\n    pointer-events: none;\n    user-select: none;\n}\n\n.midi-hint.black, .note-hint.black, .key-hint.black {\n    fill: #ccc;\n}\n.show {\n    opacity: 1.0;\n}\n\n.note-hint.always-show {\n    opacity: 1.0;\n}\n\n.felt {\n    fill: #a00;\n}\n\n.animated-slide {\n    transition: transform 0.5s ease-in-out;\n}\n\n.mini-piano {\n    opacity: 0.0;\n    transition: opacity 0.25s;\n}\n\n.mini-piano.show {\n    opacity: 1.0;\n}\n");const s={note:0,velocity:90,message:"note-on",source:"pointer"};class n{get customEvent(){return new CustomEvent(this.props.message,{bubbles:!0,composed:!0,detail:this.props})}constructor(e){this.props={...s,...e,time:Date.now()}}}class i{static init(){i.instance||(i.instance=new i)}static get ready(){return i.init(),void 0!==i.instance?.access}static get outputs(){return i.init(),i.instance?i.instance._outputs:void 0}get _outputs(){return this.access?this.access.outputs:void 0}static get inputs(){return i.init(),i.instance?i.instance._inputs:void 0}get _inputs(){return this.access?this.access.inputs:void 0}constructor(){navigator.requestMIDIAccess().then((e=>{this.access=e,console.log("Connected to MIDI."),e.addEventListener("statechange",(e=>this._midiConnection(e))),e.outputs.forEach((e=>e.open()))}),(()=>{console.log("Failed to initialize web MIDI.")}))}_midiConnection(e){const t=e.port;t&&("input"==t.type&&"connected"==t.state?t.onmidimessage=this._midiEvent:"output"==t.type&&"connected"==t.state&&t.open())}_midiEvent(e){if(e.data&&e.data.length>=2){let t=e.data[0]>>4,s=15&e.data[0],n=e.data[1],i=0;e.data.length>=3&&(i=e.data[2]),console.log(t,s,n,i)}}}class a extends HTMLElement{get minKey(){return 12*this.props.minOctave+12}get maxKey(){return 12*this.props.maxOctave+23}constructor(){super(),this.props={noteHints:!0,midiHints:!0,armed:!1,minOctave:0,maxOctave:7,keyRange:24,focusOctave:2},this.container=null,this.parent=document.createElementNS("http://www.w3.org/2000/svg","g"),this.allKeys=document.createElementNS("http://www.w3.org/2000/svg","g"),this.keys=[],this.width=700,this.height=190,this.key_map="awsedftgyhujkolp;']",this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(t)}connectedCallback(){const e=document.createElement("template");e.innerHTML='<div class="instrument"><svg class="container" version="1.1"></svg></div>',this.root.appendChild(e.content.cloneNode(!0)),this.container=this.root.querySelector("svg.container"),this.container?.append(this.parent),this.container?.setAttribute("viewBox",`0 0 ${this.props.keyRange*o.width} 190`),this.render(),document.addEventListener("keydown",(e=>this.onKeyDown(e))),document.addEventListener("keyup",(e=>this.onKeyUp(e)))}disconnectedCallback(){}attributeChangedCallback(e,t,s){switch(e){case"note-hints":this.setNoteHints("false"!=s);break;case"midi-hints":this.setMidiHints("false"!=s);break;case"armed":"false"==s?this.disarmKeyboard():this.armKeyboard();break;case"key-range":this.setKeyRange(parseInt(s));break;case"min-octave":this.setMinOctave(parseInt(s));break;case"max-octave":this.setMaxOctave(parseInt(s));break;case"focus-octave":this.setFocusOctave(parseInt(s))}}emitNoteOn(e,t,s=90){const i=new n({note:e,source:t,velocity:s,message:"note-on"});this.root.host.dispatchEvent(i.customEvent)}emitNoteOff(e,t){const s=new n({note:e,source:t,velocity:0,message:"note-off"});this.root.host.dispatchEvent(s.customEvent)}emitPitchBend(e,t){const s=new n({value:e,source:t,message:"pitch-bend"});this.root.host.dispatchEvent(s.customEvent)}noteOn(e,t=90){let s=this._noteToKey(e);s?.press()}noteOff(e){let t=this._noteToKey(e);t?.release()}allNotesOff(){this.keys.forEach((e=>e.release()))}isNoteOn(e){let t=this._noteToKey(e);return null!=t&&t.isPressed()}setKeyRange(e){isNaN(e)||(this.props.keyRange=Math.max(7,Math.min(e,56)),this.container?.setAttribute("viewBox",`0 0 ${this.props.keyRange*o.width} 190`))}setMinOctave(e){isNaN(e)||(e=Math.max(0,Math.min(6,e)))!=this.props.minOctave&&(this.props.minOctave=e,this.render())}setMaxOctave(e){isNaN(e)||(e=Math.max(1,Math.min(7,e)))!=this.props.maxOctave&&(this.props.maxOctave=e,this.render())}armKeyboard(){this.props.armed=!0,this.root.querySelectorAll(".key-hint").forEach((e=>{e.classList.add("show")}))}disarmKeyboard(){this.props.armed=!1,this.root.querySelectorAll(".key-hint").forEach((e=>{e.classList.remove("show")}))}get isKeyboardArmed(){return this.props.armed}getArmedKey(e){const t=12*(this.props.focusOctave-this.props.minOctave),s=this.key_map.indexOf(e.toLowerCase());return s>=0&&s+t<this.keys.length?this.keys[s+t]:null}onKeyDown(e){if(!(e.ctrlKey||e.metaKey||e.shiftKey||1==e.repeat)&&this.isKeyboardArmed){const t=this.getArmedKey(e.key.toLowerCase());t?(this.emitNoteOn(t.note,"keyboard"),t.press()):"ArrowLeft"==e.key?this.setFocusOctave(this.props.focusOctave-1):"ArrowRight"==e.key?this.setFocusOctave(this.props.focusOctave+1):"ArrowDown"==e.key?this.emitPitchBend(-200,"keyboard"):"ArrowUp"==e.key&&this.emitPitchBend(200,"keyboard")}}onKeyUp(e){if("ArrowUp"==e.key||"ArrowDown"==e.key)this.emitPitchBend(0,"keyboard");else{const t=this.getArmedKey(e.key.toLowerCase());t&&(this.emitNoteOff(t.note,"keyboard"),t.release())}}_noteToKey(e){const t=Math.round(e-12);return t>=0&&t>=this.keys.length?this.keys[t]:null}render(){if(null==this.container)return;this.parent.innerHTML="",this.keys=[];const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.classList.add("backdrop"),e.setAttribute("width","100%"),e.setAttribute("height","100%"),this.parent.append(e),this.allKeys.classList.add("animated-slide");const t=document.createElementNS("http://www.w3.org/2000/svg","g"),s=document.createElementNS("http://www.w3.org/2000/svg","g");for(let e=this.minKey;e<=this.maxKey;e++){const n=new o(e,this);this.keys.push(n),n.black?s.append(n.el):t.append(n.el)}this.allKeys.append(t),this.allKeys.append(s),this.parent.append(this.allKeys);const n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.classList.add("felt"),n.setAttribute("width","100%"),n.setAttribute("height","1.5"),n.setAttribute("x","0"),n.setAttribute("y","0"),this.parent.append(n),this.setFocusOctave(this.props.focusOctave)}setFocusOctave(e){this.props.focusOctave=Math.max(this.props.minOctave,Math.min(this.props.maxOctave,e));const t=12*(this.props.focusOctave-this.props.minOctave);if(!isNaN(e)&&null!=this.container&&(this.keys.forEach((e=>e.autoRelease())),t>=0&&t<this.keys.length)){const e=this.keys[t].x;this.allKeys.style.transform=`translateX(${-e}px)`,this.keys.forEach((e=>e.clearKeymap()));for(let e=0;e<this.key_map.length;e++){const s=t+e;s>=0&&s<this.keys.length&&this.keys[s].setKeymap(this.key_map[e])}}}setNoteHints(e){this.props.noteHints=e,this.root.querySelectorAll(".note-hint").forEach((t=>{t.classList.toggle("show",e)}))}get showNoteHints(){return this.props.noteHints}setMidiHints(e){this.props.midiHints=e,this.root.querySelectorAll(".midi-hint").forEach((t=>{t.classList.toggle("show",e)}))}get showMidiHints(){return this.props.midiHints}}a.observedAttributes=["note-hints","midi-hints","armed","min-octave","max-octave","key-range","focus-octave"],a.ELEMENT="piano-keyboard";class o{get step(){return this.note%12}get octave(){return Math.floor(this.note/12)-1}get name(){return`${o.NOTES[this.step]}`}get offset(){return 7*(this.octave-this.piano.props.minOctave)+this._key_offsets[this.step]}get x(){return this.offset*o.width}get black(){return[1,3,6,8,10].includes(this.step)}get white(){return!this.black}get height(){return this.black?130:195}constructor(e,t){this.keyHint=document.createElementNS("http://www.w3.org/2000/svg","text"),this._key_offsets=[0,.45,1,1.55,2,3,3.4,4,4.5,5,5.6,6],this._hint_offsets=[-8,0,0,0,8,-8,0,0,0,0,0,8],this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.rect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._down=!1,this.note=e,this.piano=t,this.el.setAttribute("transform",`translate(${this.x}, 0)`),this.el.classList.add("piano-key",`step-${this.step}`),this.el.classList.add(this.black?"black":"white");const s=this.black?10:1.5;let n=s,i=o.width-2*s;if(this.rect.setAttribute("x",`${n}`),this.rect.setAttribute("y","-8"),this.rect.setAttribute("width",`${i}`),this.rect.setAttribute("height",`${this.height}`),this.rect.setAttribute("rx","3"),this.el.append(this.rect),this.black){n+=3,i-=6;const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.classList.add("black-top"),e.setAttribute("x",`${n}`),e.setAttribute("y","-5"),e.setAttribute("width",`${i}`),e.setAttribute("height",""+(this.height-20)),e.setAttribute("pointer-events","none"),this.el.append(e)}else{const e=document.createElementNS("http://www.w3.org/2000/svg","text");e.classList.add("note-hint"),e.setAttribute("x",`${n+i/2}`),e.setAttribute("y",""+(this.height-17)),e.innerHTML=`${this.name}${this.octave}`,this.piano.showNoteHints&&e.classList.add("show"),0==this.step&&e.classList.add("always-show"),this.el.append(e)}const a=document.createElementNS("http://www.w3.org/2000/svg","text");a.classList.add("midi-hint"),this.black&&a.classList.add("black"),a.setAttribute("x",`${n+i/2}`),a.setAttribute("y",""+(this.height-35)),a.innerHTML=`${this.note}`,this.piano.showMidiHints&&a.classList.add("show"),this.el.append(a);let r=n+i/2+this._hint_offsets[this.step];this.keyHint.classList.add("key-hint"),this.black&&this.keyHint.classList.add("black"),this.keyHint.setAttribute("x",`${r}`),this.keyHint.setAttribute("y",this.black?"45":"60"),this.piano.isKeyboardArmed&&this.keyHint.classList.add("show"),this.el.append(this.keyHint),this.el.addEventListener("pointerdown",(e=>{this.piano.emitNoteOn(this.note,"pointer"),this.press(),e.stopPropagation()})),this.el.addEventListener("pointerup",(e=>{this.piano.emitNoteOff(this.note,"pointer"),this.release()})),this.el.addEventListener("pointerleave",(e=>{this._down&&(this.piano.emitNoteOff(this.note,"pointer"),this.release())})),this.el.addEventListener("pointerenter",(e=>{e.buttons>0&&(this.piano.emitNoteOn(this.note,"pointer"),this.press())}))}press(){this._down=!0,this.el.classList.add("pressed")}release(){this._down&&(this._down=!1,this.el.classList.remove("pressed"))}isPressed(){return this.el.classList.contains("pressed")}autoRelease(){this._down&&(this.piano.emitNoteOff(this.note,"system"),this._down=!1,this.el.classList.remove("pressed"))}setKeymap(e){this.keyHint.innerHTML=e}clearKeymap(){this.keyHint.innerHTML=""}}o.NOTES=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],o.width=45;const r=new CSSStyleSheet;r.replaceSync("\n.piano-wrapper {\n    width: 100%;\n    margin: 0 auto;\n    padding: 1rem 0;\n    background-color: black;\n    border-radius: 10px;\n    display: flex;\n}\n\npiano-keyboard { flex: 1; }\n.octave-button {\n    background-color: transparent;\n    border: none;\n    outline: none;\n    color: #fffc;\n    font-size: 200%;\n    user-select: none;\n}\n.octave-button:hover { color: #fff; }\n.octave-button:active { color: rgb(121, 216, 245); }\n");function h(e,t=0){const s=parseInt(e);return isNaN(s)?t:s}function c(e,t=0){const s=parseFloat(e);return isNaN(s)?t:s}function l(e,t=!1){if(null==e)return t;if("boolean"==typeof e)return e;{const t=e.toString().toLowerCase();if("true"===t||"t"===t)return!0;if("false"===t||"f"===t)return!1}return t}function d(e,t=""){return e?e.toString():t}function u(e){return Math.max(0,Math.pow(10,e/20))}function p(e){return 20*Math.log(e)/Math.LN10}function m(e){return Math.pow(10,e/20)/1.78}function g(e){return 20*Math.log(1.78*e)/Math.LN10}function f(e){return u(g(e))}function y(e,t,s){return Math.max(t,Math.min(s,e))}class v{get bpm(){return this._bpm}set bpm(e){this.setTempo(e)}get meter(){return this._meter}set meter(e){this.setTimeSignature(e)}get beatsPerMeasure(){return this._beatsPerMeasure}get beatValue(){return this._beatValue}get key(){return this._key}set key(e){this._key=e}get contextTime(){return this.context.currentTime}get time(){return this.isPaused?this._start:this.contextTime-this._start}get timeString(){let e=""+Math.floor(this.time/60)%60,t=""+Math.round(this.time)%60,s=""+Math.floor(100*this.time)%100;return 1==e.length&&(e=`0${e}`),1==t.length&&(t=`0${t}`),1==s.length&&(s=`0${s}`),`${e}:${t}.${s}`}get beats(){return this.time*this.bpm/60+this._elapsedBeats}get isPaused(){return 0==this._subscribers.size}static init(){return null==v._instance&&(v._instance=new v),v._instance}constructor(){this._start=0,this._elapsedBeats=0,this._bpm=90,this._meter="4/4",this._beatsPerMeasure=4,this._beatValue=4,this._key="C major",this._subscribers=new Set,this._listeners=new Set,this.context=new AudioContext,this._metronomes=new Set,this._timer=-1}addSubscriber(e){this._listeners.add(e)}removeSubscriber(e){this._listeners.delete(e)}isPlaying(e){return this._subscribers.has(e)}play(e){this.isPaused&&(this._start=this.contextTime-this._start),this._subscribers.add(e),this._listeners.add(e)}pause(e){this._listeners.add(e),this.isPlaying(e)&&(this._subscribers.delete(e),this.isPaused&&(this._start=this.contextTime-this._start))}stopAll(){this._elapsedBeats=0,this._start=0,this._subscribers.clear(),this._listeners.forEach((e=>e.onClockReset()))}setTime(e){this._elapsedBeats=e,this._start=0,this._listeners.forEach((e=>e.onClockTimeChange())),this._subscribers.clear()}setTempo(e){if(isNaN(e))return;const t=this.beats;e!=this._bpm&&(this._bpm=Math.max(5,e),this._start=this.contextTime-60*t/this._bpm,this._listeners.forEach((e=>e.onTempoChange())))}setTimeSignature(e){2!=e.split("/").length&&(e="4/4"),this._beatsPerMeasure=h(e.split("/")[0],-1),this._beatValue=h(e.split("/")[1],-1),(this._beatsPerMeasure<0||this._beatValue<0)&&(this._beatsPerMeasure=4,this._beatValue=4);const t=`${this._beatsPerMeasure}/${this._beatValue}`;this._meter!=t&&(this._meter=t,this._listeners.forEach((e=>e.onTimeSignatureChange())))}startMetronome(e){if(this._metronomes.add(e),-1==this._timer){const e=this.contextTime;let t=0;this._metronomes.forEach((e=>e.pulse(0))),this._timer=window.setInterval((()=>{if(0==this._metronomes.size)window.clearInterval(this._timer),this._timer=-1;else{const s=60/this.bpm,n=this.contextTime-e,i=Math.floor(n/s)%this.beatsPerMeasure;i!=t&&(t=i,this._metronomes.forEach((e=>e.pulse(t))))}}),30)}}stopMetronome(e){this._metronomes.delete(e)}isMetronomePlaying(e){return this._metronomes.has(e)}}const b=16.3516,w=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],_=["rgb(229, 76, 78)","rgb(223, 132, 74)","rgb(228, 171, 81)","rgb(227, 199, 73)","rgb(223, 228, 78)","rgb(174, 215, 71)","rgb(63, 188, 70)","rgb(63, 169, 180)","rgb(64, 124, 180)","rgb(78, 69, 179)","rgb(141, 69, 183)","rgb(202, 69, 147)"];class k{get note(){return this._note}set note(e){this._note=e}get end(){return this.start+this.duration}get octave(){return Math.floor(this.note/12)}set octave(e){this.note=12*e+this.step}get step(){return this.note%12}set step(e){this.note=12*this.octave+e}get cents(){return Math.round(100*(this.note-Math.floor(this.note)))}get velocity(){return this._velocity}set velocity(e){this._velocity=C(e,0,127)}get gain(){return this.velocity*this.velocity/16129}set gain(e){this.velocity=Math.sqrt(127*e*127)}get name(){return`${w[Math.floor(this.step)]}`}get accidental(){return this.name.substring(1)}get nameWithOctave(){return`${w[Math.round(this.step)]}${this.octave-1}`}get stepColor(){return _[Math.round(this.step)%_.length]}get rate(){return Math.pow(2,this.note/12)}get frequency(){return b*this.rate}set frequency(e){e>0&&(this.note=12*Math.log(e/b)/Math.LN2)}constructor(e){this._note=60,this.start=0,this.duration=1,this._velocity=90,this.note=e}isEqual(e){return this.note===e.note&&this.start===e.start&&this.duration===e.duration&&this.velocity===e.velocity}clone(){let e=new k(this.note);return e.start=this.start,e.duration=this.duration,e.velocity=this.velocity,e}static fromName(e){const t=new k(60);return t.octave=k.nameToOctave(e),t.step=k.nameToStep(e),t}static fromFrequency(e){const t=new k(60);return t.frequency=e,t}static nameToOctave(e){if(2==e.length){let t=e.codePointAt(1);if(t)return C(t-48,0,8)}else if(e.length>2){let t=e.codePointAt(2);if(t)return C(t-48,0,8)}return 0}static nameToStep(e){return null==e||""==e?0:(e=e.length<=2?e[0].toUpperCase():e.substring(0,2).toUpperCase(),Math.max(0,w.indexOf(e)))}static nameToNote(e){if(e.length<2||e.length>3)return-1;e=e.replaceAll("#","♯");for(let t=0;t<12;t++)if(e.startsWith(w[t])){const s=e.substring(w[t].length);if(["0","1","2","3","4","5","6","7","8"].includes(s)){let e=s.codePointAt(0);return 12*((e||48)-48)+t}}return-1}}function C(e,t,s){return Math.max(t,Math.min(s,e))}class x{get length(){return this.trace.length}get isEmpty(){return 0===this.length}get beats(){return this._beats}get minNote(){return this._minNote}get minOctave(){return Math.max(0,Math.floor(this._minNote/12))}get maxNote(){return this._maxNote}get maxOctave(){return Math.max(0,Math.floor(this._minNote/12))}get noteRange(){return this.maxNote-this.minNote}get octaveRange(){return this.maxOctave-this.minOctave}get noteCount(){return this._noteCount}constructor(){this.trace=new Array,this._beats=0,this._playhead=0,this._minNote=-1,this._maxNote=-1,this._noteCount=0}clear(){this.trace=[],this._beats=0,this._minNote=-1,this._maxNote=-1,this._noteCount=0,this._playhead=0}fromPython(e){for(let t of e)this.addTraceEvent(t)}getMessages(){return this.trace.filter((e=>"message"===e.command)).map((e=>Object.fromEntries(e.params)))}isEquivalent(e){if(this.length!==e.length)return!1;for(let t=0;t<this.length;t++)if(!this.trace[t].isEquivalent(e.trace[t]))return!1;return!0}addTraceEvent(e){this._addTraceEvent(A.fromMap(e))}_addTraceEvent(e){switch(this.trace.push(e),e.command){case A.PLAY:this._beats=Math.max(e.end,this._beats),this._playhead=e.end,(this._minNote<0||e.note.note<this._minNote)&&(this._minNote=e.note.note),this._maxNote=Math.max(this._maxNote,e.note.note),this._noteCount++;break;case A.SOUND:this._beats=Math.max(e.end,this._beats),this._playhead=e.end,this._noteCount++;break;case A.REST:this._beats=Math.max(e.end,this._beats),this._playhead=e.end}}getTraceGroup(e){return this.trace.filter((t=>t.trace_group===e))}}class A{get end(){return this.time+this.duration}constructor(e,t){this.time=0,this.duration=1,this.line=-1,this.note=new k(60),this.trace_group=-1,this.params=new Map,this.id=A._TRACE_ID++,this.command=e,this.time=t}clone(){let e=new A(this.command,this.time);e.line=this.line,e.duration=this.duration,e.note=this.note.clone();for(let[t,s]of this.params)e.params.set(t,s);return e}static fromMap(e){let t=new A(String(e.get("command")),Math.max(0,Number(e.get("time"))));t.duration=Number(e.get("duration")),t.note.duration=t.duration;for(let[s,n]of e)if("note"===s&&"number"==typeof n)t.note.note=n;else if("pitch"===s&&"number"==typeof n)t.note.note=n+60;else if("velocity"===s&&"number"==typeof n)t.note.velocity=n;else if("sustain"===s&&"number"==typeof n)t.note.duration=Math.max(t.note.duration,n),t.duration=t.note.duration;else if("line"===s&&"number"==typeof n)t.line=n;else if("trace"===s)t.trace_group=n;else{if(["command","time","duration"].includes(s))continue;t.params.set(s,n)}return t}isEquivalent(e){if(this.command===e.command&&this.time===e.time&&this.duration===e.duration&&this.note.isEqual(e.note)){for(let[t,s]of this.params)if("line"!==t&&e.params.get(t)!==s)return!1;return!0}return!1}}A.PLAY="play",A.SOUND="sound",A.REST="rest",A.PUSH_FX="push_fx",A.POP_FX="pop_fx",A.MESSAGE="message",A._TRACE_ID=0;class M{constructor(e,t){this.released=!1,this.canceled=!1,this.note=e,this.chain=t}}class T{constructor(e,t,s){this.value=1,this.gain=new GainNode(e),this.name=t,this.value=s,this.gain.gain.value=s}connect(e,t){return t==this.name&&(e.level.connect(this.gain),!0)}destroy(){this.gain.disconnect()}updateParameter(e,t){return e==`${this.name}-mod}`&&(this.value=c(t,this.value),this.gain.gain.value=this.value,!0)}}class S{constructor(e,t){this.id=0,this.modulators=new Array,this.connectors=new Array,this.context=e,this.id=parseInt(t.id),this.level=e.createGain();const s=c(t.level,0);this.level.gain?.setValueAtTime(u(s),0),this.level.gain.value=u(s),this.addModulator("gain",c(t["gain-mod"],1),this.level.gain)}connect(e,t){for(let s of this.modulators)if(s.connect(e,t))return;"level"==t?e.level.connect(this.level.gain):e.level.connect(this.level)}addConnector(e){this.connectors.push(e),this.level?.connect(e.level)}addModulator(e,t,s){const n=new T(this.context,e,t);n.gain.connect(s),this.modulators.push(n)}playNote(e){}releaseNote(){}scheduleNote(e,t,s,n){}cancelNotes(){}destroy(){this.level.disconnect(),this.modulators.forEach((e=>e.destroy())),this.connectors.forEach((e=>e.destroy()))}pitchBend(e){}schedulePitchBend(e,t){}updateParameter(e,t){for(let s of this.modulators)if(s.updateParameter(e,t))return;if("level"==e){const e=c(t,0);this.level.gain?.setValueAtTime(u(e),0),this.level.gain.value=u(e)}}updateConnectorLevel(e,t){this.connectors.forEach((s=>{s.id==e&&s.updateLevel(t)}))}attachAnalyzer(e,t,s){for(let n of this.connectors)n.id==e&&n.attachAnalyzer(t,s)}detachAnalyzer(e){this.connectors.forEach((t=>{t.id==e&&t.detachAnalyzer()}))}getFloatTimeDomainData(e,t,s){this.connectors.forEach((n=>{n.id==e&&n.getFloatTimeDomainData(t,s)}))}}class E extends S{constructor(e,t){super(e,t),this.A=.1,this.D=.1,this.S=1,this.R=.2,this.aShape=5,this.dShape=2,this.rShape=2,this.attackCurve=[],this.decayCurve=[],this.releaseCurve=[],this.A=c(t.A,this.A),this.D=c(t.D,this.D),this.S=c(t.S,this.S),this.R=c(t.R,this.R),this.R=Math.max(this.R,.01),this.aShape=c(t["a shape"],this.aShape),this.dShape=c(t["d shape"],this.dShape),this.rShape=c(t["r shape"],this.rShape),this._attack=e.createGain(),this._decay=e.createGain(),this._release=e.createGain(),this._attack.gain.value=0,this._decay.gain.value=1,this._release.gain.value=1,this._attack.connect(this._decay),this._decay.connect(this._release),this._release.connect(this.level),this._buildCurves()}connect(e,t){e.level.connect(this._attack)}playNote(e){let t=this.context.currentTime;try{this._attack.gain?.cancelScheduledValues(0),this._decay.gain?.cancelScheduledValues(0),this._release.gain?.cancelScheduledValues(0),this.A>0?this._attack.gain?.setValueAtTime(0,t):this._attack.gain?.setValueAtTime(1,t),this._decay.gain?.setValueAtTime(1,t),this._release.gain?.setValueAtTime(1,t),t=this.context.currentTime+.01,this.A>0?this._attack.gain?.setValueCurveAtTime(this.attackCurve,t,this.A):this._attack.gain?.setValueAtTime(1,t),this.D>0?this._decay.gain?.setValueCurveAtTime(this.decayCurve,t+this.A,this.D):this._decay.gain?.setValueAtTime(this.S,t+this.A)}catch(e){console.log("Exception in ADSR playNote $x.")}}releaseNote(){const e=this.context.currentTime;this.R>0?(this._attack.gain?.cancelScheduledValues(e),this._decay.gain?.cancelScheduledValues(e),this._release.gain?.setValueCurveAtTime(this.releaseCurve,e,this.R)):this._release.gain?.setValueAtTime(0,e)}scheduleNote(e,t,s,n){const i=t<0?-t:0;let a=(t=t<0?0:t)+this.context.currentTime;if(this.A>0?this._attack.gain?.setValueAtTime(0,a):this._attack.gain?.setValueAtTime(1,a),this._decay.gain?.setValueAtTime(1,a),this._release.gain?.setValueAtTime(1,a),a+=.01,this.A>0&&this.A>i){const e=this.A-i;this._attack.gain?.setValueCurveAtTime(this.attackCurve,a,e)}else this._attack.gain?.setValueAtTime(1,a);if(this.D>0&&this.A+this.D>i&&s>this.A){const e=i>=this.A?this.D-(i-this.A):this.D,t=i>=this.A?a:a+this.A-i;this._decay.gain?.setValueCurveAtTime(this.decayCurve,t,e),this.A+this.D>s&&this._decay.gain?.cancelScheduledValues(a+s-i)}else this._decay.gain?.setValueAtTime(this.S,Math.max(0,a+this.A+this.D-i));if(s+this.R>i){const e=i>=s?this.R-(i-s):this.R;this._release.gain?.setValueCurveAtTime(this.releaseCurve,a+s-i,e)}else this._release.gain?.setValueAtTime(0,a)}cancelNotes(){super.cancelNotes();const e=this.context.currentTime;this._release.gain?.cancelScheduledValues(e),this._release.gain.value=0,this._attack.gain?.cancelScheduledValues(e),this._attack.gain.value=0,this._decay.gain?.cancelScheduledValues(e),this._decay.gain.value=0}destroy(){super.destroy(),this._attack.disconnect(),this._decay.disconnect(),this._release.disconnect()}updateParameter(e,t){switch(super.updateParameter(e,t),e){case"A":this.A=c(t,this.A);break;case"D":this.D=c(t,this.D);break;case"S":this.S=c(t,this.S);break;case"R":this.R=c(t,this.R);break;case"a shape":this.aShape=c(t,this.aShape);break;case"d shape":this.dShape=c(t,this.dShape);break;case"r shape":this.rShape=c(t,this.rShape)}this.R=Math.max(this.R,.01),this._buildCurves()}_buildCurves(){this._buildAttackCurve(this.aShape),this._buildDecayCurve(this.dShape),this._buildReleaseCurve(this.rShape)}_buildAttackCurve(e){e=y(e,.001,8),this.attackCurve=[];const t=Math.ceil(E.samplesPerSecond*this.A);if(t>0)for(let s=0;s<=t;s++){let n=s/t;n=Math.pow(n,e),this.attackCurve.push(n)}}_buildDecayCurve(e){e=y(e,.001,4),this.decayCurve=[];const t=Math.ceil(E.samplesPerSecond*this.D);if(t>0)for(let s=0;s<=t;s++){let n=s/t;n=1-Math.pow(n,e),this.decayCurve.push((1-this.S)*n+this.S)}}_buildReleaseCurve(e){e=y(e,.001,4),this.releaseCurve=[];const t=Math.ceil(E.samplesPerSecond*this.R);if(t>0)for(let s=0;s<=t;s++){let n=s/t;n=1-Math.pow(n,e),this.releaseCurve.push(n)}}}E.samplesPerSecond=300;class L{get context(){return this.source.context}constructor(e,t){this.id=0,this.dB=0,this._pre=null,this._analyzers=new Array,this._splitter=null,this._merger=null,this._buffer=null,this.type="",this.source=e,this.id=h(t.id,-1),this.level=new GainNode(this.context),this.dB=c(t.level,0),this.level.gain?.setValueAtTime(u(this.dB),0),this.type=d(t.type,"")}updateLevel(e){this.dB=e,(this._pre??this.level).gain?.setValueAtTime(u(e),0)}destroy(){this.level.disconnect()}attachAnalyzer(e,t,s=-60,n=5){t=y(t,1,6),this._pre=new GainNode(this.context),this._splitter=this.context.createChannelSplitter(t),this._merger=this.context.createChannelMerger(t),this._pre.gain?.setValueAtTime(u(this.dB),0),this.level.gain?.setValueAtTime(1,0),this.source.level.disconnect(this.level),this.source.level.connect(this._pre),this._pre?.connect(this._splitter),this._merger?.connect(this.level);for(let i=0;i<t;i++){let t=new AnalyserNode(this.level.context);this._analyzers.push(t),t.fftSize=e,t.minDecibels=s,t.maxDecibels=n,this._splitter?.connect(t,i,0),t.connect(this._merger,0,i),0==i&&(this._buffer=new Float32Array(t.frequencyBinCount))}}detachAnalyzer(){if(null!=this._pre){this.level.gain?.setValueAtTime(u(this.dB),0),this.source.level.disconnect(this._pre),this._pre?.disconnect(),this._splitter?.disconnect(),this._merger?.disconnect();for(let e of this._analyzers)e.disconnect();this.source.level.connect(this.level),this._pre=null,this._buffer=null,this._splitter=null,this._merger=null,this._analyzers=[]}}getFloatTimeDomainData(e,t){if(e<this._analyzers.length){const s=this._analyzers[e];if(null!=this._buffer&&t.length==this._buffer.length){s.getFloatTimeDomainData(this._buffer);for(let e=0;e<t.length;e++)t[e]+=this._buffer[e]}}}}class N extends S{constructor(e,t){super(e,t),this.tracking=!0,this.ratio=1,this.frequency=350,this.Q=1,this.gain=0,this.detune=0,this.type="lowpass",this.filter=e.createBiquadFilter(),this.filter.connect(this.level),this.Q=y(c(t.Q,1),1e-4,1e3),this.gain=y(c(t.gain,0),-40,40),this.type=d(t["filter type"],"lowpass"),this.detune=c(t.detune,0),this.frequency=y(c(t.frequency,350),0,16700),this.tracking=l(t.tracking,!0),this.ratio=c(t["tracking ratio"],1),this.addModulator("Q",c(t["Q-mod"],1),this.filter.Q),this.addModulator("gain",c(t["gain-mod"],5),this.filter.gain),this.addModulator("frequency",c(t["frequency-mod"],1e3),this.filter.frequency),this.filter.Q.value=this.Q,this.filter.gain.value=this.gain,this.filter.type=this.type,this.filter.detune.value=this.detune,this.filter.frequency.value=this.frequency}playNote(e){const t=this.tracking?e.frequency*this.ratio+this.frequency:this.frequency,s=this.context.currentTime;this.filter.Q?.setValueAtTime(this.Q,s),this.filter.gain?.setValueAtTime(this.gain,s),this.filter.detune?.setValueAtTime(this.detune,s),this.filter.frequency?.setValueAtTime(t,s)}scheduleNote(e,t,s,n){t=t<0?0:t;const i=this.context.currentTime,a=this.tracking?e.frequency*this.ratio+this.frequency:this.frequency;this.filter.Q?.setValueAtTime(this.Q,t+i),this.filter.gain?.setValueAtTime(this.gain,t+i),this.filter.detune?.setValueAtTime(this.detune,t+i),this.filter.frequency?.setValueAtTime(a,t+i)}cancelNotes(){super.cancelNotes(),this.filter.Q?.cancelScheduledValues(0),this.filter.gain?.cancelScheduledValues(0),this.filter.detune?.cancelScheduledValues(0),this.filter.frequency?.cancelScheduledValues(0)}destroy(){super.destroy(),this.filter.disconnect()}connect(e,t){"audio"===t?e.level.connect(this.filter):super.connect(e,t)}updateParameter(e,t){const s=this.context.currentTime;"filter type"===e&&N.FILTERS.includes(t)?(this.type=d(t,"lowpass"),this.filter.type=this.type):"Q"===e?(this.Q=y(c(t,this.Q),1e-4,1e3),this.filter.Q.cancelScheduledValues(0),this.filter.Q.setValueAtTime(this.Q,s),this.filter.Q.value=this.Q):"gain"===e?(this.gain=y(c(t,this.gain),-40,40),this.filter.gain.cancelScheduledValues(0),this.filter.gain.setValueAtTime(this.gain,s),this.filter.gain.value=this.gain):"detune"===e?(this.detune=c(t,this.detune),this.filter.detune?.cancelScheduledValues(0),this.filter.detune?.setValueAtTime(this.detune,s)):"frequency"===e?(this.frequency=y(c(t,this.frequency),0,16700),this.filter.frequency?.cancelScheduledValues(0),this.filter.frequency?.setValueAtTime(this.frequency,s),this.filter.frequency.value=this.frequency):"tracking"===e?this.tracking=l(t,this.tracking):"ratio"===e?this.ratio=c(t,this.ratio):super.updateParameter(e,t)}}N.FILTERS=["lowpass","highpass","bandpass","allpass","lowshelf","highshelf","peaking","notch","allpass"];class q extends S{constructor(e,t){super(e,t),this.frequency=440,this.multiplier=1,this.detune=0,this.relative=!0,this.waveform="sine",this.waveform=d(t.waveform,"sine"),this.frequency=c(t.frequency,this.frequency),this.detune=c(t.detune,0),this.relative=l(t.relative,!0),this.multiplier=c(t.multiplier,this.multiplier),this.osc=e.createOscillator(),this.gain=new GainNode(e),this.shaper=e.createWaveShaper(),this.addModulator("detune",c(t["detune-mod"],500),this.osc.detune),this.addModulator("frequency",c(t["frequency-mod"],1e3),this.osc.frequency),this.addModulator("amplitude",c(t["amplitude-mod"],1),this.level.gain),this.gain.gain.value=.3,q.Waveforms.includes(this.waveform)||(this.waveform="sine"),this.osc.frequency.setValueAtTime(90,0),this.osc.type="sine",this.osc.start(),this.osc.connect(this.gain),this.shaper.connect(this.gain),this.gain.connect(this.level),this._updateWaveform(this.waveform)}_updateWaveform(e){q.Waveforms.includes(e)&&(this.waveform=e),this.osc.type="sine",q.BasicWaveforms.includes(e)?(this.osc.type=e,this.osc.disconnect(),this.osc.connect(this.gain)):q.PeriodicWaveforms.includes(e)?(this.osc.setPeriodicWave(this._createPeriodicWave(e)),this.osc.disconnect(),this.osc.connect(this.gain)):q.ShaperWaveforms.includes(e)&&(this.shaper.curve=this._createWaveShaper(e),this.osc.disconnect(),this.osc.connect(this.shaper),this.osc.type="pitched noise"===e?"sawtooth":"sine")}_createWaveShaper(e){var t,s=new Float32Array(256);switch(e){case"exp sin":t=e=>Math.pow(e,5);break;case"hump":t=e=>(e<0?0:e)-.5;break;default:t=e=>2*Math.random()-1}for(let e=0;e<s.length;e++)s[e]=t(2*e/s.length-1);return s}_createPeriodicWave(e){let t=new Array;switch(e){case"cello":t=[0,1,.5,.3,.5,.35,.2,.2,.1,.15,.15,.15];break;case"flute":t=[0,.5,.05,.3,.1];break;case"reed":t=[-.15,.5,1,.4,.6,.3,.25,.2];break;case"brass":t=[0,.8,.8,.85,.9,.8,.85,.7,.6,.4,.3,.25,.2,.1];break;case"glass":t=[0,1,0,.25,0,.5,0,.75,0,.8];break;case"vibraphone":t=[0,6,19,.8,13,3];break;case"camel":t.push(0);for(let e=1;e<20;e++)t.push(1/Math.pow(e,2));break;case"soft saw":t.push(-.1);for(let e=1;e<20;e++)t.push(1/e);break;case"soft square":t.push(0);for(let e=1;e<50;e++)t.push(1/e*(e%2));break;case"organ 1":t=[-.1,1,1,1];break;case"organ 2":t=[-.1,1,1,1,0,0,0,0,0,.8];break;case"organ 3":t=[0,1,0,0,0,0,.8,.8,.8,.8];break;case"buzz 1":t.push(0);let e=1;for(let s=1;s<100;s++)s%3==0||s%4==0?(t.push(1/e),e++):t.push(0);break;default:t.push(0),e=1;for(let s=1;s<100;s++)s%5==0||s%2==0?(t.push(.5/e),e++):t.push(0)}return this.osc.context.createPeriodicWave(t,new Float32Array(t.length))}playNote(e){let t=this.relative?e.frequency*this.multiplier:this.frequency;t=y(t,0,23999),this.osc.frequency?.setValueAtTime(t,this.context.currentTime),this.osc.detune?.setValueAtTime(this.detune,this.context.currentTime)}scheduleNote(e,t,s,n){t=t<0?0:t;let i=this.relative?e.frequency*this.multiplier:this.frequency;i=y(i,0,23999),this.osc.frequency?.setValueAtTime(i,t+this.context.currentTime),this.osc.detune?.setValueAtTime(this.detune,t+this.context.currentTime)}cancelNotes(){super.cancelNotes(),this.osc.frequency?.cancelScheduledValues(0),this.osc.detune?.cancelScheduledValues(0)}destroy(){super.destroy(),this.osc.stop(),this.osc.disconnect(),this.gain.disconnect(),this.shaper.disconnect()}pitchBend(e){const t=this.context.currentTime;this.osc.detune?.setTargetAtTime(this.detune+e,t,.1)}schedulePitchBend(e,t){t.apply(this.osc.detune,e,this.context,this.detune)}updateParameter(e,t){if("waveform"===e)this._updateWaveform(t);else if("relative"==e)this.relative=l(t,!0);else if("frequency"==e)this.frequency=c(t,this.frequency),this.osc.frequency?.setValueAtTime(this.frequency,this.context.currentTime);else if("multiplier"==e)if(this.relative){let e=this.osc.frequency.value/this.multiplier;this.multiplier=c(t,this.multiplier),this.multiplier>0&&(e*=this.multiplier),e=y(e,0,23999),this.osc.frequency?.setValueAtTime(e,this.context.currentTime)}else this.multiplier=c(t,this.multiplier);else"detune"==e?(this.detune=c(t,this.detune),this.osc.detune?.setValueAtTime(this.detune,this.context.currentTime)):super.updateParameter(e,t)}}q.BasicWaveforms=["sine","square","triangle","sawtooth"],q.PeriodicWaveforms=["cello","flute","reed","brass","glass","vibraphone","camel","organ 1","organ 2","organ 3","soft saw","soft square","buzz 1","buzz 2"],q.ShaperWaveforms=["pitched noise","exp sin","hump"],q.Waveforms=[...q.BasicWaveforms,...q.PeriodicWaveforms,...q.ShaperWaveforms];class H extends E{constructor(e,t){super(e,t)}}class V{constructor(){}static hasSound(e){return V.sounds.has(e)}static getAudioBuffer(e){return V.sounds.get(e)}static async loadAudioBuffer(e){const t=V.context;if(V.hasSound(e))return!0;const s=V.supportsAudioType("audio/ogg")?`${e}.ogg`:`${e}.wav`;try{let n=await fetch(s),i=await n.arrayBuffer(),a=await t.decodeAudioData(i);return V.sounds.set(e,a),!0}catch(e){return console.log(e),!1}}static async loadCustomSound(e){if(V.hasSound(e))return!0;const t=V.context;try{let s=await fetch(e),n=await s.arrayBuffer(),i=await t.decodeAudioData(n);return V.sounds.set(e,i),console.log("Loaded "+e),!0}catch(e){return console.log(e),!1}}static supportsAudioType(e){if(V._supports.has(e))return V._supports.get(e);let t=!1;const s=document.createElement("audio");return s.id="test-audio-node",document.body.append(s),"probably"!=s.canPlayType(e)&&"maybe"!=s.canPlayType(e)||(t=!0,document.querySelector("#test-audio-node")?.remove()),V._supports.set(e,t),t}}function P(e){return"object"==typeof e&&"sample"in e&&"string"==typeof e.sample&&"step"in e&&"number"==typeof e.step}V.sounds=new Map,V.context=v.init().context,V._supports=new Map;class B extends S{constructor(e,t){super(e,t),this.sources=new Array,this.playback=1,this.detune=0,this.sample_pack="piano",this.samples=new Array,this._rate=1,this.drumkit=!1,this.playback=c(t.playback,this.playback),this.detune=c(t.detune,this.detune),this.sample_pack=d(t["sample-pack"],this.sample_pack),this.dIn=new GainNode(e),this.pIn=new GainNode(e),this.dIn.gain.value=c(t["detune-mod"],1),this.pIn.gain.value=c(t["playback-mod"],1),"samples"in t&&Array.isArray(t.samples)&&this.loadSamplePack(t.samples)}loadSamplePack(e){this.samples=e.filter((e=>P(e))).sort(((e,t)=>e.step-t.step)),this.samples.forEach((e=>V.loadAudioBuffer(e.sample)))}static loadAudioBuffers(e,t){e.forEach((e=>V.loadAudioBuffer(e.sample)))}playNote(e){this.scheduleNote(e,0,0,0)}findBestSample(e){let t;if(this.drumkit)t=this.samples.find((t=>t.step===Math.round(e.note)));else{let s=1e5;for(const n of this.samples){if(n.step==e.note)return n;if(n.step>e.note){return n.step-e.note+3<s?n:t}{const i=e.note-n.step;i<s&&(t=n,s=i)}}}return t}scheduleNote(e,t,s,n){const i=t<0?-t:0;t=Math.max(0,t);const a=this.findBestSample(e);if(a){const o=V.getAudioBuffer(a.sample);if(o){const r=e.note-a.step,h=this.context.currentTime,c=Math.pow(2,r/12),l=new AudioBufferSourceNode(this.context);l.connect(this.level),this.sources.push(l),this.dIn.connect(l.detune),this.pIn.connect(l.playbackRate),l.buffer=o,l.playbackRate.value=c*this.playback,l.start(t+h,i),s>0&&l.stop(t+h+s+n),l.addEventListener("ended",(e=>{this.sources=this.sources.filter((e=>e!==l)),l.disconnect()})),o.duration,this.playback,this._rate=c}}}cancelNotes(){super.cancelNotes(),this.sources.forEach((e=>{e.stop(),e.disconnect()})),this.sources=new Array,this._rate=1}destroy(){super.destroy(),this.sources.forEach((e=>{e.stop(),e.disconnect()})),this.sources=new Array,this._rate=1}pitchBend(e){const t=this.context.currentTime;this.sources.forEach((s=>{s.detune?.setTargetAtTime(this.detune+e,t,.1)}))}schedulePitchBend(e,t){if(this.sources.length>0){const s=this.sources[this.sources.length-1];t.apply(s.detune,e,this.context,this.detune)}}connect(e,t){"detune"==t?e.level.connect(this.dIn):"playback"==t&&e.level.connect(this.pIn)}updateParameter(e,t){"playback"==e?(this.playback=c(t,this.playback),this.sources.forEach((e=>{e.playbackRate?.setValueAtTime(this._rate*this.playback,this.context.currentTime)}))):"detune"==e?(this.detune=c(t,this.detune),this.sources.forEach((e=>{e.detune?.setValueAtTime(this.detune,this.context.currentTime)}))):"sample-pack"==e||("playback-mod"==e?this.pIn.gain.value=c(t,1):"detune-mod"==e?this.dIn.gain.value=c(t,1):super.updateParameter(e,t))}}class D{constructor(e){this.id=0,this.free=0,this.nodes=new Map,this.out=null,this.release=0,this.gates=new Array,this.context=e,this.id=D._CHAIN_ID++,this.loadPatch(D._sine_patch)}playNote(e,t){const s=t.context.currentTime;this.free=31536e3,this.disconnect();const n=new GainNode(t.context);n.connect(t),n.gain.value=e.gain,n.gain.setValueAtTime(e.gain,s),this.out?.level.connect(n),this.gates.push({free:this.free,node:n}),this.nodes.forEach(((t,s,n)=>t.playNote(e)))}releaseNote(){this.nodes.forEach(((e,t,s)=>e.releaseNote()))}scheduleNote(e,t,s,n){const i=n.context.currentTime;this.free=i+t+s+this.release+.05;const a=new GainNode(n.context);a.connect(n),a.gain.value=0,a.gain?.setValueAtTime(0,0),a.gain?.setValueAtTime(e.gain,Math.max(i,i+t)),a.gain?.setValueAtTime(0,Math.max(i,i+t+s+this.release)),this.out?.level.connect(a),this.gates.push({free:this.free,node:a});try{this.nodes.forEach(((n,i,a)=>{n.scheduleNote(e,t,s,this.release)}))}catch(e){console.log("Note scheduling exception: $x")}for(let e=0;e<this.gates.length;e++)this.gates[e].free<i&&(this.gates[e].node?.disconnect(),this.out?.level.disconnect(this.gates[e].node),delete this.gates[e]);return this.gates=this.gates.filter((e=>void 0!==e)),this.release}disconnect(){this.out?.level.disconnect(),this.gates.forEach((e=>{e.node?.disconnect()})),this.gates=[]}cancelNotes(){this.disconnect(),this.nodes.forEach((e=>e.cancelNotes())),this.free=0}destroy(){this.disconnect(),this.nodes.forEach((e=>e.destroy())),this.nodes.clear()}pitchBend(e){this.nodes.forEach((t=>t.pitchBend(e)))}schedulePitchBend(e,t){this.nodes.forEach((s=>s.schedulePitchBend(e,t)))}loadPatch(e){if(this.nodes.clear(),this.out=null,this.release=0,Array.isArray(e.nodes))for(let t of e.nodes){let e=this.createSynthNode(this.context,t);e instanceof H&&(this.out=e),this.nodes.set(e.id,e)}this._updateReleaseValue();for(let t of e.routing){let e=this.nodes.get(t.source),s=this.nodes.get(t.dest);if(e&&s){let n=new L(e,t);e.addConnector(n),s.connect(n,d(t.type,""))}}}createSynthNode(e,t){switch(t.type){case"gain":return new S(e,t);case"osc":return new q(e,t);case"adsr":return new E(e,t);case"filter":return new N(e,t);case"out":return new H(e,t);case"sample":case"drums":return new B(e,t);default:return console.log(`Node not found: ${t.type}`),new S(e,t)}}getNodeById(e){return this.nodes.get(e)}updateParameter(e,t,s){let n=this.nodes.get(e);n?.updateParameter(t,s),this._updateReleaseValue()}updateConnectorLevel(e,t,s){let n=this.nodes.get(e);n?.updateConnectorLevel(t,s)}attachAnalyzer(e,t,s,n){let i=this.nodes.get(e);i?.attachAnalyzer(t,s,n)}detachAnalyzer(e,t){let s=this.nodes.get(e);s?.detachAnalyzer(t)}getFloatTimeDomainData(e,t,s,n){let i=this.nodes.get(e);i?.getFloatTimeDomainData(t,s,n)}_updateReleaseValue(){this.release=0,this.nodes.forEach((e=>{e instanceof E&&(this.release=Math.max(Math.max(e.A+e.D,e.R),this.release))}))}}D._CHAIN_ID=0,D._sine_patch={nodes:[{type:"out",A:.1,D:.1,S:.8,R:.15,id:0},{type:"osc",waveform:"sine",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"out"}]},D._custom_patch={nodes:[{type:"out",id:0,A:0,D:.1,S:1,R:.3,level:0},{type:"sample","sample-pack":"custom",samples:[{sample:"<SOUNDURL>",step:60}],id:1,level:0}],routing:[{id:2,source:1,dest:0,type:"audio",level:0}]};const z={start:0,beats:0,values:[]};class O{constructor(e,t){this.params=new Array,this.start=0,this.beats=-1,this.free=-1,this.id=O._EFFECT_ID++,this.name=e,this.oparams=t,this.start=Math.max(0,t.start),this.beats=t.beats,this.free=-1;for(const e of t.values){const t=Array();if(Array.isArray(e))for(const s of e)t.push(s);else"number"==typeof e&&t.push(e);this.params.push(t)}}static createEffect(e,t){return new F(t)}connect(e,t,s){return this.free=(s+this.start+this.beats+.1)*(60/t)+e.context.currentTime,this.node.connect(e),this.node}disconnect(){this.node.disconnect()}afterEffect(e,t,s,n,i){}clampParam(e,t,s){for(let n=0;n<e.length;n++)e[n]=y(e[n],t,s)}}O._EFFECT_ID=0;class F extends O{get node(){return this._node}constructor(e){super("empty",z),this._node=new GainNode(e)}}class I{get bpm(){return this._bpm}set bpm(e){isNaN(e)||(this._bpm=y(e,5,300))}constructor(){this._bpm=90,this.notes=new Array,this.patch={name:"piano",nodes:new Array,routing:new Array},this.voice="simple sine",this.bank=new Array,this.sound_gens=new Array,this.parameters=new Array,this._analyzer=null,this._analyzers=new Map,this._effects=new Array}get isPlaying(){if(0===this.bank.length)return!1;{const e=this.bank[0].context.currentTime;for(const t of this.bank)if(t.free>e)return!0;return!1}}playNote(e,t){let s=this._allocateGenerator(t.context,t.context.currentTime);if(null==s)return null;s.cancelNotes(),s.playNote(e,t);const n=new M(e,s);return this.notes.push(n),n}scheduleNote(e,t,s,n=0){const i=t.context.currentTime,a=e.duration*(60/this.bpm);s=(s+n)*(60/this.bpm);const o=this._allocateGenerator(t.context,i+s);return o?.scheduleNote(e,s,a,t),o}release(e){if(e.released)return;e.released=!0,e.chain.releaseNote();const t=Math.ceil(1e3*e.chain.release)+100;setTimeout((()=>{this.notes=this.notes.filter((t=>t!==e)),e.chain.disconnect(),this._releaseGenerator(e.chain)}),t)}releaseNote(e){this.notes.forEach((t=>{t.note.note==e.note&&this.release(t)}))}releaseAll(){this.notes.forEach((e=>{this.release(e)}))}cancelAllNotes(){for(const e of this.bank)this._releaseGenerator(e);for(const e of this.sound_gens)e.cancelNotes();this.sound_gens=[]}scheduleNotes(e,t,s){const n=t.context.currentTime,i=Math.max(0,-s);for(let e=0;e<this._effects.length;e++){const t=this._effects[e];t.free>0&&t.free<n&&(t.disconnect(),delete this._effects[e])}this._effects=this._effects.filter((e=>void 0!==e));for(let e=0;e<this.sound_gens.length;e++){this.sound_gens[e].free<n&&delete this.sound_gens[e]}this.sound_gens=this.sound_gens.filter((e=>void 0!==e));const a=new Array,o=new F(t.context);o.beats=e.beats,a.push(o),this._effects.push(o),o.connect(t,this.bpm,s);for(const n of e.trace)if(n.command==A.PUSH_FX){const e=a[a.length-1],i=O.createEffect(n,t.context);i.connect(e.node,this.bpm,s),a.push(i),this._effects.push(i)}else if(n.command==A.POP_FX)a.pop();else if(n.command==A.PLAY&&n.end>=i){const e=a[a.length-1],t=this.scheduleNote(n.note,e.node,n.time,s);a.forEach((e=>{e.afterEffect(t,n.time,n.note.duration,this.bpm,s)}))}}scheduleMidiNotes(e,t,s,n=1){const i=window.performance.now(),a=Math.max(0,-t);for(const o of e.trace)if(o.command===A.PLAY&&o.end>=a){const e=o.note.clone();e.gain*=n;const a=o.note.duration*(60/this.bpm)*1e3,r=i+(o.time+t)*(60/this.bpm)*1e3,h=[144,Math.round(e.note),e.velocity],c=[128,Math.round(e.note),0];s.send(h,r),s.send(c,r+a)}}setMidiProgram(e,t){t>=0&&t<=127&&e.send([192,t])}cancelAllMidiNotes(e){const t=window.performance.now();for(let s=0;s<=127;s++)e.send([128,s,0],t);"clear"in e&&"function"==typeof e.clear&&e.clear()}async recordIntoBuffer(e,t,s,n){return new Promise((async i=>{const a=s*(60/this.bpm),o=Math.round(44100*a),r=new OfflineAudioContext(2,o,44100);this.scheduleNotes(e,r.destination,t>0?-t:0);const h=r.currentTime,c=setInterval((()=>{const e=r.currentTime-h;e>=a?clearInterval(c):n(Math.min(1,e/a))}),500),l=await r.startRendering();n(1),i(l)}))}pitchBend(e){this.notes.forEach((t=>t.chain.pitchBend(e)))}async loadPatch(e){try{e.endsWith("/")&&(e+="patch.json");let s=await fetch(e),n=await s.json();if("string"==typeof(t=n).name&&"2.0"===t.version&&"tunepad-patch"===t.format&&Array.isArray(t.nodes)&&Array.isArray(t.routing)){const t=e.split("/").slice(0,-1).join("/")+"/";this.voice=n.name,this.patch=n,this.parameters=[],this._destroyAllGenerators(),this.sound_gens=[];for(const e of this.patch.nodes)if(Array.isArray(e.samples)){const s=e.samples.filter((e=>P(e))).sort(((e,t)=>e.step-t.step));s.forEach((e=>{e.sample=t+e.sample,V.loadAudioBuffer(e.sample)})),e.samples=s}else"reverb"===e.type?await V.loadCustomSound(e.impulse):"buffer source"===e.type&&await V.loadCustomSound(e.buffer);return!0}}catch(e){console.log("Failed to load audio patch.",e)}finally{return!1}var t}getNodeById(e){return this.bank.length>0?this.bank[0]?.getNodeById(e):void 0}updateParameter(e,t,s){this.bank.forEach((n=>{n.updateParameter(e,t,s)}));for(const n of this.patch.nodes)n.id==e&&(n[t]=s)}_allocateGenerator(e,t){this.bank.length>0&&this.bank[0].context!=e&&this._destroyAllGenerators();for(const s of this.bank)if(s.free<t&&s.context==e)return this._analyzers.forEach((e=>{0==s.free&&s.attachAnalyzer(e.nodeId,e.connectorId,e.fftSize,e.channels)})),s;if(this.bank.length<I.MAX_GENERATORS){const t=new D(e);return t.loadPatch(this.patch),this.bank.push(t),this._analyzers.forEach((e=>{t.attachAnalyzer(e.nodeId,e.connectorId,e.fftSize,e.channels)})),t}}_releaseGenerator(e){e.cancelNotes(),this._analyzers.forEach((t=>{e.detachAnalyzer(t.nodeId,t.connectorId)}))}_destroyAllGenerators(){this.bank.forEach((e=>{e.destroy()})),this.bank=[]}}I.MAX_GENERATORS=24;class R{constructor(){this.synth=new I,this.queue=[],this.cache=new Map,setTimeout((()=>this._processReqest()),100)}static init(){return R.instance||(R.instance=new R),R.instance}static requestAudio(e){const t=R.init();return new Promise((s=>{const n=t.cache.get(e.uuid);n?s(n):(e._callback=s,t.queue.push(e))}))}static cancelRequest(e){const t=R.init();t.queue=t.queue.filter((t=>t.uuid!==e))}static clearCache(){R.instance?.cache.clear()}static clearCacheEntry(e){R.instance?.cache.delete(e)}async _processReqest(){const e=this.queue.shift();if(e){const t=this.cache.get(e.uuid);if(t&&e._callback)e._callback(t);else{this.synth.bpm=e.bpm,await this.synth.loadPatch(e.patch);const t=await this.synth.recordIntoBuffer(e.trace,0,e.beats,e.progress);this.cache.set(e.uuid,t),e._callback&&e._callback(t)}}setTimeout((()=>this._processReqest()),100)}}class $ extends HTMLElement{constructor(){super(),this.synth=new I,this.octave=3,this.minOctave=0,this.maxOctave=7,this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(r);const e=document.createElement("template");e.innerHTML='<div class="piano-wrapper">\n    <button id="down-octave" class="octave-button" title="Lower Octave">❮</button>\n    <piano-keyboard note-hints="true" midi-hints="true" armed="true" max-octave="8" min-octave="1" focus-octave="3" key-range="14"></piano-keyboard>\n    <button id="up-octave" class="octave-button" title="Higher Octave">❯</button>\n</div>',this.root.appendChild(e.content.cloneNode(!0)),this.keyboard=this.root.querySelector("piano-keyboard"),this.audio=v.init()}connectedCallback(){this.audio=v.init(),this.keyboard.addEventListener("note-on",(e=>{const t=new k(e.detail.note);this.synth.playNote(t,this.audio.context.destination)})),this.keyboard.addEventListener("note-off",(e=>{const t=new k(e.detail.note);this.synth.releaseNote(t)})),this.root.querySelector("#down-octave")?.addEventListener("click",(e=>{this.octave=Math.max(this.minOctave,this.octave-1),this.root.querySelector("piano-keyboard")?.setAttribute("focus-octave",`${this.octave}`)})),this.root.querySelector("#up-octave")?.addEventListener("click",(e=>{this.octave=Math.min(this.maxOctave,this.octave+1),this.root.querySelector("piano-keyboard")?.setAttribute("focus-octave",`${this.octave}`)}))}disconnectedCallback(){}attributeChangedCallback(e,t,s){"patch"===e&&s!==t?this.synth.loadPatch(s):s!==t&&this.keyboard.setAttribute(e,s),"focus-octave"===e?this.octave=parseInt(s):"min-octave"===e?this.minOctave=parseInt(s):"max-octave"===e&&(this.maxOctave=parseInt(s)),this.octave=isNaN(this.octave)?3:this.octave,this.minOctave=isNaN(this.minOctave)?0:this.minOctave,this.maxOctave=isNaN(this.maxOctave)?7:this.maxOctave}}$.ELEMENT="piano-instrument",$.observedAttributes=[...a.observedAttributes,"patch"];const G=new CSSStyleSheet;G.replaceSync(':host {\n    --error-red: #da575d;\n    --warn-yellow: orange;\n    --output-green: #87c44e;\n }\n\n.code-view-wrapper {\n    margin: 2rem 0;\n    border-radius: 0.75em;\n    overflow: hidden;\n    max-width: 700px;\n    position: relative;\n    background-color: #e3e9f2;\n}\n\n.code-view-wrapper.light {\n    background-color: #e3e9f2;\n}\n.code-view-wrapper.dark {\n    background-color: #2E303F;\n}\n\n.buttons { \n    padding: 0.25rem 1.75rem;\n    background-color: #0007;\n    display: flex;\n    align-items: center;\n}\n.dark .buttons { background-color: #fff3; }\n\n.expander { flex: 1; }\n.badge {\n    min-width: 30px;\n    text-align: center;\n}\n.badge svg { \n    width: 20px;\n    height: 20px;\n    vertical-align: middle;\n}\n.badge#error-badge svg { fill: var(--error-red); }\n.badge#warning-badge svg { fill: var(--warn-yellow); }\n.badge#output-badge { \n    background-color: var(--output-green);\n    color: white;\n    font-size: 90%;\n    border-radius: 0.75em;\n    min-width: 1.5em;\n    padding: 0.1em 0.4em;\n}\n\n.badge.hidden { display: none; }\n\n.buttons button {\n    width: 40px;\n    height: 30px;\n    line-height: 20px;\n    outline: none;\n    border: none;\n    background: transparent;\n    color: #666;\n    padding: 4px;\n}\n.buttons button svg { \n    width: 17; \n    height: 17px; \n    fill: #ddd; \n    vertical-align: middle;\n}\n\n.buttons button:hover { color: white; }\n.buttons button:hover svg { fill: white; }\n\n.buttons button:active { color: var(--highlight-color); }\n.buttons button:active svg { fill: var(--highlight-color); }\n.buttons button.hidden { display: none; }\n\n#loader svg {\n    animation: spin-animation 2s infinite;\n    animation-timing-function: linear;\n}\n\npre[class*="language-python"] {\n    padding-left: 0.5em;\n    font-size: 12px;\n}\n\ncode[class*="language-python"] {\n    line-height: 1.75;\n}\n\npre[class*="language-"].line-numbers {\n\tposition: relative;\n\tpadding-left: 3.8em;\n    margin: 0;\n\tcounter-reset: linenumber;\n}\n\npre[class*="language-"].line-numbers > code {\n\tposition: relative;\n\twhite-space: inherit;\n}\n\n.line-numbers .line-numbers-rows {\n\tposition: absolute;\n\tpointer-events: none;\n\ttop: -2px;\n\tfont-size: 100%;\n\tleft: -3.8em;\n\twidth: 3em; /* works for line-numbers below 1000 lines */\n\tletter-spacing: -1px;\n\tborder-right: 1px solid #999;\n\tuser-select: none;\n\tbackground-color: transparent;\n}\n\n.line-numbers-rows > span {\n    display: block;\n    counter-increment: linenumber;\n}\n\n.line-numbers-rows > span:before {\n    content: counter(linenumber);\n    color: #999;\n    display: block;\n    padding-right: 0.8em;\n    text-align: right;\n}\n\n.message-wrapper {\n    padding: 0 0.5rem;\n}\n\nfooter {\n    background-color: #777;\n    color: white;\n    font-size: 12px;\n    padding: 0.4em 2em;\n    display: flex;\n}\n.dark footer { background-color: #535563; }\n\nfooter div {\n    margin-left: 1.5rem;\n}\n\nfooter div:first-child {\n    margin-left: 0;\n}\n\n#status { flex: 1; }\n\n.progress-bar {\n    display: block;\n    height: 5px;\n    width: 100%;\n    background-color: #000a;\n}\n.progress-bar.hidden { display: none; }\n\n.progress-bar .fill {\n    background-color: cornflowerblue;\n    height: 100%;\n    margin: 0;\n    padding: 0;\n}\n\n@media print {\n    footer { display: none; }\n    .buttons { display: none; }\n}\n\n@keyframes spin-animation {\n    0% {\n      transform: rotate(0deg);\n    }\n    100% {\n      transform: rotate(359deg);\n    }\n}');class K{static init(){return null===K.instance&&(K.instance=new K),K.instance}constructor(){this.queue=new Array,this.cache=new Map,this.modules=new Map,this.active=null,this.warnings=new Array,this.worker=new Worker("/js/PythonWorker.js"),setTimeout((()=>{K.instance?.processQueue()}),50),this.worker.onmessage=e=>{const t=e.data,s=this.active;if("preload"===s?.action&&t)s.callback(new Q(s));else if(s&&s.uuid===t.uuid){for(let e of this.queue)if(e.uuid===s.uuid&&e.action===s.action&&e.code!==s.code)return void(this.active=null);let e=new Q(s);e.output=t.output,e.globals=t.globals,e.errors=t.errors,e.dependencies=t.dependencies,this.warnings=this.warnings.filter((t=>t.target!==e.uuid&&t.source!==e.uuid));for(const[t,s]of this.cache)t!==e.uuid&&s.dependencies.includes(e.name)&&this.warnings.push({name:"Dependency Warning",message:`Cell '${e.name}' has been updated.`,details:"",line:-1,target:s.uuid,source:e.uuid});for(let[t,s]of this.cache)if(t!==e.uuid)for(let n of s.dependencies){let i=n===e.name;for(let[e,s]of this.cache)t!==e&&s.name===n&&(i=!0);i||this.warnings.push({name:"Dependency Warning",message:`Cell '${n}' does not exist.`,details:"",line:-1,target:s.uuid,source:e.uuid})}e.globals.has("__tunepad_trace")&&e.trace.fromPython(e.globals.get("__tunepad_trace").value),e.hasNoErrors&&this.cache.set(e.uuid,e),s.callback(e)}this.active=null}}static destroy(){if(K.instance){const e=K.instance;e.worker.terminate(),e.active=null,e.cache.clear(),e.modules.clear()}}static compile(e,t=!1){return new Promise((s=>{K.instance?.queue.push(new W(e,"compile",s,t))}))}static run(e){return new Promise((t=>{K.instance?.queue.push(new W(e,"run",t))}))}static preload(e){return new Promise((t=>{K.instance?.queue.push(new W(e,"preload",t))}))}static preloadAll(e){const t=K.instance;return new Promise((async s=>{for(const s of e)t?.queue.push(new W(s,"preload",(e=>{console.log("preload response for "+e.name)})));s(!0)}))}static _timeout(e){return new Promise((t=>setTimeout(t,e)))}static playCell(e){K.instance?.worker.postMessage({...e,action:"play"})}static pauseCell(e){K.instance?.worker.postMessage({...e,action:"pause"})}static deleteCell(e){const t=K.instance;if(t){t.modules.delete(e.uuid),t.cache.delete(e.uuid),t.worker.postMessage({...e,action:"delete"});for(const[s,n]of t.cache)s!==e.uuid&&n.dependencies.includes(e.name)&&t.warnings.push({name:"Dependency Warning",message:`Cell '${e.name}' was deleted.`,details:"",line:-1,target:s,source:e.uuid})}}static getWarnings(){return K.instance.warnings}hasWarnings(e){return void 0!==this.warnings.find((t=>t.target===e))}equivalentCode(e,t){function s(e){return e.split("\n").filter((e=>""!==e&&!e.startsWith("#"))).join("\n")}return s(e)===s(t)}equivalent(e,t){return!e.force&&e.name===t.name&&e.action===t.action&&this.equivalentCode(e.code,t.code)}async processQueue(){if(this.queue.length>0&&null===this.active){let e=this.queue.shift();this.modules.set(e.uuid,e.cell);let t=this.cache.get(e.uuid);t&&t.code&&!this.hasWarnings(e.uuid)&&this.equivalent(e,t)?e.callback(t):(this.active=e,this.removeFromCache(e.uuid),this.worker.postMessage({uuid:e.uuid,name:e.name,action:e.action,code:e.code}))}setTimeout((()=>{K.instance?.processQueue()}),50)}removeFromCache(e){this.cache.get(e)?.close(),this.cache.delete(e)}static makePythonSafe(e,t){let s="";for(const t of e){let e=t.charCodeAt(0);e>=48&&e<=57||e>=97&&e<=199||e>=65&&e<=90||95===e?s+=t:32===e&&(s+="_")}""===s&&(s="new_cell"),s.charCodeAt(0)>=48&&s.charCodeAt(0)<=57&&(s="_"+s),U.includes(s)&&(s="_"+s);let n=s,i=2;for(;K.instance?.duplicateName(s,t);)s=n+"_"+i,i++;return s}duplicateName(e,t){for(const[s,n]of this.modules)if(t!==s&&n.name===e)return!0;return!1}}K.instance=null;class W{constructor(e,t,s,n=!1){this.force=!1,this.cell=e,this.action=t,this.callback=s,this.force=n}get uuid(){return this.cell.uuid}get name(){return this.cell.name}get code(){return this.cell.code}}class Q{constructor(e){this.output=[],this.trace=new x,this.errors=[],this.dependencies=[],this.uuid=e.uuid,this.code=e.code,this.name=e.name,this.action=e.action}get hasErrors(){return this.errors.length>0}get hasNoErrors(){return 0===this.errors.length}close(){}}const U=["and","as","assert","break","class","continue","def","del","elif","else","except","exec","False","finally","for","from","global","if","import","in","is","lambda","None","nonlocal","not","or","pass","raise","return","True","try","while","with","yield"];class Z extends HTMLElement{get code(){return this.editor.code}get currentBeat(){return this.audio.beats%this.duration}get remainingBeats(){return this.duration-this.currentBeat}get percentBeats(){return this.currentBeat/this.duration}constructor(){super(),this.uuid=self.crypto.randomUUID(),this.name="",this.patch="/sounds/voices/piano/",this.synth=new I,this.gain=0,this.midiOut=!1,this.midiVoice=-1,this.audio_ready=!1,this.audible=!1,this.duration=4,this.readonly=!1,this._timer=-1,this._last_beat=0,this._looped=-1,this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(G);const e=document.createElement("template");e.innerHTML='<div class="code-view-wrapper">\n    <div class="buttons">\n        <button id="loader" class="hidden" title="Loading audio">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\n                <path d="M304 48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zm0 416a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM48 304a48 48 0 1 0 0-96 48 48 0 1 0 0 96zm464-48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM142.9 437A48 48 0 1 0 75 369.1 48 48 0 1 0 142.9 437zm0-294.2A48 48 0 1 0 75 75a48 48 0 1 0 67.9 67.9zM369.1 437A48 48 0 1 0 437 369.1 48 48 0 1 0 369.1 437z"/>\n            </svg>\n        </button>\n        <button id="play-button" class="hidden" title="Play Audio">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">\n                <path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/>\n            </svg>\n        </button>\n        <button id="pause-button" class="hidden">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">\n                <path d="M48 64C21.5 64 0 85.5 0 112V400c0 26.5 21.5 48 48 48H80c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H48zm192 0c-26.5 0-48 21.5-48 48V400c0 26.5 21.5 48 48 48h32c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H240z"/>\n            </svg>\n        </button>\n        <button id="stop-button" class="hidden">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">\n                <path d="M0 128C0 92.7 28.7 64 64 64H320c35.3 0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128z"/>\n            </svg>\n        </button>\n        <button id="copy-button" title="Copy to Clipboard">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">\n                <path d="M384 336H192c-8.8 0-16-7.2-16-16V64c0-8.8 7.2-16 16-16l140.1 0L400 115.9V320c0 8.8-7.2 16-16 16zM192 384H384c35.3 0 64-28.7 64-64V115.9c0-12.7-5.1-24.9-14.1-33.9L366.1 14.1c-9-9-21.2-14.1-33.9-14.1H192c-35.3 0-64 28.7-64 64V320c0 35.3 28.7 64 64 64zM64 128c-35.3 0-64 28.7-64 64V448c0 35.3 28.7 64 64 64H256c35.3 0 64-28.7 64-64V416H272v32c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192c0-8.8 7.2-16 16-16H96V128H64z"/>\n            </svg>\n        </button>\n        <div class="expander"></div>\n        <div id="error-badge" class="badge hidden">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\n                <circle cx="256" cy="256" r="250" fill="white"/>\n                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm0-384c13.3 0 24 10.7 24 24V264c0 13.3-10.7 24-24 24s-24-10.7-24-24V152c0-13.3 10.7-24 24-24zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"/>\n            </svg>\n        </div>\n        <div id="warning-badge" class="badge hidden">\n            <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 512 512">\n                <path fill="white" d="M258,108c10.5,0,20.3,5.6,25.6,14.7l160.3,273.1c5.4,9.2,5.4,20.6.1,29.8s-15.1,14.9-25.8,14.9H97.7c-10.6,0-20.5-5.7-25.8-14.9s-5.2-20.6.1-29.8L232.4,122.7c5.3-9.1,15.1-14.7,25.6-14.7Z"/>\n                <path d="M256,32c14.2,0,27.3,7.5,34.5,19.8l216,368c7.3,12.4,7.3,27.7.2,40.1s-20.4,20.1-34.7,20.1H40c-14.3,0-27.6-7.7-34.7-20.1s-7-27.8.2-40.1L221.5,51.8c7.2-12.3,20.3-19.8,34.5-19.8ZM256,160c-13.3,0-24,10.7-24,24v112c0,13.3,10.7,24,24,24s24-10.7,24-24v-112c0-13.3-10.7-24-24-24ZM288,384c0-17.7-14.3-32-32-32s-32,14.3-32,32,14.3,32,32,32,32-14.3,32-32Z"/>\n              </svg>\n        </div>\n        <div id="output-badge" class="badge hidden"></div>\n    </div>\n    <div class="progress-bar">\n        <div class="fill" style="width: 0"></div>\n    </div>\n    <div class="codemirror-container"></div>\n    <div class="message-wrapper">\n        <div id="errors"></div>\n        <div id="warnings"></div>\n        <div id="messages"></div>\n        <div id="tests"></div>\n        <div id="output"></div>\n    </div>\n    \x3c!--\n    <pre class="line-numbers"><code id="code-view" class="language-python"></code></pre>\n    --\x3e\n    <footer>\n        <div id="status"></div>\n        <div id="beats"></div>\n        <div id="tempo"></div>\n        <div id="time"></div>\n        <div id="patch"></div>\n    </footer>\n</div>\n',this.root.appendChild(e.content.cloneNode(!0)),this.audio=v.init(),this.editor=document.createElement("python-editor")}connectedCallback(){window.addEventListener("load",(()=>{const e=this.innerHTML.trim().split("\n").map((e=>"/"===e?"":e)).join("\n");this.editor.innerHTML=e,this.root.querySelector(".codemirror-container")?.appendChild(this.editor),this.editor.addEventListener("codemirror-event",(e=>{const t=e.detail.code;this.compileCode(t)})),this.compileCode(e,!0)})),this.root.querySelector("#play-button")?.addEventListener("click",(e=>this.playAudio())),this.root.querySelector("#pause-button")?.addEventListener("click",(e=>this.pauseAudio())),this.root.querySelector("#stop-button")?.addEventListener("click",(e=>this.audio.stopAll())),this.root.querySelector("#copy-button")?.addEventListener("click",(e=>{navigator.clipboard.writeText(this.code)})),this._timer=setInterval((()=>{const e=K.getWarnings().filter((e=>e.target===this.uuid));this.warnings=e}),1e3)}disconnectedCallback(){clearInterval(this._timer)}attributeChangedCallback(e,t,s){"patch"===e&&null!==s?(this.audible=!0,this.patch=s,this.loadPatch(s)):"id"===e?(this.name=K.makePythonSafe(s,this.uuid),this.status()):"readonly"===e?(this.editor.setAttribute("readonly",s),this.readonly="true"===s,this.status()):"theme"===e?(this.editor.setAttribute("theme",s),this.removeClass(".code-view-wrapper",t),this.addClass(".code-view-wrapper",s)):"tempo"===e?(this.audio.bpm=h(s,90),this.synth.bpm=h(s,90),this.setHTML("#tempo",`${this.synth.bpm} bpm`)):"time"===e&&null!==s?(this.audio.meter=s,this.setHTML("#time",`${this.audio.meter} time`)):"gain"==e?this.gain=c(s,0):"midi-out"===e?(this.midiOut="true"===s,this.midiOut&&i.init()):"midi-voice"===e&&(this.midiVoice=parseInt(s))}set errors(e){e.length>0?this.removeClass("#error-badge","hidden"):this.addClass("#error-badge","hidden"),this.setHTML("#errors",""),e.forEach((e=>{let t=`<b>${e.name}:</b> ${e.message}`;e.line>0&&(t+=` on line ${e.line}`);const s=document.createElement("python-message");s.setAttribute("type","error"),e.details&&s.setAttribute("details",e.details),s.innerHTML=t,this.root.querySelector("#errors")?.appendChild(s)}));const t=e.filter((e=>e.line>0)).map((e=>({line:e.line,message:`${e.name}: ${e.message}`})));this.editor.setMarkers(t,"error")}set warnings(e){e.length>0?this.removeClass("#warning-badge","hidden"):this.addClass("#warning-badge","hidden"),this.setHTML("#warnings",""),e.forEach((e=>{let t=`<b>${e.name}:</b> ${e.message}`;e.line>0&&(t+=` on line ${e.line}`);const s=document.createElement("python-message");s.setAttribute("type","warning"),s.innerHTML=t,this.root.querySelector("#warnings")?.appendChild(s)}));const t=e.filter((e=>e.line>0)).map((e=>({line:e.line,message:`${e.name}: ${e.message}`})));this.editor.setMarkers(t,"warning")}set unitTests(e){this.setHTML("#tests",""),e.forEach((e=>{const t=document.createElement("python-message");t.setAttribute("type","test"),t.setAttribute("pass",`${"pass"===e.params.get("type")}`),t.innerHTML=d(e.params.get("message"),""),this.root.querySelector("#tests")?.appendChild(t)}))}set messages(e){this.setHTML("#messages",""),e.forEach((e=>{const t=document.createElement("python-message");t.setAttribute("type","message"),t.innerHTML=d(e.params.get("message"),""),this.root.querySelector("#messages")?.appendChild(t)}))}set output(e){if(e.length>0?(this.removeClass("#output-badge","hidden"),this.setHTML("#output-badge",`${e.length}`)):(this.addClass("#output-badge","hidden"),this.setHTML("#output-badge","0")),this.setHTML("#output",""),e.length>0){const t=document.createElement("python-output");t.innerHTML=e.join("\n"),this.root.querySelector("#output")?.appendChild(t)}}cueAudio(e){this.trace&&(this.gain_node||(this.gain_node=new GainNode(this.audio.context),this.gain_node.gain.value=u(this.gain),this.gain_node.gain.setValueAtTime(this.gain,0),this.gain_node.connect(this.audio.context.destination)),this.synth.scheduleNotes(this.trace,this.gain_node,e)),this.trace&&this.midiOut&&i.outputs?.forEach((t=>{this.synth.setMidiProgram(t,this.midiVoice),this.synth.scheduleMidiNotes(this.trace,e,t,this.gain)}))}playAudio(){this.trace&&(this.audio.play(this),this.cueAudio(-1*this.currentBeat),this.remainingBeats<=.5&&(this.cueAudio(this.remainingBeats),this._looped=this.currentBeat,this._last_beat=this.currentBeat),this.root.querySelector("#play-button")?.classList.add("hidden"),this.root.querySelector("#pause-button")?.classList.remove("hidden"),this.animation())}pauseAudio(){this.synth.cancelAllNotes(),this.audio.pause(this),this.midiOut&&i.outputs?.forEach((e=>{this.synth.cancelAllMidiNotes(e)})),this.root.querySelector("#play-button")?.classList.remove("hidden"),this.root.querySelector("#pause-button")?.classList.add("hidden")}stopAudio(){this.pauseAudio(),this.setFill(0),this._looped=-1,this._last_beat=0}async compileCode(e,t=!1){K.init(),this.status(),t&&await K.preload(this);const s=await K.compile(this);this.trace=s.trace,this.duration=Math.ceil(s.trace.beats/this.audio.beatsPerMeasure)*this.audio.beatsPerMeasure,this.setHTML("#beats",`${this.duration} beats`),this.errors=s.errors,this.output=s.output,this.warnings=K.getWarnings().filter((e=>e.target===this.uuid)),this.messages=this.trace.trace.filter((e=>"message"===e.params.get("type"))),this.unitTests=this.trace.trace.filter((e=>["pass","fail"].includes(e.params.get("type")))),this.status()}async loadPatch(e){this.root.querySelector("#loader")?.classList.remove("hidden"),this.status(),await this.synth.loadPatch(e),this.setHTML("#patch",this.synth.patch.name),this.audio_ready=!0,this.status()}animation(){this.audio.isPlaying(this)&&(this.setFill(this.percentBeats),this.remainingBeats<.5&&this._looped<0?(this._looped=this.currentBeat,this.cueAudio(this.remainingBeats)):this._looped>this.currentBeat?this._looped=-1:this._looped<0&&this._last_beat>this.currentBeat&&this.cueAudio(-1*this.currentBeat),this._last_beat=this.currentBeat,requestAnimationFrame((e=>{this.animation()})))}setFill(e){this.root.querySelector(".progress-bar .fill").style.width=100*e+"%"}status(){const e=this.root.querySelector("#status");e&&this.audible&&(this.removeClass("footer","error"),this.setHTML("#error",""),this.audio_ready&&this.trace?(e.innerHTML=`${this.name}${this.readonly?" (readonly)":""}`,this.root.querySelector("#play-button")?.classList.remove("hidden"),this.root.querySelector("#stop-button")?.classList.remove("hidden"),this.root.querySelector(".progress-bar")?.classList.remove("hidden"),this.root.querySelector("#loader")?.classList.add("hidden")):this.audio_ready?e.innerHTML="Loading python...":this.trace?e.innerHTML="Loading audio...":e.innerHTML="Loading...")}setHTML(e,t){const s=this.root.querySelector(e);s&&(s.innerHTML=t)}addClass(e,t){const s=this.root.querySelector(e);s&&s.classList.add(t)}removeClass(e,t){const s=this.root.querySelector(e);s&&s.classList.remove(t)}onClockReset(){this.stopAudio()}onClockTimeChange(){}onTempoChange(){}onTimeSignatureChange(){}}Z.ELEMENT="tunepad-code",Z.observedAttributes=["id","readonly","theme","patch","tempo","time","gain","midi-out","midi-voice"];const j=new CSSStyleSheet;j.replaceSync(".explore-wrapper {\n    width: 95%;\n    margin: 2rem auto;\n    padding: 1rem 0;\n    border-radius: 20px;\n    display: flex;\n    flex-direction: column;\n}\n#code-hint {\n    margin: 0rem 0.25rem 0 0;\n    padding: 0 1rem;\n    background: #0002;\n    height: 35px;\n    line-height: 35px;\n    border: 1px solid #887;\n    border-radius: 5px;\n    user-select: none;\n    box-sizing: border-box;\n    flex: 1;\n}\n.shelf {\n    display: flex;\n    margin: 1rem 4.5rem;\n}\n.keyboard-wrapper {\n    display: flex;\n}\n#copy-button {\n    color: #000a;\n    outline: none;\n    border: 1px solid #555;\n    height: 35px;\n    background-color: transparent;\n    border-radius: 5px;\n    font-weight: 500;\n    user-select: none;\n}\n#copy-button:hover { color: black; }\n#copy-button:active { color: rgb(45, 113, 134); }\npiano-instrument { flex: 1; }\n");class X extends HTMLElement{constructor(){super(),this.notes=new Set,this.chord=new Array,this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(j);const e=document.createElement("template");e.innerHTML='<div class="explore-wrapper">\n    <div class="keyboard-wrapper">\n        <piano-instrument></piano-instrument> \n    </div>\n    <div class="shelf">\n        <pre id="code-hint"></pre>\n        <button id="copy-button" title="Copy Code">Copy to Clipboard</button>\n    </div>\n</div>',this.root.appendChild(e.content.cloneNode(!0))}connectedCallback(){const e=this.root.querySelector("piano-instrument");e?.addEventListener("note-on",(e=>{const t=new k(e.detail.note);this.addCodeHint(t)})),e?.addEventListener("note-off",(e=>{const t=new k(e.detail.note);this.removeCodeHint(t)})),e?.addEventListener("click",(e=>{const t=document.querySelector("#code-hint");t&&navigator.clipboard.writeText(t.innerHTML)}))}disconnectedCallback(){}attributeChangedCallback(e,t,s){s!==t&&this.root.querySelector("piano-instrument")?.setAttribute(e,s)}getCodeHint(){if(1===this.chord.length){const e=new k(this.chord[0]);return`playNote(${e.note})    # ${e.nameWithOctave}`}return this.chord.length>0?`playNote([ ${this.chord.join(", ")} ])`:""}addCodeHint(e){this.notes.add(e.note),this.chord=[...this.notes].sort();const t=this.root.getElementById("code-hint");t&&(t.innerHTML=this.getCodeHint())}removeCodeHint(e){this.notes.delete(e.note),0==this.notes.size&&(this.chord=[])}}X.ELEMENT="note-explorer",X.observedAttributes=$.observedAttributes;const Y=new CSSStyleSheet;Y.replaceSync("/*\n * TunePad\n * Northwestern University\n * michael-horn@northwestern.edu\n *\n * This project was funded by the National Science Foundation (grant DRL-1612619).\n * Any opinions, findings and conclusions or recommendations expressed in this\n * material are those of the author(s) and do not necessarily reflect the views\n * of the National Science Foundation (NSF).\n */\n :host {\n    --error-red: #da575d;\n    --error-red-bg: #f9e4e5;\n    --fail-red: #da575d;\n    --fail-red-bg: #f9e4e5;\n    --info-blue: #4b90d7;\n    --pass-green: green;\n    --pass-green-bg: #ded;\n    --warn-yellow: orange;\n    --warn-yellow-bg: #fed;\n    --output-badge-color: #87c44e;\n    --error-badge-color: #da575d;\n    --warn-badge-color: orange;\n }\n.python-message {\n    padding: 10px;\n    font-size: 12px;\n    position: relative;\n    margin: 0.25em 0;\n}\n\n.python-message.error {\n    background-color: white;\n    border-left: 10px solid var(--error-red);\n}\n\n.python-message.message {\n    background-color: white;\n    border-left: 10px solid var(--info-blue);\n}\n\n.python-message.warning {\n    background-color: white;\n    border-left: 10px solid var(--warn-yellow);\n}\n\n.python-message.test {\n    background-color: var(--fail-red-bg);\n    border-left: 10px solid var(--fail-red);\n}\n\n.python-message.test.pass {\n    background-color: var(--pass-green-bg);\n    border-left: 10px solid var(--pass-green);\n}\n\n.icon {\n    width: 20px;\n    margin-right: 0.75em;\n    position: relative;\n    top: 2px;\n}\n.error .icon { fill: var(--error-red); }\n.warning .icon { fill: var(--warn-yellow); }\n.test .icon { fill: var(--fail-red); }\n.test.pass .icon { fill: var(--pass-green); }\n.message .icon { fill: var(--info-blue); }\n\n.message-box {\n    color: #444;\n    position: relative;\n    display: flex;\n    flex-wrap: wrap;\n}\n#message { \n    flex: 1; \n    align-content: center;\n    font-size: 14px;\n}\n\n#status {\n    font-size: 70%;\n    border-radius: 8px;\n    background-color: var(--fail-red);\n    padding: 0 1.5em;\n    font-weight: bold;\n    color: white;\n    width: 40px;\n    height: 16px;\n    line-height: 16px;\n    text-align: center;\n    align-self: center;\n    display: none;\n}\n.test #status { display: block;}\n.test.pass #status { background-color: var(--pass-green); }\n\n.details-box {\n    display: flex;\n}\n.details-box.hidden {\n    display: none;\n}\n#details {\n    line-height: 150%;\n    font-size: 11px;\n    margin-left: 2.5em;\n    margin-right: 1em;\n    background-color: var(--error-red-bg);\n    padding: 1em;\n    overflow-x: auto;\n    flex: 1;\n}\n\n.view-btn {\n    outline: none;\n    border: none;\n    background-color: transparent;\n    border-radius: 0.5em;\n    width: 3em;\n    height: 2em;\n    padding: 0 0.9rem;\n    display: none;\n}\n.error .view-btn { display: block; }\n.error .view-btn.hidden { display: none; }\n.view-btn:hover { background-color: #0001; }\n\n\n.infoLinks {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    width: 65px;\n    margin-left: 1rem;\n}\n\n.infoLinks a {\n    width: 22px;\n    filter: grayscale(100%);\n    text-decoration: none;\n}\n.infoLinks a.ggl-search { width: 20px; }\n.infoLinks a:hover { filter: none; }\n");class J extends HTMLElement{static DefineElement(){customElements.define("python-message",J)}constructor(){super(),this.pass=!1,this.type="message",this.message="",this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(Y);const e=document.createElement("template");e.innerHTML='<div class="python-message">\n    <div class="message-box">\n        <div class="icon"></div>\n\n        <div id="message"></div>\n\n        <div id="status">PASSED</div>\n\n        <button id="collapse-button" class="view-btn hidden">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">\n                <path d="M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160z"/>\n            </svg>\n        </button>\n        <button id="expand-button" class="view-btn">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">\n                <path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z"/>\n            </svg>\n        </button>\n    </div>\n    <div class="details-box hidden">\n        <pre id="details">No stack trace available.</pre>\n        <div class="infoLinks">\n            <a class="ggl-search" target="_blank" rel="noreferrer" title="Search for error on Google"></a>\n            <a class="ddg-search" target="_blank" rel="noreferrer" title="Search for error on DuckDuckGo"></a>\n            \x3c!--\n             <a className={ styles.ddg }\n              target="_blank"\n              rel="noreferrer"\n              href={ "//duckduckgo.com?q=" + error?.name + " " + error?.message } \n              data-tooltip="search for error message on DuckDuckGo">\n            &nbsp;\n            </a>\n            --\x3e\n        </div>\n    </div>\n</div>',this.root.appendChild(e.content.cloneNode(!0)),this.setHTML(".ggl-search",'<svg viewBox="0 0 533.5 544.3" xmlns="http://www.w3.org/2000/svg"><path d="M533.5 278.4c0-18.5-1.5-37.1-4.7-55.3H272.1v104.8h147c-6.1 33.8-25.7 63.7-54.4 82.7v68h87.7c51.5-47.4 81.1-117.4 81.1-200.2z" fill="#4285f4"/><path d="M272.1 544.3c73.4 0 135.3-24.1 180.4-65.7l-87.7-68c-24.4 16.6-55.9 26-92.6 26-71 0-131.2-47.9-152.8-112.3H28.9v70.1c46.2 91.9 140.3 149.9 243.2 149.9z" fill="#34a853"/><path d="M119.3 324.3c-11.4-33.8-11.4-70.4 0-104.2V150H28.9c-38.6 76.9-38.6 167.5 0 244.4l90.4-70.1z" fill="#fbbc04"/><path d="M272.1 107.7c38.8-.6 76.3 14 104.4 40.8l77.7-77.7C405 24.6 339.7-.8 272.1 0 169.2 0 75.1 58 28.9 150l90.4 70.1c21.5-64.5 81.8-112.4 152.8-112.4z" fill="#ea4335"/></svg>'),this.setHTML(".ddg-search",'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg viewBox="0 0 256 255" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid">\n    <defs>\n        <linearGradient x1="71.0046292%" y1="100%" x2="0%" y2="100%" id="linearGradient-1">\n            <stop stop-color="#394A9F" offset="0%"></stop>\n            <stop stop-color="#6176B9" offset="100%"></stop>\n        </linearGradient>\n    </defs>\n\t<g>\n\t\t<path d="M128.145,18.841 C188.147,18.841 236.788,67.482 236.788,127.484 C236.788,187.485 188.147,236.126 128.145,236.126 C68.144,236.126 19.503,187.485 19.503,127.484 C19.503,67.482 68.144,18.841 128.145,18.841" fill="#DE5833"></path>\n\t\t<path d="M128.143,254.922 C198.526,254.922 255.583,197.865 255.583,127.482 C255.583,57.099 198.526,0.042 128.143,0.042 C57.76,0.042 0.703,57.099 0.703,127.482 C0.703,197.865 57.76,254.922 128.143,254.922 L128.143,254.922 Z M128.143,244.302 C63.625,244.302 11.323,192 11.323,127.482 C11.323,62.964 63.625,10.662 128.143,10.662 C192.661,10.662 244.963,62.964 244.963,127.482 C244.963,192 192.661,244.302 128.143,244.302 L128.143,244.302 Z" fill="#DE5833"></path>\n\t\t<g transform="translate(66.000000, 42.000000)">\n\t\t\t<path d="M9.219,12.13 C9.198,10.303 10.525,9.28 12.288,8.563 C11.481,8.695 10.708,8.897 10.012,9.209 C8.174,10.042 6.8,13.196 6.813,14.689 C15.736,13.787 28.931,14.411 38.58,17.291 C39.292,17.191 40.004,17.091 40.727,17.008 C31.103,12.735 19.661,11.085 9.219,12.13" fill="#D5D7D8"></path>\n\t\t\t<path d="M11.048,1.15 C11.249,1.114 11.453,1.089 11.655,1.055 C9.73,1.294 8.715,1.982 7.27,2.219 C8.839,2.358 14.784,5.133 18.52,6.659 C19.044,6.46 19.516,6.239 19.901,5.978 C17.964,5.692 13.151,1.342 11.048,1.15" fill="#D5D7D8"></path>\n\t\t\t<path d="M20.326,22.756 C19.791,22.962 19.283,23.177 18.843,23.408 C4.298,31.071 -2.127,48.97 1.702,70.418 C5.197,89.936 19.522,156.623 26.081,187.989 C27.996,188.662 29.934,189.287 31.896,189.854 C26.055,161.614 10.112,87.614 6.392,66.831 C2.621,45.688 6.29,30.517 20.326,22.756" fill="#D5D7D8"></path>\n\t\t\t<path d="M79.184,176.618 C78.944,176.778 78.658,176.928 78.353,177.074 C78.127,177.95 77.782,178.614 77.279,178.948 C74.275,180.941 65.79,181.945 61.31,180.941 C60.539,180.77 59.955,180.487 59.499,180.098 C51.85,184.345 40.85,189.999 38.616,188.725 C35.126,186.724 34.62,160.274 35.126,153.783 C35.495,148.883 52.707,156.82 61.08,160.983 C62.931,159.254 67.466,158.097 71.48,157.704 C65.415,142.943 60.942,126.059 63.684,114.086 C59.894,111.445 54.871,105.32 55.917,98.927 C56.723,94.061 69.297,84.855 78.2,84.299 C87.123,83.736 89.904,83.863 97.338,82.083 C97.71,81.994 98.119,81.896 98.547,81.793 C103.123,65.706 92.148,37.719 79.906,25.472 C75.915,21.481 69.779,18.969 62.865,17.643 C60.206,13.994 55.917,10.505 49.845,7.274 C38.57,1.288 24.636,-1.149 11.655,1.055 C11.453,1.089 11.249,1.114 11.048,1.15 C13.151,1.342 17.964,5.692 19.901,5.978 C19.516,6.239 19.044,6.46 18.52,6.659 C16.702,7.351 14.231,7.771 12.288,8.563 C10.525,9.28 9.198,10.303 9.219,12.13 C19.661,11.085 31.103,12.735 40.727,17.008 C40.004,17.091 39.292,17.191 38.58,17.291 C31.755,18.251 25.482,20.019 20.95,22.41 C20.737,22.521 20.535,22.641 20.326,22.756 C6.29,30.517 2.621,45.688 6.392,66.831 C10.112,87.614 26.1589994,162.759995 31.9999994,190.999995 C41.6029994,193.778995 50.5819993,195.999995 61.0799993,195.999995 C69.9919993,195.999995 80.7110013,194.024995 89.0000013,191.999995 C86.0890013,186.386995 82.344,180.18 80.036,175.729 C79.728,176.096 79.485,176.417 79.184,176.618 Z M85.057,70.057 C81.253,70.057 78.15,66.963 78.15,63.137 C78.15,59.329 81.253,56.234 85.057,56.234 C88.882,56.234 91.973,59.329 91.973,63.137 C91.973,66.963 88.882,70.057 85.057,70.057 L85.057,70.057 Z M89.218,44.049 C89.218,44.049 84.861,41.56 81.48,41.602 C74.532,41.693 72.64,44.763 72.64,44.763 C72.64,44.763 73.806,37.445 82.691,38.913 C87.508,39.714 89.218,44.049 89.218,44.049 L89.218,44.049 Z M15.963,53.046 C15.963,53.046 12.834,46.073 21.173,42.656 C29.521,39.238 33.586,44.601 33.586,44.601 C33.586,44.601 27.524,41.859 21.63,45.563 C15.746,49.263 15.963,53.046 15.963,53.046 L15.963,53.046 Z M23.253,67.908 C23.253,63.462 26.848,59.864 31.3,59.864 C35.74,59.864 39.34,63.462 39.34,67.908 C39.34,72.355 35.74,75.949 31.3,75.949 C26.848,75.951 23.253,72.355 23.253,67.908 L23.253,67.908 Z" fill="#FFFFFF"></path>\n\t\t\t<path d="M39.34,67.908 C39.34,63.462 35.74,59.864 31.3,59.864 C26.848,59.864 23.253,63.462 23.253,67.908 C23.253,72.355 26.848,75.951 31.3,75.949 C35.74,75.949 39.34,72.355 39.34,67.908 L39.34,67.908 Z M34.862,67.317 C33.72,67.32 32.781,66.381 32.781,65.227 C32.781,64.07 33.717,63.139 34.862,63.139 C36.016,63.139 36.952,64.07 36.952,65.227 C36.952,66.381 36.016,67.317 34.862,67.317 L34.862,67.317 Z" fill="#2D4F8E"></path>\n\t\t\t<path d="M34.862,63.139 C33.717,63.139 32.781,64.07 32.781,65.227 C32.781,66.381 33.72,67.32 34.862,67.317 C36.016,67.317 36.952,66.381 36.952,65.227 C36.952,64.07 36.016,63.139 34.862,63.139" fill="#FFFFFF"></path>\n\t\t\t<path d="M85.057,56.234 C81.253,56.234 78.15,59.329 78.15,63.137 C78.15,66.963 81.253,70.057 85.057,70.057 C88.882,70.057 91.973,66.963 91.973,63.137 C91.973,59.329 88.882,56.234 85.057,56.234 L85.057,56.234 Z M88.124,62.628 C87.149,62.628 86.344,61.835 86.344,60.839 C86.344,59.856 87.149,59.049 88.124,59.049 C89.141,59.049 89.921,59.856 89.921,60.839 C89.921,61.835 89.141,62.628 88.124,62.628 L88.124,62.628 Z" fill="#2D4F8E"></path>\n\t\t\t<path d="M88.124,59.049 C87.149,59.049 86.344,59.856 86.344,60.839 C86.344,61.835 87.149,62.628 88.124,62.628 C89.141,62.628 89.921,61.835 89.921,60.839 C89.921,59.856 89.141,59.049 88.124,59.049" fill="#FFFFFF"></path>\n\t\t\t<path d="M33.586,44.601 C33.586,44.601 29.521,39.238 21.173,42.656 C12.834,46.073 15.963,53.046 15.963,53.046 C15.963,53.046 15.746,49.263 21.63,45.563 C27.524,41.859 33.586,44.601 33.586,44.601" fill="url(#linearGradient-1)"></path>\n\t\t\t<path d="M82.691,38.913 C73.806,37.445 72.64,44.763 72.64,44.763 C72.64,44.763 74.532,41.693 81.48,41.602 C84.861,41.56 89.218,44.049 89.218,44.049 C89.218,44.049 87.508,39.714 82.691,38.913" fill="url(#linearGradient-1)"></path>\n\t\t\t<path d="M78.2,84.299 C69.297,84.855 56.723,94.061 55.917,98.927 C54.871,105.32 59.894,111.445 63.684,114.086 C63.694,114.093 63.705,114.102 63.715,114.109 C67.504,116.745 92.733,125.256 105.25,125.02 C117.781,124.776 138.361,117.102 136.101,110.953 C133.851,104.802 113.412,116.38 92.094,114.404 C76.306,112.937 73.519,105.864 77.015,100.698 C81.412,94.205 89.421,101.93 102.631,97.977 C115.861,94.035 134.363,86.979 141.228,83.137 C157.101,74.288 134.586,70.618 129.268,73.073 C124.227,75.402 106.681,79.83 98.547,81.793 C98.119,81.896 97.71,81.994 97.338,82.083 C89.904,83.863 87.123,83.736 78.2,84.299" fill="#FDD209"></path>\n\t\t</g>\n\t\t<g transform="translate(100.000000, 189.000000)">\n\t\t\t<path d="M24.316,17.97 C24.316,17.049 25.057,16.234 26.233,15.539 C26.266,14.98 26.57,14.46 27.08,13.983 C18.707,9.82 1.495,1.883 1.126,6.783 C0.62,13.274 1.126,39.724 4.616,41.725 C6.85,42.999 17.85,37.345 25.499,33.098 C23.292,31.217 24.316,26.651 24.316,17.97" fill="#65BC46"></path>\n\t\t\t<path d="M45.925,28.686 C45.961,28.7 46,28.715 46.036,28.729 C52.89,31.374 66.534,36.353 69.497,35.266 C73.492,33.739 72.492,1.813 68.008,0.796 C64.416,-0.001 50.665,9.688 45.255,13.635 C46.212,17.676 47.37,25.68 45.925,28.686" fill="#65BC46"></path>\n\t\t\t<path d="M29.214,31.611 C24.719,30.615 26.221,26.118 26.221,15.64 C26.221,15.606 26.231,15.573 26.233,15.539 C25.057,16.234 24.316,17.049 24.316,17.97 C24.316,26.651 23.292,31.217 25.499,33.098 C25.955,33.487 26.539,33.77 27.31,33.941 C31.79,34.945 40.275,33.941 43.279,31.948 C43.782,31.614 44.127,30.95 44.353,30.074 C40.837,31.758 33.329,32.547 29.214,31.611" fill="#43A244"></path>\n\t\t\t<path d="M27.08,13.983 C26.57,14.46 26.266,14.98 26.233,15.539 C26.231,15.573 26.221,15.606 26.221,15.64 C26.221,26.118 24.719,30.615 29.214,31.611 C33.329,32.547 40.837,31.758 44.353,30.074 C44.658,29.928 44.944,29.778 45.184,29.618 C45.485,29.417 45.728,29.096 45.925,28.686 C47.37,25.68 46.212,17.676 45.255,13.635 C45.044,12.746 44.844,12.046 44.683,11.636 C44.27,10.614 41.089,10.351 37.48,10.704 C33.466,11.097 28.931,12.254 27.08,13.983" fill="#65BC46"></path>\n\t\t</g>\n\t</g>\n</svg>')}connectedCallback(){this.message=this.root.host.innerHTML.trim(),this.setFields(),this.root.querySelector("#expand-button")?.addEventListener("pointerup",(e=>{this.addClass("#expand-button","hidden"),this.removeClass("#collapse-button","hidden"),this.removeClass(".details-box","hidden")})),this.root.querySelector("#collapse-button")?.addEventListener("pointerup",(e=>{this.removeClass("#expand-button","hidden"),this.addClass("#collapse-button","hidden"),this.addClass(".details-box","hidden")}))}disconnectedCallback(){}attributeChangedCallback(e,t,s){s!==t&&("type"===e&&["message","error","warning","test"].includes(s)?this.type=s:"pass"===e?this.pass="true"===s:"details"===e&&(this.details=s),this.setFields())}setFields(){this.addClass(".python-message",this.type),this.setHTML("#message",this.message),this.setHTML("#details",this.details?this.details:"No stack trace available."),this.pass&&this.addClass(".python-message","pass"),this.setHTML("#status",this.pass?"PASSED":"FAILED"),"message"===this.type?this.setHTML(".icon",'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\n    \x3c!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--\x3e\n    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/>\n</svg>'):"warning"===this.type?this.setHTML(".icon",'<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 512 512">\n  <path fill="white" d="M258,108c10.5,0,20.3,5.6,25.6,14.7l160.3,273.1c5.4,9.2,5.4,20.6.1,29.8s-15.1,14.9-25.8,14.9H97.7c-10.6,0-20.5-5.7-25.8-14.9s-5.2-20.6.1-29.8L232.4,122.7c5.3-9.1,15.1-14.7,25.6-14.7Z"/>\n  <path d="M256,32c14.2,0,27.3,7.5,34.5,19.8l216,368c7.3,12.4,7.3,27.7.2,40.1s-20.4,20.1-34.7,20.1H40c-14.3,0-27.6-7.7-34.7-20.1s-7-27.8.2-40.1L221.5,51.8c7.2-12.3,20.3-19.8,34.5-19.8ZM256,160c-13.3,0-24,10.7-24,24v112c0,13.3,10.7,24,24,24s24-10.7,24-24v-112c0-13.3-10.7-24-24-24ZM288,384c0-17.7-14.3-32-32-32s-32,14.3-32,32,14.3,32,32,32,32-14.3,32-32Z"/>\n</svg>'):"error"===this.type?this.setHTML(".icon",'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\n    <circle cx="256" cy="256" r="250" fill="white"/>\n    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm0-384c13.3 0 24 10.7 24 24V264c0 13.3-10.7 24-24 24s-24-10.7-24-24V152c0-13.3 10.7-24 24-24zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"/>\n</svg>'):"test"===this.type&&this.pass?this.setHTML(".icon",'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\n    \x3c!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--\x3e\n    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>\n</svg>'):"test"===this.type&&this.setHTML(".icon",'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\n    \x3c!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--\x3e\n    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM175 175c9.4-9.4 24.6-9.4 33.9 0l47 47 47-47c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-47 47 47 47c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-47-47-47 47c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l47-47-47-47c-9.4-9.4-9.4-24.6 0-33.9z"/>\n</svg>');const e=encodeURI(`q=${this.message.replace(/<[^>]*>?/gm,"")}`);this.root.querySelector(".ddg-search")?.setAttribute("href","//duckduckgo.com?"+e),this.root.querySelector(".ggl-search")?.setAttribute("href","//google.com?"+e)}setHTML(e,t){const s=this.root.querySelector(e);s&&(s.innerHTML=t)}addClass(e,t){const s=this.root.querySelector(e);s&&s.classList.add(t)}removeClass(e,t){const s=this.root.querySelector(e);s&&s.classList.remove(t)}}J.observedAttributes=["type","pass","details"];const ee=new CSSStyleSheet;ee.replaceSync("/*\n * TunePad\n * Northwestern University\n * michael-horn@northwestern.edu\n *\n * This project was funded by the National Science Foundation (grant DRL-1612619).\n * Any opinions, findings and conclusions or recommendations expressed in this\n * material are those of the author(s) and do not necessarily reflect the views\n * of the National Science Foundation (NSF).\n */\n :host {\n    --output-badge-color: #87c44e;\n }\n\n.python-output {\n    background-color: white;\n    color: #444;\n    font-size: 12px;\n    margin: 0.25em 0;\n    padding: 10px;\n    border-left: 10px solid var(--output-badge-color);\n}\n\n.toolbar {\n    font-size: 14px;\n    display: flex;\n    line-height: 2em;\n}\n\n.expander {\n    flex: 1;\n}\n\n.view-btn {\n    outline: none;\n    border: none;\n    background-color: transparent;\n    border-radius: 0.5em;\n    width: 3em;\n    height: 2em;\n    padding: 0 0.9rem;\n    display: block;\n}\n.view-btn:hover { background-color: #0001; }\n.view-btn.hidden { display: none; }\n\n#output-container {\n    max-height: 250px;\n    font-family: monospace;\n    overflow-y: auto;\n    line-height: 140%;\n    padding: 1em;\n    text-wrap: wrap;\n    font-size: 12px;\n    background-color: #eee;\n    display: block;\n    box-shadow: 0 0 3px inset #0003;\n}\n#output-container.hidden { display: none; }\n\n.counter {\n    color: white;\n    background-color: var(--output-badge-color);\n    font-size: 90%;\n    border-radius: 0.65em;\n    margin-right: 1em;\n    text-align: center;\n    height: 20px;\n    min-width: 1.5em;\n    line-height: 20px;\n    padding: 0 0.4em;\n    align-self: center;\n}");class te extends HTMLElement{static DefineElement(){customElements.define("python-output",te)}constructor(){super(),this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(ee);const e=document.createElement("template");e.innerHTML='<div class="python-output">\n    <div class="toolbar">\n        <div class="counter"></div>\n        Python Output\n        <div class="expander"></div>\n        <button id="collapse-button" class="view-btn hidden">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">\n                <path d="M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160z"/>\n            </svg>\n        </button>\n        <button id="expand-button" class="view-btn">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">\n                <path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z"/>\n            </svg>\n        </button>\n    </div>\n    <pre id="output-container" class="hidden">Output Uo</pre>\n</div>\n',this.root.appendChild(e.content.cloneNode(!0))}connectedCallback(){const e=this.root.host.innerHTML.trim(),t=e.split("\n").length;this.setHTML("#output-container",e),this.setHTML(".counter",`${t}`),this.root.querySelector(".toolbar")?.addEventListener("pointerup",(e=>{this.toggleClass("#expand-button","hidden"),this.toggleClass("#collapse-button","hidden"),this.toggleClass("#output-container","hidden")}))}disconnectedCallback(){}setHTML(e,t){const s=this.root.querySelector(e);s&&(s.innerHTML=t)}toggleClass(e,t){const s=this.root.querySelector(e);s&&s.classList.toggle(t)}addClass(e,t){const s=this.root.querySelector(e);s&&s.classList.add(t)}removeClass(e,t){const s=this.root.querySelector(e);s&&s.classList.remove(t)}}return te.observedAttributes=[],customElements.define($.ELEMENT,$),customElements.define(a.ELEMENT,a),customElements.define(X.ELEMENT,X),customElements.define(Z.ELEMENT,Z),J.DefineElement(),te.DefineElement(),e.AudioLoadingService=R,e.CompileResponse=Q,e.MIDIEvent=n,e.MIDIManager=i,e.MusicTrace=x,e.Note=k,e.PythonRuntime=K,e.Synthesizer=I,e.TraceEvent=A,e.TunePadAudio=v,e.clamp=y,e.dBToGain=u,e.dBToValue=m,e.gainToValue=function(e){return m(p(e))},e.gainTodB=p,e.mix=function(e,t,s){return e+s*(t-e)},e.toBool=l,e.toDateTime=function(e){return Date.parse(e)},e.toInt=h,e.toNum=c,e.toStr=d,e.valueToGain=f,e.valueTodB=g,e.veloctyToGain=function(e){return f(e/127)},e}({});
//# sourceMappingURL=tunepad.min.js.map
