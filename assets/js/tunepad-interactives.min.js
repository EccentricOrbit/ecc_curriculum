!function(){"use strict";var e="undefined"!=typeof document?document.currentScript:null;const t=new CSSStyleSheet;t.replaceSync(".explore-wrapper {\n    width: 95%;\n    margin: 2rem auto;\n    padding: 1rem 0;\n    border-radius: 20px;\n    display: flex;\n    flex-direction: column;\n}\n#code-hint {\n    margin: 0rem 0.25rem 0 0;\n    padding: 0 1rem;\n    background: #0002;\n    height: 35px;\n    line-height: 35px;\n    border: 1px solid #887;\n    border-radius: 5px;\n    user-select: none;\n    box-sizing: border-box;\n    flex: 1;\n}\n.shelf {\n    display: flex;\n    margin: 1rem 4.5rem;\n}\n.keyboard-wrapper {\n    display: flex;\n}\n#copy-button {\n    color: #000a;\n    outline: none;\n    border: 1px solid #555;\n    height: 35px;\n    background-color: transparent;\n    border-radius: 5px;\n    font-weight: 500;\n    user-select: none;\n}\n#copy-button:hover { color: black; }\n#copy-button:active { color: rgb(45, 113, 134); }\npiano-instrument { flex: 1; }\n");function s(e,t=0){const s=parseInt(e);return isNaN(s)?t:s}function n(e,t=0){const s=parseFloat(e);return isNaN(s)?t:s}function i(e,t=!1){if(null==e)return t;if("boolean"==typeof e)return e;{const t=e.toString().toLowerCase();if("true"===t||"t"===t)return!0;if("false"===t||"f"===t)return!1}return t}function r(e,t=""){return e?e.toString():t}function a(e){return Math.max(0,Math.pow(10,e/20))}function o(e,t,s){return Math.max(t,Math.min(s,e))}class h{get bpm(){return this._bpm}set bpm(e){this.setTempo(e)}get meter(){return this._meter}set meter(e){this.setTimeSignature(e)}get beatsPerMeasure(){return this._beatsPerMeasure}get beatValue(){return this._beatValue}get key(){return this._key}set key(e){this._key=e}get contextTime(){return this.context.currentTime}get time(){return this.isPaused?this._start:this.contextTime-this._start}get timeString(){let e=""+Math.floor(this.time/60)%60,t=""+Math.round(this.time)%60,s=""+Math.floor(100*this.time)%100;return 1==e.length&&(e=`0${e}`),1==t.length&&(t=`0${t}`),1==s.length&&(s=`0${s}`),`${e}:${t}.${s}`}get beats(){return this.time*this.bpm/60+this._elapsedBeats}get isPaused(){return 0==this._subscribers.size}static init(){return null==h._instance&&(h._instance=new h),h._instance}constructor(){this._start=0,this._elapsedBeats=0,this._bpm=90,this._meter="4/4",this._beatsPerMeasure=4,this._beatValue=4,this._key="C major",this._subscribers=new Set,this._listeners=new Set,this.context=new AudioContext,this._metronomes=new Set,this._timer=-1}addSubscriber(e){this._listeners.add(e)}removeSubscriber(e){this._listeners.delete(e)}isPlaying(e){return this._subscribers.has(e)}play(e){this.isPaused&&(this._start=this.contextTime-this._start),this._subscribers.add(e),this._listeners.add(e)}pause(e){this._listeners.add(e),this.isPlaying(e)&&(this._subscribers.delete(e),this.isPaused&&(this._start=this.contextTime-this._start))}stopAll(){this._elapsedBeats=0,this._start=0,this._subscribers.clear(),this._listeners.forEach((e=>e.onClockReset()))}setTime(e){this._elapsedBeats=e,this._start=0,this._listeners.forEach((e=>e.onClockTimeChange())),this._subscribers.clear()}setTempo(e){if(isNaN(e))return;const t=this.beats;e!=this._bpm&&(this._bpm=Math.max(5,e),this._start=this.contextTime-60*t/this._bpm,this._listeners.forEach((e=>e.onTempoChange())))}setTimeSignature(e){2!=e.split("/").length&&(e="4/4"),this._beatsPerMeasure=s(e.split("/")[0],-1),this._beatValue=s(e.split("/")[1],-1),(this._beatsPerMeasure<0||this._beatValue<0)&&(this._beatsPerMeasure=4,this._beatValue=4);const t=`${this._beatsPerMeasure}/${this._beatValue}`;this._meter!=t&&(this._meter=t,this._listeners.forEach((e=>e.onTimeSignatureChange())))}startMetronome(e){if(this._metronomes.add(e),-1==this._timer){const e=this.contextTime;let t=0;this._metronomes.forEach((e=>e.pulse(0))),this._timer=window.setInterval((()=>{if(0==this._metronomes.size)window.clearInterval(this._timer),this._timer=-1;else{const s=60/this.bpm,n=this.contextTime-e,i=Math.floor(n/s)%this.beatsPerMeasure;i!=t&&(t=i,this._metronomes.forEach((e=>e.pulse(t))))}}),30)}}stopMetronome(e){this._metronomes.delete(e)}isMetronomePlaying(e){return this._metronomes.has(e)}}class c{constructor(e,t,s){this.value=1,this.gain=new GainNode(e),this.name=t,this.value=s,this.gain.gain.value=s}connect(e,t){return t==this.name&&(e.level.connect(this.gain),!0)}destroy(){this.gain.disconnect()}updateParameter(e,t){return e==`${this.name}-mod}`&&(this.value=n(t,this.value),this.gain.gain.value=this.value,!0)}}class l{constructor(e,t){this.id=0,this.modulators=new Array,this.connectors=new Array,this.context=e,this.id=parseInt(t.id),this.level=e.createGain();const s=n(t.level,0);this.level.gain?.setValueAtTime(a(s),0),this.level.gain.value=a(s),this.addModulator("gain",n(t["gain-mod"],1),this.level.gain)}connect(e,t){for(let s of this.modulators)if(s.connect(e,t))return;"level"==t?e.level.connect(this.level.gain):e.level.connect(this.level)}addConnector(e){this.connectors.push(e),this.level?.connect(e.level)}addModulator(e,t,s){const n=new c(this.context,e,t);n.gain.connect(s),this.modulators.push(n)}playNote(e){}releaseNote(){}scheduleNote(e,t,s,n){}cancelNotes(){}destroy(){this.level.disconnect(),this.modulators.forEach((e=>e.destroy())),this.connectors.forEach((e=>e.destroy()))}pitchBend(e){}schedulePitchBend(e,t){}updateParameter(e,t){for(let s of this.modulators)if(s.updateParameter(e,t))return;if("level"==e){const e=n(t,0);this.level.gain?.setValueAtTime(a(e),0),this.level.gain.value=a(e)}}updateConnectorLevel(e,t){this.connectors.forEach((s=>{s.id==e&&s.updateLevel(t)}))}attachAnalyzer(e,t,s){for(let n of this.connectors)n.id==e&&n.attachAnalyzer(t,s)}detachAnalyzer(e){this.connectors.forEach((t=>{t.id==e&&t.detachAnalyzer()}))}getFloatTimeDomainData(e,t,s){this.connectors.forEach((n=>{n.id==e&&n.getFloatTimeDomainData(t,s)}))}}class d extends l{constructor(e,t){super(e,t),this.A=.1,this.D=.1,this.S=1,this.R=.2,this.aShape=5,this.dShape=2,this.rShape=2,this.attackCurve=[],this.decayCurve=[],this.releaseCurve=[],this.A=n(t.A,this.A),this.D=n(t.D,this.D),this.S=n(t.S,this.S),this.R=n(t.R,this.R),this.R=Math.max(this.R,.01),this.aShape=n(t["a shape"],this.aShape),this.dShape=n(t["d shape"],this.dShape),this.rShape=n(t["r shape"],this.rShape),this._attack=e.createGain(),this._decay=e.createGain(),this._release=e.createGain(),this._attack.gain.value=0,this._decay.gain.value=1,this._release.gain.value=1,this._attack.connect(this._decay),this._decay.connect(this._release),this._release.connect(this.level),this._buildCurves()}connect(e,t){e.level.connect(this._attack)}playNote(e){let t=this.context.currentTime;try{this._attack.gain?.cancelScheduledValues(0),this._decay.gain?.cancelScheduledValues(0),this._release.gain?.cancelScheduledValues(0),this.A>0?this._attack.gain?.setValueAtTime(0,t):this._attack.gain?.setValueAtTime(1,t),this._decay.gain?.setValueAtTime(1,t),this._release.gain?.setValueAtTime(1,t),t=this.context.currentTime+.01,this.A>0?this._attack.gain?.setValueCurveAtTime(this.attackCurve,t,this.A):this._attack.gain?.setValueAtTime(1,t),this.D>0?this._decay.gain?.setValueCurveAtTime(this.decayCurve,t+this.A,this.D):this._decay.gain?.setValueAtTime(this.S,t+this.A)}catch(e){console.log("Exception in ADSR playNote $x.")}}releaseNote(){const e=this.context.currentTime;this.R>0?(this._attack.gain?.cancelScheduledValues(e),this._decay.gain?.cancelScheduledValues(e),this._release.gain?.setValueCurveAtTime(this.releaseCurve,e,this.R)):this._release.gain?.setValueAtTime(0,e)}scheduleNote(e,t,s,n){const i=t<0?-t:0;let r=(t=t<0?0:t)+this.context.currentTime;if(this.A>0?this._attack.gain?.setValueAtTime(0,r):this._attack.gain?.setValueAtTime(1,r),this._decay.gain?.setValueAtTime(1,r),this._release.gain?.setValueAtTime(1,r),r+=.01,this.A>0&&this.A>i){const e=this.A-i;this._attack.gain?.setValueCurveAtTime(this.attackCurve,r,e)}else this._attack.gain?.setValueAtTime(1,r);if(this.D>0&&this.A+this.D>i&&s>this.A){const e=i>=this.A?this.D-(i-this.A):this.D,t=i>=this.A?r:r+this.A-i;this._decay.gain?.setValueCurveAtTime(this.decayCurve,t,e),this.A+this.D>s&&this._decay.gain?.cancelScheduledValues(r+s-i)}else this._decay.gain?.setValueAtTime(this.S,Math.max(0,r+this.A+this.D-i));if(s+this.R>i){const e=i>=s?this.R-(i-s):this.R;this._release.gain?.setValueCurveAtTime(this.releaseCurve,r+s-i,e)}else this._release.gain?.setValueAtTime(0,r)}cancelNotes(){super.cancelNotes();const e=this.context.currentTime;this._release.gain?.cancelScheduledValues(e),this._release.gain.value=0,this._attack.gain?.cancelScheduledValues(e),this._attack.gain.value=0,this._decay.gain?.cancelScheduledValues(e),this._decay.gain.value=0}destroy(){super.destroy(),this._attack.disconnect(),this._decay.disconnect(),this._release.disconnect()}updateParameter(e,t){switch(super.updateParameter(e,t),e){case"A":this.A=n(t,this.A);break;case"D":this.D=n(t,this.D);break;case"S":this.S=n(t,this.S);break;case"R":this.R=n(t,this.R);break;case"a shape":this.aShape=n(t,this.aShape);break;case"d shape":this.dShape=n(t,this.dShape);break;case"r shape":this.rShape=n(t,this.rShape)}this.R=Math.max(this.R,.01),this._buildCurves()}_buildCurves(){this._buildAttackCurve(this.aShape),this._buildDecayCurve(this.dShape),this._buildReleaseCurve(this.rShape)}_buildAttackCurve(e){e=o(e,.001,8),this.attackCurve=[];const t=Math.ceil(d.samplesPerSecond*this.A);if(t>0)for(let s=0;s<=t;s++){let n=s/t;n=Math.pow(n,e),this.attackCurve.push(n)}}_buildDecayCurve(e){e=o(e,.001,4),this.decayCurve=[];const t=Math.ceil(d.samplesPerSecond*this.D);if(t>0)for(let s=0;s<=t;s++){let n=s/t;n=1-Math.pow(n,e),this.decayCurve.push((1-this.S)*n+this.S)}}_buildReleaseCurve(e){e=o(e,.001,4),this.releaseCurve=[];const t=Math.ceil(d.samplesPerSecond*this.R);if(t>0)for(let s=0;s<=t;s++){let n=s/t;n=1-Math.pow(n,e),this.releaseCurve.push(n)}}}d.samplesPerSecond=300;class u extends l{constructor(e,t){super(e,t),this.compressor=e.createDynamicsCompressor(),this.compressor.connect(this.level),this.compressor.threshold.value=n(t.threshold,-24),this.compressor.knee.value=n(t.knee,30),this.compressor.ratio.value=n(t.ratio,12),this.compressor.attack.value=n(t.attack,.003),this.compressor.release.value=n(t.release,.25)}connect(e,t){"audio"===t?e.level.connect(this.compressor):super.connect(e,t)}destroy(){super.destroy(),this.compressor.disconnect()}updateParameter(e,t){super.updateParameter(e,t),"threshold"===e?this.compressor.threshold.value=o(n(t,-24),-100,0):"knee"==e?this.compressor.knee.value=o(n(t,30),0,40):"ratio"==e?this.compressor.ratio.value=o(n(t,12),1,20):"release"==e?this.compressor.release.value=o(n(t,.25),0,1):"attack"==e&&(this.compressor.attack.value=o(n(t,.003),0,1))}}class p{get context(){return this.source.context}constructor(e,t){this.id=0,this.dB=0,this._pre=null,this._analyzers=new Array,this._splitter=null,this._merger=null,this._buffer=null,this.type="",this.source=e,this.id=s(t.id,-1),this.level=new GainNode(this.context),this.dB=n(t.level,0),this.level.gain?.setValueAtTime(a(this.dB),0),this.type=r(t.type,"")}updateLevel(e){this.dB=e,(this._pre??this.level).gain?.setValueAtTime(a(e),0)}destroy(){this.level.disconnect()}attachAnalyzer(e,t,s=-60,n=5){t=o(t,1,6),this._pre=new GainNode(this.context),this._splitter=this.context.createChannelSplitter(t),this._merger=this.context.createChannelMerger(t),this._pre.gain?.setValueAtTime(a(this.dB),0),this.level.gain?.setValueAtTime(1,0),this.source.level.disconnect(this.level),this.source.level.connect(this._pre),this._pre?.connect(this._splitter),this._merger?.connect(this.level);for(let i=0;i<t;i++){let t=new AnalyserNode(this.level.context);this._analyzers.push(t),t.fftSize=e,t.minDecibels=s,t.maxDecibels=n,this._splitter?.connect(t,i,0),t.connect(this._merger,0,i),0==i&&(this._buffer=new Float32Array(t.frequencyBinCount))}}detachAnalyzer(){if(null!=this._pre){this.level.gain?.setValueAtTime(a(this.dB),0),this.source.level.disconnect(this._pre),this._pre?.disconnect(),this._splitter?.disconnect(),this._merger?.disconnect();for(let e of this._analyzers)e.disconnect();this.source.level.connect(this.level),this._pre=null,this._buffer=null,this._splitter=null,this._merger=null,this._analyzers=[]}}getFloatTimeDomainData(e,t){if(e<this._analyzers.length){const s=this._analyzers[e];if(null!=this._buffer&&t.length==this._buffer.length){s.getFloatTimeDomainData(this._buffer);for(let e=0;e<t.length;e++)t[e]+=this._buffer[e]}}}}class m extends l{constructor(e,t){super(e,t),this.csn=e.createConstantSource(),this.csn.offset.value=n(t.signal,1),this.csn.connect(this.level),this.csn.start()}destroy(){super.destroy(),this.csn.stop(),this.csn.disconnect()}updateParameter(e,t){super.updateParameter(e,t),"signal"===e&&this.csn.offset.setValueAtTime(n(t,1),this.context.currentTime)}}class f extends l{constructor(e,t){super(e,t),this.gates=new Array,this.delayTime=.1,this.delayTime=n(t.delay,.1),this.audioIn=e.createGain(),this.delayIn=e.createGain(),this.addModulator("delay",n(t["delay-mod"],.5),this.delayIn.gain)}connect(e,t){"audio"==t?e.level.connect(this.audioIn):"delay"==t?e.level.connect(this.delayIn):super.connect(e,t)}updateParameter(e,t){"delay"==e?(this.delayTime=n(t,this.delayTime),this.gates.forEach((e=>{e.delay.delayTime.linearRampToValueAtTime(this.delayTime,this.context.currentTime+.1)}))):super.updateParameter(e,t)}playNote(e){const t=this.context.createGain();t.gain.value=1,t.gain.setValueAtTime(1,0);const s=this.context.createDelay();s.delayTime.setValueAtTime(this.delayTime,0),this.audioIn.connect(t),this.delayIn.connect(s.delayTime),t.connect(s),s.connect(this.level),this.gates.push({free:-1,gate:t,delay:s}),this._freeGates()}releaseNote(){this._freeGates(),this.gates.forEach((e=>{e.free<0&&(e.free=this.level.context.currentTime)}))}_freeGates(){const e=this.context.currentTime;this.gates=this.gates.filter((t=>!(t.free>=0&&t.free<e&&(t.gate.disconnect(),t.delay.disconnect(),1))))}scheduleNote(e,t,s,n){const i=this.context.currentTime,r=i+t+s+n,a=this.context.createGain();a.gain.value=0,a.gain.setValueAtTime(0,0),a.gain.setValueAtTime(1,Math.max(i,i+t)),a.gain.setValueAtTime(0,r);const o=this.context.createDelay();o.delayTime.setValueAtTime(this.delayTime,i),this.audioIn.connect(a),this.delayIn.connect(o.delayTime),a.connect(o),o.connect(this.level),this.gates.push({free:r,gate:a,delay:o}),this._freeGates()}destroy(){super.destroy(),this.gates.forEach((e=>{e.gate.disconnect(),e.delay.disconnect()})),this.gates=[],this.audioIn.disconnect(),this.delayIn.disconnect()}cancelNotes(){this.gates.forEach((e=>{e.gate.disconnect(),e.delay.disconnect()})),this.gates=[]}}class g extends l{constructor(e,t){super(e,t),this.param=0,this.curve="tanh",this.param=n(t.param,this.param),this.curve=r(t.curve,this.curve),this.dist=new WaveShaperNode(e),this.dist.curve=this._makeCurve(),this.dist.oversample="4x",this.gain=new GainNode(e),this.gain.gain.value=n(t["pre-gain"],1),this.gain.connect(this.dist),this.dist.connect(this.level)}connect(e,t){"audio"===t?e.level.connect(this.gain):super.connect(e,t)}destroy(){super.destroy(),this.gain.disconnect(),this.dist.disconnect()}updateParameter(e,t){super.updateParameter(e,t),"param"===e?(this.param=n(t,this.param),this.dist.curve=this._makeCurve()):"curve"===e?(this.curve=r(t,this.curve),this.dist.curve=this._makeCurve()):"pre-gain"===e&&(this.gain.gain.value=n(t,1))}_makeCurve(){const e=new Float32Array(512),t=this._curve(this.curve);for(let s=0;s<e.length;s++){const n=x(-1,1,s/(e.length-1));e[s]=t(n,this.param)}return e}_curve(e){switch(e){case"tanh":default:return y;case"sigmoid":return b;case"sin":case"sine":return v;case"steep sin":case"steep sine":return w}}}function y(e,t){const s=6-5*t,n=Math.pow(Math.E,s*e);return(n-1)/(n+1)}function b(e,t){const s=50*t;return(3+s)*e*20*(Math.PI/180)/(Math.PI+s*Math.abs(e))}function v(e,t){const s=1+5*t;return Math.sin(e*(19.8*s)/(2*Math.PI))}function w(e,t){const s=9.9*Math.PI;return x(Math.pow(Math.sin(e*s),5),Math.sin(e*s),t)}function x(e,t,s){return e+s*(t-e)}class k extends l{constructor(e,t){super(e,t),this.tracking=!0,this.ratio=1,this.frequency=350,this.Q=1,this.gain=0,this.detune=0,this.type="lowpass",this.filter=e.createBiquadFilter(),this.filter.connect(this.level),this.Q=o(n(t.Q,1),1e-4,1e3),this.gain=o(n(t.gain,0),-40,40),this.type=r(t["filter type"],"lowpass"),this.detune=n(t.detune,0),this.frequency=o(n(t.frequency,350),0,16700),this.tracking=i(t.tracking,!0),this.ratio=n(t["tracking ratio"],1),this.addModulator("Q",n(t["Q-mod"],1),this.filter.Q),this.addModulator("gain",n(t["gain-mod"],5),this.filter.gain),this.addModulator("frequency",n(t["frequency-mod"],1e3),this.filter.frequency),this.filter.Q.value=this.Q,this.filter.gain.value=this.gain,this.filter.type=this.type,this.filter.detune.value=this.detune,this.filter.frequency.value=this.frequency}playNote(e){const t=this.tracking?e.frequency*this.ratio+this.frequency:this.frequency,s=this.context.currentTime;this.filter.Q?.setValueAtTime(this.Q,s),this.filter.gain?.setValueAtTime(this.gain,s),this.filter.detune?.setValueAtTime(this.detune,s),this.filter.frequency?.setValueAtTime(t,s)}scheduleNote(e,t,s,n){t=t<0?0:t;const i=this.context.currentTime,r=this.tracking?e.frequency*this.ratio+this.frequency:this.frequency;this.filter.Q?.setValueAtTime(this.Q,t+i),this.filter.gain?.setValueAtTime(this.gain,t+i),this.filter.detune?.setValueAtTime(this.detune,t+i),this.filter.frequency?.setValueAtTime(r,t+i)}cancelNotes(){super.cancelNotes(),this.filter.Q?.cancelScheduledValues(0),this.filter.gain?.cancelScheduledValues(0),this.filter.detune?.cancelScheduledValues(0),this.filter.frequency?.cancelScheduledValues(0)}destroy(){super.destroy(),this.filter.disconnect()}connect(e,t){"audio"===t?e.level.connect(this.filter):super.connect(e,t)}updateParameter(e,t){const s=this.context.currentTime;"filter type"===e&&k.FILTERS.includes(t)?(this.type=r(t,"lowpass"),this.filter.type=this.type):"Q"===e?(this.Q=o(n(t,this.Q),1e-4,1e3),this.filter.Q.cancelScheduledValues(0),this.filter.Q.setValueAtTime(this.Q,s),this.filter.Q.value=this.Q):"gain"===e?(this.gain=o(n(t,this.gain),-40,40),this.filter.gain.cancelScheduledValues(0),this.filter.gain.setValueAtTime(this.gain,s),this.filter.gain.value=this.gain):"detune"===e?(this.detune=n(t,this.detune),this.filter.detune?.cancelScheduledValues(0),this.filter.detune?.setValueAtTime(this.detune,s)):"frequency"===e?(this.frequency=o(n(t,this.frequency),0,16700),this.filter.frequency?.cancelScheduledValues(0),this.filter.frequency?.setValueAtTime(this.frequency,s),this.filter.frequency.value=this.frequency):"tracking"===e?this.tracking=i(t,this.tracking):"ratio"===e?this.ratio=n(t,this.ratio):super.updateParameter(e,t)}}k.FILTERS=["lowpass","highpass","bandpass","allpass","lowshelf","highshelf","peaking","notch","allpass"];class A extends l{constructor(e,t){super(e,t),this.inverter=e.createGain(),this.inverter.gain.value=-1,this.inverter.gain.setValueAtTime(-1,0),this.inverter.connect(this.level)}connect(e,t){e.level.connect(this.inverter)}destroy(){super.destroy(),this.inverter.disconnect()}}class S extends l{get buffer(){switch(this.noise){case"pink":return this.pink;case"brown":return this.brown;default:return this.white}}constructor(e,t){super(e,t),this.noise="white",this.noise=r(t.noise,this.noise);const s=e.sampleRate,n=2*s;this.white=e.createBuffer(1,n,s),this.pink=e.createBuffer(1,n,s),this.brown=e.createBuffer(1,n,s);const i=this.white.getChannelData(0),a=this.pink.getChannelData(0),o=this.brown.getChannelData(0);let h=0,c=0,l=0,d=0,u=0,p=0,m=0,f=0;for(let e=0;e<n;e++){i[e]=2*Math.random()-1;let t=Math.random();h=.99886*h+.0555179*t,c=.99332*c+.0750759*t,l=.969*l+.153852*t,d=.8665*d+.3104856*t,u=.55*u+.5329522*t,p=-.7616*p-.016898*t,a[e]=h+c+l+d+u+p+m+.5362*t,a[e]*=.11,m=.115926*t,o[e]=(f+.02*t)/1.02,f=o[e],o[e]*=3.5}this.gain=new GainNode(e),this.gain.gain.value=.3,this.gain.connect(this.level),this.source=new AudioBufferSourceNode(e),this.source.buffer=this.buffer,this.source.loop=!0,this.source.start(),this.source.connect(this.gain)}destroy(){super.destroy(),this.source.stop(),this.source.disconnect(),this.gain.disconnect()}updateParameter(e,t){super.updateParameter(e,t),"noise"===e&&(this.noise=r(t,this.noise),this.source.disconnect(),this.source=new AudioBufferSourceNode(this.context),this.source.buffer=this.buffer,this.source.loop=!0,this.source.start(),this.source.connect(this.gain))}}S.NOISE_TYPES=["white","pink","brown"];class E extends l{constructor(e,t){super(e,t),this.frequency=440,this.multiplier=1,this.detune=0,this.relative=!0,this.waveform="sine",this.waveform=r(t.waveform,"sine"),this.frequency=n(t.frequency,this.frequency),this.detune=n(t.detune,0),this.relative=i(t.relative,!0),this.multiplier=n(t.multiplier,this.multiplier),this.osc=e.createOscillator(),this.gain=new GainNode(e),this.shaper=e.createWaveShaper(),this.addModulator("detune",n(t["detune-mod"],500),this.osc.detune),this.addModulator("frequency",n(t["frequency-mod"],1e3),this.osc.frequency),this.addModulator("amplitude",n(t["amplitude-mod"],1),this.level.gain),this.gain.gain.value=.3,E.Waveforms.includes(this.waveform)||(this.waveform="sine"),this.osc.frequency.setValueAtTime(90,0),this.osc.type="sine",this.osc.start(),this.osc.connect(this.gain),this.shaper.connect(this.gain),this.gain.connect(this.level),this._updateWaveform(this.waveform)}_updateWaveform(e){E.Waveforms.includes(e)&&(this.waveform=e),this.osc.type="sine",E.BasicWaveforms.includes(e)?(this.osc.type=e,this.osc.disconnect(),this.osc.connect(this.gain)):E.PeriodicWaveforms.includes(e)?(this.osc.setPeriodicWave(this._createPeriodicWave(e)),this.osc.disconnect(),this.osc.connect(this.gain)):E.ShaperWaveforms.includes(e)&&(this.shaper.curve=this._createWaveShaper(e),this.osc.disconnect(),this.osc.connect(this.shaper),this.osc.type="pitched noise"===e?"sawtooth":"sine")}_createWaveShaper(e){var t,s=new Float32Array(256);switch(e){case"exp sin":t=e=>Math.pow(e,5);break;case"hump":t=e=>(e<0?0:e)-.5;break;default:t=e=>2*Math.random()-1}for(let e=0;e<s.length;e++)s[e]=t(2*e/s.length-1);return s}_createPeriodicWave(e){let t=new Array;switch(e){case"cello":t=[0,1,.5,.3,.5,.35,.2,.2,.1,.15,.15,.15];break;case"flute":t=[0,.5,.05,.3,.1];break;case"reed":t=[-.15,.5,1,.4,.6,.3,.25,.2];break;case"brass":t=[0,.8,.8,.85,.9,.8,.85,.7,.6,.4,.3,.25,.2,.1];break;case"glass":t=[0,1,0,.25,0,.5,0,.75,0,.8];break;case"vibraphone":t=[0,6,19,.8,13,3];break;case"camel":t.push(0);for(let e=1;e<20;e++)t.push(1/Math.pow(e,2));break;case"soft saw":t.push(-.1);for(let e=1;e<20;e++)t.push(1/e);break;case"soft square":t.push(0);for(let e=1;e<50;e++)t.push(1/e*(e%2));break;case"organ 1":t=[-.1,1,1,1];break;case"organ 2":t=[-.1,1,1,1,0,0,0,0,0,.8];break;case"organ 3":t=[0,1,0,0,0,0,.8,.8,.8,.8];break;case"buzz 1":t.push(0);let e=1;for(let s=1;s<100;s++)s%3==0||s%4==0?(t.push(1/e),e++):t.push(0);break;default:t.push(0),e=1;for(let s=1;s<100;s++)s%5==0||s%2==0?(t.push(.5/e),e++):t.push(0)}return this.osc.context.createPeriodicWave(t,new Float32Array(t.length))}playNote(e){let t=this.relative?e.frequency*this.multiplier:this.frequency;t=o(t,0,23999),this.osc.frequency?.setValueAtTime(t,this.context.currentTime),this.osc.detune?.setValueAtTime(this.detune,this.context.currentTime)}scheduleNote(e,t,s,n){t=t<0?0:t;let i=this.relative?e.frequency*this.multiplier:this.frequency;i=o(i,0,23999),this.osc.frequency?.setValueAtTime(i,t+this.context.currentTime),this.osc.detune?.setValueAtTime(this.detune,t+this.context.currentTime)}cancelNotes(){super.cancelNotes(),this.osc.frequency?.cancelScheduledValues(0),this.osc.detune?.cancelScheduledValues(0)}destroy(){super.destroy(),this.osc.stop(),this.osc.disconnect(),this.gain.disconnect(),this.shaper.disconnect()}pitchBend(e){const t=this.context.currentTime;this.osc.detune?.setTargetAtTime(this.detune+e,t,.1)}schedulePitchBend(e,t){t.apply(this.osc.detune,e,this.context,this.detune)}updateParameter(e,t){if("waveform"===e)this._updateWaveform(t);else if("relative"==e)this.relative=i(t,!0);else if("frequency"==e)this.frequency=n(t,this.frequency),this.osc.frequency?.setValueAtTime(this.frequency,this.context.currentTime);else if("multiplier"==e)if(this.relative){let e=this.osc.frequency.value/this.multiplier;this.multiplier=n(t,this.multiplier),this.multiplier>0&&(e*=this.multiplier),e=o(e,0,23999),this.osc.frequency?.setValueAtTime(e,this.context.currentTime)}else this.multiplier=n(t,this.multiplier);else"detune"==e?(this.detune=n(t,this.detune),this.osc.detune?.setValueAtTime(this.detune,this.context.currentTime)):super.updateParameter(e,t)}}E.BasicWaveforms=["sine","square","triangle","sawtooth"],E.PeriodicWaveforms=["cello","flute","reed","brass","glass","vibraphone","camel","organ 1","organ 2","organ 3","soft saw","soft square","buzz 1","buzz 2"],E.ShaperWaveforms=["pitched noise","exp sin","hump"],E.Waveforms=[...E.BasicWaveforms,...E.PeriodicWaveforms,...E.ShaperWaveforms];class _ extends d{constructor(e,t){super(e,t)}}class N extends l{constructor(e,t){super(e,t),this.panner=new StereoPannerNode(e),this.panner.pan.setValueAtTime(n(t.pan,0),0),this.panner.connect(this.level),this.addModulator("pan",n(t["pan-mod"],.5),this.panner.pan)}connect(e,t){"audio"===t?e.level.connect(this.panner):super.connect(e,t)}destroy(){super.destroy(),this.panner.disconnect()}updateParameter(e,t){super.updateParameter(e,t),"pan"===e&&this.panner.pan.setValueAtTime(n(t,0),0)}}class M extends l{constructor(e,t){super(e,t),this.frequency=220,this.multiplier=1,this.detune=0,this.relative=!0;var s=new Float32Array(512);for(let e=0;e<s.length/2;e++)s[e]=-1,s[e+Math.floor(s.length/2)]=1;this.driver=new OscillatorNode(e),this.driver.type="sawtooth",this.gain=new GainNode(e),this.shaper=new WaveShaperNode(e),this.shaper.curve=s,this.csn=new ConstantSourceNode(e),this.addModulator("pulse width",1,this.csn.offset),this.addModulator("detune",n(t["detune-mod"],400),this.driver.detune),this.addModulator("frequency",n(t["frequency-mod"],100),this.driver.frequency),this.addModulator("amplitude",n(t["amplitude-mod"],1),this.level.gain),this.driver.connect(this.shaper),this.csn.connect(this.shaper),this.shaper.connect(this.gain),this.gain.connect(this.level),this.csn.offset.value=n(t["pulse width"],0),this.frequency=n(t.frequency,this.frequency),this.detune=n(t.detune,this.detune),this.relative=i(t.relative,this.relative),this.gain.gain.value=.3,this.driver.frequency.value=this.frequency,this.driver.detune.value=this.detune,this.csn.start(),this.driver.start()}playNote(e){let t=this.relative?e.frequency*this.multiplier:this.frequency;t=o(t,0,23999),this.driver.frequency.setValueAtTime(t,this.context.currentTime),this.driver.detune.setValueAtTime(this.detune,this.context.currentTime)}scheduleNote(e,t,s,n){t=t<0?0:t;let i=this.relative?e.frequency*this.multiplier:this.frequency;i=o(i,0,23999),this.driver.frequency.setValueAtTime(i,t+this.context.currentTime),this.driver.detune.setValueAtTime(this.detune,t+this.context.currentTime)}cancelNotes(){super.cancelNotes(),this.driver.frequency.cancelScheduledValues(0),this.driver.detune.cancelScheduledValues(0)}destroy(){super.destroy(),this.csn.stop(),this.csn.disconnect(),this.driver.stop(),this.driver.disconnect(),this.gain.disconnect(),this.shaper.disconnect()}pitchBend(e){const t=this.context.currentTime;this.driver.detune.setTargetAtTime(this.detune+e,t,.1)}schedulePitchBend(e,t){t.apply(this.driver.detune,e,this.context,this.detune)}updateParameter(e,t){if("relative"===e)this.relative=i(t,!0);else if("frequency"==e)this.frequency=n(t,this.frequency),this.driver.frequency.setValueAtTime(this.frequency,this.context.currentTime);else if("multiplier"===e)if(this.relative){let e=this.driver.frequency.value/this.multiplier;this.multiplier=n(t,this.multiplier),this.multiplier>0&&(e*=this.multiplier),e=o(e,0,23999),this.driver.frequency.setValueAtTime(e,this.context.currentTime)}else this.multiplier=n(t,this.multiplier);else"detune"===e?(this.detune=n(t,this.detune),this.driver.detune.setValueAtTime(this.detune,this.context.currentTime)):"pulse width"===e?this.csn.offset.value=n(t,0):super.updateParameter(e,t)}}class T extends l{constructor(e,t){super(e,t),this.csn=new ConstantSourceNode(e),this.csn.offset.value=2*Math.random()-1,this.csn.connect(this.level),this.csn.start()}playNote(e){const t=2*Math.random()-1;this.csn.offset.setValueAtTime(t,this.context.currentTime)}scheduleNote(e,t,s,n){const i=2*Math.random()-1;t=t<0?0:t,this.csn.offset.setValueAtTime(i,t+this.context.currentTime)}destroy(){super.destroy(),this.csn.stop(),this.csn.disconnect()}}class L{constructor(){}static hasSound(e){return L.sounds.has(e)}static getAudioBuffer(e){return L.sounds.get(e)}static async loadAudioBuffer(e){const t=L.context;if(L.hasSound(e))return L.getAudioBuffer(e);let s=e;s=s.endsWith(".ogg")||s.endsWith(".wav")?e:L.supportsAudioType("audio/ogg")?`${e}.ogg`:`${e}.wav`;try{let n=await fetch(s),i=await n.arrayBuffer(),r=await t.decodeAudioData(i);return L.sounds.set(e,r),r}catch(e){console.log(e)}}static async loadCustomSound(e){if(L.hasSound(e))return!0;const t=L.context;try{let s=await fetch(e),n=await s.arrayBuffer(),i=await t.decodeAudioData(n);return L.sounds.set(e,i),console.log("Loaded "+e),!0}catch(e){return console.log(e),!1}}static supportsAudioType(e){if(L._supports.has(e))return L._supports.get(e);let t=!1;const s=document.createElement("audio");return s.id="test-audio-node",document.body.append(s),"probably"!=s.canPlayType(e)&&"maybe"!=s.canPlayType(e)||(t=!0,document.querySelector("#test-audio-node")?.remove()),L._supports.set(e,t),t}}function C(e){return"object"==typeof e&&"sample"in e&&"string"==typeof e.sample&&"step"in e&&"number"==typeof e.step}L.sounds=new Map,L.context=h.init().context,L._supports=new Map;class P extends l{constructor(e,t){super(e,t),this.sources=new Array,this.playback=1,this.detune=0,this.sample_pack="piano",this.samples=new Array,this._rate=1,this.drumkit=!1,this.playback=n(t.playback,this.playback),this.detune=n(t.detune,this.detune),this.sample_pack=r(t["sample-pack"],this.sample_pack),this.dIn=new GainNode(e),this.pIn=new GainNode(e),this.dIn.gain.value=n(t["detune-mod"],1),this.pIn.gain.value=n(t["playback-mod"],1),"samples"in t&&Array.isArray(t.samples)&&this.loadSamplePack(t.samples)}loadSamplePack(e){this.samples=e.filter((e=>C(e))).sort(((e,t)=>e.step-t.step)),this.samples.forEach((e=>L.loadAudioBuffer(e.sample)))}static loadAudioBuffers(e,t){e.forEach((e=>L.loadAudioBuffer(e.sample)))}playNote(e){this.scheduleNote(e,0,0,0)}findBestSample(e){let t;if(this.drumkit)t=this.samples.find((t=>t.step===Math.round(e.note)));else{let s=1e5;for(const n of this.samples){if(n.step==e.note)return n;if(n.step>e.note)return n.step-e.note+3<s?n:t;{const i=e.note-n.step;i<s&&(t=n,s=i)}}}return t}scheduleNote(e,t,s,n){const i=t<0?-t:0;t=Math.max(0,t);const r=this.findBestSample(e);if(r){const a=L.getAudioBuffer(r.sample);if(a){const o=e.note-r.step,h=this.context.currentTime,c=Math.pow(2,o/12),l=new AudioBufferSourceNode(this.context);l.connect(this.level),this.sources.push(l),this.dIn.connect(l.detune),this.pIn.connect(l.playbackRate),l.buffer=a,l.playbackRate.value=c*this.playback,l.start(t+h,i),s>0&&l.stop(t+h+s+n),l.addEventListener("ended",(e=>{this.sources=this.sources.filter((e=>e!==l)),l.disconnect()})),a.duration,this.playback,this._rate=c}}}cancelNotes(){super.cancelNotes(),this.sources.forEach((e=>{e.stop(),e.disconnect()})),this.sources=new Array,this._rate=1}destroy(){super.destroy(),this.sources.forEach((e=>{e.stop(),e.disconnect()})),this.sources=new Array,this._rate=1}pitchBend(e){const t=this.context.currentTime;this.sources.forEach((s=>{s.detune?.setTargetAtTime(this.detune+e,t,.1)}))}schedulePitchBend(e,t){if(this.sources.length>0){const s=this.sources[this.sources.length-1];t.apply(s.detune,e,this.context,this.detune)}}connect(e,t){"detune"==t?e.level.connect(this.dIn):"playback"==t&&e.level.connect(this.pIn)}updateParameter(e,t){"playback"==e?(this.playback=n(t,this.playback),this.sources.forEach((e=>{e.playbackRate?.setValueAtTime(this._rate*this.playback,this.context.currentTime)}))):"detune"==e?(this.detune=n(t,this.detune),this.sources.forEach((e=>{e.detune?.setValueAtTime(this.detune,this.context.currentTime)}))):"sample-pack"==e||("playback-mod"==e?this.pIn.gain.value=n(t,1):"detune-mod"==e?this.dIn.gain.value=n(t,1):super.updateParameter(e,t))}}class q extends l{constructor(e,t){super(e,t),this.merger=e.createChannelMerger(2),this.leftGain=new GainNode(e),this.rightGain=new GainNode(e);let s=n(t["left-level"],0);this.leftGain.gain.setValueAtTime(a(s),0),s=n(t["right-level"],0),this.rightGain.gain?.setValueAtTime(a(s),0),this.leftGain.connect(this.merger,0,0),this.rightGain.connect(this.merger,0,1),this.merger.connect(this.level),this.addModulator("left-level",n(t["left-level-mod"],.5),this.leftGain.gain),this.addModulator("right-level",n(t["right-level-mod"],.5),this.rightGain.gain)}connect(e,t){"left"===t?e.level.connect(this.leftGain):"right"===t?e.level.connect(this.rightGain):super.connect(e,t)}destroy(){super.destroy(),this.merger.disconnect(),this.leftGain.disconnect(),this.rightGain.disconnect()}updateParameter(e,t){if(super.updateParameter(e,t),"left-level"===e){let e=n(t,0);this.leftGain.gain.setValueAtTime(a(e),0)}else if("right-level"==e){let e=n(t,0);this.rightGain.gain.setValueAtTime(a(e),0)}}}class V{constructor(e){this.id=0,this.free=0,this.nodes=new Map,this.release=0,this.gates=new Array,this.context=e,this.id=V._CHAIN_ID++,this.loadPatch(V._sine_patch)}playNote(e,t){const s=t.context.currentTime;this.free=31536e3,this.disconnect();const n=new GainNode(t.context);n.connect(t),n.gain.value=e.gain,n.gain.setValueAtTime(e.gain,s),this.out?.level.connect(n),this.gates.push({free:this.free,node:n}),this.nodes.forEach(((t,s,n)=>t.playNote(e)))}releaseNote(){this.nodes.forEach(((e,t,s)=>e.releaseNote()))}scheduleNote(e,t,s,n){const i=n.context.currentTime;this.free=i+t+s+this.release+.05;const r=new GainNode(n.context);r.connect(n),r.gain.value=0,r.gain?.setValueAtTime(0,0),r.gain?.setValueAtTime(e.gain,Math.max(i,i+t)),r.gain?.setValueAtTime(0,Math.max(i,i+t+s+this.release)),this.out?.level.connect(r),this.gates.push({free:this.free,node:r});try{this.nodes.forEach(((n,i,r)=>{n.scheduleNote(e,t,s,this.release)}))}catch(e){console.log("Note scheduling exception: $x")}for(let e=0;e<this.gates.length;e++)this.gates[e].free<i&&(this.gates[e].node?.disconnect(),this.out?.level.disconnect(this.gates[e].node),delete this.gates[e]);return this.gates=this.gates.filter((e=>void 0!==e)),this.release}disconnect(){this.out?.level.disconnect(),this.gates.forEach((e=>{e.node?.disconnect()})),this.gates=[]}cancelNotes(){this.disconnect(),this.nodes.forEach((e=>e.cancelNotes())),this.free=0}destroy(){this.disconnect(),this.nodes.forEach((e=>e.destroy())),this.nodes.clear()}pitchBend(e){this.nodes.forEach((t=>t.pitchBend(e)))}schedulePitchBend(e,t){this.nodes.forEach((s=>s.schedulePitchBend(e,t)))}loadPatch(e){if(this.nodes.clear(),this.out=void 0,this.release=0,Array.isArray(e.nodes))for(let t of e.nodes){let e=this.createSynthNode(this.context,t);e instanceof _&&(this.out=e),this.nodes.set(e.id,e)}this._updateReleaseValue();for(let t of e.routing){let e=this.nodes.get(t.source),s=this.nodes.get(t.dest);if(e&&s){let n=new p(e,t);e.addConnector(n),s.connect(n,r(t.type,""))}}}createSynthNode(e,t){switch(t.type){case"compressor":return new u(e,t);case"const":return new m(e,t);case"distortion":return new g(e,t);case"gain":return new l(e,t);case"inverter":return new A(e,t);case"lfo":const s=new E(e,t);return s.gain.gain.value=1,s;case"fm":case"osc":return new E(e,t);case"noise":return new S(e,t);case"panner":return new N(e,t);case"pwm":return new M(e,t);case"delay":return new f(e,t);case"adsr":return new d(e,t);case"filter":return new k(e,t);case"out":return new _(e,t);case"rand":return new T(e,t);case"sample":case"drums":return new P(e,t);case"stereo":return new q(e,t);default:return console.log(`Node not found: ${t.type}`),new l(e,t)}}getNodeById(e){return this.nodes.get(e)}updateParameter(e,t,s){let n=this.nodes.get(e);n?.updateParameter(t,s),this._updateReleaseValue()}updateConnectorLevel(e,t,s){let n=this.nodes.get(e);n?.updateConnectorLevel(t,s)}attachAnalyzer(e,t,s,n){let i=this.nodes.get(e);i?.attachAnalyzer(t,s,n)}detachAnalyzer(e,t){let s=this.nodes.get(e);s?.detachAnalyzer(t)}getFloatTimeDomainData(e,t,s,n){let i=this.nodes.get(e);i?.getFloatTimeDomainData(t,s,n)}_updateReleaseValue(){this.release=0,this.nodes.forEach((e=>{e instanceof d&&(this.release=Math.max(Math.max(e.A+e.D,e.R),this.release))}))}}V._CHAIN_ID=0,V._sine_patch={nodes:[{type:"out",A:.1,D:.1,S:.8,R:.15,id:0},{type:"osc",waveform:"sine",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"out"}]},V._custom_patch={nodes:[{type:"out",id:0,A:0,D:.1,S:1,R:.3,level:0},{type:"sample","sample-pack":"custom",samples:[{sample:"<SOUNDURL>",step:60}],id:1,level:0}],routing:[{id:2,source:1,dest:0,type:"audio",level:0}]};const $=16.3516,O=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],I=["rgb(229, 76, 78)","rgb(223, 132, 74)","rgb(228, 171, 81)","rgb(227, 199, 73)","rgb(223, 228, 78)","rgb(174, 215, 71)","rgb(63, 188, 70)","rgb(63, 169, 180)","rgb(64, 124, 180)","rgb(78, 69, 179)","rgb(141, 69, 183)","rgb(202, 69, 147)"];class B{get note(){return this._note}set note(e){this._note=e}get end(){return this.start+this.duration}get octave(){return Math.floor(this.note/12)}set octave(e){this.note=12*e+this.step}get step(){return this.note%12}set step(e){this.note=12*this.octave+e}get cents(){return Math.round(100*(this.note-Math.floor(this.note)))}get velocity(){return this._velocity}set velocity(e){this._velocity=D(e,0,127)}get gain(){return this.velocity*this.velocity/16129}set gain(e){this.velocity=Math.sqrt(127*e*127)}get name(){return`${O[Math.floor(this.step)]}`}get accidental(){return this.name.substring(1)}get nameWithOctave(){return`${O[Math.round(this.step)]}${this.octave-1}`}get stepColor(){return I[Math.round(this.step)%I.length]}get rate(){return Math.pow(2,this.note/12-1)}get frequency(){return $*this.rate}set frequency(e){e>0&&(this.note=12*Math.log(e/$)/Math.LN2)}constructor(e){this._note=60,this.start=0,this.duration=1,this._velocity=90,this.note=e}isEqual(e){return this.note===e.note&&this.start===e.start&&this.duration===e.duration&&this.velocity===e.velocity}clone(){let e=new B(this.note);return e.start=this.start,e.duration=this.duration,e.velocity=this.velocity,e}static fromName(e){const t=new B(60);return t.octave=B.nameToOctave(e),t.step=B.nameToStep(e),t}static fromFrequency(e){const t=new B(60);return t.frequency=e,t}static nameToOctave(e){if(2==e.length){let t=e.codePointAt(1);if(t)return D(t-48,0,8)}else if(e.length>2){let t=e.codePointAt(2);if(t)return D(t-48,0,8)}return 0}static nameToStep(e){return null==e||""==e?0:(e=e.length<=2?e[0].toUpperCase():e.substring(0,2).toUpperCase(),Math.max(0,O.indexOf(e)))}static nameToNote(e){if(e.length<2||e.length>3)return-1;e=e.replaceAll("#","♯");for(let t=0;t<12;t++)if(e.startsWith(O[t])){const s=e.substring(O[t].length);if(["0","1","2","3","4","5","6","7","8"].includes(s)){return 12*((s.codePointAt(0)||48)-48)+t}}return-1}}function D(e,t,s){return Math.max(t,Math.min(s,e))}class R{get end(){return this.time+this.duration}constructor(e,t){this.time=0,this.duration=1,this.line=-1,this.note=new B(60),this.trace_group=-1,this.params=new Map,this.id=R._TRACE_ID++,this.command=e,this.time=t}clone(){let e=new R(this.command,this.time);e.line=this.line,e.duration=this.duration,e.note=this.note.clone();for(let[t,s]of this.params)e.params.set(t,s);return e}static fromMap(e){let t=new R(String(e.get("command")),Math.max(0,Number(e.get("time"))));t.duration=Number(e.get("duration")),t.note.duration=t.duration;for(let[s,n]of e)if("note"===s&&"number"==typeof n)t.note.note=n;else if("pitch"===s&&"number"==typeof n)t.note.note=n+60;else if("velocity"===s&&"number"==typeof n)t.note.velocity=n;else if("sustain"===s&&"number"==typeof n)t.note.duration=Math.max(t.note.duration,n),t.duration=t.note.duration;else if("line"===s&&"number"==typeof n)t.line=n;else if("trace"===s)t.trace_group=n;else{if(["command","time","duration"].includes(s))continue;t.params.set(s,n)}return t}isEquivalent(e){if(this.command===e.command&&this.time===e.time&&this.duration===e.duration&&this.note.isEqual(e.note)){for(let[t,s]of this.params)if("line"!==t&&e.params.get(t)!==s)return!1;return!0}return!1}}R.PLAY="play",R.SOUND="sound",R.REST="rest",R.PUSH_FX="push_fx",R.POP_FX="pop_fx",R.MESSAGE="message",R._TRACE_ID=0;class H{constructor(e,t){this.released=!1,this.canceled=!1,this.note=e,this.chain=t}}const K={start:0,beats:0,values:[]};class F{constructor(e,t){this.params=new Array,this.start=0,this.beats=-1,this.free=-1,this.id=F._EFFECT_ID++,this.name=e,this.oparams=t,this.start=Math.max(0,t.start),this.beats=t.beats,this.free=-1;for(const e of t.values){const t=Array();if(Array.isArray(e))for(const s of e)t.push(s);else"number"==typeof e&&t.push(e);this.params.push(t)}}static createEffect(e,t){return new G(t)}connect(e,t,s){return this.free=(s+this.start+this.beats+.1)*(60/t)+e.context.currentTime,this.node.connect(e),this.node}disconnect(){this.node.disconnect()}afterEffect(e,t,s,n,i){}clampParam(e,t,s){for(let n=0;n<e.length;n++)e[n]=o(e[n],t,s)}}F._EFFECT_ID=0;class G extends F{get node(){return this._node}constructor(e){super("empty",K),this._node=new GainNode(e)}}class z{get isAssigned(){return this.nodeId>=0}get value(){return o(this._value,this.minValue,this.maxValue)}set value(e){this._value=o(e,this.minValue,this.maxValue)}get percentValue(){return(this.value-this.minValue)/this.range}set percentValue(e){this.value=e*this.range+this.minValue}get range(){return this.maxValue-this.minValue}constructor(){this._value=1,this.nodeId=-1,this.name="",this.label="",this.slot=0,this.minValue=0,this.maxValue=1}static fromJSON(e){const t=new z;return t.nodeId=s(e.node,-1),t.name=r(e.name,""),t.label=r(e.label,""),t.slot=s(e.slot,0),t.minValue=n(e.min,0),t.maxValue=n(e.max,1),t._value=o(n(e.value,1),t.minValue,t.maxValue),t}toJSON(){return{node:this.nodeId,name:this.name,label:this.label,slot:this.slot,min:this.minValue,max:this.maxValue,value:this.value}}}const j={nodes:[{type:"out",A:.05,D:.1,S:.8,R:.25,level:0,id:0},{type:"osc",waveform:"sine",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"audio",level:0,id:1}],parameters:[],name:"Simple Sine",description:"",instrument:"piano",submenu:"",version:"2.0",format:"tunepad-patch",created:"2024-03-08 16:15:54.384",modified:"2024-03-08 16:15:54.385"},U={patch_id:280,nodes:[{type:"out",A:.05,D:.1,S:.8,R:.25,level:0,id:0},{type:"osc",waveform:"sawtooth",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"audio",level:0,id:1}],parameters:[],name:"Simple Saw",description:"",instrument:"piano",submenu:"",version:"2.0",format:"tunepad-patch",created:"2024-03-08 16:15:54.384",modified:"2024-03-08 16:15:54.385"},W={nodes:[{type:"out",A:.05,D:.1,S:.8,R:.25,level:0,id:0},{type:"osc",waveform:"square",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"audio",level:0,id:1}],parameters:[],name:"Simple Square",description:"",instrument:"piano",submenu:"",version:"2.0",format:"tunepad-patch",created:"2024-03-08 16:15:54.384",modified:"2024-03-08 16:15:54.385"},Q={nodes:[{type:"out",A:.05,D:.1,S:.8,R:.25,level:0,id:0},{type:"osc",waveform:"triangle",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"audio",level:0,id:1}],parameters:[],name:"Simple Tri",description:"",instrument:"piano",submenu:"",version:"2.0",format:"tunepad-patch",created:"2024-03-08 16:15:54.384",modified:"2024-03-08 16:15:54.385"},X={nodes:[{id:0,type:"out",A:0,D:.3,S:.5,R:.2,"a shape":3.4,"d shape":2,"r shape":2,level:0},{id:7,type:"osc",waveform:"sawtooth",relative:!0,frequency:440,multiplier:1,"frequency-mod":1e3,detune:0,"detune-mod":2,"amplitude-mod":.5,level:.1},{id:8,type:"filter","filter type":"lowpass",tracking:!0,frequency:980,"frequency-mod":100,Q:3,"Q-mod":10,gain:0,"gain-mod":250,"tracking ratio":1,level:0}],routing:[{id:26,source:7,dest:8,type:"audio",level:0},{id:25,source:8,dest:0,type:"audio",level:0}],parameters:[{node:8,name:"frequency",label:"FREQUENCY",slot:1,min:32,max:15e3,value:7e3},{node:8,name:"Q",label:"RESONANCE (Q)",slot:2,min:1e-4,max:50,value:50}],name:"Filtered Saw",instrument:"piano",version:"2.0",format:"tunepad-patch",created:"2024-05-30 17:44:15.448",modified:"2024-05-30 17:44:15.449"},Y={nodes:[{id:0,type:"out",cx:116.38970947265625,cy:86.873046875,A:.011363636363636362,D:.1,S:1,R:.005681818181818182,"a shape":4.000000000000001,"d shape":2,"r shape":2,level:0},{id:2,type:"osc",cx:13.176898002624512,cy:87.11394500732422,waveform:"square",relative:!0,frequency:440.00000000000034,multiplier:1,"frequency-mod":1e3,detune:0,"detune-mod":10,"amplitude-mod":.5,level:-5},{id:3,type:"lfo",cx:-87.84600448608398,cy:87.11394500732422,waveform:"sine",relative:!1,frequency:6.900000000000002,"frequency-mod":30,detune:0,"detune-mod":20,"amplitude-mod":.5,level:4.950595879501315}],routing:[{id:2,source:2,dest:0,type:"audio",level:0},{id:5,source:3,dest:2,type:"detune",level:5}],parameters:[],name:"Wobbly Square",description:"Created in patchworks",instrument:"piano",version:"2.0",format:"tunepad-patch",created:"2022-03-01 16:37:48.199",modified:"2022-03-01 17:34:23.146"};function J(e){return"string"==typeof e.name&&Array.isArray(e.nodes)&&Array.isArray(e.routing)&&"2.0"===e.version&&"tunepad-patch"===e.format}class Z{get bpm(){return this._bpm}set bpm(e){isNaN(e)||(this._bpm=o(e,5,300))}get voice(){return this.patch.name}constructor(e){this._bpm=90,this.notes=new Array,this.patch=j,this.bank=new Array,this.sound_gens=new Array,this.parameters=new Array,this._analyzers=new Map,this._effects=new Array,e&&this.loadPatch(e)}get isPlaying(){if(0===this.bank.length)return!1;{const e=this.bank[0].context.currentTime;for(const t of this.bank)if(t.free>e)return!0;return!1}}playNote(e,t){t||(t=h.init().context.destination);const s="number"==typeof e?new B(e):e;let n=this._allocateGenerator(t.context,t.context.currentTime);n&&(n.cancelNotes(),n.playNote(s,t),this.notes.push(new H(s,n)))}releaseNote(e){const t="number"==typeof e?e:e.note;this.notes.forEach((e=>{e.note.note===t&&this._release(e)}))}releaseAll(){this.notes.forEach((e=>{this._release(e)}))}_release(e){if(e.released)return;e.released=!0,e.chain.releaseNote();const t=Math.ceil(1e3*e.chain.release)+100;setTimeout((()=>{this.notes=this.notes.filter((t=>t!==e)),e.chain.disconnect(),this._releaseGenerator(e.chain)}),t)}scheduleNote(e,t,s=0,n){n||(n=h.init().context.destination);const i="number"==typeof e?new B(e):e,r=n.context.currentTime,a=i.duration*(60/this.bpm);t=(t+s)*(60/this.bpm);const o=this._allocateGenerator(n.context,r+t);return o?.scheduleNote(i,t,a,n),o}cancelAllNotes(){for(const e of this.bank)this._releaseGenerator(e);for(const e of this.sound_gens)e.cancelNotes();this.sound_gens=[]}scheduleNotes(e,t,s){const n=t.context.currentTime,i=Math.max(0,-s);for(let e=0;e<this._effects.length;e++){const t=this._effects[e];t.free>0&&t.free<n&&(t.disconnect(),delete this._effects[e])}this._effects=this._effects.filter((e=>void 0!==e));for(let e=0;e<this.sound_gens.length;e++)this.sound_gens[e].free<n&&delete this.sound_gens[e];this.sound_gens=this.sound_gens.filter((e=>void 0!==e));const r=new Array,a=new G(t.context);a.beats=e.beats,r.push(a),this._effects.push(a),a.connect(t,this.bpm,s);for(const n of e.trace)if(n.command==R.PUSH_FX){const e=r[r.length-1],i=F.createEffect(n,t.context);i.connect(e.node,this.bpm,s),r.push(i),this._effects.push(i)}else if(n.command==R.POP_FX)r.pop();else if(n.command==R.PLAY&&n.end>=i){const e=r[r.length-1],t=this.scheduleNote(n.note,n.time,s,e.node);r.forEach((e=>{e.afterEffect(t,n.time,n.note.duration,this.bpm,s)}))}}scheduleMidiNotes(e,t,s,n=1){const i=window.performance.now(),r=Math.max(0,-t);for(const a of e.trace)if(a.command===R.PLAY&&a.end>=r){const e=a.note.clone();e.gain*=n;const r=a.note.duration*(60/this.bpm)*1e3,o=i+(a.time+t)*(60/this.bpm)*1e3,h=[144,Math.round(e.note),e.velocity],c=[128,Math.round(e.note),0];s.send(h,o),s.send(c,o+r)}}playMidiNote(e,t){const s="number"==typeof e?new B(e):e,n=[144,Math.round(s.note),s.velocity];t.send(n,window.performance.now())}releaseMidiNote(e,t){const s="number"==typeof e?new B(e):e,n=[128,Math.round(s.note),0];t.send(n,window.performance.now())}setMidiProgram(e,t){t>=0&&t<=127&&e.send([192,t])}cancelAllMidiNotes(e){const t=window.performance.now();for(let s=0;s<=127;s++)e.send([128,s,0],t);"clear"in e&&"function"==typeof e.clear&&e.clear()}pitchBend(e){this.notes.forEach((t=>t.chain.pitchBend(e)))}async loadPatch(e){if(J(e))return await this._loadPatchData(e);if(e instanceof URL)return await this._loadPatchURL(e);switch(e){case"simple-saw":return await this._loadPatchData(U);case"simple-sine":default:return await this._loadPatchData(j);case"simple-square":return await this._loadPatchData(W);case"simple-tri":return await this._loadPatchData(Q);case"filtered-saw":return await this._loadPatchData(X);case"wobbly-square":return await this._loadPatchData(Y)}}async _loadPatchURL(e){let t=await fetch(e),s=await t.json();return J(s)?await this._loadPatchData(s,e.toString()):(this._loadPatchData(j),!1)}async _loadPatchData(e,t="./"){const s=t.split("/").slice(0,-1).join("/")+"/";this.patch=e,this.parameters=[],this._destroyAllGenerators(),this.sound_gens=[];for(const e of this.patch.nodes)if(Array.isArray(e.samples)){const t=e.samples.filter((e=>C(e))).sort(((e,t)=>e.step-t.step));t.forEach((e=>{e.sample=s+e.sample,L.loadAudioBuffer(e.sample)})),e.samples=t}else"reverb"===e.type?await L.loadCustomSound(e.impulse):"buffer source"===e.type&&await L.loadCustomSound(e.buffer);if(Array.isArray(this.patch.parameters))for(const e of this.patch.parameters)this.parameters.push(z.fromJSON(e));return!0}updateParameter(e,t){let s=-1;for(let t of this.parameters)if(t.name===e){s=t.nodeId;break}if(!(s<0)){this.bank.forEach((n=>{n.updateParameter(s,e,t)}));for(const n of this.patch.nodes)n.id==s&&(n[e]=t)}}set attack(e){this.bank.forEach((t=>{t.out&&(t.out.A=Math.max(0,e))})),this.patch.nodes.filter((e=>"out"===e.type)).forEach((t=>t.A=Math.max(0,e)))}set decay(e){this.bank.forEach((t=>{t.out&&(t.out.D=Math.max(0,e))})),this.patch.nodes.filter((e=>"out"===e.type)).forEach((t=>t.D=Math.max(0,e)))}set sustain(e){this.bank.forEach((t=>{t.out&&(t.out.S=o(e,0,1))})),this.patch.nodes.filter((e=>"out"===e.type)).forEach((t=>t.S=o(e,0,1)))}set release(e){this.bank.forEach((t=>{t.out&&(t.out.R=Math.max(0,e))})),this.patch.nodes.filter((e=>"out"===e.type)).forEach((t=>t.R=Math.max(0,e)))}set volume(e){this.bank.forEach((t=>{t.out?.updateParameter("level",o(e,-50,5))})),this.patch.nodes.filter((e=>"out"===e.type)).forEach((t=>t.level=o(e,-50,5)))}_allocateGenerator(e,t){this.bank.length>0&&this.bank[0].context!=e&&this._destroyAllGenerators();for(const s of this.bank)if(s.free<t&&s.context==e)return this._analyzers.forEach((e=>{0==s.free&&s.attachAnalyzer(e.nodeId,e.connectorId,e.fftSize,e.channels)})),s;if(this.bank.length<Z.MAX_GENERATORS){const t=new V(e);return t.loadPatch(this.patch),this.bank.push(t),this._analyzers.forEach((e=>{t.attachAnalyzer(e.nodeId,e.connectorId,e.fftSize,e.channels)})),t}}_releaseGenerator(e){e.cancelNotes(),this._analyzers.forEach((t=>{e.detachAnalyzer(t.nodeId,t.connectorId)}))}_destroyAllGenerators(){this.bank.forEach((e=>{e.destroy()})),this.bank=[]}}Z.MAX_GENERATORS=24;const ee=new CSSStyleSheet;ee.replaceSync("#ring {\n    fill: #3e3e3c;\n    stroke: none;\n}\n.track {\n    fill: #181818;\n    stroke: black;\n    stroke-width: 1.5;\n}\n#arc {\n    stroke: #7ff;\n    stroke-width: 7;\n    fill: none;\n}\n.active #arc {\n    stroke: white;\n}\n#pointer {\n    stroke: #ddd;\n    stroke-width: 6;\n    pointer-events: none;\n}\n#container {\n    max-width: 100px;\n    user-select: none;\n}\n.tick {\n    fill: #999;\n}\n.cover {\n    fill: #fff2;\n    stroke: #fff1;\n    stroke-width: 4;\n    pointer-events: none;\n}");class te extends HTMLElement{get value(){const e=this.maxValue-this.minValue;return this.minValue+this._value*e}set value(e){const t=this.maxValue-this.minValue;e=Math.min(this.maxValue,Math.max(this.minValue,e)),this._value=(e-this.minValue)/t,this._redraw()}get angle(){const e=this.maxAngle-this.minAngle;return this._value*e+this.minAngle}constructor(){super(),this.minAngle=0,this.maxAngle=1.5*Math.PI,this.minValue=0,this.maxValue=1,this._value=0,this._startVal=0,this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(ee),this.root.innerHTML='<div id="container">\n    <svg version="1.1" viewBox="-50 -50 100 100">\n        <g transform="rotate(135, 0, 0)">\n            <circle class="track" cx="0" cy="0" r="49"/>\n            <path id="arc" d=""/>\n            <circle id="ring" cx="0" cy="0" r="36"/>\n            <line id="pointer" x1="0" y1="0" x2="0" y2="46"/>\n            <circle class="cover" cx="0" cy="0" r="27"/>\n            <circle class="tick" cx="55" cy="0" r="4"/>\n            <circle class="tick" cx="0" cy="-55" r="4"/>\n        </g>\n    </svg>\n</div>\n',this.container=this.root.querySelector("#container"),this.ring=this.root.querySelector("#ring"),this.line=this.root.querySelector("#pointer"),this.arc=this.root.querySelector("#arc"),this._value=1,console.log(this._describeArc(55))}connectedCallback(){this.value=this._startVal,this._redraw();let e=!1,t=-1;this.ring.addEventListener("pointerdown",(s=>{e=!0,t=s.clientY,this.container.classList.add("active")})),document.addEventListener("pointermove",(s=>{if(e){const e=t-s.clientY;t=s.clientY,this._value=Math.max(0,Math.min(1,this._value+e/100)),this._redraw(),this.emitEvent("adjusted")}})),document.addEventListener("pointerup",(t=>{e&&(e=!1,this.container.classList.remove("active"),this.emitEvent("changed"))}))}disconnectedCallback(){}attributeChangedCallback(e,t,s){"min"===e?this.minValue=parseFloat(s):"max"===e?this.maxValue=parseFloat(s):"value"===e&&(this.isConnected?this.value=parseFloat(s):this._startVal=parseFloat(s))}emitEvent(e){this.dispatchEvent(new CustomEvent(e,{bubbles:!0,composed:!0,detail:{origin:this,value:this.value}}))}_redraw(){const e=Math.cos(this.angle),t=Math.sin(this.angle);this.line.setAttribute("x1",""+15*e),this.line.setAttribute("y1",""+15*t),this.line.setAttribute("x2",""+33*e),this.line.setAttribute("y2",""+33*t),this.arc.setAttribute("d",this._describeArc(43))}_describeArc(e){const t=e*Math.cos(this.angle),s=e*Math.sin(this.angle);return["M",e*Math.cos(0),e*Math.sin(0),"A",e,e,0,this.angle>=Math.PI?1:0,1,t,s].join(" ")}}te.ELEMENT="range-dial",te.observedAttributes=["min","max","value"];(new CSSStyleSheet).replaceSync('\n.drop-menu {\n    position: absolute;\n    background-color: white;\n    border: 1px solid #0001;\n    border-radius: 8px;\n    padding: 8px 0;\n    z-index: 100;\n    display: flex;\n    flex-direction: column;\n    min-width: 200px;\n    box-shadow: 0px 3px 5px #0005;\n    -webkit-touch-callout: none;\n    user-select: none;\n    margin: 0;\n}\n.drop-menu.hidden { display: none; }\n.drop-menu:hover { cursor: pointer; }\n.drop-menu.terminal {\n    max-height: 70vh;\n    overflow-y: auto !important;\n}\n.menu-item {\n    line-height: 140%;\n    display: flex;\n    align-items: center;\n    font-size: 14px;\n    font-weight: normal;\n    color: #3C4E60;\n    outline: none;\n    border: none;\n    padding: 5px 20px 5px 10px;\n    white-space: nowrap;\n    position: relative;\n    text-align: left;\n}\n.menu-item:hover { background: rgba(0, 0, 0, 0.15); }\n.menu-item:not(:has(.drop-menu)):active { background: rgba(0, 0, 0, 0.2); }\n.menu-item.highlight { background: rgba(0, 0, 0, 0.085); }\n.menu-item.disabled { color: #aaa; }\n.menu-item.disabled:hover { background-color: transparent; }\n.menu-item.disabled:active { background-color: transparent; }\n.menu-item.disabled .icon { opacity: 0.3; }\n.menu-item.hidden { display: none; }\n\n.menu-item:hover > .drop-menu {\n  display: flex;\n  left: 88%;\n  top: -10px;\n}\n\n.menu-item .icon {\n    width: 1.1rem;\n    height: 1.1rem;\n    margin: 0 0.85rem 0 0.5rem;\n    text-align: center;\n    opacity: 0.6;\n    background-repeat: no-repeat;\n    background-size: contain;\n    background-position: center;\n}\n.menu-item .expand {\n  text-align: right;\n  position: relative;\n  left: 5px;\n  font-size: 90%;\n  width: 2em;\n  flex: 1;\n}\n.menu-item .name {\n  flex: 1;\n}\n.menu-item .expand::before {\n  content: "▸";\n  font-size: 17px;\n  color: rgba(0,0,0,0.6);\n  font-weight: 600;\n}\n.menu-separator {\n    border-top: 1px solid #0005;\n    margin: 10px;\n    height: 2px;\n}');class se extends HTMLElement{constructor(){super(),this.classList.add("drop-menu","hidden")}emitEvent(e){this.dispatchEvent(new CustomEvent(e,{bubbles:!0,composed:!0,detail:{origin:this}}))}async connectedCallback(){this.parentElement.addEventListener("pointerdown",(e=>{this.classList.toggle("hidden"),e.stopPropagation(),this.emitEvent("context-menu-open")})),document.addEventListener("pointerdown",(e=>{this.classList.add("hidden")})),document.addEventListener("context-menu-open",(e=>{e.detail.origin!==this&&this.classList.add("hidden")})),this.addEventListener("context-menu-action",(e=>{this.classList.add("hidden")}))}}se.ELEMENT="context-menu";class ne extends HTMLElement{constructor(){super(),this.disabled=!1,this.classList.add("menu-item"),this.name=document.createElement("div"),this.name.classList.add("name"),this.icon=document.createElement("div"),this.icon.classList.add("icon"),this.expand=document.createElement("div"),this.expand.classList.add("expand")}emitEvent(e){this.dispatchEvent(new CustomEvent(e,{bubbles:!0,composed:!0,detail:{origin:this,action:this.getAttribute("action"),checked:this.checked}}))}async connectedCallback(){this.appendChild(this.icon),this.appendChild(this.name);const e=this.querySelector("context-menu");e&&this.appendChild(this.expand),this.addEventListener("pointerdown",(e=>e.stopPropagation())),this.addEventListener("pointerup",(t=>{this.disabled||e||(this.toggleChecked(),setTimeout((()=>this.emitEvent("context-menu-action")),100))}))}attributeChangedCallback(e,t,s){"name"===e?this.name.innerHTML=s:"icon"===e?this.icon.style.backgroundImage=`url(${s})`:"disabled"===e?(this.disabled="true"===s,this.classList.toggle("disabled",this.disabled)):"checked"===e&&(this.hasAttribute("radio-group")&&"true"===s?this.toggleChecked():this.setChecked("true"===s))}toggleChecked(){if(this.hasAttribute("radio-group")){const e=this.getAttribute("radio-group");this.uncheckSiblings(e),this.setChecked(!0);let t=this.parentElement;for(;t instanceof se||t instanceof ne;)t instanceof ne&&t.getAttribute("radio-group")===e&&t.setChecked(!0),t=t.parentElement}else void 0!==this.checked&&this.setChecked(!this.checked)}uncheckSiblings(e){let t=this.parentElement,s=t;for(;s instanceof se||s instanceof ne;)s=s.parentElement,s instanceof se&&(t=s);t?.querySelectorAll(`.menu-item[radio-group=${e}]`).forEach((e=>{e instanceof ne&&e.setChecked(!1)}))}setChecked(e){this.checked=e,this.icon.style.backgroundImage=this.checked?"url(/assets/images/check-icon.svg)":"none"}}ne.ELEMENT="context-menu-item",ne.observedAttributes=["name","icon","action","disabled","checked"];const ie=new CSSStyleSheet;ie.replaceSync('* {\n    box-sizing: border-box;\n}\n\n.instrument {\n    display: grid;\n    grid-template-columns: repeat(8, 1fr);\n}\n\n.instrument.armed {\n    /*outline: 1px solid gold;*/\n}\n\n.wrapper {\n    margin: 0 3px 3px 0;\n    color: white;\n    flex: 1;\n    border-radius: 4px;\n    border: 2px solid #fff1;\n    box-shadow: 3px 3px 3px #0002;\n}\n\n.drum-pad {\n    min-width: 58px;\n    height: 72px;\n    text-align: center;\n    border-radius: 1px;\n    background-color: #fff2;\n    display: flex;\n    flex-direction: column;\n    border: 1px solid #fff5;\n    position: relative;\n}\n.drum-pad:hover { \n    background-color: #fff5;\n    border: 1px solid #fff7;\n}\n.drum-pad.pressed {\n    background-color: #fff7;\n    border: 1px solid #fff7;\n}\n.drum-name {\n    color: #fffa;\n    font-weight: bold;\n    text-transform: uppercase;\n    font-size: 10px;\n    user-select: none;\n    flex: 1;\n    align-content: center;\n}\n.drum-pad:hover .drum-name { color: white; }\n\n.pad-name, .key-hint {\n    font-size: 10px;\n    pointer-events: none;\n    user-select: none;\n    position: absolute;\n    bottom: 3px;\n    color: #fff6;\n}\n.pad-name {\n    font-weight: bold;\n    color: #fffd;\n    left: 3px;\n}\n.key-hint { right: 3px; }\n\n.wrapper:has(.drum-pad.pressed[data-note="0"]) {\n    background-color: hsl(0 90 50);\n    box-shadow: 0px 0px 5px hsl(0 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="1"]) {\n    background-color: hsl(22 90 50);\n    box-shadow: 0px 0px 5px hsl(22 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="2"]) {\n    background-color: hsl(44 90 50);\n    box-shadow: 0px 0px 5px hsl(44 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="3"]) {\n    background-color: hsl(66 90 50);\n    box-shadow: 0px 0px 5px hsl(66 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="4"]) {\n    background-color: hsl(88 90 50);\n    box-shadow: 0px 0px 5px hsl(88 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="5"]) {\n    background-color: hsl(110 90 50);\n    box-shadow: 0px 0px 5px hsl(110 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="6"]) {\n    background-color: hsl(132 90 50);\n    box-shadow: 0px 0px 5px hsl(132 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="7"]) {\n    background-color: hsl(154 90 50);\n    box-shadow: 0px 0px 5px hsl(154 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="8"]) {\n    background-color: hsl(176 90 50);\n    box-shadow: 0px 0px 5px hsl(176 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="9"]) {\n    background-color: hsl(198 90 50);\n    box-shadow: 0px 0px 5px hsl(198 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="10"]) {\n    background-color: hsl(220 90 50);\n    box-shadow: 0px 0px 5px hsl(220 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="11"]) {\n    background-color: hsl(242 90 50);\n    box-shadow: 0px 0px 5px hsl(242 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="12"]) {\n    background-color: hsl(264 90 50);\n    box-shadow: 0px 0px 5px hsl(264 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="13"]) {\n    background-color: hsl(286 90 50);\n    box-shadow: 0px 0px 5px hsl(286 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="14"]) {\n    background-color: hsl(308 90 50);\n    box-shadow: 0px 0px 5px hsl(308 90 50);\n}\n.wrapper:has(.drum-pad.pressed[data-note="15"]) {\n    background-color: hsl(330 90 50);\n    box-shadow: 0px 0px 5px hsl(330 90 50);\n}\n\n@media screen and (max-width: 650px) {\n    .instrument {\n        grid-template-columns: repeat(4, 1fr);\n    }\n}');class re extends HTMLElement{constructor(){super(),this.armed=!1,this.keys="qwertyuiasdfghjk",this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(ie),this.root.innerHTML='<div class="instrument"></div>\n'}connectedCallback(){document.addEventListener("keydown",(e=>this.onKeyDown(e))),document.addEventListener("keyup",(e=>this.onKeyUp(e)));for(let e=0;e<16;e++){const t=document.createElement("div");t.classList.add("wrapper"),t.innerHTML=`\n                <div class="drum-pad" data-hint="${this.keys[e]}" data-note="${e}">\n                    <div class="drum-name"></div>\n                    <div class="key-hint">${this.keys[e]}</div>\n                    <div class="pad-name">${e}</div>\n                </div>`,this.root.querySelector(".instrument")?.append(t)}this.root.querySelectorAll(".drum-pad").forEach((e=>{let t=!1;e.addEventListener("pointerdown",(s=>{e.classList.add("pressed"),this.emitNoteOn(this.getPadNote(e),"pointer"),t=!0})),e.addEventListener("pointerup",(s=>{t&&(e.classList.remove("pressed"),this.emitNoteOff(this.getPadNote(e),"pointer"),t=!1)})),e.addEventListener("pointerenter",(s=>{s.buttons>0&&(e.classList.add("pressed"),this.emitNoteOn(this.getPadNote(e),"pointer"),t=!0)})),e.addEventListener("pointerleave",(s=>{e.classList.remove("pressed"),this.emitNoteOff(this.getPadNote(e),"pointer"),t=!0}))}))}disconnectedCallback(){}attributeChangedCallback(e,t,s){"armed"===e&&s!==t&&("true"===s?this.armKeyboard():this.disarmKeyboard())}emitNoteOn(e,t,s=90){if(e<0)return;const n=new CustomEvent("note-on",{bubbles:!0,composed:!0,detail:{note:e,source:t,velocity:s}});this.dispatchEvent(n)}emitNoteOff(e,t){if(e<0)return;const s=new CustomEvent("note-off",{bubbles:!0,composed:!0,detail:{note:e,source:t,velocity:0}});this.dispatchEvent(s)}emitPitchBend(e,t){const s=new CustomEvent("pitch-bend",{bubbles:!0,composed:!0,detail:{source:t,value:e}});this.dispatchEvent(s)}noteOn(e,t=90){this.root.querySelector(`.drum-pad[data-note="${e}"]`)?.classList.add("pressed")}noteOff(e){this.root.querySelector(`.drum-pad[data-note="${e}"]`)?.classList.remove("pressed")}allNotesOff(){this.root.querySelectorAll(".drum-pad")?.forEach((e=>e.classList.remove("pressed")))}isNoteOn(e){const t=this.root.querySelector(`.drum-pad[data-note="${e}"]`);return null!==t&&t.classList.contains("pressed")}armKeyboard(){this.armed=!0,this.setAttribute("armed","true"),this.root.querySelector(".instrument")?.classList.add("armed")}disarmKeyboard(){this.armed=!1,this.setAttribute("armed","false"),this.root.querySelector(".instrument")?.classList.remove("armed")}get isKeyboardArmed(){return this.armed}setPatch(e){if(Array.isArray(e.nodes))for(let t of e.nodes)if("drums"===t.type&&Array.isArray(t.samples)){for(let e of t.samples)if("number"==typeof e.step&&"string"==typeof e.name){const t=this.root.querySelector(`.drum-pad[data-note="${e.step}"] .drum-name`);t&&(t.innerHTML=e.name)}return}}onKeyDown(e){if(!(e.ctrlKey||e.metaKey||e.shiftKey||1==e.repeat)&&this.isKeyboardArmed){const t=e.key.toLowerCase();console.log(t),console.log(this.root.querySelector(`.drum-pad[data-hint="${t}"]`)),this.root.querySelector(`.drum-pad[data-hint="${t}"]`)?.classList.add("pressed");const s=this.keys.indexOf(t);s>=0?this.emitNoteOn(s,"keyboard"):"ArrowDown"==e.key?this.emitPitchBend(-200,"keyboard"):"ArrowUp"==e.key&&this.emitPitchBend(200,"keyboard")}}onKeyUp(e){if("ArrowUp"==e.key||"ArrowDown"==e.key)this.emitPitchBend(0,"keyboard");else{const t=e.key.toLowerCase();this.root.querySelector(`.drum-pad[data-hint="${t}"]`)?.classList.remove("pressed");const s=this.keys.indexOf(t);s>=0&&this.emitNoteOff(s,"keyboard")}}getPadNote(e){return parseInt(e?.getAttribute("data-note")??"-1")}}re.observedAttributes=["armed"],re.ELEMENT="drums-instrument";const ae=new CSSStyleSheet;ae.replaceSync("/*\n@keyframes fade-out {\n    0% {\n        opacity: 1.0;\n    }\n\n    100% {\n        opacity: 0.0;\n    }\n}\n*/\n.instrument {\n    position: relative;\n    box-sizing: border-box;\n    display: flex;\n    background-color: #222;\n    overflow: hidden;\n    flex-direction: column;\n}\n\n.instrument.armed {\n    outline: 1px solid gold;\n}\n\n.naturals, .accidentals {\n    width: 100%;\n    display: flex;\n}\n.accidentals {\n    height: 50px;\n    position: relative;\n    top: 10px;\n    left: -20px;\n}\n.marimba-key, .spacer {\n    border: 2px solid #fff2;\n    flex: 1;\n    margin: 3px;\n    box-sizing: border-box;\n    min-width: 34px;\n}\n\n.marimba-key {\n    background-color: burlywood;\n    background-image: url('/assets/images/marimba-key.png');\n    background-position: center;\n    background-size: cover;\n    border-radius: 0.25rem;\n    display: flex;\n    flex-direction: column;\n    text-align: center;\n    height: 160px;\n    font-size: 12px;\n    padding-top: 20px;\n    color: #fff9;\n    user-select: none;\n    box-shadow: 0 0 6px #000b;\n}\n\n.spacer {\n    pointer-events: none;\n    opacity: 0;\n}\n\n.marimba-key.accidental {\n    height: 70px;\n    padding-top: 10px;\n    position: relative;\n    top: -20px;\n}\n\n.accidental .note-name { display: none; }\n\n.marimba-key:hover {\n    border: 2px solid #fff7;\n    color: white;\n}\n\n.marimba-key.pressed {\n    border: 2px solid white;\n}\n/*\n.marimba-key.white.pressed.step-0 { fill: rgb(229, 76, 78); }\n.marimba-key.white.pressed.step-2 { fill: rgb(228, 171, 81); }\n.marimba-key.white.pressed.step-4 { fill: rgb(223, 228, 78); }\n.marimba-key.white.pressed.step-5 { fill: rgb(174, 215, 71); }\n.marimba-key.white.pressed.step-7 { fill: rgb(63, 169, 180); }\n.marimba-key.white.pressed.step-9 { fill: rgb(78, 69, 179); }\n.marimba-key.white.pressed.step-11 { fill: rgb(202, 69, 147); }\n*/\n\n.note-name { flex: 1; }\n.key-hint { margin-bottom: 1rem; display: none; }\n.armed .key-hint { display: block; }\n");class oe extends HTMLElement{get minKey(){return 48}get maxKey(){return 77}constructor(){super(),this.armed=!1,this.key_map="awsedftgyhujkolp;']",this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(ae),this.root.innerHTML='<div class="instrument"></div>',this.container=this.root.querySelector(".instrument")}connectedCallback(){const e=document.createElement("div"),t=document.createElement("div");e.classList.add("naturals"),t.classList.add("accidentals");for(let s=this.minKey;s<=this.maxKey;s++){const n=this._buildKey(s);if(this.isAccidental(s)?t.append(n):e.append(n),[5,11].includes(s%12)||s==this.maxKey||s==this.minKey){const e=document.createElement("div");e.classList.add("spacer"),t.append(e)}this.container.append(t),this.container.append(e)}document.addEventListener("keydown",(e=>this.onKeyDown(e))),document.addEventListener("keyup",(e=>this.onKeyUp(e)))}_buildKey(e){const t=e%12,s=Math.floor(e/12)-1,n=oe.NOTES[t],i=e-this.minKey,r=document.createElement("div"),a=document.createElement("div"),o=document.createElement("div"),h=document.createElement("div");r.classList.add("marimba-key"),a.classList.add("key-hint"),o.classList.add("note-name"),h.classList.add("midi-value"),r.setAttribute("data-note",`${e}`),this.isAccidental(e)?r.classList.add("accidental"):r.style.height=145-2*i+"px",i>=0&&i<this.key_map.length&&(r.setAttribute("data-trigger",`${this.key_map[i]}`),a.innerHTML=`${this.key_map[i]}`),o.innerHTML=`${n}${s}`,h.innerHTML=`${e}`,r.append(h),r.append(o),r.append(a);let c=!1;return r.addEventListener("pointerdown",(t=>{this.emitNoteOn(e,"pointer"),c=!0,r.classList.add("pressed"),t.stopPropagation()})),r.addEventListener("pointerup",(t=>{c=!1,this.emitNoteOff(e,"pointer"),r.classList.remove("pressed")})),r.addEventListener("pointerleave",(t=>{c&&(this.emitNoteOff(e,"pointer"),r.classList.remove("pressed"),c=!1)})),r.addEventListener("pointerenter",(t=>{t.buttons>0&&(this.emitNoteOn(e,"pointer"),r.classList.add("pressed"),c=!0)})),r}disconnectedCallback(){}attributeChangedCallback(e,t,s){if("armed"===e)"false"==s?this.disarmKeyboard():this.armKeyboard()}emitNoteOn(e,t,s=90){const n=new CustomEvent("note-on",{bubbles:!0,composed:!0,detail:{note:e,source:t,velocity:s}});this.dispatchEvent(n)}emitNoteOff(e,t){const s=new CustomEvent("note-off",{bubbles:!0,composed:!0,detail:{note:e,source:t,velocity:0}});this.dispatchEvent(s)}emitPitchBend(e,t){const s=new CustomEvent("pitch-bend",{bubbles:!0,composed:!0,detail:{source:t,value:e}});this.dispatchEvent(s)}isAccidental(e){return[1,3,6,8,10].includes(e%12)}noteOn(e,t=90){const s=this.root.querySelector(`.marimba-key[data-note="${e}"]`);s?.classList.add("pressed")}noteOff(e){const t=this.root.querySelector(`.marimba-key[data-note="${e}"]`);t?.classList.remove("pressed")}allNotesOff(){this.root.querySelectorAll(".marimba-key").forEach((e=>e.classList.remove("pressed")))}isNoteOn(e){const t=this.root.querySelector(`.marimba-key[data-note="${e}"]`);return!!t&&t.classList.contains("pressed")}armKeyboard(){this.armed=!0,this.container.classList.add("armed")}disarmKeyboard(){this.armed=!1,this.container.classList.remove("armed")}get isKeyboardArmed(){return this.armed}getArmedKey(e){return this.root.querySelector(`.marimba-key[data-trigger="${e}"]`)}setPatch(e){}onKeyDown(e){if(!(e.ctrlKey||e.metaKey||e.shiftKey||1==e.repeat))if("ArrowDown"==e.key)this.emitPitchBend(-200,"keyboard");else if("ArrowUp"==e.key)this.emitPitchBend(200,"keyboard");else if(this.isKeyboardArmed){const t=this.getArmedKey(e.key.toLowerCase());t?.classList.add("pressed");const s=he(t?.getAttribute("data-note"),-1);s>0&&this.emitNoteOn(s,"keyboard")}}onKeyUp(e){if("ArrowUp"==e.key||"ArrowDown"==e.key)this.emitPitchBend(0,"keyboard");else{const t=this.getArmedKey(e.key.toLowerCase());t?.classList.remove("pressed");const s=he(t?.getAttribute("data-note"),-1);s>0&&this.emitNoteOff(s,"keyboard")}}}function he(e,t=0){const s=parseInt(e);return isNaN(s)?t:s}oe.NOTES=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],oe.observedAttributes=["armed"],oe.ELEMENT="marimba-instrument";const ce=new CSSStyleSheet;ce.replaceSync("/*\n@keyframes fade-out {\n    0% {\n        opacity: 1.0;\n    }\n\n    100% {\n        opacity: 0.0;\n    }\n}\n*/\n.wrapper {\n    display: flex;\n}\n\n.instrument {\n    flex: 1;\n    position: relative;\n    box-sizing: border-box;\n    display: flex;\n}\n\n.backdrop {\n    fill: #30303f;\n}\n\n.container {\n    width: 100%;\n}\n\n.piano-key.black {\n    fill: #1d1e1f;\n    stroke: #222;\n    stroke-width: 1.5;\n    rx: 1.5;\n}\n\n.piano-key.black .black-top {\n    fill: #444;\n}\n\n.piano-key.black:hover .black-top {\n    fill: #777;\n}\n\n.piano-key.black.pressed .black-top {\n    fill: #222;\n}\n\n.piano-key.white {\n    fill: #ecedee;\n    stroke: #f7f7f8;\n    stroke-width: 1.5;\n    rx: 1.4;\n}\n\n.piano-key.white:hover {\n    fill: #ccc;\n}\n\n.piano-key.white.pressed {\n    fill: #aaa;\n    stroke: #777;\n}\n/*\n.piano-key.white.pressed.step-0 { fill: rgb(229, 76, 78); }\n.piano-key.white.pressed.step-2 { fill: rgb(228, 171, 81); }\n.piano-key.white.pressed.step-4 { fill: rgb(223, 228, 78); }\n.piano-key.white.pressed.step-5 { fill: rgb(174, 215, 71); }\n.piano-key.white.pressed.step-7 { fill: rgb(63, 169, 180); }\n.piano-key.white.pressed.step-9 { fill: rgb(78, 69, 179); }\n.piano-key.white.pressed.step-11 { fill: rgb(202, 69, 147); }\n*/\n.note-hint,\n.midi-hint,\n.key-hint {\n    stroke: none;\n    font: 9pt sans-serif;\n    fill: #0006;\n    text-anchor: middle;\n    opacity: 0.0;\n    pointer-events: none;\n    user-select: none;\n}\n\n.midi-hint.black, .note-hint.black, .key-hint.black {\n    fill: #ccc;\n}\n.show {\n    opacity: 1.0;\n}\n\n.note-hint.always-show {\n    opacity: 1.0;\n}\n\n.felt {\n    fill: #a00;\n}\n\n.animated-slide {\n    transition: transform 0.5s ease-in-out;\n}\n\n.mini-piano {\n    opacity: 0.0;\n    transition: opacity 0.25s;\n}\n\n.mini-piano.show {\n    opacity: 1.0;\n}\n\n.octave-button {\n    background-color: transparent;\n    border: none;\n    outline: none;\n    color: #fffc;\n    font-size: 14px;\n    user-select: none;\n    width: 12px;\n    padding: 0;\n    height: 100%;\n    position: absolute;\n    top: 0;\n}\n.octave-button:hover { color: #fff; }\n.octave-button:active { color: rgb(121, 216, 245); }\n#down-octave { left: 0; }\n#up-octave { right: 0; }");class le extends HTMLElement{get minKey(){return this.props.minNote}get maxKey(){return this.props.maxNote}get minOctave(){return Math.floor(this.minKey/12)-1}get maxOctave(){const e=Math.floor(this.maxKey/12)-1,t=12*e+12;return this.maxKey-t<this.key_map.length?e-1:e}constructor(){super(),this.props={noteHints:!0,midiHints:!0,armed:!1,minNote:12,maxNote:107,keyRange:17,focusOctave:2},this.container=null,this.parent=document.createElementNS("http://www.w3.org/2000/svg","g"),this.allKeys=document.createElementNS("http://www.w3.org/2000/svg","g"),this.keys=[],this.width=700,this.height=190,this.key_map="awsedftgyhujkolp;']",this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(ce)}connectedCallback(){const e=document.createElement("template");e.innerHTML='<div classs="wrapper">\n    <button id="down-octave" class="octave-button" title="Lower Octave">❮</button>\n    <div class="instrument"><svg class="container" version="1.1"></svg></div>\n    <button id="up-octave" class="octave-button" title="Higher Octave">❯</button>\n</div>',this.root.appendChild(e.content.cloneNode(!0)),this.container=this.root.querySelector("svg.container"),this.container?.append(this.parent),this.container?.setAttribute("viewBox",`0 0 ${this.props.keyRange*de.width} 190`),this.render(),document.addEventListener("keydown",(e=>this.onKeyDown(e))),document.addEventListener("keyup",(e=>this.onKeyUp(e))),this.root.querySelector("#down-octave")?.addEventListener("click",(e=>{this.setFocusOctave(this.props.focusOctave-1)})),this.root.querySelector("#up-octave")?.addEventListener("click",(e=>{this.setFocusOctave(this.props.focusOctave+1)}))}disconnectedCallback(){}attributeChangedCallback(e,t,s){switch(e){case"note-hints":this.setNoteHints("true"==s);break;case"midi-hints":this.setMidiHints("true"==s);break;case"armed":"true"==s?this.armKeyboard():this.disarmKeyboard();break;case"key-range":this.setKeyRange(parseInt(s));break;case"min-octave":this.setMinOctave(parseInt(s));break;case"max-octave":this.setMaxOctave(parseInt(s));break;case"min-note":this.setMinNote(parseInt(s));break;case"max-note":this.setMaxNote(parseInt(s));break;case"focus-octave":this.setFocusOctave(parseInt(s))}}emitNoteOn(e,t,s=90){const n=new CustomEvent("note-on",{bubbles:!0,composed:!0,detail:{note:e,source:t,velocity:s}});this.dispatchEvent(n)}emitNoteOff(e,t){const s=new CustomEvent("note-off",{bubbles:!0,composed:!0,detail:{note:e,source:t,velocity:0}});this.dispatchEvent(s)}emitPitchBend(e,t){const s=new CustomEvent("pitch-bend",{bubbles:!0,composed:!0,detail:{source:t,value:e}});this.dispatchEvent(s)}noteOn(e,t=90){const s=this._noteToKey(e);s?.press()}noteOff(e){let t=this._noteToKey(e);t?.release()}allNotesOff(){this.keys.forEach((e=>e.release()))}isNoteOn(e){const t=this._noteToKey(e);return null!=t&&t.isPressed()}setKeyRange(e){isNaN(e)||(this.props.keyRange=Math.max(7,Math.min(e,56)),this.container?.setAttribute("viewBox",`0 0 ${this.props.keyRange*de.width} 190`))}setMinOctave(e){isNaN(e)||this.setMinNote(12*e+12)}setMaxOctave(e){isNaN(e)||this.setMaxNote(12*e+23)}setMinNote(e){isNaN(e)||(e=Math.max(0,Math.min(96,e)))!=this.props.minNote&&(this.props.minNote=e,this.render())}setMaxNote(e){isNaN(e)||(e=Math.max(12,Math.min(108,e)))!=this.props.maxNote&&(this.props.maxNote=e,this.render())}armKeyboard(){this.props.armed=!0,this.root.querySelectorAll(".key-hint").forEach((e=>{e.classList.add("show")}))}disarmKeyboard(){this.props.armed=!1,this.root.querySelectorAll(".key-hint").forEach((e=>{e.classList.remove("show")}))}get isKeyboardArmed(){return this.props.armed}getArmedKey(e){let t=12*this.props.focusOctave+12;t<this.props.minNote&&(t+=12);const s=this.key_map.indexOf(e.toLowerCase());return s>=0?this._noteToKey(t+s):null}setPatch(e){"min-note"in e&&this.setMinNote(ue(e["min-note"],this.props.minNote)),"max-note"in e&&this.setMaxNote(ue(e["max-note"],this.props.maxNote)),"key-range"in e&&this.setKeyRange(ue(e["key-range"],this.props.keyRange)),"focus-octave"in e&&this.setFocusOctave(ue(e["focus-octave"],this.props.focusOctave))}onKeyDown(e){if(!(e.ctrlKey||e.metaKey||e.shiftKey||1==e.repeat)&&this.isKeyboardArmed){const t=this.getArmedKey(e.key.toLowerCase());t?(this.emitNoteOn(t.note,"keyboard"),t.press()):"ArrowLeft"==e.key?this.setFocusOctave(this.props.focusOctave-1):"ArrowRight"==e.key?this.setFocusOctave(this.props.focusOctave+1):"ArrowDown"==e.key?this.emitPitchBend(-200,"keyboard"):"ArrowUp"==e.key&&this.emitPitchBend(200,"keyboard")}}onKeyUp(e){if("ArrowUp"==e.key||"ArrowDown"==e.key)this.emitPitchBend(0,"keyboard");else{const t=this.getArmedKey(e.key.toLowerCase());t&&(this.emitNoteOff(t.note,"keyboard"),t.release())}}_noteToKey(e){for(let t of this.keys)if(t.note===e)return t;return null}render(){if(null==this.container)return;this.parent.innerHTML="",this.keys=[];const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.classList.add("backdrop"),e.setAttribute("width","100%"),e.setAttribute("height","100%"),this.parent.append(e),this.allKeys.classList.add("animated-slide");const t=document.createElementNS("http://www.w3.org/2000/svg","g"),s=document.createElementNS("http://www.w3.org/2000/svg","g");for(let e=this.minKey;e<=this.maxKey;e++){const n=new de(e,this);this.keys.push(n),n.black?s.append(n.el):t.append(n.el)}this.allKeys.innerHTML="",this.allKeys.append(t),this.allKeys.append(s),this.parent.append(this.allKeys);const n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.classList.add("felt"),n.setAttribute("width","100%"),n.setAttribute("height","1.5"),n.setAttribute("x","0"),n.setAttribute("y","0"),this.parent.append(n),this.setFocusOctave(this.props.focusOctave)}setFocusOctave(e){if(isNaN(e)||null==this.container)return;this.props.focusOctave=Math.max(this.minOctave,Math.min(this.maxOctave,e));let t=12*this.props.focusOctave+12;t<this.props.minNote&&(t+=12);const s=this._noteToKey(t);if(this.keys.forEach((e=>e.autoRelease())),s){const e=s.x;this.allKeys.style.transform=`translateX(${-e}px)`,this.keys.forEach((e=>e.clearKeymap()));for(let e=0;e<this.key_map.length;e++){const s=this._noteToKey(t+e);s&&s.setKeymap(this.key_map[e])}}}setNoteHints(e){this.props.noteHints=e,this.root.querySelectorAll(".note-hint").forEach((t=>{t.classList.toggle("show",e)}))}get showNoteHints(){return this.props.noteHints}setMidiHints(e){this.props.midiHints=e,this.root.querySelectorAll(".midi-hint").forEach((t=>{t.classList.toggle("show",e)}))}get showMidiHints(){return this.props.midiHints}}le.observedAttributes=["note-hints","midi-hints","armed","min-octave","max-octave","min-note","max-note","key-range","focus-octave"],le.ELEMENT="piano-instrument";class de{get step(){return this.note%12}get octave(){return Math.floor(this.note/12)-1}get name(){return`${de.NOTES[this.step]}`}get offset(){return 7*(this.octave-this.piano.minOctave)+this._key_offsets[this.step]}get x(){return this.offset*de.width}get black(){return[1,3,6,8,10].includes(this.step)}get white(){return!this.black}get height(){return this.black?130:195}constructor(e,t){this.keyHint=document.createElementNS("http://www.w3.org/2000/svg","text"),this._key_offsets=[0,.45,1,1.55,2,3,3.4,4,4.5,5,5.6,6],this._hint_offsets=[-8,0,0,0,8,-8,0,0,0,0,0,8],this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.rect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._down=!1,this.note=e,this.piano=t,this.el.setAttribute("transform",`translate(${this.x}, 0)`),this.el.classList.add("piano-key",`step-${this.step}`),this.el.classList.add(this.black?"black":"white");const s=this.black?10:1.5;let n=s,i=de.width-2*s;if(this.rect.setAttribute("x",`${n}`),this.rect.setAttribute("y","-8"),this.rect.setAttribute("width",`${i}`),this.rect.setAttribute("height",`${this.height}`),this.rect.setAttribute("rx","3"),this.el.append(this.rect),this.black){n+=3,i-=6;const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.classList.add("black-top"),e.setAttribute("x",`${n}`),e.setAttribute("y","-5"),e.setAttribute("width",`${i}`),e.setAttribute("height",""+(this.height-20)),e.setAttribute("pointer-events","none"),this.el.append(e)}else{const e=document.createElementNS("http://www.w3.org/2000/svg","text");e.classList.add("note-hint"),e.setAttribute("x",`${n+i/2}`),e.setAttribute("y",""+(this.height-17)),e.innerHTML=`${this.name}${this.octave}`,this.piano.showNoteHints&&e.classList.add("show"),0==this.step&&e.classList.add("always-show"),this.el.append(e)}const r=document.createElementNS("http://www.w3.org/2000/svg","text");r.classList.add("midi-hint"),this.black&&r.classList.add("black"),r.setAttribute("x",`${n+i/2}`),r.setAttribute("y",""+(this.height-35)),r.innerHTML=`${this.note}`,this.piano.showMidiHints&&r.classList.add("show"),this.el.append(r);let a=n+i/2+this._hint_offsets[this.step];this.keyHint.classList.add("key-hint"),this.black&&this.keyHint.classList.add("black"),this.keyHint.setAttribute("x",`${a}`),this.keyHint.setAttribute("y",this.black?"45":"60"),this.piano.isKeyboardArmed&&this.keyHint.classList.add("show"),this.el.append(this.keyHint),this.el.addEventListener("pointerdown",(e=>{this.piano.emitNoteOn(this.note,"pointer"),this.press(),e.stopPropagation()})),this.el.addEventListener("pointerup",(e=>{this.piano.emitNoteOff(this.note,"pointer"),this.release()})),this.el.addEventListener("pointerleave",(e=>{this._down&&(this.piano.emitNoteOff(this.note,"pointer"),this.release())})),this.el.addEventListener("pointerenter",(e=>{e.buttons>0&&(this.piano.emitNoteOn(this.note,"pointer"),this.press())}))}press(){this._down=!0,this.el.classList.add("pressed")}release(){this._down&&(this._down=!1,this.el.classList.remove("pressed"))}isPressed(){return this.el.classList.contains("pressed")}autoRelease(){this._down&&(this.piano.emitNoteOff(this.note,"system"),this._down=!1,this.el.classList.remove("pressed"))}setKeymap(e){this.keyHint.innerHTML=e}clearKeymap(){this.keyHint.innerHTML=""}}function ue(e,t=0){const s=parseInt(e);return isNaN(s)?t:s}de.NOTES=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],de.width=45;class pe extends HTMLElement{constructor(){super(),this.notes=new Set,this.chord=new Array,this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(t),this.root.innerHTML='<div class="explore-wrapper">\n    <div class="keyboard-wrapper">\n        <piano-instrument></piano-instrument> \n    </div>\n    <div class="shelf">\n        <pre id="code-hint"></pre>\n        <button id="copy-button" title="Copy Code">Copy to Clipboard</button>\n    </div>\n</div>'}connectedCallback(){const e=this.root.querySelector("piano-instrument");e?.addEventListener("note-on",(e=>{const t=new B(e.detail.note);this.addCodeHint(t)})),e?.addEventListener("note-off",(e=>{const t=new B(e.detail.note);this.removeCodeHint(t)})),e?.addEventListener("click",(e=>{const t=document.querySelector("#code-hint");t&&navigator.clipboard.writeText(t.innerHTML)}))}disconnectedCallback(){}attributeChangedCallback(e,t,s){s!==t&&this.root.querySelector("piano-instrument")?.setAttribute(e,s)}getCodeHint(){if(1===this.chord.length){const e=new B(this.chord[0]);return`playNote(${e.note})    # ${e.nameWithOctave}`}return this.chord.length>0?`playNote([ ${this.chord.join(", ")} ])`:""}addCodeHint(e){this.notes.add(e.note),this.chord=[...this.notes].sort();const t=this.root.getElementById("code-hint");t&&(t.innerHTML=this.getCodeHint())}removeCodeHint(e){this.notes.delete(e.note),0==this.notes.size&&(this.chord=[])}}pe.ELEMENT="note-explorer",pe.observedAttributes=le.observedAttributes;const me=new CSSStyleSheet;me.replaceSync(".ring {\n    fill: #AC6BF4;\n    \n}\n.ring:hover {\n    fill: #C9A0F7;\n}\n.outer-ring {\n    fill: #DAC5F1;\n}\n.center-circle {\n    fill: #331C4D;\n}\n\n.note {\n    fill: rgb(255, 142, 161);\n    transition: color 0.08s ease;\n}\n\n#pointer {\n    stroke: #331C4D;\n    stroke-width: 4;\n    stroke-linecap: round;\n}\n\n\n#tick-mark {\n    stroke: #FFFFFF;\n    stroke-width: 2;\n    stroke-linecap: round;\n}\n\n#music-line {\n    stroke: #000000;\n    stroke-width: 1.5;\n    stroke-linecap: round;\n}\n\n.ledger-line{\n    stroke:rgb(255, 142, 161);\n    stroke-width: 1.5;\n    stroke-linecap: round;\n}\n\n#sharp {\n    fill: rgb(255, 142, 161);\n}\n\n#stem {\n    stroke: rgb(255, 142, 161);\n    stroke-width: 1.5;\n    stroke-linecap: round;\n    transition: color 0.08s ease;\n}\n\n\n.scaled-up{\n    transform: scale(5);\n}\n\n#dynamicText {\n    user-select: none;\n    font-family: 'Tahoma', sans-serif;\n    font-size: 6px;\n    padding-left: 42px;\n    color: rgb(255, 142, 161);\n\n}\n\n.interactive-text{\n    font-size: 16px;\n    margin-left: 150px;\n    margin-top: 5px;\n    margin-bottom: 5px;\n    padding-top: 0px;\n    transition: color 0.08s ease;\n}\n\n.interactive-button{\n    font-size: 12px;\n    margin: 1px;\n    margin-left: 150px;\n    margin-top: 0px;\n    padding: 7px;\n    border-width: 0px;\n    border-style: solid;\n    background-color: #331C4D;\n    color: white;\n    border-radius: 5px;\n}\n\n.interactive-button:hover {\n    opacity: 80%;\n}\n/*\n#music-note:hover ellipse { fill: pink; }\n#music-note:hover line { stroke: pink; }\n\n#music-note:active ellipse { fill: blue; }\n#music-note:active line { stroke: blue; }\n*/\n\n.context-menu {\n    background: white;\n    border: 1px solid #888888;\n    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);\n}\n\n.context-menu div {\n    padding: 8px 12px;\n    cursor: pointer;\n}\n\n.context-menu div:hover {\n    background-color: #f1f1f1;\n}\n\n.menuBox {\n    box-shadow: #888888;\n}");const fe=[60,62,64,65,67,69,71],ge=["C","D","E","F","G","A","B"],ye=["rgb(255, 142, 161)","tomato","orange","gold","rgb(157, 242, 135)","lightskyblue","plum"],be={"rgb(255, 142, 161)":"rgb(250, 85, 113)",tomato:"rgb(220, 34, 1)",orange:"rgb(226, 117, 0)",gold:"rgb(224, 190, 7)","rgb(157, 242, 135)":"rgb(82, 195, 54)",lightskyblue:"rgb(90, 169, 219)",plum:"rgb(196, 114, 196)"};class ve extends HTMLElement{constructor(){super(),this.container=null,this.wholeInteractive=null,this.notes=[],this.svgY=30,this.leftXBound=155,this.rightXBound=255,this.noteXPos=10,this.numNotes=0,this.pointerOnMenu=!1,this.allNotes=document.createElementNS("http://www.w3.org/2000/svg","g"),this.textBox=document.createElement("div"),this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(me),this.root.innerHTML='<div id="interactive-container">\n    <svg id="interactive-svg" class="container" version="1.1" viewBox="-50 -50 500 200">\n      <g id="staff">\n        <g id="treble-clef" transform="translate(85 -34) scale(0.25)">\n          <path d="M156.716,61.478c-4.111,6.276-8.881,11.511-14.212,15.609l-8.728,6.962c-13.339,11.855-22.937,21.433-28.542,28.464\n            c-10.209,12.788-15.806,25.779-16.65,38.611c-0.942,14.473,3.187,28.21,12.275,40.84c9.636,13.458,21.8,20.754,36.164,21.69\n            c3.291,0.218,6.897,0.182,9.896-0.015l-1.121-10.104c-2.09,0.192-4.306,0.223-6.628,0.068c-9.437-0.617-17.864-4.511-25.064-11.573\n            c-7.524-7.333-10.895-15.415-10.287-24.7c1.149-17.59,12.562-35.004,33.925-51.792l9.543-7.599\n            c8.394-7.174,15.192-16.191,20.216-26.825c4.971-10.556,7.886-21.983,8.673-33.96c0.466-7.037-0.513-15.775-2.874-25.965\n            c-3.241-13.839-7.854-20.765-14.136-21.179c-2.232-0.138-4.676,0.986-7.658,3.617c-7.252,6.548-12.523,14.481-15.683,23.542\n            c-2.438,6.926-4.057,16.189-4.805,27.529c-0.313,4.72,0.313,13.438,1.805,23.962l8.844-8.192c-0.028-1.183,0.005-2.413,0.096-3.703\n            c0.466-7.221,2.289-15.062,5.394-23.293c3.956-10.296,7.689-13.409,10.133-14.204c0.668-0.218,1.32-0.298,2.015-0.254\n            c3.185,0.212,6.358,1.559,5.815,9.979C164.664,46.132,161.831,53.693,156.716,61.478z"/>\n          <path d="M164.55,209.161c5.728-2.568,10.621-6.478,14.576-11.651c5.055-6.561,7.897-14.316,8.467-23.047\n            c0.72-10.719-1.854-20.438-7.617-28.895c-6.322-9.264-14.98-14.317-25.745-15.026c-1.232-0.081-2.543-0.075-3.895,0.025\n            l-2.304-17.191l-9.668,7.112l1.483,12.194c-5.789,2.393-10.827,6.17-15.017,11.255c-4.823,5.924-7.508,12.443-7.964,19.382\n            c-0.466,7.208,1.142,13.81,4.782,19.583c1.895,3.081,4.507,5.82,7.498,8.058c4.906,3.65,10.563,3.376,11.459,1.393\n            c0.906-1.983-2.455-5.095-5.09-9.248c-1.502-2.351-2.242-5.173-2.242-8.497c0-7.053,4.256-13.116,10.317-15.799l5.673,44.211\n            l1.325,10.258c0.864,4.873,1.719,9.725,2.537,14.52c1,6.488,1.352,12.112,1.041,16.715c-0.419,6.375-2.408,11.584-5.919,15.493\n            c-2.234,2.485-4.844,4.055-7.795,4.925c3.961-3.962,6.414-9.43,6.414-15.478c0-12.075-9.792-21.872-21.87-21.872\n            c-3.353,0-6.491,0.812-9.329,2.159c-0.36,0.155-0.699,0.388-1.054,0.574c-0.779,0.425-1.559,0.85-2.286,1.362\n            c-0.249,0.187-0.487,0.403-0.732,0.605c-4.888,3.816-8.091,9.616-8.375,16.229c0,0.01-0.011,0.021-0.011,0.031\n            c0,0.005,0,0.01,0,0.016c-0.013,0.311-0.09,0.59-0.09,0.896c0,0.259,0.067,0.492,0.078,0.74\n            c-0.011,7.084,2.933,13.179,8.839,18.118c5.584,4.666,12.277,7.28,19.892,7.777c4.327,0.28,8.505-0.217,12.407-1.485\n            c3.189-1.041,6.275-2.62,9.149-4.687c6.96-5.022,10.75-11.584,11.272-19.532c0.399-6.063,0.094-13.235-0.937-21.411l-2.838-18.429\n            l-7.156-52.899c7.984,1.532,14.027,8.543,14.027,16.968c0,5.986-1.937,15.431-5.551,20.376L164.55,209.161z"/>\n        </g>\n        <g id="bass-clef" transform="translate(105 60) scale(0.37)">\n          <path d="M46.593,1.814c16.429,6.061,22.84,20.793,18.019,36.615c-4.08,13.392-12.446,23.87-23.83,31.962    C30.29,77.849,18.962,83.849,7.427,89.48c-0.507,0.247-1.605,0.185-1.874-0.162c-0.637-0.824-0.321-1.557,0.657-2.236    c6.66-4.617,13.521-8.995,19.826-14.061c13.186-10.593,21.679-24.134,23.958-41.147c0.693-5.175,0.587-10.387-0.781-15.466    c-1.404-5.217-4.386-8.989-8.422-10.997c-2.274-1.131-4.882-1.687-7.731-1.656C28.22,3.807,24.553,5.23,24.553,5.23    c-4.075,1.094-7.962,4.981-9.387,8.493c-0.759,1.872,0.258,3.629,2.275,3.713c0.851,0.035,1.756-0.127,2.566-0.405    c5.805-1.997,11.434,1.629,12.717,6.635c1.288,5.026-2.253,10.349-7.873,11.829c-7.101,1.871-14.661-2.16-16.414-9.089    c-1.289-5.096,0.289-9.794,3.124-14.09c4.377-6.632,10.97-9.698,18.415-11.333C36.121-0.366,44.489,1.037,46.593,1.814z     M70.673,39.731c0.015,3.575,2.657,6.239,6.177,6.23c3.44-0.009,6.187-2.816,6.165-6.3c-0.022-3.39-2.741-6.095-6.146-6.114    C73.325,33.527,70.658,36.189,70.673,39.731z M70.674,15.053c0.011,3.585,2.621,6.221,6.16,6.221c3.455,0,6.185-2.765,6.179-6.257    c-0.006-3.385-2.707-6.075-6.127-6.102C73.313,8.887,70.663,11.505,70.674,15.053z"/>\n        </g>\n        <line id="music-line" x1="100" x2="500" y1="0" y2="0"/>\n        <line id="music-line" x1="100" x2="500" y1="10" y2="10"/>\n        <line id="music-line" x1="100" x2="500" y1="20" y2="20"/>\n        <line id="music-line" x1="100" x2="500" y1="-10" y2="-10"/>\n        <line id="music-line" x1="100" x2="500" y1="-20" y2="-20"/>\n        <line id="music-line" x1="100" x2="100" y1="-20" y2="100"/>\n\n        <line id="music-line" x1="100" x2="500" y1="60" y2="60"/>\n        <line id="music-line" x1="100" x2="500" y1="70" y2="70"/>\n        <line id="music-line" x1="100" x2="500" y1="80" y2="80"/>\n        <line id="music-line" x1="100" x2="500" y1="90" y2="90"/>\n        <line id="music-line" x1="100" x2="500" y1="100" y2="100"/>\n\n        <rect id="play-button" x="150" y="200" width="50" height="50" fill="blue"/>\n      </g>\n\n      \n\n    </svg>\n</div>\n\n',this.svg=this.root.querySelector("svg");const t=new URL("/assets/sounds/voices/grand-piano/patch.json",e&&"SCRIPT"===e.tagName.toUpperCase()&&e.src||new URL("tunepad-interactives.min.js",document.baseURI).href);this.synth=new Z(t)}playNote(e,t,s){s&&this.synth.releaseAll(),this.synth.playNote(e),setTimeout((()=>this.synth.releaseNote(e)),t)}sleep(e){return new Promise((t=>setTimeout(t,e)))}async playAll(){for(const e of this.notes)this.playNote(e.value,e.length,!1),e.textFlash(),e.noteFlash(),await this.sleep(e.length),console.log("playing one note"),e.textBlack(),e.noteReturn();console.log("playing all")}svgCoords(e,t){const s=this.svg.getScreenCTM(),n=this.svg.createSVGPoint();return n.x=e,n.y=t,n.matrixTransform(s.inverse())}render(){this.notes=[];const e=document.createElementNS("http://www.w3.org/2000/svg","g"),t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d","M56.15,142.08c0,0,0.38-3.35,1.97-3.93c1.52-0.56,2.24-0.46,2.24-0.46l25.71-0.44c0,0-8.78,17.73-49.27,61.81h34.94l0.54-8.42c0,0,0-2.51-3.58-5.02l25.26-29.56l0.72,43h11.47v4.84H94.5v12.9c0,0,0.72,9.5,11.65,8.6v6.79l-44.84,0.2v-5.38c0,0,12.03-1.97,11.22-9.85v-5.02c0,0,0.73-7.7-8.45-7.88l-33.75,0.54c0,0-1.44-1.89,0.02-4.12C37.54,189.74,54.9,170.3,56.15,142.08z"),e.append(t);const s=t.cloneNode(!0);s.setAttribute("transform","translate(0 -102)"),e.append(s),e.setAttribute("transform","translate(117 52) scale(0.21)");const n=e.cloneNode(!0);n.setAttribute("transform","translate(117 -28) scale(0.21)"),this.allNotes.append(e),this.allNotes.append(n),this.allNotes.setAttribute("transform","translate(20 0)")}connectedCallback(){this.container=this.root.querySelector("svg.container"),this.container?.append(this.allNotes),this.container.setAttribute("transform","scale (1)"),this.wholeInteractive=this.root.querySelector("#interactive-container"),this.render();const e=document.createElement("button");e.textContent="Play",e.classList.add("interactive-button"),this.wholeInteractive.append(e),this.wholeInteractive.append(this.textBox);let t=!1;document.addEventListener("pointerdown",(e=>{t=!0,console.log("down");const s=e.clientX,n=e.clientY,i=this.svgCoords(s,n).x,r=this.svgCoords(s,n).y;if(console.log(i,r),i>this.leftXBound&&i<this.rightXBound&&this.noteXPos<450&&r<115&&r>-40&&0==this.pointerOnMenu){const e=new we(this,this.noteXPos);this.allNotes.append(e.el),this.textBox.append(e.noteText),this.notes.push(e),console.log(this.notes),this.leftXBound+=50,this.rightXBound+=50,this.noteXPos+=50,this.numNotes+=1}})),document.addEventListener("pointermove",(e=>{if(t){const t=e.clientX,s=e.clientY;this.svgY=this.svgCoords(t,s).y}})),document.addEventListener("pointerup",(e=>{t&&console.log("up"),t=!1})),e.addEventListener("pointerdown",(e=>{this.playAll()}))}disconnectedCallback(){}attributeChangedCallback(e,t,s){}}ve.ELEMENT="note-doodle";class we{constructor(e,t){this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.note=document.createElementNS("http://www.w3.org/2000/svg","g"),this.ledgerLines=document.createElementNS("http://www.w3.org/2000/svg","g"),this.noteText=document.createElement("p"),this.contextMenu=document.createElementNS("http://www.w3.org/2000/svg","g"),this.noteGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.roundedPos=0,this.noteValue=60,this.noteColor="rgb(255, 142, 161)",this.noteLength=1e3,this.menuOpen=!1,this.selectedIcon=null,this.interactive=e,this.oldNote=0,this.inBassClef=!1,this.noteText.classList.add("interactive-text"),this.noteText.textContent="playNote(60) #C4";const s=document.createElementNS("http://www.w3.org/2000/svg","ellipse");s.setAttribute("cx","160"),s.setAttribute("cy","30"),s.setAttribute("rx","6"),s.setAttribute("ry","4.5"),s.setAttribute("class","note");const n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1","165.5"),n.setAttribute("x2","165.5"),n.setAttribute("y1","30"),n.setAttribute("y2","-5"),n.setAttribute("id","stem");const i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("d","M780.124,451.278C791.607,571.761 822.743,570.836 890.699,654.592C978.478,762.782 922.593,888.363 880.724,953.947C897.077,887.487 1003.32,711.966 780.915,630.724C781.328,570.03 775.998,529.329 780.124,451.278Z"),i.setAttribute("fill",this.noteColor),i.setAttribute("transform","scale(0.05) translate(2540 -550)"),i.setAttribute("class","tail"),i.style.display="none",this.note.append(s),this.note.append(n),this.note.append(i);const r=document.createElementNS("http://www.w3.org/2000/svg","line");r.setAttribute("x1","152.5"),r.setAttribute("x2","167.5"),r.setAttribute("y1","30"),r.setAttribute("y2","30"),r.setAttribute("class","ledger-line");const a=r.cloneNode(!0);a.setAttribute("y1","40"),a.setAttribute("y2","40");const o=r.cloneNode(!0);o.setAttribute("y1","50"),o.setAttribute("y2","50");const h=r.cloneNode(!0);h.setAttribute("y1","-30"),h.setAttribute("y2","-30");const c=r.cloneNode(!0);c.setAttribute("y1","-40"),c.setAttribute("y2","-40");const l=r.cloneNode(!0);l.setAttribute("y1","110"),l.setAttribute("y2","110");const d=r.cloneNode(!0);d.setAttribute("y1","120"),d.setAttribute("y2","120"),[a,h,c,o,l,d].forEach((e=>e.style.display="none")),this.ledgerLines.append(r),this.ledgerLines.append(a),this.ledgerLines.append(o),this.ledgerLines.append(h),this.ledgerLines.append(c),this.ledgerLines.append(l),this.ledgerLines.append(d);const u=document.createElementNS("http://www.w3.org/2000/svg","rect");u.setAttribute("x","67.5"),u.setAttribute("width","185"),u.setAttribute("y","45"),u.setAttribute("height","50"),u.setAttribute("fill","#F8F8F8"),u.classList.add(".menuBox"),u.setAttribute("stroke","#CCCCCC"),u.setAttribute("stroke-width","2"),u.setAttribute("rx","5"),u.setAttribute("ry","5");const p=document.createElementNS("http://www.w3.org/2000/svg","g"),m=document.createElementNS("http://www.w3.org/2000/svg","g"),f=document.createElementNS("http://www.w3.org/2000/svg","g"),g=document.createElementNS("http://www.w3.org/2000/svg","g"),y=document.createElementNS("http://www.w3.org/2000/svg","rect");y.setAttribute("x","72.5"),y.setAttribute("width","40"),y.setAttribute("y","50"),y.setAttribute("height","40"),y.setAttribute("fill","#E8E8E8");const b=y.cloneNode(!0);b.setAttribute("x","117.5");const v=y.cloneNode(!0);v.setAttribute("x","162.5");const w=y.cloneNode(!0);w.setAttribute("x","207.5");const x=document.createElementNS("http://www.w3.org/2000/svg","ellipse");x.setAttribute("cx","92.5"),x.setAttribute("cy","79.5"),x.setAttribute("rx","4"),x.setAttribute("ry","3"),x.style.fill="none",x.style.stroke="black";const k=document.createElementNS("http://www.w3.org/2000/svg","line");k.setAttribute("x1","96.4"),k.setAttribute("x2","96.4"),k.setAttribute("y1","79.5"),k.setAttribute("y2","57.5"),k.style.stroke="black";const A=document.createElementNS("http://www.w3.org/2000/svg","g");A.append(x);const S=A.cloneNode(!0);S.setAttribute("transform","translate(135 -5)"),A.append(k);const E=A.cloneNode(!0);E.setAttribute("transform","translate(90 0)"),x.style.fill="black";const _=A.cloneNode(!0),N=document.createElementNS("http://www.w3.org/2000/svg","line");N.setAttribute("x1","100"),N.setAttribute("x2","96.4"),N.setAttribute("y1","63"),N.setAttribute("y2","57.5"),N.style.stroke="black",_.appendChild(N),A.setAttribute("transform","translate(45 0)"),x.style.fill="black",p.appendChild(y),p.appendChild(_),m.appendChild(b),m.appendChild(A),f.appendChild(v),f.appendChild(E),g.appendChild(w),g.appendChild(S),this.contextMenu.append(u),this.contextMenu.append(p),this.contextMenu.append(m),this.contextMenu.append(f),this.contextMenu.append(g),this.contextMenu.style.display="none",this.noteGroup.append(this.note),this.noteGroup.append(this.contextMenu),this.el.setAttribute("transform",`translate (${t} 0)`),this.el.append(this.ledgerLines),this.el.append(this.noteGroup);let M=!0;this.note.addEventListener("pointerdown",(e=>{M=!0,console.log("down on note"),this.interactive.playNote(this.noteValue,this.noteLength,!0),this.noteText.style.color=this.noteColor,this.oldNote=this.noteValue})),document.addEventListener("pointermove",(e=>{if(M){this.roundedPos=5*Math.round(this.interactive.svgY/5)-30,this.roundedPos<-75&&(this.roundedPos=-75),this.roundedPos>95&&(this.roundedPos=95);let e=-1*this.roundedPos/5;this.roundedPos>=0&&1==this.inBassClef&&(e+=4),this.noteColor=ye[(e+21)%7];let t=ge[(e+21)%7],u=Math.floor(e/7+4);this.noteValue=fe[(e+21)%7]+12*(u-4),this.noteGroup.setAttribute("transform",`translate(0 ${this.roundedPos})`),this.roundedPos<=0&&(this.inBassClef=!1),this.roundedPos>=20&&(this.inBassClef=!0),this.noteValue!=this.oldNote&&this.interactive.playNote(this.noteValue,this.noteLength,!0),this.noteText.textContent="playNote("+this.noteValue+")",this.noteText.textContent+=" #"+t+u,s.style.fill=this.noteColor,n.style.stroke=this.noteColor,i.style.fill=this.noteColor,this.noteText.style.color=this.noteColor,[r,a,h,c,o,l,d].forEach((e=>e.style.stroke=this.noteColor)),this.roundedPos<=-30||this.roundedPos>0&&this.roundedPos<=50&&this.inBassClef?(n.setAttribute("x1","154.5"),n.setAttribute("x2","154.5"),n.setAttribute("transform","translate(0 35)"),i.setAttribute("transform","scale(0.05 -0.05) translate(2322 -1750)")):(n.setAttribute("transform","translate(0 0)"),n.setAttribute("x1","165.5"),n.setAttribute("x2","165.5"),i.setAttribute("transform","scale(0.05 0.05) translate(2540 -550)")),this.roundedPos<0||this.roundedPos>15||this.inBassClef?r.style.display="none":r.style.display="block",this.roundedPos<10&&!this.inBassClef||this.roundedPos>10&&this.inBassClef?a.style.display="none":a.style.display="block",this.roundedPos>-60?h.style.display="none":h.style.display="block",this.roundedPos>-70?c.style.display="none":c.style.display="block",this.roundedPos<20&&!this.inBassClef||this.roundedPos>20?o.style.display="none":o.style.display="block",this.roundedPos<80?l.style.display="none":l.style.display="block",this.roundedPos<90?d.style.display="none":d.style.display="block",this.oldNote=this.noteValue}})),this.note.addEventListener("mouseover",(()=>{this.noteText.style.color=this.noteColor,this.noteFlash()})),this.note.addEventListener("mouseleave",(()=>{this.noteText.style.color="black",this.noteReturn()})),this.noteText.addEventListener("mouseenter",(()=>{this.noteText.style.color=this.noteColor,this.noteFlash()})),this.noteText.addEventListener("mouseleave",(()=>{this.noteText.style.color="black",this.noteReturn()})),document.addEventListener("pointerup",(e=>{M&&(console.log("released note"),M=!1,this.noteText.style.color="black")})),this.note.addEventListener("contextmenu",(e=>{e.preventDefault(),this.interactive.allNotes.appendChild(this.el),this.menuOpen=!0,this.contextMenu.style.display="block"})),document.addEventListener("pointerdown",(e=>{this.menuOpen&&(this.interactive.pointerOnMenu||(this.contextMenu.style.display="none",this.menuOpen=!1))})),this.contextMenu.addEventListener("mouseenter",(()=>this.interactive.pointerOnMenu=!0)),this.contextMenu.addEventListener("mouseleave",(()=>this.interactive.pointerOnMenu=!1)),p.addEventListener("mouseenter",(()=>this.handleMouseEnter(y,_))),p.addEventListener("mouseleave",(()=>this.handleMouseLeave(y,_))),p.addEventListener("mousedown",(()=>this.handleClick(y,_,500))),m.addEventListener("mouseenter",(()=>this.handleMouseEnter(b,A))),m.addEventListener("mouseleave",(()=>this.handleMouseLeave(b,A))),m.addEventListener("mousedown",(()=>this.handleClick(b,A,1e3))),f.addEventListener("mouseenter",(()=>this.handleMouseEnter(v,E))),f.addEventListener("mouseleave",(()=>this.handleMouseLeave(v,E))),f.addEventListener("mousedown",(()=>this.handleClick(v,E,2e3))),g.addEventListener("mouseenter",(()=>this.handleMouseEnter(w,S))),g.addEventListener("mouseleave",(()=>this.handleMouseLeave(w,S))),g.addEventListener("mousedown",(()=>this.handleClick(w,S,4e3)))}get value(){return this.noteValue}get length(){return this.noteLength}textFlash(){this.noteText.style.color=this.noteColor}textBlack(){this.noteText.style.color="black"}noteFlash(){const e=this.note.querySelector("ellipse"),t=this.note.querySelector("line"),s=this.note.querySelector("path");e&&t&&s&&(e.style.fill=be[this.noteColor],t.style.stroke=be[this.noteColor],s.style.fill=be[this.noteColor],console.log(be[this.noteColor]));const n=this.ledgerLines.querySelectorAll(".ledger-line");console.log(n),n.forEach((e=>{e.style.stroke=be[this.noteColor]})),console.log("attempting to change color")}noteReturn(){const e=this.note.querySelector("ellipse"),t=this.note.querySelector("line"),s=this.note.querySelector("path");e&&t&&s&&(e.style.fill=this.noteColor,t.style.stroke=this.noteColor,s.style.fill=this.noteColor);const n=this.ledgerLines.querySelectorAll(".ledger-line");console.log(n),n.forEach((e=>{e.style.stroke=this.noteColor}))}handleMouseEnter(e,t){e!=this.selectedIcon&&(e.style.fill="#F1F1F1",t.setAttribute("opacity","0.7"))}handleMouseLeave(e,t){e!=this.selectedIcon&&(e.style.fill="#E8E8E8",t.setAttribute("opacity","1"),console.log(e==this.selectedIcon))}handleClick(e,t,s){e.style.fill="#C1C1C1",t.setAttribute("opacity","1"),this.selectedIcon=e,this.noteLength=s}}const xe=new CSSStyleSheet;xe.replaceSync(".lines {\n    stroke: black;\n    stroke-width: 0.3;\n    stroke-linecap: round;\n}\n.note {\n    stroke-width: 0.3;\n    stroke-linecap: round;\n}\n.button:active {\n    fill-opacity: 0.5;\n}\n.wheel {\n    fill-opacity: 0.8;\n    stroke-width: 0;\n    box-sizing: border-box;\n}\n\n/* Steps */\n.whole {\n    fill:none; \n    stroke:grey;\n    stroke-width: 0.4;\n    stroke-linejoin: round;\n}\n.half {\n    fill:none; \n    stroke:grey;\n    stroke-width: 0.4;\n    stroke-linejoin: round;\n    stroke-dasharray: 1;\n}\n\n/* Text */\n.wheel-text {\n    font: 8px monospace;\n    fill:darkslategray;\n    text-anchor: middle;\n    text-transform: uppercase;\n    user-select: none;\n    pointer-events: none;\n}\n.major-text {\n    text-transform: uppercase;\n}\n.minor-text {\n    text-transform: lowercase;\n}\n.button-text {\n    font: 3.2px monospace;\n    text-anchor: middle;\n    user-select: none;\n    pointer-events: none;\n}\n.code {\n    font: 4px monospace;\n    stroke-width: 0;\n    text-anchor: middle;\n}\n\n/* Notes */\n.C {\n    fill:rgb(255, 142, 161);\n    stroke: rgb(255, 142, 161);\n} \n.C.hover {\n    fill:rgb(237, 63, 118);\n    stroke: rgb(237, 63, 118);\n}\n.D {\n    fill:tomato;\n    stroke:tomato;\n}\n.D.hover {\n    fill:rgb(220, 34, 1);\n    stroke:rgb(220, 34, 1);\n}\n.E {\n    fill:orange;\n    stroke:orange;\n}\n.E.hover {\n    fill:rgb(226, 117, 0);\n    stroke:rgb(226, 117, 0);\n}\n.F {\n    fill:gold;\n    stroke:gold;\n}\n.F.hover {\n    fill:rgb(207, 193, 0);\n    stroke:rgb(207, 193, 0);\n}\n.G {\n    fill:rgb(157, 242, 135);\n    stroke:rgb(157, 242, 135);\n}\n.G.hover {\n    fill:rgb(82, 195, 54);\n    stroke:rgb(82, 195, 54);\n}\n.A {\n    fill:lightskyblue;\n    stroke:lightskyblue;\n}\n.A.hover {\n    fill:rgb(29, 156, 235);\n    stroke:rgb(29, 156, 235);\n}\n.B {\n    fill:plum;\n    stroke:plum;\n}\n.B.hover {\n    fill:rgb(165, 89, 165);\n    stroke:rgb(165, 89, 165);\n}\n#scale-container {\n    max-width: 550px;\n}");class ke extends HTMLElement{constructor(){super(),this.container=null,this.parent=document.createElementNS("http://www.w3.org/2000/svg","g"),this.synth=new Z,this.wheel=null,this.button=null,this.playSound=e=>{const t=e.currentTarget;let s,n=ke.NOTES.findIndex((e=>e===t.classList[1]))-ke.startNote;n<0&&(n+=7),s=ke.isMajor?t.classList.contains("last")?ke.MIDI[ke.startNote]+ke.MAJOR[n]+12:ke.MIDI[ke.startNote]+ke.MAJOR[n]:t.classList.contains("last")?ke.MIDI[ke.startNote]+ke.MINOR[n]+12:ke.MIDI[ke.startNote]+ke.MINOR[n],this.synth.scheduleNote(s,0)},this.addHover=e=>{const t=e.currentTarget;let s;s=t.classList.contains("first")?this.root.querySelectorAll(`.${t.classList[1]}.first, .wheel.${t.classList[1]}`):t.classList.contains("last")?this.root.querySelectorAll(`.${t.classList[1]}.last, .wheel.${t.classList[1]}`):this.root.querySelectorAll(`.${t.classList[1]}`),s?.forEach((e=>{e.classList.add("hover")}))},this.removeHover=e=>{const t=e.currentTarget;let s=this.root.querySelectorAll(`.${t.classList[1]}`);s?.forEach((e=>{e.classList.remove("hover")}))},this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(xe),this.root.innerHTML='<div id="scale-container">\n  <svg id="scale-svg" class="container" version="1.1" viewBox="0 0 100 200">\n  </svg>\n</div>'}async connectedCallback(){this.container=this.root.querySelector("svg.container"),this.container?.append(this.parent),this.container?.setAttribute("viewBox","0 0 100 1000"),this.render(!0,!0),this.synth=new Z;try{await this.synth.loadPatch(new URL("/sounds/voices/grand-piano/patch.json",e&&"SCRIPT"===e.tagName.toUpperCase()&&e.src||new URL("tunepad-interactives.min.js",document.baseURI).href))}catch(t){this.synth.loadPatch(new URL("/assets/sounds/voices/grand-piano/patch.json",e&&"SCRIPT"===e.tagName.toUpperCase()&&e.src||new URL("tunepad-interactives.min.js",document.baseURI).href))}}disconnectedCallback(){}attributeChangedCallback(e,t,s){}update(e,t){e&&this.render(!1,!0),t&&this.render(!1,!1)}render(e,t){if(null==this.container)return;this.parent.removeEventListener("click",this.playSound),this.parent.removeEventListener("pointerleave",this.addHover),this.parent.removeEventListener("pointerenter",this.removeHover),this.parent.innerHTML="",t||e?(this.wheel=new Se(this),this.parent.append(this.wheel.el),this.button=new Ae(this),this.parent.append(this.button.el)):(this.wheel&&this.parent.append(this.wheel.el),this.button&&this.parent.append(this.button.el));const s=new Ee(this);this.parent.append(s.el);const n=new _e(this);this.parent.append(n.el);const i=this.root.querySelectorAll(".note");i?.forEach((e=>{e.addEventListener("click",this.playSound),e.addEventListener("pointerenter",this.addHover),e.addEventListener("pointerleave",this.removeHover)}))}}ke.ELEMENT="music-scale",ke.observedAttributes=["min-value","max-value","value"],ke.isMajor=!0,ke.startNote=0,ke.NOTES=["C","D","E","F","G","A","B"],ke.MIDI=[60,62,64,65,67,69,71,72],ke.MAJOR=[0,2,4,5,7,9,11,12],ke.MINOR=[0,2,3,5,7,8,10,12];class Ae{get x(){return 2}get y(){return 2}get height(){return 10}get width(){return 26}constructor(e){this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.scale=e;const t=document.createElementNS("http://www.w3.org/2000/svg","rect");t.setAttribute("x",`${this.x}`),t.setAttribute("y",`${this.y}`),t.setAttribute("width",`${this.width}`),t.setAttribute("height",`${this.height}`),t.setAttribute("rx","2"),t.setAttribute("ry","2"),t.setAttribute("fill","black"),t.setAttribute("fill-opacity","0.3"),t.classList.add("button"),this.el.append(t);const s=document.createElementNS("http://www.w3.org/2000/svg","text");s.classList.add("button-text"),s.setAttribute("x",""+(this.x+this.width-this.width/2)),s.setAttribute("y",""+(this.y+this.height-this.height/2)),s.setAttribute("dominant-baseline","central"),s.innerHTML=ke.isMajor?"Major Scales":"minor scales",this.el.append(s),this.el.addEventListener("click",(t=>{ke.isMajor=!ke.isMajor,s.innerHTML=ke.isMajor?"Major Scales":"minor scales",e.update(!0,!1)}))}}class Se{get cx(){return 50}get cy(){return 39}get r(){return 25}get numSectors(){return 7}get angle(){return 360/this.numSectors*(Math.PI/180)}get offset(){return Math.PI/180*12.83}get pickerCoords(){return[[50,18],[47,11],[53,11]]}constructor(e){this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.wheel=document.createElementNS("http://www.w3.org/2000/svg","g"),this.text=document.createElementNS("http://www.w3.org/2000/svg","g"),this.down=!1,this.scale=e;let t=ke.startNote+1;for(let e=0;e<this.numSectors;e++){let s=ke.NOTES[(t+7)%7];const n=this.r*Math.cos(this.angle*(e+1)+this.offset)+this.cx,i=Math.abs(this.r*Math.sin(this.angle*(e+1)+this.offset)-this.cy),r=this.r*Math.cos(this.angle*e+this.offset)+this.cx,a=Math.abs(this.r*Math.sin(this.angle*e+this.offset)-this.cy),o=document.createElementNS("http://www.w3.org/2000/svg","path");o.setAttribute("d",`M ${this.cx} ${this.cy} \n                L ${n} ${i}\n                A ${this.r} ${this.r} 0 0 1 ${r} ${a}\n                L ${this.cx} ${this.cy}`),o.classList.add("wheel",s,"note"),this.wheel.append(o);const h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",""+(n+r+this.cx)/3),h.setAttribute("y",""+(i+a+this.cy)/3),h.setAttribute("dominant-baseline","central"),h.innerHTML=`${s}`,ke.isMajor?h.classList.add("major-text"):h.classList.add("minor-text"),h.classList.add("wheel-text"),this.text.append(h),t--}this.wheel.append(this.text),this.el.append(this.wheel);const s=document.createElementNS("http://www.w3.org/2000/svg","polygon");s.setAttribute("points",`${this.pickerCoords}`),s.setAttribute("fill","grey"),s.setAttribute("fill-opacity","0.8"),this.el.append(s);let n=0,i=0;this.el.addEventListener("pointerdown",(e=>{this.down=!0})),document.addEventListener("pointermove",(t=>{if(this.down){const e=this.svgToScreen(this.cx,this.cy),s=e.x-t.clientX,r=e.y-t.clientY;n=180*Math.atan2(r,s)/Math.PI-i,this.wheel.setAttribute("transform",`rotate(${n} ${this.cx} ${this.cy})`);const a=this.wheel.querySelectorAll(".wheel-text");a?.forEach((e=>{e.setAttribute("transform",`rotate(${-n} \n                        ${e.getAttribute("x")} \n                        ${e.getAttribute("y")})`)}))}const s=this.svgToScreen(50,18);let r=this.scale.root.elementsFromPoint(s.x,s.y);r=r.filter((e=>e.classList.contains("wheel"))),r.length>0&&(ke.startNote=ke.NOTES.indexOf(r[0].classList.item(1)),e.update(!1,!0))})),document.addEventListener("pointerup",(e=>{this.down&&(this.down=!1);const t=this.svgToScreen(this.cx,this.cy),s=t.x-e.clientX,n=t.y-e.clientY;i=180*Math.atan2(n,s)/Math.PI}))}svgToScreen(e,t){const s=this.scale.container,n=s.createSVGPoint();return n.x=e,n.y=t,n.matrixTransform(s.getScreenCTM()??void 0)}}class Ee{get max(){return 70}get min(){return this.max+13}get x0(){return 18}get y0(){return 86}constructor(e){this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.staff=document.createElementNS("http://www.w3.org/2000/svg","g"),this.scale=e;for(let e=0;e<5;e++){const t=document.createElementNS("http://www.w3.org/2000/svg","line");let s=this.max+3.25*e;t.setAttribute("x1","0"),t.setAttribute("y1",`${s}`),t.setAttribute("x2","100"),t.setAttribute("y2",`${s}`),t.classList.add("lines"),this.staff.append(t)}const t=document.createElementNS("http://www.w3.org/2000/svg","image");t.setAttribute("href",Ee.clef_url),t.setAttribute("x","0"),t.setAttribute("y","64"),t.setAttribute("width","15"),t.setAttribute("height","25"),t.onerror=e=>{Ee.clef_url="/images/treble_clef.png",t.setAttribute("href",Ee.clef_url)},this.staff.append(t),this.el.append(this.staff);let s,n=this.min+2,i=this.max-2,r=(n+i)/2,a=ke.startNote;for(let e=0;e<8;e++){const t=document.createElementNS("http://www.w3.org/2000/svg","g"),o=document.createElementNS("http://www.w3.org/2000/svg","ellipse");s=ke.NOTES[(a+7)%7];let h=this.x0+11*(a-ke.startNote),c=this.y0-1.6*a;o.setAttribute("cx",`${h}`),o.setAttribute("cy",`${c}`),o.setAttribute("rx","2"),o.setAttribute("ry","1.2"),o.setAttribute("transform",`rotate(-18, ${h}, ${c})`),t.append(o);const l=document.createElementNS("http://www.w3.org/2000/svg","line");c>r?(l.setAttribute("x1",`${h+1.9}`),l.setAttribute("y1",""+(c-.8)),l.setAttribute("x2",`${h+1.9}`),l.setAttribute("y2",""+(c-9.5))):(l.setAttribute("x1",""+(h-1.9)),l.setAttribute("y1",`${c+.8}`),l.setAttribute("x2",""+(h-1.9)),l.setAttribute("y2",`${c+9.5}`)),t.append(l),(c>n||c<i)&&t.append(this.drawLedger(h,c,i,a)),this.addAccidental(s,t,h,c),7!=e&&this.el.append(this.drawSteps(e,h,c)),t.classList.add("staff",s,"note"),0==e?t.classList.add("first"):7==e&&t.classList.add("last"),this.el.append(t),a++}}drawLedger(e,t,s,n){const i=document.createElementNS("http://www.w3.org/2000/svg","line");return i.setAttribute("x1",""+(e-3)),i.setAttribute("x2",`${e+2.7}`),n%2==0?(i.setAttribute("y1",`${t+.25}`),i.setAttribute("y2",`${t+.25}`)):t<s?(i.setAttribute("y1",`${t+1.25}`),i.setAttribute("y2",`${t+1.25}`)):(i.setAttribute("y1",""+(t-1.25)),i.setAttribute("y2",""+(t-1.25))),i}addAccidental(e,t,s,n){switch(e){case"C":switch(ke.startNote){case 1:case 2:case 5:ke.isMajor&&t.append(this.drawSharp(s,n));break;case 6:t.append(this.drawSharp(s,n))}break;case"D":switch(ke.startNote){case 2:case 6:ke.isMajor&&t.append(this.drawSharp(s,n));break;case 3:ke.isMajor||t.append(this.drawFlat(s,n))}break;case"E":switch(ke.startNote){case 0:case 3:case 4:ke.isMajor||t.append(this.drawFlat(s,n))}break;case"F":switch(ke.startNote){case 1:case 4:case 5:ke.isMajor&&t.append(this.drawSharp(s,n));break;case 2:case 6:t.append(this.drawSharp(s,n))}break;case"G":switch(ke.startNote){case 2:case 5:case 6:ke.isMajor&&t.append(this.drawSharp(s,n))}break;case"A":switch(ke.startNote){case 6:ke.isMajor&&t.append(this.drawSharp(s,n));break;case 0:case 3:ke.isMajor||t.append(this.drawFlat(s,n))}break;case"B":switch(ke.startNote){case 0:case 1:case 4:ke.isMajor||t.append(this.drawFlat(s,n));break;case 3:t.append(this.drawFlat(s,n))}}}drawSharp(e,t){const s=document.createElementNS("http://www.w3.org/2000/svg","g"),n=document.createElementNS("http://www.w3.org/2000/svg","line"),i=document.createElementNS("http://www.w3.org/2000/svg","line"),r=document.createElementNS("http://www.w3.org/2000/svg","line"),a=document.createElementNS("http://www.w3.org/2000/svg","line");return n.setAttribute("x1",""+(e-5)),n.setAttribute("y1",`${t+1}`),n.setAttribute("x2",""+(e-3)),n.setAttribute("y2",""+(t-1)),s.append(n),i.setAttribute("x1",""+(e-5)),i.setAttribute("y1",`${t+3}`),i.setAttribute("x2",""+(e-3)),i.setAttribute("y2",`${t+1}`),s.append(i),r.setAttribute("x1",""+(e-4.35)),r.setAttribute("y1",`${t+4.5}`),r.setAttribute("x2",""+(e-4.35)),r.setAttribute("y2",""+(t-1.5)),s.append(r),a.setAttribute("x1",""+(e-3.55)),a.setAttribute("y1",`${t+3.5}`),a.setAttribute("x2",""+(e-3.55)),a.setAttribute("y2",""+(t-2.5)),s.append(a),s}drawFlat(e,t){const s=document.createElementNS("http://www.w3.org/2000/svg","g"),n=document.createElementNS("http://www.w3.org/2000/svg","line"),i=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("x1",""+(e-4.35)),n.setAttribute("y1",`${t+1.5}`),n.setAttribute("x2",""+(e-4.35)),n.setAttribute("y2",""+(t-4.5)),s.append(n),i.setAttribute("d",`M ${e-4.35} ${t} A 2.5 0.5 -45 0 1 ${e-4.35} ${t+1.5}`),i.setAttribute("fill","none"),s.append(i),s}drawSteps(e,t,s){const n=document.createElementNS("http://www.w3.org/2000/svg","polyline");return ke.isMajor?2==e||6==e?n.classList.add("half"):n.classList.add("whole"):1==e||4==e?n.classList.add("half"):n.classList.add("whole"),n.setAttribute("points",`${t+.6} ${s+2.2}, \n            ${t+5.5} ${s+6}, \n            ${t+5.5} ${s+6}, \n            ${t+10.4} ${s+.6}`),n}}Ee.clef_url="/assets/images/treble_clef.png";class _e{get x(){return 31}get y(){return 96}get height(){return 44.5}get width(){return 38}constructor(e){this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.rect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.scale=e,this.rect.setAttribute("x",`${this.x}`),this.rect.setAttribute("y",`${this.y}`),this.rect.setAttribute("width",`${this.width}`),this.rect.setAttribute("height",`${this.height}`),this.rect.setAttribute("rx","2"),this.rect.setAttribute("ry","2"),this.rect.setAttribute("fill","black"),this.rect.setAttribute("fill-opacity","0.7"),this.el.append(this.rect);let t=ke.MIDI[ke.startNote];for(let e=0;e<8;e++){const s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("x",""+(this.x+this.width-this.width/2+.7)),s.setAttribute("y",`${this.y+5+5*e}`),s.setAttribute("dominant-baseline","central"),ke.isMajor?s.innerHTML=`playNote(${t+ke.MAJOR[e]})`:s.innerHTML=`playNote(${t+ke.MINOR[e]})`,s.classList.add("code",ke.NOTES[(ke.startNote+e+7)%7],"note"),0==e?s.classList.add("first"):7==e&&s.classList.add("last"),this.el.append(s)}}}const Ne=new CSSStyleSheet;Ne.replaceSync("\n#garden-container {\n   text-align: center;\n}\n\n#garden-canvas {\n    background-color: rgb(210, 200, 190);\n}");const Me=qe([-100,-80,-1]);class Te{constructor(e,t,s,n,i){this.petals=new Array,this.note=0,this.cx=t,this.cy=s,this.r=n,this.note=e,this.color=i;for(let e=0;e<16;e++)this.petals.push(0)}surfaceNormal(e,t){const s=2*Math.PI/16,n=Ce([1,0],e*s),i=Ce([1,0],t?(e+1)*s:(e-1)*s),r=this.isPetalHighlighted(e)?-.05:.05;return qe(t?Pe([n[0],n[1],r],[0,0,0],[i[0],i[1],0]):Pe([0,0,0],[n[0],n[1],r],[i[0],i[1],0]))}shadowColor(e,t,s=1){const n=this.surfaceNormal(e,t),i=Math.max(-1,Math.min(1,function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}(Me,n)*s));return i>0?`rgba(255, 255, 255, ${i})`:`rgba(0, 0, 0, ${-i})`}halfPetalShape(e,t,s){const n=this.cx,i=this.cy,r=this.r,a=r/5.7;e.resetTransform(),e.translate(n,i),e.scale(1,-1),e.rotate(t*Math.PI*2/16),e.moveTo(0,0),s?e.bezierCurveTo(.8*r,a,.8*r,a,r,0):e.bezierCurveTo(.8*r,-a,.8*r,-a,r,0),e.lineTo(0,0)}petalShape(e,t){e.beginPath(),this.halfPetalShape(e,t,!0),this.halfPetalShape(e,t,!1),e.closePath()}drawShadow(e){e.save(),e.beginPath();for(let t=0;t<16;t++)this.halfPetalShape(e,t,!0),this.halfPetalShape(e,t,!1);e.closePath(),e.shadowBlur=8,e.shadowOffsetX=-10,e.shadowOffsetY=10,e.shadowColor="#0009",e.fillStyle=this.color,e.fill(),e.restore()}drawHalfPetal(e,t,s,n=!1){const i=this.r;e.resetTransform(),e.save(),e.beginPath(),this.halfPetalShape(e,t,s),e.closePath(),e.fillStyle=this.color,e.fill(),e.lineWidth=1,n?(e.fillStyle="#fffa",e.strokeStyle="white"):this.isPetalHighlighted(t)?(e.fillStyle="#fff7",e.strokeStyle="#ffff",e.lineWidth=2):(e.fillStyle=this.shadowColor(t,s),e.strokeStyle="#0001"),e.fill(),e.stroke(),e.beginPath(),e.moveTo(0,s?1:-1),e.lineTo(i,s?1:-1),e.lineWidth=1,e.strokeStyle=this.shadowColor(t,s,1.5),e.stroke(),e.restore()}drawCenter(e){const t=this.cx,s=this.cy,n=this.r/5.5;e.resetTransform(),e.save(),e.beginPath(),e.arc(t,s,n,0,2*Math.PI),e.fillStyle=this.color,e.shadowBlur=4,e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowColor="#0007",e.fill(),e.restore();for(let i=0;i<16;i++)e.resetTransform(),e.save(),e.beginPath(),e.translate(t,s),e.scale(1,-1),e.rotate(i*Math.PI*2/16),e.moveTo(0,0),e.lineTo(n,.187*n),e.lineTo(n,-.187*n),e.closePath(),e.fillStyle=this.color,e.strokeStyle="#0001",e.lineWidth=.5,e.fill(),e.stroke(),e.restore()}drawPetal(e,t,s=-1){this.drawHalfPetal(e,t,!0,s==t),this.drawHalfPetal(e,t,!1,s==t)}draw(e,t=-1){this.drawShadow(e);for(let s=0;s<16;s++)this.drawPetal(e,s,Math.floor(4*t));this.drawCenter(e)}playLoop(e,t){const s=this.petals.length/4;for(let n=0;n<this.petals.length;n++)this.isPetalHighlighted(n)&&e.scheduleNote(this.note,n/s+t)}hitTest(e,t,s){const n=this.cx,i=this.cy,r=this.r,a=t-n,o=s-i,h=Math.sqrt(a*a+o*o);if(h<=r/3.75||h>1.25*r)return-1;for(let n=this.petals.length-1;n>=0;n--){if(this.petalShape(e,n),e.isPointInPath(t,s))return n;e.restore()}return-1}isPetalHighlighted(e){return e>=0&&e<this.petals.length&&this.petals[e]>0}highlightPetal(e,t=100){e>=0&&e<this.petals.length&&(this.petals[e]=t)}unhighlightPetal(e){e>=0&&e<this.petals.length&&(this.petals[e]=0)}togglePetal(e,t=100){e>=0&&e<this.petals.length&&(this.petals[e]=this.petals[e]>0?0:t)}}class Le extends HTMLElement{constructor(){super(),this.synth=new Z,this.isPlaying=!1,this.flowers=[],this._start_time=0,this._loop_time=0,this.audio=h.init(),this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(Ne),this.root.innerHTML='<div id="garden-container">\n  <canvas id="garden-canvas" width="800" height="600"></canvas>\n  <br>\n  <button id="play-pause-button">Play</button>\n</div>',this.canvas=this.root.querySelector("#garden-canvas"),this.ctx=this.canvas.getContext("2d"),this.playButton=this.root.querySelector("#play-pause-button"),this.flowers.push(new Te(4,190,230,150,"rgb(150, 190, 215)")),this.flowers.push(new Te(0,530,200,190,"rgb(220, 100, 70)")),this.flowers.push(new Te(2,350,457,130,"rgb(250, 210, 110)"))}async connectedCallback(){this.render(),this.synth=new Z;try{await this.synth.loadPatch(new URL("/sounds/voices/808-drums/patch.json",e&&"SCRIPT"===e.tagName.toUpperCase()&&e.src||new URL("tunepad-interactives.min.js",document.baseURI).href))}catch(t){this.synth.loadPatch(new URL("/assets/sounds/voices/808-drums/patch.json",e&&"SCRIPT"===e.tagName.toUpperCase()&&e.src||new URL("tunepad-interactives.min.js",document.baseURI).href))}this.canvas.addEventListener("pointerdown",(e=>{this.flowers.forEach((t=>{const s=t.hitTest(this.ctx,e.offsetX,e.offsetY);s>=0&&(t.togglePetal(s),t.isPetalHighlighted(s)&&this.synth.scheduleNote(t.note,0),this.render())}))})),this.playButton.addEventListener("click",(e=>{this.isPlaying?(this.playButton.innerHTML="Play",this.synth.cancelAllNotes(),this.isPlaying=!1):(this.playButton.innerHTML="Pause",this.synth.scheduleNote(10,0),this._start_time=this.audio.contextTime,this._playLoop(),this.isPlaying=!0,window.requestAnimationFrame((e=>this._animate(e))))}))}_playLoop(e=0){const t=60/this.audio.bpm;this._loop_time=this.audio.contextTime+e*t,this.flowers.forEach((t=>{t.playLoop(this.synth,e)}))}_animate(e){if(this.render(),this.isPlaying){const e=this.audio.contextTime,t=(e-this._start_time)*(this.audio.bpm/60)%this.audio.beatsPerMeasure,s=this.audio.beatsPerMeasure-t,n=60/this.audio.bpm*this.audio.beatsPerMeasure;s<.25&&this._loop_time<e?this._playLoop(s):e-this._loop_time>n&&(this._start_time=this._loop_time+n,this._playLoop()),window.requestAnimationFrame((e=>this._animate(e)))}}disconnectedCallback(){}attributeChangedCallback(e,t,s){}render(){const e=this.canvas.width,t=this.canvas.height,s=this.ctx;s.resetTransform(),s.clearRect(0,0,e,t);let n=-1;if(this.isPlaying){const e=this.audio.contextTime-this._start_time;n=e*(this.audio.bpm/60)%this.audio.beatsPerMeasure}this.flowers.forEach((e=>{e.draw(s,n)}))}}function Ce(e,t){return[e[0]*Math.cos(t)-e[1]*Math.sin(t),e[0]*Math.sin(t)-e[1]*Math.cos(t)]}function Pe(e,t,s){return function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]}([t[0]-e[0],t[1]-e[1],t[2]-e[2]],[s[0]-e[0],s[1]-e[1],s[2]-e[2]])}function qe(e){const t=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}(e);return[e[0]/t,e[1]/t,e[2]/t]}Le.ELEMENT="groove-garden",Le.observedAttributes=["min-value","max-value","value"],customElements.define(ve.ELEMENT,ve),customElements.define(le.ELEMENT,le),customElements.define(pe.ELEMENT,pe),customElements.define(ke.ELEMENT,ke),customElements.define(Le.ELEMENT,Le)}();
//# sourceMappingURL=tunepad-interactives.min.js.map
