!function(){"use strict";var t="undefined"!=typeof document?document.currentScript:null;const e=new CSSStyleSheet;e.replaceSync(".lines {\n    stroke: black;\n    stroke-width: 0.3;\n    stroke-linecap: round;\n}\n.note {\n    stroke-width: 0.3;\n    stroke-linecap: round;\n}\n.button:active {\n    fill-opacity: 0.5;\n}\n.wheel {\n    fill-opacity: 0.8;\n    stroke-width: 0;\n    box-sizing: border-box;\n}\n\n/* Steps */\n.whole {\n    fill:none; \n    stroke:grey;\n    stroke-width: 0.4;\n    stroke-linejoin: round;\n}\n.half {\n    fill:none; \n    stroke:grey;\n    stroke-width: 0.4;\n    stroke-linejoin: round;\n    stroke-dasharray: 1;\n}\n\n/* Text */\n.wheel-text {\n    font: 8px monospace;\n    fill:darkslategray;\n    text-anchor: middle;\n    text-transform: uppercase;\n    user-select: none;\n}\n.major-text {\n    text-transform: uppercase;\n}\n.minor-text {\n    text-transform: lowercase;\n}\n.button-text {\n    font: 3.2px monospace;\n    text-anchor: middle;\n    user-select: none;\n}\n.code {\n    font: 4px monospace;\n    stroke-width: 0;\n    text-anchor: middle;\n}\n\n/* Notes */\n.C {\n    fill:rgb(255, 142, 161);\n    stroke: rgb(255, 142, 161);\n} \n.C.hover {\n    fill:rgb(237, 63, 118);\n    stroke: rgb(237, 63, 118);\n}\n.D {\n    fill:tomato;\n    stroke:tomato;\n}\n.D.hover {\n    fill:rgb(220, 34, 1);\n    stroke:rgb(220, 34, 1);\n}\n.E {\n    fill:orange;\n    stroke:orange;\n}\n.E.hover {\n    fill:rgb(226, 117, 0);\n    stroke:rgb(226, 117, 0);\n}\n.F {\n    fill:gold;\n    stroke:gold;\n}\n.F.hover {\n    fill:rgb(207, 193, 0);\n    stroke:rgb(207, 193, 0);\n}\n.G {\n    fill:rgb(157, 242, 135);\n    stroke:rgb(157, 242, 135);\n}\n.G.hover {\n    fill:rgb(82, 195, 54);\n    stroke:rgb(82, 195, 54);\n}\n.A {\n    fill:lightskyblue;\n    stroke:lightskyblue;\n}\n.A.hover {\n    fill:rgb(29, 156, 235);\n    stroke:rgb(29, 156, 235);\n}\n.B {\n    fill:plum;\n    stroke:plum;\n}\n.B.hover {\n    fill:rgb(165, 89, 165);\n    stroke:rgb(165, 89, 165);\n}\n/* #scale-container {\n    max-width: 550px;\n} */");function s(t,e=0){const s=parseInt(t);return isNaN(s)?e:s}function i(t,e=0){const s=parseFloat(t);return isNaN(s)?e:s}function a(t,e=!1){if(null==t)return e;if("boolean"==typeof t)return t;{const e=t.toString().toLowerCase();if("true"===e||"t"===e)return!0;if("false"===e||"f"===e)return!1}return e}function n(t,e=""){return t?t.toString():e}function r(t){return Math.max(0,Math.pow(10,t/20))}function o(t,e,s){return Math.max(e,Math.min(s,t))}class h{get bpm(){return this._bpm}set bpm(t){this.setTempo(t)}get meter(){return this._meter}set meter(t){this.setTimeSignature(t)}get beatsPerMeasure(){return this._beatsPerMeasure}get beatValue(){return this._beatValue}get key(){return this._key}set key(t){this._key=t}get contextTime(){return this.context.currentTime}get time(){return this.isPaused?this._start:this.contextTime-this._start}get timeString(){let t=""+Math.floor(this.time/60)%60,e=""+Math.round(this.time)%60,s=""+Math.floor(100*this.time)%100;return 1==t.length&&(t=`0${t}`),1==e.length&&(e=`0${e}`),1==s.length&&(s=`0${s}`),`${t}:${e}.${s}`}get beats(){return this.time*this.bpm/60+this._elapsedBeats}get isPaused(){return 0==this._subscribers.size}static init(){return null==h._instance&&(h._instance=new h),h._instance}constructor(){this._start=0,this._elapsedBeats=0,this._bpm=90,this._meter="4/4",this._beatsPerMeasure=4,this._beatValue=4,this._key="C major",this._subscribers=new Set,this._listeners=new Set,this.context=new AudioContext,this._metronomes=new Set,this._timer=-1}addSubscriber(t){this._listeners.add(t)}removeSubscriber(t){this._listeners.delete(t)}isPlaying(t){return this._subscribers.has(t)}play(t){this.isPaused&&(this._start=this.contextTime-this._start),this._subscribers.add(t),this._listeners.add(t)}pause(t){this._listeners.add(t),this.isPlaying(t)&&(this._subscribers.delete(t),this.isPaused&&(this._start=this.contextTime-this._start))}stopAll(){this._elapsedBeats=0,this._start=0,this._subscribers.clear(),this._listeners.forEach((t=>t.onClockReset()))}setTime(t){this._elapsedBeats=t,this._start=0,this._listeners.forEach((t=>t.onClockTimeChange())),this._subscribers.clear()}setTempo(t){if(isNaN(t))return;const e=this.beats;t!=this._bpm&&(this._bpm=Math.max(5,t),this._start=this.contextTime-60*e/this._bpm,this._listeners.forEach((t=>t.onTempoChange())))}setTimeSignature(t){2!=t.split("/").length&&(t="4/4"),this._beatsPerMeasure=s(t.split("/")[0],-1),this._beatValue=s(t.split("/")[1],-1),(this._beatsPerMeasure<0||this._beatValue<0)&&(this._beatsPerMeasure=4,this._beatValue=4);const e=`${this._beatsPerMeasure}/${this._beatValue}`;this._meter!=e&&(this._meter=e,this._listeners.forEach((t=>t.onTimeSignatureChange())))}startMetronome(t){if(this._metronomes.add(t),-1==this._timer){const t=this.contextTime;let e=0;this._metronomes.forEach((t=>t.pulse(0))),this._timer=window.setInterval((()=>{if(0==this._metronomes.size)window.clearInterval(this._timer),this._timer=-1;else{const s=60/this.bpm,i=this.contextTime-t,a=Math.floor(i/s)%this.beatsPerMeasure;a!=e&&(e=a,this._metronomes.forEach((t=>t.pulse(e))))}}),30)}}stopMetronome(t){this._metronomes.delete(t)}isMetronomePlaying(t){return this._metronomes.has(t)}}class c{constructor(t,e,s){this.value=1,this.gain=new GainNode(t),this.name=e,this.value=s,this.gain.gain.value=s}connect(t,e){return e==this.name&&(t.level.connect(this.gain),!0)}destroy(){this.gain.disconnect()}updateParameter(t,e){return t==`${this.name}-mod}`&&(this.value=i(e,this.value),this.gain.gain.value=this.value,!0)}}class l{constructor(t,e){this.id=0,this.modulators=new Array,this.connectors=new Array,this.context=t,this.id=parseInt(e.id),this.level=t.createGain();const s=i(e.level,0);this.level.gain?.setValueAtTime(r(s),0),this.level.gain.value=r(s),this.addModulator("gain",i(e["gain-mod"],1),this.level.gain)}connect(t,e){for(let s of this.modulators)if(s.connect(t,e))return;"level"==e?t.level.connect(this.level.gain):t.level.connect(this.level)}addConnector(t){this.connectors.push(t),this.level?.connect(t.level)}addModulator(t,e,s){const i=new c(this.context,t,e);i.gain.connect(s),this.modulators.push(i)}playNote(t){}releaseNote(){}scheduleNote(t,e,s,i){}cancelNotes(){}destroy(){this.level.disconnect(),this.modulators.forEach((t=>t.destroy())),this.connectors.forEach((t=>t.destroy()))}pitchBend(t){}schedulePitchBend(t,e){}updateParameter(t,e){for(let s of this.modulators)if(s.updateParameter(t,e))return;if("level"==t){const t=i(e,0);this.level.gain?.setValueAtTime(r(t),0),this.level.gain.value=r(t)}}updateConnectorLevel(t,e){this.connectors.forEach((s=>{s.id==t&&s.updateLevel(e)}))}attachAnalyzer(t,e,s){for(let i of this.connectors)i.id==t&&i.attachAnalyzer(e,s)}detachAnalyzer(t){this.connectors.forEach((e=>{e.id==t&&e.detachAnalyzer()}))}getFloatTimeDomainData(t,e,s){this.connectors.forEach((i=>{i.id==t&&i.getFloatTimeDomainData(e,s)}))}}class u extends l{constructor(t,e){super(t,e),this.A=.1,this.D=.1,this.S=1,this.R=.2,this.aShape=5,this.dShape=2,this.rShape=2,this.attackCurve=[],this.decayCurve=[],this.releaseCurve=[],this.A=i(e.A,this.A),this.D=i(e.D,this.D),this.S=i(e.S,this.S),this.R=i(e.R,this.R),this.R=Math.max(this.R,.01),this.aShape=i(e["a shape"],this.aShape),this.dShape=i(e["d shape"],this.dShape),this.rShape=i(e["r shape"],this.rShape),this._attack=t.createGain(),this._decay=t.createGain(),this._release=t.createGain(),this._attack.gain.value=0,this._decay.gain.value=1,this._release.gain.value=1,this._attack.connect(this._decay),this._decay.connect(this._release),this._release.connect(this.level),this._buildCurves()}connect(t,e){t.level.connect(this._attack)}playNote(t){let e=this.context.currentTime;try{this._attack.gain?.cancelScheduledValues(0),this._decay.gain?.cancelScheduledValues(0),this._release.gain?.cancelScheduledValues(0),this.A>0?this._attack.gain?.setValueAtTime(0,e):this._attack.gain?.setValueAtTime(1,e),this._decay.gain?.setValueAtTime(1,e),this._release.gain?.setValueAtTime(1,e),e=this.context.currentTime+.01,this.A>0?this._attack.gain?.setValueCurveAtTime(this.attackCurve,e,this.A):this._attack.gain?.setValueAtTime(1,e),this.D>0?this._decay.gain?.setValueCurveAtTime(this.decayCurve,e+this.A,this.D):this._decay.gain?.setValueAtTime(this.S,e+this.A)}catch(t){console.log("Exception in ADSR playNote $x.")}}releaseNote(){const t=this.context.currentTime;this.R>0?(this._attack.gain?.cancelScheduledValues(t),this._decay.gain?.cancelScheduledValues(t),this._release.gain?.setValueCurveAtTime(this.releaseCurve,t,this.R)):this._release.gain?.setValueAtTime(0,t)}scheduleNote(t,e,s,i){const a=e<0?-e:0;let n=(e=e<0?0:e)+this.context.currentTime;if(this.A>0?this._attack.gain?.setValueAtTime(0,n):this._attack.gain?.setValueAtTime(1,n),this._decay.gain?.setValueAtTime(1,n),this._release.gain?.setValueAtTime(1,n),n+=.01,this.A>0&&this.A>a){const t=this.A-a;this._attack.gain?.setValueCurveAtTime(this.attackCurve,n,t)}else this._attack.gain?.setValueAtTime(1,n);if(this.D>0&&this.A+this.D>a&&s>this.A){const t=a>=this.A?this.D-(a-this.A):this.D,e=a>=this.A?n:n+this.A-a;this._decay.gain?.setValueCurveAtTime(this.decayCurve,e,t),this.A+this.D>s&&this._decay.gain?.cancelScheduledValues(n+s-a)}else this._decay.gain?.setValueAtTime(this.S,Math.max(0,n+this.A+this.D-a));if(s+this.R>a){const t=a>=s?this.R-(a-s):this.R;this._release.gain?.setValueCurveAtTime(this.releaseCurve,n+s-a,t)}else this._release.gain?.setValueAtTime(0,n)}cancelNotes(){super.cancelNotes();const t=this.context.currentTime;this._release.gain?.cancelScheduledValues(t),this._release.gain.value=0,this._attack.gain?.cancelScheduledValues(t),this._attack.gain.value=0,this._decay.gain?.cancelScheduledValues(t),this._decay.gain.value=0}destroy(){super.destroy(),this._attack.disconnect(),this._decay.disconnect(),this._release.disconnect()}updateParameter(t,e){switch(super.updateParameter(t,e),t){case"A":this.A=i(e,this.A);break;case"D":this.D=i(e,this.D);break;case"S":this.S=i(e,this.S);break;case"R":this.R=i(e,this.R);break;case"a shape":this.aShape=i(e,this.aShape);break;case"d shape":this.dShape=i(e,this.dShape);break;case"r shape":this.rShape=i(e,this.rShape)}this.R=Math.max(this.R,.01),this._buildCurves()}_buildCurves(){this._buildAttackCurve(this.aShape),this._buildDecayCurve(this.dShape),this._buildReleaseCurve(this.rShape)}_buildAttackCurve(t){t=o(t,.001,8),this.attackCurve=[];const e=Math.ceil(u.samplesPerSecond*this.A);if(e>0)for(let s=0;s<=e;s++){let i=s/e;i=Math.pow(i,t),this.attackCurve.push(i)}}_buildDecayCurve(t){t=o(t,.001,4),this.decayCurve=[];const e=Math.ceil(u.samplesPerSecond*this.D);if(e>0)for(let s=0;s<=e;s++){let i=s/e;i=1-Math.pow(i,t),this.decayCurve.push((1-this.S)*i+this.S)}}_buildReleaseCurve(t){t=o(t,.001,4),this.releaseCurve=[];const e=Math.ceil(u.samplesPerSecond*this.R);if(e>0)for(let s=0;s<=e;s++){let i=s/e;i=1-Math.pow(i,t),this.releaseCurve.push(i)}}}u.samplesPerSecond=300;class d{get context(){return this.source.context}constructor(t,e){this.id=0,this.dB=0,this._pre=null,this._analyzers=new Array,this._splitter=null,this._merger=null,this._buffer=null,this.type="",this.source=t,this.id=s(e.id,-1),this.level=new GainNode(this.context),this.dB=i(e.level,0),this.level.gain?.setValueAtTime(r(this.dB),0),this.type=n(e.type,"")}updateLevel(t){this.dB=t,(this._pre??this.level).gain?.setValueAtTime(r(t),0)}destroy(){this.level.disconnect()}attachAnalyzer(t,e,s=-60,i=5){e=o(e,1,6),this._pre=new GainNode(this.context),this._splitter=this.context.createChannelSplitter(e),this._merger=this.context.createChannelMerger(e),this._pre.gain?.setValueAtTime(r(this.dB),0),this.level.gain?.setValueAtTime(1,0),this.source.level.disconnect(this.level),this.source.level.connect(this._pre),this._pre?.connect(this._splitter),this._merger?.connect(this.level);for(let a=0;a<e;a++){let e=new AnalyserNode(this.level.context);this._analyzers.push(e),e.fftSize=t,e.minDecibels=s,e.maxDecibels=i,this._splitter?.connect(e,a,0),e.connect(this._merger,0,a),0==a&&(this._buffer=new Float32Array(e.frequencyBinCount))}}detachAnalyzer(){if(null!=this._pre){this.level.gain?.setValueAtTime(r(this.dB),0),this.source.level.disconnect(this._pre),this._pre?.disconnect(),this._splitter?.disconnect(),this._merger?.disconnect();for(let t of this._analyzers)t.disconnect();this.source.level.connect(this.level),this._pre=null,this._buffer=null,this._splitter=null,this._merger=null,this._analyzers=[]}}getFloatTimeDomainData(t,e){if(t<this._analyzers.length){const s=this._analyzers[t];if(null!=this._buffer&&e.length==this._buffer.length){s.getFloatTimeDomainData(this._buffer);for(let t=0;t<e.length;t++)e[t]+=this._buffer[t]}}}}class p extends l{constructor(t,e){super(t,e),this.tracking=!0,this.ratio=1,this.frequency=350,this.Q=1,this.gain=0,this.detune=0,this.type="lowpass",this.filter=t.createBiquadFilter(),this.filter.connect(this.level),this.Q=o(i(e.Q,1),1e-4,1e3),this.gain=o(i(e.gain,0),-40,40),this.type=n(e["filter type"],"lowpass"),this.detune=i(e.detune,0),this.frequency=o(i(e.frequency,350),0,16700),this.tracking=a(e.tracking,!0),this.ratio=i(e["tracking ratio"],1),this.addModulator("Q",i(e["Q-mod"],1),this.filter.Q),this.addModulator("gain",i(e["gain-mod"],5),this.filter.gain),this.addModulator("frequency",i(e["frequency-mod"],1e3),this.filter.frequency),this.filter.Q.value=this.Q,this.filter.gain.value=this.gain,this.filter.type=this.type,this.filter.detune.value=this.detune,this.filter.frequency.value=this.frequency}playNote(t){const e=this.tracking?t.frequency*this.ratio+this.frequency:this.frequency,s=this.context.currentTime;this.filter.Q?.setValueAtTime(this.Q,s),this.filter.gain?.setValueAtTime(this.gain,s),this.filter.detune?.setValueAtTime(this.detune,s),this.filter.frequency?.setValueAtTime(e,s)}scheduleNote(t,e,s,i){e=e<0?0:e;const a=this.context.currentTime,n=this.tracking?t.frequency*this.ratio+this.frequency:this.frequency;this.filter.Q?.setValueAtTime(this.Q,e+a),this.filter.gain?.setValueAtTime(this.gain,e+a),this.filter.detune?.setValueAtTime(this.detune,e+a),this.filter.frequency?.setValueAtTime(n,e+a)}cancelNotes(){super.cancelNotes(),this.filter.Q?.cancelScheduledValues(0),this.filter.gain?.cancelScheduledValues(0),this.filter.detune?.cancelScheduledValues(0),this.filter.frequency?.cancelScheduledValues(0)}destroy(){super.destroy(),this.filter.disconnect()}connect(t,e){"audio"===e?t.level.connect(this.filter):super.connect(t,e)}updateParameter(t,e){const s=this.context.currentTime;"filter type"===t&&p.FILTERS.includes(e)?(this.type=n(e,"lowpass"),this.filter.type=this.type):"Q"===t?(this.Q=o(i(e,this.Q),1e-4,1e3),this.filter.Q.cancelScheduledValues(0),this.filter.Q.setValueAtTime(this.Q,s),this.filter.Q.value=this.Q):"gain"===t?(this.gain=o(i(e,this.gain),-40,40),this.filter.gain.cancelScheduledValues(0),this.filter.gain.setValueAtTime(this.gain,s),this.filter.gain.value=this.gain):"detune"===t?(this.detune=i(e,this.detune),this.filter.detune?.cancelScheduledValues(0),this.filter.detune?.setValueAtTime(this.detune,s)):"frequency"===t?(this.frequency=o(i(e,this.frequency),0,16700),this.filter.frequency?.cancelScheduledValues(0),this.filter.frequency?.setValueAtTime(this.frequency,s),this.filter.frequency.value=this.frequency):"tracking"===t?this.tracking=a(e,this.tracking):"ratio"===t?this.ratio=i(e,this.ratio):super.updateParameter(t,e)}}p.FILTERS=["lowpass","highpass","bandpass","allpass","lowshelf","highshelf","peaking","notch","allpass"];class m extends l{constructor(t,e){super(t,e),this.frequency=440,this.multiplier=1,this.detune=0,this.relative=!0,this.waveform="sine",this.waveform=n(e.waveform,"sine"),this.frequency=i(e.frequency,this.frequency),this.detune=i(e.detune,0),this.relative=a(e.relative,!0),this.multiplier=i(e.multiplier,this.multiplier),this.osc=t.createOscillator(),this.gain=new GainNode(t),this.shaper=t.createWaveShaper(),this.addModulator("detune",i(e["detune-mod"],500),this.osc.detune),this.addModulator("frequency",i(e["frequency-mod"],1e3),this.osc.frequency),this.addModulator("amplitude",i(e["amplitude-mod"],1),this.level.gain),this.gain.gain.value=.3,m.Waveforms.includes(this.waveform)||(this.waveform="sine"),this.osc.frequency.setValueAtTime(90,0),this.osc.type="sine",this.osc.start(),this.osc.connect(this.gain),this.shaper.connect(this.gain),this.gain.connect(this.level),this._updateWaveform(this.waveform)}_updateWaveform(t){m.Waveforms.includes(t)&&(this.waveform=t),this.osc.type="sine",m.BasicWaveforms.includes(t)?(this.osc.type=t,this.osc.disconnect(),this.osc.connect(this.gain)):m.PeriodicWaveforms.includes(t)?(this.osc.setPeriodicWave(this._createPeriodicWave(t)),this.osc.disconnect(),this.osc.connect(this.gain)):m.ShaperWaveforms.includes(t)&&(this.shaper.curve=this._createWaveShaper(t),this.osc.disconnect(),this.osc.connect(this.shaper),this.osc.type="pitched noise"===t?"sawtooth":"sine")}_createWaveShaper(t){var e,s=new Float32Array(256);switch(t){case"exp sin":e=t=>Math.pow(t,5);break;case"hump":e=t=>(t<0?0:t)-.5;break;default:e=t=>2*Math.random()-1}for(let t=0;t<s.length;t++)s[t]=e(2*t/s.length-1);return s}_createPeriodicWave(t){let e=new Array;switch(t){case"cello":e=[0,1,.5,.3,.5,.35,.2,.2,.1,.15,.15,.15];break;case"flute":e=[0,.5,.05,.3,.1];break;case"reed":e=[-.15,.5,1,.4,.6,.3,.25,.2];break;case"brass":e=[0,.8,.8,.85,.9,.8,.85,.7,.6,.4,.3,.25,.2,.1];break;case"glass":e=[0,1,0,.25,0,.5,0,.75,0,.8];break;case"vibraphone":e=[0,6,19,.8,13,3];break;case"camel":e.push(0);for(let t=1;t<20;t++)e.push(1/Math.pow(t,2));break;case"soft saw":e.push(-.1);for(let t=1;t<20;t++)e.push(1/t);break;case"soft square":e.push(0);for(let t=1;t<50;t++)e.push(1/t*(t%2));break;case"organ 1":e=[-.1,1,1,1];break;case"organ 2":e=[-.1,1,1,1,0,0,0,0,0,.8];break;case"organ 3":e=[0,1,0,0,0,0,.8,.8,.8,.8];break;case"buzz 1":e.push(0);let t=1;for(let s=1;s<100;s++)s%3==0||s%4==0?(e.push(1/t),t++):e.push(0);break;default:e.push(0),t=1;for(let s=1;s<100;s++)s%5==0||s%2==0?(e.push(.5/t),t++):e.push(0)}return this.osc.context.createPeriodicWave(e,new Float32Array(e.length))}playNote(t){let e=this.relative?t.frequency*this.multiplier:this.frequency;e=o(e,0,23999),this.osc.frequency?.setValueAtTime(e,this.context.currentTime),this.osc.detune?.setValueAtTime(this.detune,this.context.currentTime)}scheduleNote(t,e,s,i){e=e<0?0:e;let a=this.relative?t.frequency*this.multiplier:this.frequency;a=o(a,0,23999),this.osc.frequency?.setValueAtTime(a,e+this.context.currentTime),this.osc.detune?.setValueAtTime(this.detune,e+this.context.currentTime)}cancelNotes(){super.cancelNotes(),this.osc.frequency?.cancelScheduledValues(0),this.osc.detune?.cancelScheduledValues(0)}destroy(){super.destroy(),this.osc.stop(),this.osc.disconnect(),this.gain.disconnect(),this.shaper.disconnect()}pitchBend(t){const e=this.context.currentTime;this.osc.detune?.setTargetAtTime(this.detune+t,e,.1)}schedulePitchBend(t,e){e.apply(this.osc.detune,t,this.context,this.detune)}updateParameter(t,e){if("waveform"===t)this._updateWaveform(e);else if("relative"==t)this.relative=a(e,!0);else if("frequency"==t)this.frequency=i(e,this.frequency),this.osc.frequency?.setValueAtTime(this.frequency,this.context.currentTime);else if("multiplier"==t)if(this.relative){let t=this.osc.frequency.value/this.multiplier;this.multiplier=i(e,this.multiplier),this.multiplier>0&&(t*=this.multiplier),t=o(t,0,23999),this.osc.frequency?.setValueAtTime(t,this.context.currentTime)}else this.multiplier=i(e,this.multiplier);else"detune"==t?(this.detune=i(e,this.detune),this.osc.detune?.setValueAtTime(this.detune,this.context.currentTime)):super.updateParameter(t,e)}}m.BasicWaveforms=["sine","square","triangle","sawtooth"],m.PeriodicWaveforms=["cello","flute","reed","brass","glass","vibraphone","camel","organ 1","organ 2","organ 3","soft saw","soft square","buzz 1","buzz 2"],m.ShaperWaveforms=["pitched noise","exp sin","hump"],m.Waveforms=[...m.BasicWaveforms,...m.PeriodicWaveforms,...m.ShaperWaveforms];class f extends u{constructor(t,e){super(t,e)}}class g{constructor(){}static hasSound(t){return g.sounds.has(t)}static getAudioBuffer(t){return g.sounds.get(t)}static async loadAudioBuffer(t){const e=g.context;if(g.hasSound(t))return!0;const s=g.supportsAudioType("audio/ogg")?`${t}.ogg`:`${t}.wav`;try{let i=await fetch(s),a=await i.arrayBuffer(),n=await e.decodeAudioData(a);return g.sounds.set(t,n),!0}catch(t){return console.log(t),!1}}static async loadCustomSound(t){if(g.hasSound(t))return!0;const e=g.context;try{let s=await fetch(t),i=await s.arrayBuffer(),a=await e.decodeAudioData(i);return g.sounds.set(t,a),console.log("Loaded "+t),!0}catch(t){return console.log(t),!1}}static supportsAudioType(t){if(g._supports.has(t))return g._supports.get(t);let e=!1;const s=document.createElement("audio");return s.id="test-audio-node",document.body.append(s),"probably"!=s.canPlayType(t)&&"maybe"!=s.canPlayType(t)||(e=!0,document.querySelector("#test-audio-node")?.remove()),g._supports.set(t,e),e}}function y(t){return"object"==typeof t&&"sample"in t&&"string"==typeof t.sample&&"step"in t&&"number"==typeof t.step}g.sounds=new Map,g.context=h.init().context,g._supports=new Map;class b extends l{constructor(t,e){super(t,e),this.sources=new Array,this.playback=1,this.detune=0,this.sample_pack="piano",this.samples=new Array,this._rate=1,this.drumkit=!1,this.playback=i(e.playback,this.playback),this.detune=i(e.detune,this.detune),this.sample_pack=n(e["sample-pack"],this.sample_pack),this.dIn=new GainNode(t),this.pIn=new GainNode(t),this.dIn.gain.value=i(e["detune-mod"],1),this.pIn.gain.value=i(e["playback-mod"],1),"samples"in e&&Array.isArray(e.samples)&&this.loadSamplePack(e.samples)}loadSamplePack(t){this.samples=t.filter((t=>y(t))).sort(((t,e)=>t.step-e.step)),this.samples.forEach((t=>g.loadAudioBuffer(t.sample)))}static loadAudioBuffers(t,e){t.forEach((t=>g.loadAudioBuffer(t.sample)))}playNote(t){this.scheduleNote(t,0,0,0)}findBestSample(t){let e;if(this.drumkit)e=this.samples.find((e=>e.step===Math.round(t.note)));else{let s=1e5;for(const i of this.samples){if(i.step==t.note)return i;if(i.step>t.note)return i.step-t.note+3<s?i:e;{const a=t.note-i.step;a<s&&(e=i,s=a)}}}return e}scheduleNote(t,e,s,i){const a=e<0?-e:0;e=Math.max(0,e);const n=this.findBestSample(t);if(n){const r=g.getAudioBuffer(n.sample);if(r){const o=t.note-n.step,h=this.context.currentTime,c=Math.pow(2,o/12),l=new AudioBufferSourceNode(this.context);l.connect(this.level),this.sources.push(l),this.dIn.connect(l.detune),this.pIn.connect(l.playbackRate),l.buffer=r,l.playbackRate.value=c*this.playback,l.start(e+h,a),s>0&&l.stop(e+h+s+i),l.addEventListener("ended",(t=>{this.sources=this.sources.filter((t=>t!==l)),l.disconnect()})),r.duration,this.playback,this._rate=c}}}cancelNotes(){super.cancelNotes(),this.sources.forEach((t=>{t.stop(),t.disconnect()})),this.sources=new Array,this._rate=1}destroy(){super.destroy(),this.sources.forEach((t=>{t.stop(),t.disconnect()})),this.sources=new Array,this._rate=1}pitchBend(t){const e=this.context.currentTime;this.sources.forEach((s=>{s.detune?.setTargetAtTime(this.detune+t,e,.1)}))}schedulePitchBend(t,e){if(this.sources.length>0){const s=this.sources[this.sources.length-1];e.apply(s.detune,t,this.context,this.detune)}}connect(t,e){"detune"==e?t.level.connect(this.dIn):"playback"==e&&t.level.connect(this.pIn)}updateParameter(t,e){"playback"==t?(this.playback=i(e,this.playback),this.sources.forEach((t=>{t.playbackRate?.setValueAtTime(this._rate*this.playback,this.context.currentTime)}))):"detune"==t?(this.detune=i(e,this.detune),this.sources.forEach((t=>{t.detune?.setValueAtTime(this.detune,this.context.currentTime)}))):"sample-pack"==t||("playback-mod"==t?this.pIn.gain.value=i(e,1):"detune-mod"==t?this.dIn.gain.value=i(e,1):super.updateParameter(t,e))}}class w{constructor(t){this.id=0,this.free=0,this.nodes=new Map,this.release=0,this.gates=new Array,this.context=t,this.id=w._CHAIN_ID++,this.loadPatch(w._sine_patch)}playNote(t,e){const s=e.context.currentTime;this.free=31536e3,this.disconnect();const i=new GainNode(e.context);i.connect(e),i.gain.value=t.gain,i.gain.setValueAtTime(t.gain,s),this.out?.level.connect(i),this.gates.push({free:this.free,node:i}),this.nodes.forEach(((e,s,i)=>e.playNote(t)))}releaseNote(){this.nodes.forEach(((t,e,s)=>t.releaseNote()))}scheduleNote(t,e,s,i){const a=i.context.currentTime;this.free=a+e+s+this.release+.05;const n=new GainNode(i.context);n.connect(i),n.gain.value=0,n.gain?.setValueAtTime(0,0),n.gain?.setValueAtTime(t.gain,Math.max(a,a+e)),n.gain?.setValueAtTime(0,Math.max(a,a+e+s+this.release)),this.out?.level.connect(n),this.gates.push({free:this.free,node:n});try{this.nodes.forEach(((i,a,n)=>{i.scheduleNote(t,e,s,this.release)}))}catch(t){console.log("Note scheduling exception: $x")}for(let t=0;t<this.gates.length;t++)this.gates[t].free<a&&(this.gates[t].node?.disconnect(),this.out?.level.disconnect(this.gates[t].node),delete this.gates[t]);return this.gates=this.gates.filter((t=>void 0!==t)),this.release}disconnect(){this.out?.level.disconnect(),this.gates.forEach((t=>{t.node?.disconnect()})),this.gates=[]}cancelNotes(){this.disconnect(),this.nodes.forEach((t=>t.cancelNotes())),this.free=0}destroy(){this.disconnect(),this.nodes.forEach((t=>t.destroy())),this.nodes.clear()}pitchBend(t){this.nodes.forEach((e=>e.pitchBend(t)))}schedulePitchBend(t,e){this.nodes.forEach((s=>s.schedulePitchBend(t,e)))}loadPatch(t){if(this.nodes.clear(),this.out=void 0,this.release=0,Array.isArray(t.nodes))for(let e of t.nodes){let t=this.createSynthNode(this.context,e);t instanceof f&&(this.out=t),this.nodes.set(t.id,t)}this._updateReleaseValue();for(let e of t.routing){let t=this.nodes.get(e.source),s=this.nodes.get(e.dest);if(t&&s){let i=new d(t,e);t.addConnector(i),s.connect(i,n(e.type,""))}}}createSynthNode(t,e){switch(e.type){case"gain":return new l(t,e);case"lfo":const s=new m(t,e);return s.gain.gain.value=1,s;case"osc":return new m(t,e);case"adsr":return new u(t,e);case"filter":return new p(t,e);case"out":return new f(t,e);case"sample":case"drums":return new b(t,e);default:return console.log(`Node not found: ${e.type}`),new l(t,e)}}getNodeById(t){return this.nodes.get(t)}updateParameter(t,e,s){let i=this.nodes.get(t);i?.updateParameter(e,s),this._updateReleaseValue()}updateConnectorLevel(t,e,s){let i=this.nodes.get(t);i?.updateConnectorLevel(e,s)}attachAnalyzer(t,e,s,i){let a=this.nodes.get(t);a?.attachAnalyzer(e,s,i)}detachAnalyzer(t,e){let s=this.nodes.get(t);s?.detachAnalyzer(e)}getFloatTimeDomainData(t,e,s,i){let a=this.nodes.get(t);a?.getFloatTimeDomainData(e,s,i)}_updateReleaseValue(){this.release=0,this.nodes.forEach((t=>{t instanceof u&&(this.release=Math.max(Math.max(t.A+t.D,t.R),this.release))}))}}w._CHAIN_ID=0,w._sine_patch={nodes:[{type:"out",A:.1,D:.1,S:.8,R:.15,id:0},{type:"osc",waveform:"sine",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"out"}]},w._custom_patch={nodes:[{type:"out",id:0,A:0,D:.1,S:1,R:.3,level:0},{type:"sample","sample-pack":"custom",samples:[{sample:"<SOUNDURL>",step:60}],id:1,level:0}],routing:[{id:2,source:1,dest:0,type:"audio",level:0}]};const v=16.3516,A=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],_=["rgb(229, 76, 78)","rgb(223, 132, 74)","rgb(228, 171, 81)","rgb(227, 199, 73)","rgb(223, 228, 78)","rgb(174, 215, 71)","rgb(63, 188, 70)","rgb(63, 169, 180)","rgb(64, 124, 180)","rgb(78, 69, 179)","rgb(141, 69, 183)","rgb(202, 69, 147)"];class x{get note(){return this._note}set note(t){this._note=t}get end(){return this.start+this.duration}get octave(){return Math.floor(this.note/12)}set octave(t){this.note=12*t+this.step}get step(){return this.note%12}set step(t){this.note=12*this.octave+t}get cents(){return Math.round(100*(this.note-Math.floor(this.note)))}get velocity(){return this._velocity}set velocity(t){this._velocity=S(t,0,127)}get gain(){return this.velocity*this.velocity/16129}set gain(t){this.velocity=Math.sqrt(127*t*127)}get name(){return`${A[Math.floor(this.step)]}`}get accidental(){return this.name.substring(1)}get nameWithOctave(){return`${A[Math.round(this.step)]}${this.octave-1}`}get stepColor(){return _[Math.round(this.step)%_.length]}get rate(){return Math.pow(2,this.note/12)}get frequency(){return v*this.rate}set frequency(t){t>0&&(this.note=12*Math.log(t/v)/Math.LN2)}constructor(t){this._note=60,this.start=0,this.duration=1,this._velocity=90,this.note=t}isEqual(t){return this.note===t.note&&this.start===t.start&&this.duration===t.duration&&this.velocity===t.velocity}clone(){let t=new x(this.note);return t.start=this.start,t.duration=this.duration,t.velocity=this.velocity,t}static fromName(t){const e=new x(60);return e.octave=x.nameToOctave(t),e.step=x.nameToStep(t),e}static fromFrequency(t){const e=new x(60);return e.frequency=t,e}static nameToOctave(t){if(2==t.length){let e=t.codePointAt(1);if(e)return S(e-48,0,8)}else if(t.length>2){let e=t.codePointAt(2);if(e)return S(e-48,0,8)}return 0}static nameToStep(t){return null==t||""==t?0:(t=t.length<=2?t[0].toUpperCase():t.substring(0,2).toUpperCase(),Math.max(0,A.indexOf(t)))}static nameToNote(t){if(t.length<2||t.length>3)return-1;t=t.replaceAll("#","♯");for(let e=0;e<12;e++)if(t.startsWith(A[e])){const s=t.substring(A[e].length);if(["0","1","2","3","4","5","6","7","8"].includes(s)){return 12*((s.codePointAt(0)||48)-48)+e}}return-1}}function S(t,e,s){return Math.max(e,Math.min(s,t))}class k{get end(){return this.time+this.duration}constructor(t,e){this.time=0,this.duration=1,this.line=-1,this.note=new x(60),this.trace_group=-1,this.params=new Map,this.id=k._TRACE_ID++,this.command=t,this.time=e}clone(){let t=new k(this.command,this.time);t.line=this.line,t.duration=this.duration,t.note=this.note.clone();for(let[e,s]of this.params)t.params.set(e,s);return t}static fromMap(t){let e=new k(String(t.get("command")),Math.max(0,Number(t.get("time"))));e.duration=Number(t.get("duration")),e.note.duration=e.duration;for(let[s,i]of t)if("note"===s&&"number"==typeof i)e.note.note=i;else if("pitch"===s&&"number"==typeof i)e.note.note=i+60;else if("velocity"===s&&"number"==typeof i)e.note.velocity=i;else if("sustain"===s&&"number"==typeof i)e.note.duration=Math.max(e.note.duration,i),e.duration=e.note.duration;else if("line"===s&&"number"==typeof i)e.line=i;else if("trace"===s)e.trace_group=i;else{if(["command","time","duration"].includes(s))continue;e.params.set(s,i)}return e}isEquivalent(t){if(this.command===t.command&&this.time===t.time&&this.duration===t.duration&&this.note.isEqual(t.note)){for(let[e,s]of this.params)if("line"!==e&&t.params.get(e)!==s)return!1;return!0}return!1}}k.PLAY="play",k.SOUND="sound",k.REST="rest",k.PUSH_FX="push_fx",k.POP_FX="pop_fx",k.MESSAGE="message",k._TRACE_ID=0;class T{constructor(t,e){this.released=!1,this.canceled=!1,this.note=t,this.chain=e}}const E={start:0,beats:0,values:[]};class N{constructor(t,e){this.params=new Array,this.start=0,this.beats=-1,this.free=-1,this.id=N._EFFECT_ID++,this.name=t,this.oparams=e,this.start=Math.max(0,e.start),this.beats=e.beats,this.free=-1;for(const t of e.values){const e=Array();if(Array.isArray(t))for(const s of t)e.push(s);else"number"==typeof t&&e.push(t);this.params.push(e)}}static createEffect(t,e){return new M(e)}connect(t,e,s){return this.free=(s+this.start+this.beats+.1)*(60/e)+t.context.currentTime,this.node.connect(t),this.node}disconnect(){this.node.disconnect()}afterEffect(t,e,s,i,a){}clampParam(t,e,s){for(let i=0;i<t.length;i++)t[i]=o(t[i],e,s)}}N._EFFECT_ID=0;class M extends N{get node(){return this._node}constructor(t){super("empty",E),this._node=new GainNode(t)}}class V{get isAssigned(){return this.nodeId>=0}get value(){return o(this._value,this.minValue,this.maxValue)}set value(t){this._value=o(t,this.minValue,this.maxValue)}get percentValue(){return(this.value-this.minValue)/this.range}set percentValue(t){this.value=t*this.range+this.minValue}get range(){return this.maxValue-this.minValue}constructor(){this._value=1,this.nodeId=-1,this.name="",this.label="",this.slot=0,this.minValue=0,this.maxValue=1}static fromJSON(t){const e=new V;return e.nodeId=s(t.node,-1),e.name=n(t.name,""),e.label=n(t.label,""),e.slot=s(t.slot,0),e.minValue=i(t.min,0),e.maxValue=i(t.max,1),e._value=o(i(t.value,1),e.minValue,e.maxValue),e}toJSON(){return{node:this.nodeId,name:this.name,label:this.label,slot:this.slot,min:this.minValue,max:this.maxValue,value:this.value}}}const P={nodes:[{type:"out",A:.05,D:.1,S:.8,R:.25,level:0,id:0},{type:"osc",waveform:"sine",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"audio",level:0,id:1}],parameters:[],name:"Simple Sine",description:"",instrument:"piano",submenu:"",version:"2.0",format:"tunepad-patch",created:"2024-03-08 16:15:54.384",modified:"2024-03-08 16:15:54.385"},q={nodes:[{type:"out",A:.05,D:.1,S:.8,R:.25,level:0,id:0},{type:"osc",waveform:"sawtooth",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"audio",level:0,id:1}],parameters:[],name:"Simple Saw",description:"",instrument:"piano",submenu:"",version:"2.0",format:"tunepad-patch",created:"2024-03-08 16:15:54.384",modified:"2024-03-08 16:15:54.385"},$={nodes:[{type:"out",A:.05,D:.1,S:.8,R:.25,level:0,id:0},{type:"osc",waveform:"square",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"audio",level:0,id:1}],parameters:[],name:"Simple Square",description:"",instrument:"piano",submenu:"",version:"2.0",format:"tunepad-patch",created:"2024-03-08 16:15:54.384",modified:"2024-03-08 16:15:54.385"},C={nodes:[{type:"out",A:.05,D:.1,S:.8,R:.25,level:0,id:0},{type:"osc",waveform:"triangle",relative:"true",frequency:1,id:1,level:.1}],routing:[{source:1,dest:0,type:"audio",level:0,id:1}],parameters:[],name:"Simple Tri",description:"",instrument:"piano",submenu:"",version:"2.0",format:"tunepad-patch",created:"2024-03-08 16:15:54.384",modified:"2024-03-08 16:15:54.385"},D={nodes:[{id:0,type:"out",A:0,D:.3,S:.5,R:.2,"a shape":3.4,"d shape":2,"r shape":2,level:0},{id:7,type:"osc",waveform:"sawtooth",relative:!0,frequency:440,multiplier:1,"frequency-mod":1e3,detune:0,"detune-mod":2,"amplitude-mod":.5,level:.1},{id:8,type:"filter","filter type":"lowpass",tracking:!0,frequency:980,"frequency-mod":100,Q:3,"Q-mod":10,gain:0,"gain-mod":250,"tracking ratio":1,level:0}],routing:[{id:26,source:7,dest:8,type:"audio",level:0},{id:25,source:8,dest:0,type:"audio",level:0}],parameters:[{node:8,name:"frequency",label:"FREQUENCY",slot:1,min:32,max:15e3,value:7e3},{node:8,name:"Q",label:"RESONANCE (Q)",slot:2,min:1e-4,max:50,value:50}],name:"Filtered Saw",instrument:"piano",version:"2.0",format:"tunepad-patch",created:"2024-05-30 17:44:15.448",modified:"2024-05-30 17:44:15.449"},L={nodes:[{id:0,type:"out",cx:116.38970947265625,cy:86.873046875,A:.011363636363636362,D:.1,S:1,R:.005681818181818182,"a shape":4.000000000000001,"d shape":2,"r shape":2,level:0},{id:2,type:"osc",cx:13.176898002624512,cy:87.11394500732422,waveform:"square",relative:!0,frequency:440.00000000000034,multiplier:1,"frequency-mod":1e3,detune:0,"detune-mod":10,"amplitude-mod":.5,level:-5},{id:3,type:"lfo",cx:-87.84600448608398,cy:87.11394500732422,waveform:"sine",relative:!1,frequency:6.900000000000002,"frequency-mod":30,detune:0,"detune-mod":20,"amplitude-mod":.5,level:4.950595879501315}],routing:[{id:2,source:2,dest:0,type:"audio",level:0},{id:5,source:3,dest:2,type:"detune",level:5}],parameters:[],name:"Wobbly Square",description:"Created in patchworks",instrument:"piano",version:"2.0",format:"tunepad-patch",created:"2022-03-01 16:37:48.199",modified:"2022-03-01 17:34:23.146"};function R(t){return"string"==typeof t.name&&"2.0"===t.version&&"tunepad-patch"===t.format&&Array.isArray(t.nodes)&&Array.isArray(t.routing)}class I{get bpm(){return this._bpm}set bpm(t){isNaN(t)||(this._bpm=o(t,5,300))}get voice(){return this.patch.name}constructor(t){this._bpm=90,this.notes=new Array,this.patch=P,this.bank=new Array,this.sound_gens=new Array,this.parameters=new Array,this._analyzers=new Map,this._effects=new Array,t&&this.loadPatch(t)}get isPlaying(){if(0===this.bank.length)return!1;{const t=this.bank[0].context.currentTime;for(const e of this.bank)if(e.free>t)return!0;return!1}}playNote(t,e){e||(e=h.init().context.destination);const s="number"==typeof t?new x(t):t;let i=this._allocateGenerator(e.context,e.context.currentTime);i&&(i.cancelNotes(),i.playNote(s,e),this.notes.push(new T(s,i)))}releaseNote(t){const e="number"==typeof t?t:t.note;this.notes.forEach((t=>{t.note.note===e&&this._release(t)}))}releaseAll(){this.notes.forEach((t=>{this._release(t)}))}_release(t){if(t.released)return;t.released=!0,t.chain.releaseNote();const e=Math.ceil(1e3*t.chain.release)+100;setTimeout((()=>{this.notes=this.notes.filter((e=>e!==t)),t.chain.disconnect(),this._releaseGenerator(t.chain)}),e)}scheduleNote(t,e,s,i=0){const a=e.context.currentTime,n=t.duration*(60/this.bpm);s=(s+i)*(60/this.bpm);const r=this._allocateGenerator(e.context,a+s);return r?.scheduleNote(t,s,n,e),r}cancelAllNotes(){for(const t of this.bank)this._releaseGenerator(t);for(const t of this.sound_gens)t.cancelNotes();this.sound_gens=[]}scheduleNotes(t,e,s){const i=e.context.currentTime,a=Math.max(0,-s);for(let t=0;t<this._effects.length;t++){const e=this._effects[t];e.free>0&&e.free<i&&(e.disconnect(),delete this._effects[t])}this._effects=this._effects.filter((t=>void 0!==t));for(let t=0;t<this.sound_gens.length;t++)this.sound_gens[t].free<i&&delete this.sound_gens[t];this.sound_gens=this.sound_gens.filter((t=>void 0!==t));const n=new Array,r=new M(e.context);r.beats=t.beats,n.push(r),this._effects.push(r),r.connect(e,this.bpm,s);for(const i of t.trace)if(i.command==k.PUSH_FX){const t=n[n.length-1],a=N.createEffect(i,e.context);a.connect(t.node,this.bpm,s),n.push(a),this._effects.push(a)}else if(i.command==k.POP_FX)n.pop();else if(i.command==k.PLAY&&i.end>=a){const t=n[n.length-1],e=this.scheduleNote(i.note,t.node,i.time,s);n.forEach((t=>{t.afterEffect(e,i.time,i.note.duration,this.bpm,s)}))}}scheduleMidiNotes(t,e,s,i=1){const a=window.performance.now(),n=Math.max(0,-e);for(const r of t.trace)if(r.command===k.PLAY&&r.end>=n){const t=r.note.clone();t.gain*=i;const n=r.note.duration*(60/this.bpm)*1e3,o=a+(r.time+e)*(60/this.bpm)*1e3,h=[144,Math.round(t.note),t.velocity],c=[128,Math.round(t.note),0];s.send(h,o),s.send(c,o+n)}}setMidiProgram(t,e){e>=0&&e<=127&&t.send([192,e])}cancelAllMidiNotes(t){const e=window.performance.now();for(let s=0;s<=127;s++)t.send([128,s,0],e);"clear"in t&&"function"==typeof t.clear&&t.clear()}pitchBend(t){this.notes.forEach((e=>e.chain.pitchBend(t)))}async loadPatch(t){if(R(t))return await this._loadPatchData(t);if(t instanceof URL)return await this._loadPatchURL(t);switch(t){case"simple-saw":return await this._loadPatchData(q);case"simple-sine":default:return await this._loadPatchData(P);case"simple-square":return await this._loadPatchData($);case"simple-tri":return await this._loadPatchData(C);case"filtered-saw":return await this._loadPatchData(D);case"wobbly-square":return await this._loadPatchData(L)}}async _loadPatchURL(t){let e=await fetch(t),s=await e.json();return R(s)?await this._loadPatchData(s,t.toString()):(this._loadPatchData(P),!1)}async _loadPatchData(t,e="./"){const s=e.split("/").slice(0,-1).join("/")+"/";this.patch=t,this.parameters=[],this._destroyAllGenerators(),this.sound_gens=[];for(const t of this.patch.nodes)if(Array.isArray(t.samples)){const e=t.samples.filter((t=>y(t))).sort(((t,e)=>t.step-e.step));e.forEach((t=>{t.sample=s+t.sample,g.loadAudioBuffer(t.sample)})),t.samples=e}else"reverb"===t.type?await g.loadCustomSound(t.impulse):"buffer source"===t.type&&await g.loadCustomSound(t.buffer);for(const t of this.patch.parameters)this.parameters.push(V.fromJSON(t));return!0}getNodeById(t){return this.bank.length>0?this.bank[0]?.getNodeById(t):void 0}updateParameter(t,e){let s=-1;for(let e of this.parameters)if(e.name===t){s=e.nodeId;break}if(!(s<0)){this.bank.forEach((i=>{i.updateParameter(s,t,e)}));for(const i of this.patch.nodes)i.id==s&&(i[t]=e)}}set attack(t){this.bank.forEach((e=>{e.out&&(e.out.A=Math.max(0,t))})),this.patch.nodes.filter((t=>"out"===t.type)).forEach((e=>e.A=Math.max(0,t)))}set decay(t){this.bank.forEach((e=>{e.out&&(e.out.D=Math.max(0,t))})),this.patch.nodes.filter((t=>"out"===t.type)).forEach((e=>e.D=Math.max(0,t)))}set sustain(t){this.bank.forEach((e=>{e.out&&(e.out.S=o(t,0,1))})),this.patch.nodes.filter((t=>"out"===t.type)).forEach((e=>e.S=o(t,0,1)))}set release(t){this.bank.forEach((e=>{e.out&&(e.out.R=Math.max(0,t))})),this.patch.nodes.filter((t=>"out"===t.type)).forEach((e=>e.R=Math.max(0,t)))}set volume(t){this.bank.forEach((e=>{e.out?.updateParameter("level",o(t,-50,5))})),this.patch.nodes.filter((t=>"out"===t.type)).forEach((e=>e.level=o(t,-50,5)))}_allocateGenerator(t,e){this.bank.length>0&&this.bank[0].context!=t&&this._destroyAllGenerators();for(const s of this.bank)if(s.free<e&&s.context==t)return this._analyzers.forEach((t=>{0==s.free&&s.attachAnalyzer(t.nodeId,t.connectorId,t.fftSize,t.channels)})),s;if(this.bank.length<I.MAX_GENERATORS){const e=new w(t);return e.loadPatch(this.patch),this.bank.push(e),this._analyzers.forEach((t=>{e.attachAnalyzer(t.nodeId,t.connectorId,t.fftSize,t.channels)})),e}}_releaseGenerator(t){t.cancelNotes(),this._analyzers.forEach((e=>{t.detachAnalyzer(e.nodeId,e.connectorId)}))}_destroyAllGenerators(){this.bank.forEach((t=>{t.destroy()})),this.bank=[]}}I.MAX_GENERATORS=24;class B extends HTMLElement{constructor(){super(),this.container=null,this.parent=document.createElementNS("http://www.w3.org/2000/svg","g"),this.width=700,this.height=900,this.major=!0,this.startNote=0,this.wheel=null,this.button=null,this.root=this.attachShadow({mode:"open"}),this.root.adoptedStyleSheets.push(e),this.root.innerHTML='<div id="scale-container">\n  <svg id="scale-svg" class="container" version="1.1" viewBox="0 0 100 200">\n  </svg>\n</div>'}connectedCallback(){this.container=this.root.querySelector("svg.container"),this.container?.append(this.parent),this.container?.setAttribute("viewBox","0 0 100 1000"),console.log(this.container),this.render(!0,!0);const e=this.root.querySelectorAll(".note");console.log("connected",e);const s=new URL("/assets/sounds/voices/grand-piano/patch.json",t&&t.src||new URL("example.min.js",document.baseURI).href),i=new I(s);e?.forEach((t=>{t.addEventListener("click",(e=>{console.log("clicked on "+t.classList);const s=B.NOTES.findIndex((e=>e===t.classList[1]))-this.startNote;this.major?i.playNote(B.MIDI[this.startNote]+B.MAJOR[s]):i.playNote(B.MIDI[this.startNote]+B.MINOR[s])}));let e=this.root.querySelectorAll(`.${t.classList[1]}`);t.addEventListener("mouseout",(t=>{e?.forEach((t=>{t.classList.contains("hover")&&t.classList.remove("hover")}))})),t.addEventListener("mouseover",(s=>{if(t.classList.contains("wheel"))e?.forEach((t=>{t.classList.add("hover")}));else{t.classList.contains("first")?e=this.root.querySelectorAll(`.${t.classList[1]}.first`):t.classList.contains("last")&&(e=this.root.querySelectorAll(`.${t.classList[1]}.last`)),e?.forEach((t=>{t.classList.add("hover")}));const s=this.root.querySelector(`.wheel.${t.classList[1]}`);s&&s.classList.add("hover")}}))}))}disconnectedCallback(){}attributeChangedCallback(t,e,s){}update(t,e){null!=t&&(this.major=t,this.render(!1,!0)),null!=e&&(this.startNote=B.NOTES.indexOf(e),this.render(!1,!1))}render(t,e){if(null==this.container)return;this.parent.innerHTML="",e||t?(this.wheel=new z(this.major,this.startNote,this),this.parent.append(this.wheel.el),this.button=new F(this.major,this),this.parent.append(this.button.el)):(this.wheel&&this.parent.append(this.wheel.el),this.button&&this.parent.append(this.button.el));const s=new G(this.major,this.startNote,this);this.parent.append(s.el);const i=new O(this.major,this.startNote,this);this.parent.append(i.el)}}B.ELEMENT="music-scale",B.observedAttributes=["min-value","max-value","value"],B.NOTES=["C","D","E","F","G","A","B"],B.MIDI=[60,62,64,65,67,69,71,72],B.MAJOR=[0,2,4,5,7,9,11,12],B.MINOR=[0,2,3,5,7,8,10,12];class F{get x(){return 2}get y(){return 2}get height(){return 10}get width(){return 26}constructor(t,e){this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.major=t,this.scale=e;const s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("x",`${this.x}`),s.setAttribute("y",`${this.y}`),s.setAttribute("width",`${this.width}`),s.setAttribute("height",`${this.height}`),s.setAttribute("rx","2"),s.setAttribute("ry","2"),s.setAttribute("fill","black"),s.setAttribute("fill-opacity","0.3"),s.classList.add("button"),this.el.append(s);const i=document.createElementNS("http://www.w3.org/2000/svg","text");i.classList.add("button-text"),i.setAttribute("x",""+(this.x+this.width-this.width/2)),i.setAttribute("y",""+(this.y+this.height-this.height/2)),i.setAttribute("dominant-baseline","central"),i.innerHTML=this.major?"Major Scales":"minor scales",this.el.append(i),this.el.addEventListener("click",(t=>{this.major=!this.major,i.innerHTML=this.major?"Major Scales":"minor scales",e.update(this.major,null)}))}}class z{get cx(){return 50}get cy(){return 39}get r(){return 25}get numSectors(){return 7}get angle(){return 360/this.numSectors*(Math.PI/180)}get offset(){return Math.PI/180*12.83}get pickerCoords(){return[[50,18],[47,11],[53,11]]}constructor(t,e,s){this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.wheel=document.createElementNS("http://www.w3.org/2000/svg","g"),this.text=document.createElementNS("http://www.w3.org/2000/svg","g"),this.down=!1,this.scale=s;let i,a=e+1;for(let e=0;e<this.numSectors;e++){i=z.NOTES[(a+7)%7];const s=this.r*Math.cos(this.angle*(e+1)+this.offset)+this.cx,n=Math.abs(this.r*Math.sin(this.angle*(e+1)+this.offset)-this.cy),r=this.r*Math.cos(this.angle*e+this.offset)+this.cx,o=Math.abs(this.r*Math.sin(this.angle*e+this.offset)-this.cy),h=document.createElementNS("http://www.w3.org/2000/svg","path");h.setAttribute("d",`M ${this.cx} ${this.cy} \n                L ${s} ${n}\n                A ${this.r} ${this.r} 0 0 1 ${r} ${o}\n                L ${this.cx} ${this.cy}`),h.classList.add("wheel"),h.classList.add(i),h.classList.add("note"),this.wheel.append(h);const c=document.createElementNS("http://www.w3.org/2000/svg","text");c.setAttribute("x",""+(s+r+this.cx)/3),c.setAttribute("y",""+(n+o+this.cy)/3),c.setAttribute("dominant-baseline","central"),c.innerHTML=`${i}`,t?c.classList.add("major-text"):c.classList.add("minor-text"),c.classList.add("wheel-text"),this.text.append(c),a--}this.wheel.append(this.text),this.el.append(this.wheel);const n=document.createElementNS("http://www.w3.org/2000/svg","polygon");n.setAttribute("points",`${this.pickerCoords[0][0]} ${this.pickerCoords[0][1]}, \n            ${this.pickerCoords[1][0]} ${this.pickerCoords[1][1]}, \n            ${this.pickerCoords[2][0]} ${this.pickerCoords[2][1]}`),n.setAttribute("fill","grey"),n.setAttribute("fill-opacity","0.8"),this.el.append(n);let r=0,o=0;this.el.addEventListener("pointerdown",(t=>{this.down=!0,t.clientX,t.clientY})),document.addEventListener("pointermove",(t=>{if(this.down){const e=this.svgToScreen(this.cx,this.cy),s=e.x-t.clientX,i=e.y-t.clientY;r=180*Math.atan2(i,s)/Math.PI-o,this.wheel.setAttribute("transform",`rotate(${r} ${this.cx} ${this.cy})`);const a=this.wheel.querySelectorAll(".wheel-text");a?.forEach((t=>{t.setAttribute("transform",`rotate(${-r} \n                        ${t.getAttribute("x")} \n                        ${t.getAttribute("y")})`)}))}const e=this.svgToScreen(50,18);let i=this.scale.root.elementsFromPoint(e.x,e.y);i=i.filter((t=>t.classList.contains("wheel"))),i.length>0&&s.update(null,i[0].classList.item(1))})),document.addEventListener("pointerup",(t=>{this.down&&(this.down=!1);const e=this.svgToScreen(this.cx,this.cy),s=e.x-t.clientX,i=e.y-t.clientY;o=180*Math.atan2(i,s)/Math.PI}))}svgToScreen(t,e){const s=this.scale.container,i=s.createSVGPoint();return i.x=t,i.y=e,i.matrixTransform(s.getScreenCTM()??void 0)}}z.NOTES=["C","D","E","F","G","A","B"];class G{get max(){return 70}get min(){return this.max+13}get x0(){return 18}get y0(){return 86}constructor(t,e,s){this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.staff=document.createElementNS("http://www.w3.org/2000/svg","g"),this.scale=s;for(let t=0;t<5;t++){const e=document.createElementNS("http://www.w3.org/2000/svg","line");let s=this.max+3.25*t;e.setAttribute("x1","0"),e.setAttribute("y1",`${s}`),e.setAttribute("x2","100"),e.setAttribute("y2",`${s}`),e.classList.add("lines"),this.staff.append(e)}const i=document.createElementNS("http://www.w3.org/2000/svg","image");i.setAttribute("href","/assets/images/treble_clef.png"),i.setAttribute("x","0"),i.setAttribute("y","64"),i.setAttribute("width","15"),i.setAttribute("height","25"),this.staff.append(i),this.el.append(this.staff);let a,n=this.min+2,r=this.max-2,o=(n+r)/2,h=e;for(let s=0;s<8;s++){const i=document.createElementNS("http://www.w3.org/2000/svg","g"),c=document.createElementNS("http://www.w3.org/2000/svg","ellipse");a=G.NOTES[(h+7)%7];let l=this.x0+11*(h-e),u=this.y0-1.6*h;c.setAttribute("cx",`${l}`),c.setAttribute("cy",`${u}`),c.setAttribute("rx","2"),c.setAttribute("ry","1.2"),c.setAttribute("transform",`rotate(-18, ${l}, ${u})`),i.append(c);const d=document.createElementNS("http://www.w3.org/2000/svg","line");if(u>o?(d.setAttribute("x1",`${l+1.9}`),d.setAttribute("y1",""+(u-.8)),d.setAttribute("x2",`${l+1.9}`),d.setAttribute("y2",""+(u-9.5))):(d.setAttribute("x1",""+(l-1.9)),d.setAttribute("y1",`${u+.8}`),d.setAttribute("x2",""+(l-1.9)),d.setAttribute("y2",`${u+9.5}`)),i.append(d),u>n||u<r){const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",""+(l-3)),t.setAttribute("x2",`${l+2.7}`),h%2==0?(t.setAttribute("y1",`${u+.25}`),t.setAttribute("y2",`${u+.25}`)):u<r?(t.setAttribute("y1",`${u+1.25}`),t.setAttribute("y2",`${u+1.25}`)):(t.setAttribute("y1",""+(u-1.25)),t.setAttribute("y2",""+(u-1.25))),i.append(t)}switch(a){case"C":switch(e){case 1:case 2:case 5:t&&i.append(this.drawSharp(l,u));break;case 6:i.append(this.drawSharp(l,u))}break;case"D":switch(e){case 2:case 6:t&&i.append(this.drawSharp(l,u));break;case 3:t||i.append(this.drawFlat(l,u))}break;case"E":switch(e){case 0:case 3:case 4:t||i.append(this.drawFlat(l,u))}break;case"F":switch(e){case 1:case 4:case 5:t&&i.append(this.drawSharp(l,u));break;case 2:case 6:i.append(this.drawSharp(l,u))}break;case"G":switch(e){case 2:case 5:case 6:t&&i.append(this.drawSharp(l,u))}break;case"A":switch(e){case 6:t&&i.append(this.drawSharp(l,u));break;case 0:case 3:t||i.append(this.drawFlat(l,u))}break;case"B":switch(e){case 0:case 1:case 4:t||i.append(this.drawFlat(l,u));break;case 3:i.append(this.drawFlat(l,u))}}if(7!=s){const e=document.createElementNS("http://www.w3.org/2000/svg","polyline");t?2==s||6==s?e.classList.add("half"):e.classList.add("whole"):1==s||4==s?e.classList.add("half"):e.classList.add("whole"),e.setAttribute("points",`${l+.6} ${u+2.2}, \n                    ${l+5.5} ${u+6}, \n                    ${l+5.5} ${u+6}, \n                    ${l+10.4} ${u+.6}`),this.el.append(e)}i.classList.add("staff"),i.classList.add(a),0==s?i.classList.add("first"):7==s&&i.classList.add("last"),i.classList.add("note"),this.el.append(i),h++}}drawSharp(t,e){const s=document.createElementNS("http://www.w3.org/2000/svg","g"),i=document.createElementNS("http://www.w3.org/2000/svg","line"),a=document.createElementNS("http://www.w3.org/2000/svg","line"),n=document.createElementNS("http://www.w3.org/2000/svg","line"),r=document.createElementNS("http://www.w3.org/2000/svg","line");return i.setAttribute("x1",""+(t-5)),i.setAttribute("y1",`${e+1}`),i.setAttribute("x2",""+(t-3)),i.setAttribute("y2",""+(e-1)),s.append(i),a.setAttribute("x1",""+(t-5)),a.setAttribute("y1",`${e+3}`),a.setAttribute("x2",""+(t-3)),a.setAttribute("y2",`${e+1}`),s.append(a),n.setAttribute("x1",""+(t-4.35)),n.setAttribute("y1",`${e+4.5}`),n.setAttribute("x2",""+(t-4.35)),n.setAttribute("y2",""+(e-1.5)),s.append(n),r.setAttribute("x1",""+(t-3.55)),r.setAttribute("y1",`${e+3.5}`),r.setAttribute("x2",""+(t-3.55)),r.setAttribute("y2",""+(e-2.5)),s.append(r),s}drawFlat(t,e){const s=document.createElementNS("http://www.w3.org/2000/svg","g"),i=document.createElementNS("http://www.w3.org/2000/svg","line"),a=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("x1",""+(t-4.35)),i.setAttribute("y1",`${e+1.5}`),i.setAttribute("x2",""+(t-4.35)),i.setAttribute("y2",""+(e-4.5)),s.append(i),a.setAttribute("d",`M ${t-4.35} ${e} A 2.5 0.5 -45 0 1 ${t-4.35} ${e+1.5}`),a.setAttribute("fill","none"),s.append(a),s}}G.NOTES=["C","D","E","F","G","A","B"];class O{get x(){return 31}get y(){return 97}get height(){return 44.5}get width(){return 38}constructor(t,e,s){this.el=document.createElementNS("http://www.w3.org/2000/svg","g"),this.rect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.scale=s,this.rect.setAttribute("x",`${this.x}`),this.rect.setAttribute("y",`${this.y}`),this.rect.setAttribute("width",`${this.width}`),this.rect.setAttribute("height",`${this.height}`),this.rect.setAttribute("rx","2"),this.rect.setAttribute("ry","2"),this.rect.setAttribute("fill","black"),this.rect.setAttribute("fill-opacity","0.7"),this.el.append(this.rect);let i=e,a=e+60;for(let e=0;e<8;e++){const s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("x",""+(this.x+this.width-this.width/2+.7)),s.setAttribute("y",`${this.y+5+5*e}`),s.setAttribute("dominant-baseline","central"),s.innerHTML=`playNote(${a})`,B.MIDI[e]=a,a+=t?2==e||6==e?1:2:1==e||4==e?1:2,s.classList.add("code"),s.classList.add(O.NOTES[(i+7)%7]),0==e?s.classList.add("first"):7==e&&s.classList.add("last"),s.classList.add("note"),this.el.append(s),i++}}}O.NOTES=["C","D","E","F","G","A","B"],customElements.define(B.ELEMENT,B)}();
//# sourceMappingURL=example.min.js.map
